<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Authentication</title>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .debug-section { margin: 20px 0; padding: 15px; border: 1px solid #ccc; }
        button { padding: 10px 20px; margin: 5px; }
        .log { background: #f5f5f5; padding: 10px; margin: 10px 0; font-family: monospace; }
    </style>
</head>
<body>
    <h1>Debug Authentication Flow</h1>
    
    <div class="debug-section">
        <h3>Test User: invested4thefuture@gmail.com</h3>
        <button onclick="testStripeCheck()">Test Stripe Check</button>
        <button onclick="testSyncFunction()">Test Sync Function</button>
        <button onclick="testFirebaseCollections()">Test Firebase Collections</button>
        <button onclick="testFullFlow()">Test Full Authentication Flow</button>
    </div>
    
    <div class="debug-section">
        <h3>Debug Logs:</h3>
        <div id="debugLogs" class="log"></div>
    </div>

    <script>
        // Firebase config
        const firebaseConfig = {
            apiKey: "AIzaSyBQJQJQJQJQJQJQJQJQJQJQJQJQJQJQJQ",
            authDomain: "nestmate-167ed.firebaseapp.com",
            projectId: "nestmate-167ed",
            storageBucket: "nestmate-167ed.appspot.com",
            messagingSenderId: "123456789",
            appId: "1:123456789:web:abcdefghijklmnop"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        function log(message) {
            const logs = document.getElementById('debugLogs');
            logs.innerHTML += new Date().toLocaleTimeString() + ': ' + message + '\n';
            console.log(message);
        }

        async function testStripeCheck() {
            log('üîç Testing Stripe check for invested4thefuture@gmail.com');
            try {
                const response = await fetch('/.netlify/functions/check-user-subscription-simple', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        email: 'invested4thefuture@gmail.com'
                    })
                });

                log('üì° Stripe response status: ' + response.status);
                
                if (response.ok) {
                    const result = await response.json();
                    log('üìä Stripe result: ' + JSON.stringify(result, null, 2));
                } else {
                    const error = await response.text();
                    log('‚ùå Stripe error: ' + error);
                }
            } catch (error) {
                log('‚ùå Stripe check failed: ' + error.message);
            }
        }

        async function testSyncFunction() {
            log('üîÑ Testing sync function for invested4thefuture@gmail.com');
            try {
                const response = await fetch('/.netlify/functions/sync-user-collections', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        email: 'invested4thefuture@gmail.com'
                    })
                });

                log('üì° Sync response status: ' + response.status);
                
                if (response.ok) {
                    const result = await response.json();
                    log('üìä Sync result: ' + JSON.stringify(result, null, 2));
                } else {
                    const error = await response.text();
                    log('‚ùå Sync error: ' + error);
                }
            } catch (error) {
                log('‚ùå Sync function failed: ' + error.message);
            }
        }

        async function testFirebaseCollections() {
            log('üîç Testing Firebase collections');
            
            // First, we need to find the user's UID
            try {
                // Try to sign in the user to get their UID
                const userCredential = await auth.signInWithEmailAndPassword('invested4thefuture@gmail.com', 'testpassword');
                const user = userCredential.user;
                log('üë§ User UID: ' + user.uid);
                
                // Check all collections
                const collections = [
                    'Advanced Pro User Accounts',
                    'Pro User Accounts', 
                    'Basic User Accounts',
                    'userProfiles'
                ];
                
                for (const collectionName of collections) {
                    const doc = await db.collection(collectionName).doc(user.uid).get();
                    log('üìä ' + collectionName + ': ' + (doc.exists ? 'EXISTS' : 'NOT FOUND'));
                    if (doc.exists) {
                        log('üìÑ Data: ' + JSON.stringify(doc.data(), null, 2));
                    }
                }
                
            } catch (error) {
                log('‚ùå Firebase test failed: ' + error.message);
            }
        }

        async function testFullFlow() {
            log('üöÄ Testing full authentication flow');
            
            try {
                // Step 1: Test Stripe check
                await testStripeCheck();
                
                // Step 2: Test sync function
                await testSyncFunction();
                
                // Step 3: Test Firebase collections
                await testFirebaseCollections();
                
                log('‚úÖ Full flow test completed');
            } catch (error) {
                log('‚ùå Full flow test failed: ' + error.message);
            }
        }

        // Auto-run tests on page load
        window.onload = function() {
            log('üîß Debug page loaded - ready to test');
        };
    </script>
</body>
</html>
