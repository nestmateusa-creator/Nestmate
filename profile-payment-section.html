<!-- Payment Management Section for Profile Page -->
<!-- This section should be inserted into profile.html -->

<div class="card full-width" id="paymentManagementCard" style="display: none;">
    <div class="card-header">
        <i class="fas fa-credit-card"></i>
        <h2>Payment & Subscription</h2>
    </div>

    <!-- Current Subscription Info -->
    <div class="subscription-info-section" id="subscriptionInfoSection">
        <div class="info-row">
            <span class="info-label">Current Plan:</span>
            <span class="info-value" id="currentPlanName">Loading...</span>
        </div>
        <div class="info-row">
            <span class="info-label">Status:</span>
            <span class="info-value">
                <span class="status-badge" id="subscriptionStatusBadge">Loading...</span>
            </span>
        </div>
        <div class="info-row" id="lastPaymentRow" style="display: none;">
            <span class="info-label">Last Payment:</span>
            <span class="info-value" id="lastPaymentDate">-</span>
        </div>
        <div class="info-row" id="paymentFailedRow" style="display: none;">
            <span class="info-label">Payment Failed:</span>
            <span class="info-value" style="color: #ef4444;" id="paymentFailedDate">-</span>
        </div>
    </div>

    <!-- Lock Warning -->
    <div id="lockedWarning" style="display: none;">
        <div class="alert alert-warning">
            <strong>‚ö†Ô∏è Dashboard Locked</strong><br>
            Your payment failed. Please update your payment method to unlock your dashboard.
        </div>
        <button class="btn btn-success" onclick="retryPayment()" style="width: 100%; margin-top: 12px;">
            <i class="fas fa-redo"></i> Retry Payment
        </button>
    </div>

    <!-- Plan Selection -->
    <div class="plan-selection-section" style="margin-top: 24px;">
        <h3 style="margin-bottom: 16px; color: var(--primary);">Change Plan</h3>
        <div class="plan-selector-grid" id="planSelectorGrid">
            <!-- Plans will be loaded dynamically -->
        </div>
        <button class="btn btn-primary" onclick="handlePlanChange()" id="changePlanBtn" style="width: 100%; margin-top: 16px;" disabled>
            Change Plan
        </button>
    </div>

    <!-- Payment Methods -->
    <div class="payment-methods-section" style="margin-top: 32px;">
        <h3 style="margin-bottom: 16px; color: var(--primary);">Payment Methods</h3>
        <div id="paymentMethodsList">
            <p style="color: #64748b; margin-bottom: 16px;">Loading payment methods...</p>
        </div>
        <button class="btn btn-secondary" onclick="addPaymentMethod()" style="width: 100%;">
            <i class="fas fa-plus"></i> Add Payment Method
        </button>
    </div>

    <!-- Subscription Actions -->
    <div class="subscription-actions-section" style="margin-top: 32px; padding-top: 24px; border-top: 2px solid var(--border);">
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px;">
            <button class="btn btn-secondary" onclick="openCustomerPortal()">
                <i class="fas fa-external-link-alt"></i> Open Customer Portal
            </button>
            <button class="btn btn-danger" onclick="cancelSubscription()">
                <i class="fas fa-times"></i> Cancel Subscription
            </button>
        </div>
    </div>
</div>

<style>
    .subscription-info-section {
        background: #f8fafc;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 24px;
    }

    .info-row {
        display: flex;
        justify-content: space-between;
        padding: 12px 0;
        border-bottom: 1px solid #e2e8f0;
    }

    .info-row:last-child {
        border-bottom: none;
    }

    .info-label {
        color: #64748b;
        font-weight: 500;
    }

    .info-value {
        color: #1e293b;
        font-weight: 600;
    }

    .status-badge {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 0.875rem;
        font-weight: 600;
    }

    .status-active {
        background: #d1fae5;
        color: #065f46;
    }

    .status-inactive {
        background: #fee2e2;
        color: #991b1b;
    }

    .status-locked {
        background: #fef3c7;
        color: #92400e;
    }

    .plan-selector-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 12px;
        margin-bottom: 16px;
    }

    .plan-option {
        border: 2px solid #e2e8f0;
        border-radius: 8px;
        padding: 16px;
        cursor: pointer;
        transition: all 0.2s;
        background: white;
    }

    .plan-option:hover {
        border-color: #667eea;
        background: #f8fafc;
    }

    .plan-option.selected {
        border-color: #667eea;
        background: #eef2ff;
    }

    .plan-option-name {
        font-weight: 600;
        color: #1e293b;
        margin-bottom: 4px;
    }

    .plan-option-price {
        color: #64748b;
        font-size: 0.875rem;
    }

    .payment-method-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 16px;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        margin-bottom: 12px;
        background: white;
    }

    .payment-method-info {
        flex: 1;
    }

    .payment-method-type {
        font-weight: 600;
        color: #1e293b;
        margin-bottom: 4px;
    }

    .payment-method-details {
        color: #64748b;
        font-size: 0.875rem;
    }

    .payment-method-actions {
        display: flex;
        gap: 8px;
    }

    .btn-small {
        padding: 6px 12px;
        font-size: 0.875rem;
        width: auto;
        margin: 0;
    }

    .alert {
        padding: 16px;
        border-radius: 8px;
        margin-bottom: 20px;
    }

    .alert-warning {
        background: #fef3c7;
        color: #92400e;
        border: 1px solid #fde68a;
    }

    .btn-success {
        background: #10b981;
        color: white;
    }

    .btn-success:hover {
        background: #059669;
    }

    .full-width {
        grid-column: 1 / -1;
    }
</style>

<script>
    // Payment management functions for profile page
    let paymentSystem;
    let currentSubscription = null;
    let selectedPlan = null;

    // Initialize payment management
    async function initPaymentManagement() {
        try {
            if (typeof StripePaymentSystem === 'undefined') {
                console.error('StripePaymentSystem not loaded');
                return;
            }

            paymentSystem = new StripePaymentSystem();
            await loadSubscriptionInfo();
            await loadPlans();
            await loadPaymentMethods();
            
            // Check for lock
            const isLocked = await paymentSystem.checkDashboardLock();
            if (isLocked) {
                document.getElementById('lockedWarning').style.display = 'block';
            }

            document.getElementById('paymentManagementCard').style.display = 'block';
        } catch (error) {
            console.error('Error initializing payment management:', error);
        }
    }

    // Load subscription info
    async function loadSubscriptionInfo() {
        try {
            currentSubscription = await paymentSystem.getUserSubscription();
            
            if (!currentSubscription) {
                document.getElementById('currentPlanName').textContent = 'No subscription';
                document.getElementById('subscriptionStatusBadge').textContent = 'Inactive';
                document.getElementById('subscriptionStatusBadge').className = 'status-badge status-inactive';
                return;
            }

            const plans = paymentSystem.getPlans();
            const currentPlan = Object.values(plans).find(p => p.subscriptionType === currentSubscription.subscription);

            document.getElementById('currentPlanName').textContent = currentPlan ? currentPlan.name : currentSubscription.subscription;
            
            const statusClass = currentSubscription.isLocked ? 'status-locked' : 
                              (currentSubscription.status === 'active' ? 'status-active' : 'status-inactive');
            const statusText = currentSubscription.isLocked ? 'Locked' : 
                             (currentSubscription.status === 'active' ? 'Active' : 'Inactive');
            
            document.getElementById('subscriptionStatusBadge').textContent = statusText;
            document.getElementById('subscriptionStatusBadge').className = `status-badge ${statusClass}`;

            if (currentSubscription.lastPayment) {
                document.getElementById('lastPaymentRow').style.display = 'flex';
                document.getElementById('lastPaymentDate').textContent = new Date(currentSubscription.lastPayment).toLocaleDateString();
            }

            if (currentSubscription.paymentFailedAt) {
                document.getElementById('paymentFailedRow').style.display = 'flex';
                document.getElementById('paymentFailedDate').textContent = new Date(currentSubscription.paymentFailedAt).toLocaleDateString();
            }
        } catch (error) {
            console.error('Error loading subscription info:', error);
        }
    }

    // Load plans for selection
    function loadPlans() {
        const plans = paymentSystem.getPlans();
        const selectorGrid = document.getElementById('planSelectorGrid');
        
        selectorGrid.innerHTML = Object.keys(plans).map(planKey => {
            const plan = plans[planKey];
            const isCurrent = currentSubscription && plan.subscriptionType === currentSubscription.subscription;
            
            return `
                <div class="plan-option ${isCurrent ? 'selected' : ''}" data-plan="${planKey}" onclick="selectPlanOption('${planKey}')">
                    <div class="plan-option-name">${plan.name}</div>
                    <div class="plan-option-price">$${plan.price}/month</div>
                </div>
            `;
        }).join('');
    }

    // Select plan option
    function selectPlanOption(planKey) {
        document.querySelectorAll('.plan-option').forEach(opt => opt.classList.remove('selected'));
        document.querySelector(`[data-plan="${planKey}"]`).classList.add('selected');
        selectedPlan = planKey;
        document.getElementById('changePlanBtn').disabled = false;
    }

    // Handle plan change
    async function handlePlanChange() {
        if (!selectedPlan) {
            alert('Please select a plan first.');
            return;
        }

        if (currentSubscription && 
            paymentSystem.getPlans()[selectedPlan].subscriptionType === currentSubscription.subscription) {
            alert('This is already your current plan.');
            return;
        }

        if (!confirm(`Are you sure you want to change to the ${paymentSystem.getPlans()[selectedPlan].name} plan?`)) {
            return;
        }

        try {
            const btn = document.getElementById('changePlanBtn');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';

            await paymentSystem.changeSubscription(selectedPlan);
            
            alert('Plan changed successfully! Redirecting...');
        } catch (error) {
            console.error('Error changing plan:', error);
            alert(error.message || 'Failed to change plan. Please try again.');
            
            const btn = document.getElementById('changePlanBtn');
            btn.disabled = false;
            btn.innerHTML = 'Change Plan';
        }
    }

    // Load payment methods
    async function loadPaymentMethods() {
        try {
            const methods = await paymentSystem.getPaymentMethods();
            const methodsDiv = document.getElementById('paymentMethodsList');
            
            if (methods.length === 0) {
                methodsDiv.innerHTML = '<p style="color: #64748b; margin-bottom: 16px;">No payment methods on file.</p>';
                return;
            }

            methodsDiv.innerHTML = methods.map(method => `
                <div class="payment-method-item">
                    <div class="payment-method-info">
                        <div class="payment-method-type">${method.type === 'card' ? 'üí≥ Card' : method.type}</div>
                        <div class="payment-method-details">
                            ${method.type === 'card' ? `${method.card.brand.toUpperCase()} ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ${method.card.last4}` : method.id}
                            ${method.isDefault ? ' (Default)' : ''}
                        </div>
                    </div>
                    <div class="payment-method-actions">
                        ${!method.isDefault ? `
                            <button class="btn btn-small btn-secondary" onclick="setDefaultPaymentMethod('${method.id}')">
                                Set Default
                            </button>
                        ` : ''}
                        <button class="btn btn-small btn-danger" onclick="deletePaymentMethod('${method.id}')">
                            Delete
                        </button>
                    </div>
                </div>
            `).join('');
        } catch (error) {
            console.error('Error loading payment methods:', error);
        }
    }

    // Add payment method
    async function addPaymentMethod() {
        try {
            await paymentSystem.addPaymentMethod();
            await loadPaymentMethods();
            alert('Payment method added successfully!');
        } catch (error) {
            console.error('Error adding payment method:', error);
            alert(error.message || 'Failed to add payment method.');
        }
    }

    // Set default payment method
    async function setDefaultPaymentMethod(paymentMethodId) {
        try {
            await paymentSystem.setDefaultPaymentMethod(paymentMethodId);
            await loadPaymentMethods();
            alert('Default payment method updated.');
        } catch (error) {
            console.error('Error setting default payment method:', error);
            alert(error.message || 'Failed to update payment method.');
        }
    }

    // Delete payment method
    async function deletePaymentMethod(paymentMethodId) {
        if (!confirm('Are you sure you want to delete this payment method?')) {
            return;
        }

        try {
            await paymentSystem.deletePaymentMethod(paymentMethodId);
            await loadPaymentMethods();
            alert('Payment method deleted.');
        } catch (error) {
            console.error('Error deleting payment method:', error);
            alert(error.message || 'Failed to delete payment method.');
        }
    }

    // Retry payment
    async function retryPayment() {
        try {
            const result = await paymentSystem.retryPayment();
            if (result.success) {
                alert('Payment successful! Dashboard unlocked.');
                location.reload();
            } else {
                alert(result.error || 'Payment failed. Please update your payment method.');
            }
        } catch (error) {
            console.error('Error retrying payment:', error);
            alert(error.message || 'Failed to retry payment.');
        }
    }

    // Open customer portal
    async function openCustomerPortal() {
        try {
            await paymentSystem.openCustomerPortal();
        } catch (error) {
            console.error('Error opening customer portal:', error);
            alert(error.message || 'Failed to open customer portal.');
        }
    }

    // Cancel subscription
    async function cancelSubscription() {
        if (!confirm('Are you sure you want to cancel your subscription? You will lose access to premium features.')) {
            return;
        }

        try {
            await paymentSystem.cancelSubscription();
            alert('Subscription cancelled successfully.');
            location.reload();
        } catch (error) {
            console.error('Error cancelling subscription:', error);
            alert(error.message || 'Failed to cancel subscription.');
        }
    }
</script>

