<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NestMate - Smart Home Management</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <!-- Google Maps JavaScript API -->
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyC_dBBCQ9R3n0KiZ6RodccRsUHoBov7GSA&libraries=places"></script>
    
    <!-- Account Manager Script -->
    <script src="account-manager.js"></script>
    
    <!-- AWS SDK -->
    <script src="https://sdk.amazonaws.com/js/aws-sdk-2.1491.0.min.js"></script>
    <script src="auth-aws.js"></script>
    <script>
        // AWS Configuration
        AWS.config.update({
            region: 'us-east-2',
            accessKeyId: 'AKIAXBLPTGPR44FNAHUL',
            secretAccessKey: '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'
        });

        const dynamodb = new AWS.DynamoDB.DocumentClient();

        // Make Firebase services available globally
        // AWS Cognito auth via auth-aws.js
        // AWS DynamoDB via dynamodb variable
        // AWS services available via AWS SDK

        console.log('AWS initialized successfully');
    </script>
    
    <style>
        :root {
            --primary: #2563eb;
            --primary-dark: #1d4ed8;
            --secondary: #64748b;
            --success: #10b981;
            --success-light: #d1fae5;
            --warning: #f59e0b;
            --warning-light: #fef3c7;
            --danger: #ef4444;
            --light: #f8fafc;
            --dark: #1e293b;
            --border: #e2e8f0;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            --radius: 12px;
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: var(--dark);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        .header {
            background: white;
            border-radius: var(--radius);
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: var(--shadow);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 24px;
            font-weight: 700;
            color: var(--primary);
        }

        .logo i {
            font-size: 32px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
        }

        /* Quick Actions Section */
        .quick-actions-section {
            background: white;
            border-radius: var(--radius);
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: var(--shadow);
        }

        .quick-actions-header {
            text-align: center;
            margin-bottom: 24px;
        }

        .quick-actions-header h2 {
            color: var(--dark);
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .quick-actions-header p {
            color: var(--secondary);
            font-size: 16px;
            margin: 0;
        }

        .quick-actions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
        }

        .action-card {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            border: 2px solid transparent;
            border-radius: var(--radius);
            padding: 24px;
            cursor: pointer;
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }

        .action-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary), var(--success));
            transform: scaleX(0);
            transition: transform 0.3s ease;
        }

        .action-card:hover {
            border-color: var(--primary);
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
        }

        .action-card:hover::before {
            transform: scaleX(1);
        }

        .action-icon {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 16px;
            transition: var(--transition);
        }

        .action-card:hover .action-icon {
            transform: scale(1.1);
        }

        .action-icon i {
            font-size: 24px;
            color: white;
        }

        .action-card h3 {
            color: var(--dark);
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .action-card p {
            color: var(--secondary);
            font-size: 14px;
            line-height: 1.5;
            margin-bottom: 16px;
        }

        .action-badge {
            display: inline-block;
            background: var(--primary);
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Home Selector */
        .home-selector {
            background: white;
            border-radius: var(--radius);
            padding: 20px;
            margin-bottom: 24px;
            box-shadow: var(--shadow);
        }

        .home-selector-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .home-selector h2 {
            color: var(--dark);
            font-size: 18px;
            font-weight: 600;
        }

        .home-dropdown {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        select {
            padding: 8px 16px;
            border: 2px solid var(--border);
            border-radius: var(--radius);
            font-size: 14px;
            background: white;
            cursor: pointer;
            transition: var(--transition);
        }

        select:focus {
            outline: none;
            border-color: var(--primary);
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: var(--radius);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
        }

        .btn-secondary {
            background: var(--light);
            color: var(--dark);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            background: var(--border);
        }

        /* Dashboard Grid */
        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
            margin-bottom: 24px;
        }

        .card {
            background: white;
            border-radius: var(--radius);
            padding: 24px;
            box-shadow: var(--shadow);
            transition: var(--transition);
        }

        .card:hover {
            box-shadow: var(--shadow-lg);
            transform: translateY(-2px);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .card-actions {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .card-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--dark);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .card-title i {
            color: var(--primary);
        }

        /* Home Details */
        .home-details {
            grid-column: 1 / -1;
        }

        .details-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
        }

        .detail-item {
            padding: 16px;
            background: var(--light);
            border-radius: var(--radius);
            border-left: 4px solid var(--primary);
        }

        .detail-label {
            font-size: 12px;
            color: var(--secondary);
            font-weight: 500;
            margin-bottom: 4px;
        }

        .detail-value {
            font-size: 16px;
            font-weight: 600;
            color: var(--dark);
        }

        /* Task Manager */
        .task-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .task-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            margin-bottom: 8px;
            transition: var(--transition);
        }

        .task-item:hover {
            background: var(--light);
        }

        .task-checkbox {
            width: 20px;
            height: 20px;
            accent-color: var(--success);
        }

        .task-content {
            flex: 1;
        }

        .task-title {
            font-weight: 500;
            margin-bottom: 4px;
        }

        .task-due {
            font-size: 12px;
            color: var(--secondary);
        }

        .task-priority {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
        }

        .priority-high {
            background: #fef2f2;
            color: var(--danger);
        }

        .priority-medium {
            background: #fffbeb;
            color: var(--warning);
        }

        .priority-low {
            background: #f0fdf4;
            color: var(--success);
        }

        /* Maintenance Calendar */
        .calendar-controls {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .calendar-nav-btn {
            background: var(--light);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 8px 12px;
            cursor: pointer;
            transition: var(--transition);
            color: var(--secondary);
        }

        .calendar-nav-btn:hover {
            background: var(--border);
            color: var(--primary);
        }

        .current-month {
            font-weight: 600;
            color: var(--dark);
            min-width: 120px;
            text-align: center;
        }

        .calendar-container {
            padding: 20px;
        }

        .calendar-header {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            margin-bottom: 8px;
        }

        .calendar-day-header {
            text-align: center;
            font-weight: 600;
            color: var(--secondary);
            padding: 8px;
            font-size: 14px;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background: var(--border);
            border-radius: var(--radius);
            overflow: hidden;
        }

        .calendar-day {
            background: white;
            min-height: 80px;
            padding: 8px;
            cursor: pointer;
            transition: var(--transition);
            position: relative;
        }

        .calendar-day:hover {
            background: var(--light);
        }

        .calendar-day.other-month {
            background: #f8f9fa;
            color: var(--muted);
        }

        .calendar-day.today {
            background: var(--primary-light);
            border: 2px solid var(--primary);
        }

        .calendar-day.has-reminder {
            background: var(--warning-light);
        }

        .calendar-day.has-reminder::after {
            content: '';
            position: absolute;
            top: 4px;
            right: 4px;
            width: 8px;
            height: 8px;
            background: var(--warning);
            border-radius: 50%;
        }

        .day-number {
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 4px;
        }

        .reminder-indicator {
            font-size: 10px;
            color: var(--warning);
            font-weight: 600;
        }

        .reminder-indicator.completed {
            color: var(--success);
        }

        .calendar-day.all-completed {
            background: var(--success-light);
        }

        .calendar-day.all-completed::after {
            background: var(--success);
        }

        .calendar-actions {
            display: flex;
            gap: 12px;
            padding: 16px 20px;
            border-top: 1px solid var(--border);
        }

        .calendar-action-btn {
            background: var(--primary);
            color: white;
            border: none;
            border-radius: var(--radius);
            padding: 10px 16px;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }

        .calendar-action-btn:hover {
            background: var(--primary-dark);
        }

        .calendar-action-btn.secondary {
            background: var(--light);
            color: var(--dark);
            border: 1px solid var(--border);
        }

        .calendar-action-btn.secondary:hover {
            background: var(--border);
        }

        /* Day Details Modal Styles */
        .day-reminders {
            margin-top: 16px;
        }

        .reminder-item {
            background: white;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 16px;
            margin-bottom: 12px;
            box-shadow: var(--shadow);
        }

        .reminder-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .reminder-header h5 {
            margin: 0;
            color: var(--dark);
            font-size: 16px;
            font-weight: 600;
        }

        .reminder-actions {
            display: flex;
            gap: 8px;
        }

        .btn-icon {
            background: none;
            border: none;
            padding: 4px 8px;
            cursor: pointer;
            border-radius: var(--radius);
            transition: var(--transition);
            color: var(--secondary);
        }

        .btn-icon:hover {
            background: var(--light);
            color: var(--primary);
        }

        .reminder-item p {
            margin: 8px 0;
            color: var(--secondary);
            font-size: 14px;
        }

        .reminder-meta {
            display: flex;
            gap: 12px;
            font-size: 12px;
            color: var(--muted);
        }

        .reminder-meta span {
            background: var(--light);
            padding: 4px 8px;
            border-radius: var(--radius);
        }

        .reminder-time {
            color: var(--primary);
            font-weight: 600;
        }

        .reminder-category {
            color: var(--success);
        }

        .reminder-priority {
            text-transform: capitalize;
        }

        .reminder-item.completed {
            opacity: 0.7;
            background: var(--success-light);
        }

        .reminder-item.completed h5 {
            text-decoration: line-through;
            color: var(--success);
        }

        .reminder-status.completed {
            color: var(--success);
            font-weight: 600;
        }

        /* Notification Styles */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            border: 1px solid var(--success);
            border-radius: var(--radius);
            box-shadow: var(--shadow-lg);
            z-index: 10000;
            max-width: 400px;
            animation: slideInRight 0.3s ease-out;
        }

        .notification-content {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px;
        }

        .notification-content i {
            color: var(--success);
            font-size: 18px;
        }

        .notification-content span {
            flex: 1;
            color: var(--dark);
            font-size: 14px;
        }

        .notification-close {
            background: none;
            border: none;
            color: var(--secondary);
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            transition: var(--transition);
        }

        .notification-close:hover {
            background: var(--light);
            color: var(--danger);
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Context Menu Styles */
        .context-menu {
            position: fixed;
            background: white;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            box-shadow: var(--shadow-lg);
            z-index: 10001;
            min-width: 200px;
            animation: fadeIn 0.2s ease-out;
        }

        .context-menu-header {
            padding: 12px 16px;
            border-bottom: 1px solid var(--border);
            background: var(--light);
            border-radius: var(--radius) var(--radius) 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .context-menu-count {
            font-size: 12px;
            color: var(--secondary);
            background: var(--primary);
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
        }

        .context-menu-item {
            padding: 12px 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: var(--transition);
            border-bottom: 1px solid var(--border);
        }

        .context-menu-item:last-child {
            border-bottom: none;
            border-radius: 0 0 var(--radius) var(--radius);
        }

        .context-menu-item:hover {
            background: var(--light);
        }

        .context-menu-item.danger {
            color: var(--danger);
        }

        .context-menu-item.danger:hover {
            background: #fef2f2;
        }

        .context-menu-item i {
            width: 16px;
            text-align: center;
        }

        .context-menu-separator {
            height: 1px;
            background: var(--border);
            margin: 4px 0;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: scale(0.95);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        /* Large Modal Styles */
        .large-modal {
            max-width: 800px;
            width: 90%;
        }

        /* Expert Services Styles */
        .expert-services-content {
            display: grid;
            gap: 24px;
        }

        .service-category {
            background: var(--light);
            border-radius: var(--radius);
            padding: 20px;
        }

        .service-category h3 {
            color: var(--dark);
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .service-list {
            display: grid;
            gap: 12px;
        }

        .service-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: white;
            border-radius: var(--radius);
            border: 1px solid var(--border);
        }

        .service-item span {
            font-weight: 500;
            color: var(--dark);
        }

        /* Shop Styles */
        .shop-content {
            display: grid;
            gap: 24px;
        }

        .shop-category {
            background: var(--light);
            border-radius: var(--radius);
            padding: 20px;
        }

        .shop-category h3 {
            color: var(--dark);
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .product-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
        }

        .product-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            padding: 16px;
            background: white;
            border-radius: var(--radius);
            border: 1px solid var(--border);
            text-align: center;
        }

        .product-item i {
            font-size: 24px;
            color: var(--primary);
        }

        .product-item span {
            font-weight: 500;
            color: var(--dark);
        }

        /* Guide Styles */
        .guide-content {
            display: grid;
            gap: 24px;
        }

        .guide-section {
            background: var(--light);
            border-radius: var(--radius);
            padding: 20px;
        }

        .guide-section h3 {
            color: var(--dark);
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .guide-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 16px;
        }

        .guide-item {
            background: white;
            border-radius: var(--radius);
            padding: 16px;
            border: 1px solid var(--border);
        }

        .guide-item h4 {
            color: var(--primary);
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 12px;
        }

        .guide-item ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .guide-item li {
            padding: 4px 0;
            color: var(--secondary);
            font-size: 14px;
            position: relative;
            padding-left: 16px;
        }

        .guide-item li::before {
            content: 'â€¢';
            color: var(--primary);
            position: absolute;
            left: 0;
        }

        .tip-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
        }

        .tip-item {
            background: white;
            border-radius: var(--radius);
            padding: 16px;
            border: 1px solid var(--border);
            text-align: center;
        }

        .tip-item i {
            font-size: 24px;
            color: var(--success);
            margin-bottom: 8px;
        }

        .tip-item h4 {
            color: var(--dark);
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .tip-item p {
            color: var(--secondary);
            font-size: 14px;
            line-height: 1.4;
        }

        /* Claims Styles */
        .claims-content {
            display: grid;
            gap: 24px;
        }

        .claims-section {
            background: var(--light);
            border-radius: var(--radius);
            padding: 20px;
        }

        .claims-section h3 {
            color: var(--dark);
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .claim-form {
            background: white;
            border-radius: var(--radius);
            padding: 20px;
            border: 1px solid var(--border);
        }

        .claim-history {
            display: grid;
            gap: 12px;
        }

        .claim-item {
            background: white;
            border-radius: var(--radius);
            padding: 16px;
            border: 1px solid var(--border);
            position: relative;
        }

        .claim-status {
            position: absolute;
            top: 12px;
            right: 12px;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .claim-status.approved {
            background: var(--success-light);
            color: var(--success);
        }

        .claim-status.pending {
            background: var(--warning-light);
            color: var(--warning);
        }

        .claim-item h4 {
            color: var(--dark);
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .claim-item p {
            color: var(--secondary);
            font-size: 14px;
        }

        /* Energy Audit Styles */
        .energy-content {
            display: grid;
            gap: 24px;
        }

        .energy-section {
            background: var(--light);
            border-radius: var(--radius);
            padding: 20px;
        }

        .energy-section h3 {
            color: var(--dark);
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .energy-metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 16px;
        }

        .metric-item {
            background: white;
            border-radius: var(--radius);
            padding: 16px;
            text-align: center;
            border: 1px solid var(--border);
        }

        .metric-value {
            font-size: 24px;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 4px;
        }

        .metric-label {
            font-size: 14px;
            color: var(--secondary);
        }

        .recommendation-list {
            display: grid;
            gap: 16px;
        }

        .recommendation-item {
            display: flex;
            align-items: flex-start;
            gap: 16px;
            background: white;
            border-radius: var(--radius);
            padding: 16px;
            border: 1px solid var(--border);
        }

        .recommendation-item i {
            font-size: 24px;
            color: var(--success);
            margin-top: 4px;
        }

        .recommendation-item h4 {
            color: var(--dark);
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .recommendation-item p {
            color: var(--secondary);
            font-size: 14px;
            margin-bottom: 8px;
        }

        .savings {
            color: var(--success);
            font-weight: 600;
            font-size: 14px;
        }

        /* Home Value Styles */
        .value-content {
            display: grid;
            gap: 24px;
        }

        .value-section {
            background: var(--light);
            border-radius: var(--radius);
            padding: 20px;
        }

        .value-section h3 {
            color: var(--dark);
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .value-display {
            background: white;
            border-radius: var(--radius);
            padding: 24px;
            text-align: center;
            border: 1px solid var(--border);
        }

        .current-value {
            font-size: 36px;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 8px;
        }

        .value-change {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .value-change.positive {
            color: var(--success);
        }

        .value-change.negative {
            color: var(--danger);
        }

        .value-period {
            font-size: 14px;
            color: var(--secondary);
        }

        .improvement-list {
            display: grid;
            gap: 16px;
        }

        .improvement-item {
            display: flex;
            gap: 16px;
            background: white;
            border-radius: var(--radius);
            padding: 16px;
            border: 1px solid var(--border);
        }

        .improvement-date {
            background: var(--primary);
            color: white;
            padding: 8px 12px;
            border-radius: var(--radius);
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            height: fit-content;
        }

        .improvement-details {
            flex: 1;
        }

        .improvement-details h4 {
            color: var(--dark);
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .improvement-details p {
            color: var(--secondary);
            font-size: 14px;
            margin-bottom: 8px;
        }

        .value-added {
            color: var(--success);
            font-weight: 600;
            font-size: 14px;
        }

        /* Warranty Styles */
        .warranty-content {
            display: grid;
            gap: 24px;
        }

        .warranty-section {
            background: var(--light);
            border-radius: var(--radius);
            padding: 20px;
        }

        .warranty-section h3 {
            color: var(--dark);
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .warranty-form {
            background: white;
            border-radius: var(--radius);
            padding: 20px;
            border: 1px solid var(--border);
        }

        .warranty-list {
            display: grid;
            gap: 16px;
        }

        .warranty-item {
            background: white;
            border-radius: var(--radius);
            padding: 16px;
            border: 1px solid var(--border);
            position: relative;
        }

        .warranty-status {
            position: absolute;
            top: 12px;
            right: 12px;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .warranty-status.active {
            background: var(--success-light);
            color: var(--success);
        }

        .warranty-status.warning {
            background: var(--warning-light);
            color: var(--warning);
        }

        .warranty-status.expired {
            background: var(--danger-light);
            color: var(--danger);
        }

        .warranty-item h4 {
            color: var(--dark);
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .warranty-item p {
            color: var(--secondary);
            font-size: 14px;
            margin-bottom: 8px;
        }

        .warranty-expiry {
            color: var(--secondary);
            font-size: 12px;
        }

        /* Emergency Contacts Styles */
        .emergency-content {
            display: grid;
            gap: 24px;
        }

        .emergency-section {
            background: var(--light);
            border-radius: var(--radius);
            padding: 20px;
        }

        .emergency-section h3 {
            color: var(--dark);
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .contact-list {
            display: grid;
            gap: 12px;
        }

        .contact-item {
            display: flex;
            align-items: center;
            gap: 16px;
            background: white;
            border-radius: var(--radius);
            padding: 16px;
            border: 1px solid var(--border);
        }

        .contact-item.emergency {
            border-color: var(--danger);
            background: #fef2f2;
        }

        .contact-item i {
            font-size: 24px;
            color: var(--primary);
        }

        .contact-item.emergency i {
            color: var(--danger);
        }

        .contact-item > div {
            flex: 1;
        }

        .contact-item h4 {
            color: var(--dark);
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .contact-item p {
            color: var(--secondary);
            font-size: 14px;
            margin-bottom: 2px;
        }

        .contact-item span {
            color: var(--primary);
            font-size: 14px;
            font-weight: 500;
        }

        /* Bulk Delete Preview Styles */
        .bulk-delete-preview {
            background: var(--light);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 16px;
            margin-top: 8px;
        }

        .bulk-delete-preview #bulkDeleteCount {
            font-weight: 600;
            color: var(--dark);
            margin-bottom: 8px;
        }

        .bulk-delete-preview #bulkDeleteDates {
            font-size: 14px;
            color: var(--secondary);
        }

        /* Home Details Sections */
        .home-sections {
            grid-column: 1 / -1;
        }

        .section-item {
            background: white;
            border-radius: var(--radius);
            margin-bottom: 16px;
            box-shadow: var(--shadow);
            overflow: hidden;
        }

        .section-header {
            background: var(--light);
            padding: 16px 20px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border);
            transition: var(--transition);
        }

        .section-header:hover {
            background: var(--border);
        }

        .section-header h3 {
            font-size: 16px;
            font-weight: 600;
            color: var(--dark);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .section-header i {
            color: var(--primary);
        }

        .section-toggle {
            background: none;
            border: none;
            font-size: 18px;
            color: var(--secondary);
            cursor: pointer;
            transition: var(--transition);
        }

        .section-toggle:hover {
            color: var(--primary);
        }

        .section-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .section-content.expanded {
            max-height: 2000px;
        }

        .section-details {
            padding: 20px;
        }

        .detail-row {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr auto;
            gap: 16px;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid var(--border);
        }

        .detail-row:last-child {
            border-bottom: none;
        }

        .detail-field {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .detail-label {
            font-size: 12px;
            color: var(--secondary);
            font-weight: 500;
        }

        .detail-value {
            font-size: 14px;
            color: var(--dark);
            font-weight: 500;
        }

        .detail-actions {
            display: flex;
            gap: 8px;
        }

        .action-icon {
            background: none;
            border: none;
            font-size: 14px;
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            transition: var(--transition);
        }

        .action-icon.edit {
            color: var(--primary);
        }

        .action-icon.delete {
            color: var(--danger);
        }

        .action-icon:hover {
            background: var(--light);
        }

        .add-detail-btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: var(--radius);
            font-size: 14px;
            cursor: pointer;
            transition: var(--transition);
            margin-top: 16px;
        }

        .add-detail-btn:hover {
            background: var(--primary-dark);
        }

        .edit-form {
            display: none;
            background: var(--light);
            padding: 16px;
            border-radius: var(--radius);
            margin-top: 12px;
        }

        .edit-form.show {
            display: block;
        }

        .edit-form-row {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 12px;
            margin-bottom: 12px;
        }

        .edit-form input,
        .edit-form select,
        .edit-form textarea {
            padding: 8px 12px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 14px;
        }

        .edit-form textarea {
            resize: vertical;
            min-height: 60px;
        }

        .edit-form-buttons {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
        }

        /* Room Management Styles */
        .room-management {
            padding: 20px 0;
        }

        .room-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 16px;
            background: var(--light);
            border-radius: var(--radius);
        }

        .room-selector {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .room-selector label {
            font-weight: 600;
            color: var(--dark);
            font-size: 14px;
        }

        .room-selector select {
            padding: 8px 12px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 14px;
            min-width: 200px;
        }

        .room-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 16px;
            background: var(--primary);
            color: white;
            border-radius: var(--radius);
        }

        .room-header h4 {
            margin: 0;
            font-size: 18px;
        }

        .room-actions {
            display: flex;
            gap: 8px;
        }

        .room-actions .btn {
            font-size: 12px;
            padding: 6px 12px;
        }

        .room-detail-item {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr auto;
            gap: 16px;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid var(--border);
        }

        .room-detail-item:last-child {
            border-bottom: none;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }

        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            border-radius: var(--radius);
            padding: 24px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--border);
        }

        .modal-header h3 {
            margin: 0;
            color: var(--dark);
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--secondary);
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            color: var(--dark);
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 14px;
            box-sizing: border-box;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .modal-footer {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            margin-top: 20px;
            padding-top: 12px;
            border-top: 1px solid var(--border);
        }

        .action-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            padding: 16px;
            border: 2px solid var(--border);
            border-radius: var(--radius);
            background: white;
            cursor: pointer;
            transition: var(--transition);
            text-decoration: none;
            color: var(--dark);
        }

        .action-btn:hover {
            border-color: var(--primary);
            background: var(--light);
        }

        .action-btn i {
            font-size: 24px;
            color: var(--primary);
        }

        .action-btn span {
            font-size: 12px;
            font-weight: 500;
            text-align: center;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            backdrop-filter: blur(4px);
        }

        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            border-radius: var(--radius);
            padding: 32px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-lg);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--dark);
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--secondary);
            padding: 4px;
        }

        .close-btn:hover {
            color: var(--danger);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--dark);
        }

        .form-input {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--border);
            border-radius: var(--radius);
            font-size: 14px;
            transition: var(--transition);
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        /* Google Maps Autocomplete Styles */
        .pac-container {
            border-radius: var(--radius);
            border: 2px solid var(--primary);
            box-shadow: var(--shadow-lg);
            font-family: 'Inter', sans-serif;
            z-index: 9999;
        }

        .pac-item {
            padding: 12px 16px;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            transition: var(--transition);
        }

        .pac-item:hover {
            background-color: var(--light);
        }

        .pac-item:last-child {
            border-bottom: none;
        }

        .pac-item-query {
            font-weight: 600;
            color: var(--dark);
        }

        .pac-matched {
            font-weight: 600;
            color: var(--primary);
        }

        .pac-secondary-text {
            color: var(--secondary);
            font-size: 14px;
        }

        /* Ensure autocomplete dropdown appears above modals */
        .modal .pac-container {
            z-index: 10000;
        }

        /* Style for autocomplete input focus */
        .form-input:focus + .pac-container {
            border-color: var(--primary);
        }

        /* Profile Modal Styles */
        .profile-avatar-section {
            text-align: center;
            margin-bottom: 24px;
        }

        .profile-avatar {
            position: relative;
            display: inline-block;
            width: 120px;
            height: 120px;
            border-radius: 50%;
            overflow: hidden;
            border: 4px solid var(--primary);
            background: var(--light);
        }

        .profile-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .avatar-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.7);
            padding: 8px;
            transform: translateY(100%);
            transition: var(--transition);
        }

        .profile-avatar:hover .avatar-overlay {
            transform: translateY(0);
        }

        .avatar-upload-btn {
            color: white;
            cursor: pointer;
            font-size: 16px;
        }

        .avatar-upload-btn:hover {
            color: var(--primary);
        }

        .checkbox-group {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            padding: 8px;
            border-radius: var(--radius);
            transition: var(--transition);
        }

        .checkbox-item:hover {
            background: var(--light);
        }

        .checkbox-item input[type="checkbox"] {
            width: 16px;
            height: 16px;
            accent-color: var(--primary);
        }

        .checkbox-item span {
            font-size: 14px;
            color: var(--dark);
        }

        .profile-actions {
            margin-top: 24px;
            padding-top: 24px;
            border-top: 1px solid var(--border);
            text-align: center;
        }

        .profile-actions .btn-danger {
            background: var(--danger);
            color: white;
            border: 1px solid var(--danger);
        }

        .profile-actions .btn-danger:hover {
            background: #dc2626;
            border-color: #dc2626;
        }

        .delete-warning {
            background: #fef2f2;
            border: 1px solid #fecaca;
            border-radius: var(--radius);
            padding: 20px;
            margin-bottom: 24px;
            text-align: center;
        }

        .delete-warning i {
            color: #dc2626;
            font-size: 2rem;
            margin-bottom: 12px;
        }

        .delete-warning h4 {
            color: #dc2626;
            margin-bottom: 12px;
            font-weight: 600;
        }

        .delete-warning p {
            color: #374151;
            margin-bottom: 12px;
        }

        .delete-warning ul {
            text-align: left;
            margin: 12px 0;
            padding-left: 20px;
        }

        .delete-warning li {
            color: #374151;
            margin-bottom: 4px;
        }

        .delete-warning strong {
            color: #dc2626;
        }

        /* User avatar hover effect */
        .user-avatar:hover {
            background: var(--light);
            transform: scale(1.05);
        }

        /* Task styling */
        .task-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            margin-bottom: 8px;
            background: white;
            transition: var(--transition);
        }

        .task-item:hover {
            box-shadow: var(--shadow);
        }

        .task-item.empty-state {
            text-align: center;
            color: var(--secondary);
            font-style: italic;
        }

        .task-checkbox {
            width: 18px;
            height: 18px;
            accent-color: var(--primary);
        }

        .task-content {
            flex: 1;
        }

        .task-title {
            font-weight: 600;
            color: var(--dark);
            margin-bottom: 4px;
        }

        .task-title.completed {
            text-decoration: line-through;
            color: var(--secondary);
        }

        .task-due {
            font-size: 14px;
            color: var(--secondary);
        }

        .task-due.overdue {
            color: var(--danger);
            font-weight: 600;
        }

        .task-description {
            font-size: 14px;
            color: var(--secondary);
            margin-top: 4px;
        }

        .task-priority {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .task-calendar-indicator {
            color: var(--success);
            margin-left: 8px;
            font-size: 12px;
        }

        .task-form-info {
            margin: 16px 0;
            padding: 12px;
            background: var(--success-light);
            border: 1px solid var(--success);
            border-radius: var(--radius);
        }

        .auto-save-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--success);
            font-size: 14px;
            font-weight: 500;
        }

        .auto-save-indicator i {
            font-size: 16px;
        }

        .calendar-sync-status {
            margin-top: 8px;
        }

        .sync-error {
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--danger);
            font-size: 14px;
            font-weight: 500;
        }

        .sync-error i {
            font-size: 16px;
        }

        .btn-sm {
            padding: 4px 8px;
            font-size: 12px;
        }

        .task-sync-status {
            margin-top: 8px;
        }

        .sync-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            font-weight: 500;
            padding: 4px 8px;
            border-radius: var(--radius);
        }

        .sync-indicator.synced {
            color: var(--success);
            background: var(--success-light);
        }

        .sync-indicator.partial {
            color: var(--warning);
            background: var(--warning-light);
        }

        .sync-indicator i {
            font-size: 14px;
        }

        .priority-low {
            background: #d1fae5;
            color: #065f46;
        }

        .priority-medium {
            background: #fef3c7;
            color: #92400e;
        }

        .priority-high {
            background: #fee2e2;
            color: #991b1b;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        .btn-group {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            margin-top: 24px;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .header {
                flex-direction: column;
                gap: 16px;
            }

            .home-selector-header {
                flex-direction: column;
                gap: 12px;
                align-items: stretch;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="logo">
                <i class="fas fa-home"></i>
                NestMate
            </div>
            <div class="user-info">
                <span id="userEmail">Demo User</span>
                <button class="btn btn-secondary" onclick="exportData()">
                    <i class="fas fa-download"></i>
                    Import/Export Files
                </button>
                <div class="user-avatar" onclick="openProfileModal()" style="cursor: pointer;">
                    <i class="fas fa-user"></i>
                </div>
                <button class="btn btn-secondary" onclick="signOut()">
                    <i class="fas fa-sign-out-alt"></i>
                    Sign Out
                </button>
            </div>
        </div>

        <!-- Quick Actions Section -->
        <div class="quick-actions-section">
            <div class="quick-actions-header">
                <h2>Quick Actions</h2>
                <p>Get help with your home maintenance and improvements</p>
            </div>
            <div class="quick-actions-grid">
                <div class="action-card" onclick="openExpertServices()">
                    <div class="action-icon">
                        <i class="fas fa-tools"></i>
                    </div>
                    <h3>Contact Expert Services</h3>
                    <p>Find qualified contractors, plumbers, electricians, and more</p>
                    <div class="action-badge">Professional</div>
                </div>
                
                <div class="action-card" onclick="openHomeShop()">
                    <div class="action-icon">
                        <i class="fas fa-shopping-cart"></i>
                    </div>
                    <h3>Shop for My Home</h3>
                    <p>Browse maintenance supplies, tools, and home improvement products</p>
                    <div class="action-badge">Products</div>
                </div>
                
                <div class="action-card" onclick="openMaintenanceGuide()">
                    <div class="action-icon">
                        <i class="fas fa-book-open"></i>
                    </div>
                    <h3>Maintenance Guide</h3>
                    <p>DIY tips, seasonal checklists, and maintenance schedules</p>
                    <div class="action-badge">DIY</div>
                </div>
                
                <div class="action-card" onclick="openInsuranceClaims()">
                    <div class="action-icon">
                        <i class="fas fa-shield-alt"></i>
                    </div>
                    <h3>Insurance Claims</h3>
                    <p>Track damage, file claims, and manage insurance documentation</p>
                    <div class="action-badge">Claims</div>
                </div>
                
                <div class="action-card" onclick="openEnergyAudit()">
                    <div class="action-icon">
                        <i class="fas fa-leaf"></i>
                    </div>
                    <h3>Energy Audit</h3>
                    <p>Analyze energy usage and find ways to save on utilities</p>
                    <div class="action-badge">Savings</div>
                </div>
                
                <div class="action-card" onclick="openHomeValue()">
                    <div class="action-icon">
                        <i class="fas fa-chart-line"></i>
                    </div>
                    <h3>Home Value Tracker</h3>
                    <p>Monitor your home's value and track improvements</p>
                    <div class="action-badge">Investment</div>
                </div>
                
                <div class="action-card" onclick="openWarrantyTracker()">
                    <div class="action-icon">
                        <i class="fas fa-certificate"></i>
                    </div>
                    <h3>Warranty Tracker</h3>
                    <p>Track appliance warranties and service contracts</p>
                    <div class="action-badge">Protection</div>
                </div>
                
                <div class="action-card" onclick="openEmergencyContacts()">
                    <div class="action-icon">
                        <i class="fas fa-phone-alt"></i>
                    </div>
                    <h3>Emergency Contacts</h3>
                    <p>Quick access to emergency services and important contacts</p>
                    <div class="action-badge">Emergency</div>
                </div>
            </div>
        </div>

        <!-- Home Selector -->
        <div class="home-selector">
            <div class="home-selector-header">
                <h2>Select Your Home</h2>
                <div class="home-dropdown">
                    <select id="homeSelect" onchange="loadHomeData()">
                        <option value="">Select a home...</option>
                        <option value="home1">My First Home</option>
                        <option value="home2">Vacation House</option>
                    </select>
                    <button class="btn btn-primary" onclick="openAddHomeModal()">
                        <i class="fas fa-plus"></i>
                        Add Home
                    </button>
                </div>
            </div>
        </div>

        <!-- Dashboard Grid -->
        <div class="dashboard-grid">
            <!-- Home Details -->
            <div class="card home-details">
                <div class="card-header">
                    <h3 class="card-title">
                        <i class="fas fa-info-circle"></i>
                        Home Details
                    </h3>
                    <div class="card-actions">
                        <button class="btn btn-secondary" onclick="openEditHomeModal()">
                            <i class="fas fa-edit"></i>
                            Edit
                        </button>
                        <button class="btn btn-danger" onclick="deleteCurrentHome()" id="deleteHomeBtn" style="display: none;">
                            <i class="fas fa-trash"></i>
                            Delete
                        </button>
                    </div>
                </div>
                <div id="homeDetailsContent">
                    <div class="details-grid">
                        <div class="detail-item">
                            <div class="detail-label">Home Name</div>
                            <div class="detail-value">My First Home</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Address</div>
                            <div class="detail-value">123 Main St, City, State</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Year Built</div>
                            <div class="detail-value">2020</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Square Feet</div>
                            <div class="detail-value">2,500</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Bedrooms</div>
                            <div class="detail-value">3</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Bathrooms</div>
                            <div class="detail-value">2.5</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Purchase Price</div>
                            <div class="detail-value">$350,000</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Property Type</div>
                            <div class="detail-value">Single Family</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Task Manager -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">
                        <i class="fas fa-tasks"></i>
                        Maintenance Tasks
                    </h3>
                    <button class="btn btn-primary" onclick="openAddTaskModal()">
                        <i class="fas fa-plus"></i>
                        Add Task
                    </button>
                </div>
                <div id="taskList" class="task-list">
                    <div class="task-item">
                        <input type="checkbox" class="task-checkbox" onchange="toggleTask(this)">
                        <div class="task-content">
                            <div class="task-title">Replace Air Filter</div>
                            <div class="task-due">Due: Dec 15, 2024</div>
                        </div>
                        <span class="task-priority priority-medium">Medium</span>
                        <button class="btn btn-secondary" onclick="deleteTask(this)" style="padding: 4px 8px;">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                    <div class="task-item">
                        <input type="checkbox" class="task-checkbox" onchange="toggleTask(this)">
                        <div class="task-content">
                            <div class="task-title">HVAC Maintenance</div>
                            <div class="task-due">Due: Jan 20, 2025</div>
                        </div>
                        <span class="task-priority priority-high">High</span>
                        <button class="btn btn-secondary" onclick="deleteTask(this)" style="padding: 4px 8px;">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                    <div class="task-item">
                        <input type="checkbox" class="task-checkbox" onchange="toggleTask(this)">
                        <div class="task-content">
                            <div class="task-title">Clean Gutters</div>
                            <div class="task-due">Due: Nov 30, 2024</div>
                        </div>
                        <span class="task-priority priority-low">Low</span>
                        <button class="btn btn-secondary" onclick="deleteTask(this)" style="padding: 4px 8px;">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            </div>

                         <!-- Maintenance Calendar -->
             <div class="card">
                 <div class="card-header">
                     <h3 class="card-title">
                         <i class="fas fa-calendar-alt"></i>
                         Maintenance Calendar
                     </h3>
                     <div class="calendar-controls">
                         <button class="calendar-nav-btn" onclick="previousMonth()">
                             <i class="fas fa-chevron-left"></i>
                         </button>
                         <span class="current-month" id="currentMonth">December 2024</span>
                         <button class="calendar-nav-btn" onclick="nextMonth()">
                             <i class="fas fa-chevron-right"></i>
                         </button>
                     </div>
                 </div>
                 <div class="calendar-container">
                     <div class="calendar-header">
                         <div class="calendar-day-header">Sun</div>
                         <div class="calendar-day-header">Mon</div>
                         <div class="calendar-day-header">Tue</div>
                         <div class="calendar-day-header">Wed</div>
                         <div class="calendar-day-header">Thu</div>
                         <div class="calendar-day-header">Fri</div>
                         <div class="calendar-day-header">Sat</div>
                     </div>
                     <div class="calendar-grid" id="calendarGrid">
                         <!-- Calendar days will be populated by JavaScript -->
                     </div>
                 </div>
                 <div class="calendar-actions">
                     <button class="calendar-action-btn" onclick="openAddReminderModal()">
                         <i class="fas fa-plus"></i>
                         Add Reminder
                     </button>
                     <button class="calendar-action-btn" onclick="openCalendarSettings()">
                         <i class="fas fa-cog"></i>
                         Settings
                     </button>
                 </div>
             </div>

             <!-- Comprehensive Home Details -->
             <div class="card home-sections">
                 <div class="card-header">
                     <h3 class="card-title">
                         <i class="fas fa-clipboard-list"></i>
                         Home Details & Specifications
                     </h3>
                 </div>
                 
                 <!-- Roof Section -->
                 <div class="section-item">
                     <div class="section-header" onclick="toggleSection('roof')">
                         <h3><i class="fas fa-home"></i> Roof & Attic</h3>
                         <button class="section-toggle" id="roof-toggle">â–¼</button>
                     </div>
                     <div class="section-content" id="roof-content">
                         <div class="section-details">
                             <div class="detail-row">
                                 <div class="detail-field">
                                     <div class="detail-label">Roof Type</div>
                                     <div class="detail-value">Asphalt Shingle</div>
                                 </div>
                                 <div class="detail-field">
                                     <div class="detail-label">Installation Date</div>
                                     <div class="detail-value">2020-05-15</div>
                                 </div>
                                 <div class="detail-field">
                                     <div class="detail-label">Warranty Expiry</div>
                                     <div class="detail-value">2030-05-15</div>
                                 </div>
                                 <div class="detail-actions">
                                     <button class="action-icon edit" onclick="editDetail('roof')"><i class="fas fa-edit"></i></button>
                                     <button class="action-icon delete" onclick="deleteDetail('roof')"><i class="fas fa-trash"></i></button>
                                 </div>
                             </div>
                             <div class="detail-row">
                                 <div class="detail-field">
                                     <div class="detail-label">Attic Insulation</div>
                                     <div class="detail-value">R-38 Fiberglass</div>
                                 </div>
                                 <div class="detail-field">
                                     <div class="detail-label">Ventilation</div>
                                     <div class="detail-value">Ridge & Soffit Vents</div>
                                 </div>
                                 <div class="detail-field">
                                     <div class="detail-label">Last Inspection</div>
                                     <div class="detail-value">2024-03-10</div>
                                 </div>
                                 <div class="detail-actions">
                                     <button class="action-icon edit" onclick="editDetail('roof')"><i class="fas fa-edit"></i></button>
                                     <button class="action-icon delete" onclick="deleteDetail('roof')"><i class="fas fa-trash"></i></button>
                                 </div>
                             </div>
                             <button class="add-detail-btn" onclick="addDetail('roof')">
                                 <i class="fas fa-plus"></i> Add Roof Detail
                             </button>
                         </div>
                     </div>
                 </div>

                 <!-- Exterior Section -->
                 <div class="section-item">
                     <div class="section-header" onclick="toggleSection('exterior')">
                         <h3><i class="fas fa-paint-brush"></i> Exterior & Siding</h3>
                         <button class="section-toggle" id="exterior-toggle">â–¼</button>
                     </div>
                     <div class="section-content" id="exterior-content">
                         <div class="section-details">
                             <div class="detail-row">
                                 <div class="detail-field">
                                     <div class="detail-label">Siding Material</div>
                                     <div class="detail-value">Vinyl</div>
                                 </div>
                                 <div class="detail-field">
                                     <div class="detail-label">Color</div>
                                     <div class="detail-value">Beige</div>
                                 </div>
                                 <div class="detail-field">
                                     <div class="detail-label">Last Paint Date</div>
                                     <div class="detail-value">2022-08-20</div>
                                 </div>
                                 <div class="detail-actions">
                                     <button class="action-icon edit" onclick="editDetail('exterior')"><i class="fas fa-edit"></i></button>
                                     <button class="action-icon delete" onclick="deleteDetail('exterior')"><i class="fas fa-trash"></i></button>
                                 </div>
                             </div>
                             <div class="detail-row">
                                 <div class="detail-field">
                                     <div class="detail-label">Gutters</div>
                                     <div class="detail-value">Aluminum, 6"</div>
                                 </div>
                                 <div class="detail-field">
                                     <div class="detail-label">Downspouts</div>
                                     <div class="detail-value">4 total</div>
                                 </div>
                                 <div class="detail-field">
                                     <div class="detail-label">Last Cleaning</div>
                                     <div class="detail-value">2024-04-15</div>
                                 </div>
                                 <div class="detail-actions">
                                     <button class="action-icon edit" onclick="editDetail('exterior')"><i class="fas fa-edit"></i></button>
                                     <button class="action-icon delete" onclick="deleteDetail('exterior')"><i class="fas fa-trash"></i></button>
                                 </div>
                             </div>
                             <button class="add-detail-btn" onclick="addDetail('exterior')">
                                 <i class="fas fa-plus"></i> Add Exterior Detail
                             </button>
                         </div>
                     </div>
                 </div>

                 <!-- HVAC Section -->
                 <div class="section-item">
                     <div class="section-header" onclick="toggleSection('hvac')">
                         <h3><i class="fas fa-thermometer-half"></i> HVAC & Climate Control</h3>
                         <button class="section-toggle" id="hvac-toggle">â–¼</button>
                     </div>
                     <div class="section-content" id="hvac-content">
                         <div class="section-details">
                             <div class="detail-row">
                                 <div class="detail-field">
                                     <div class="detail-label">Furnace Type</div>
                                     <div class="detail-value">Gas Forced Air</div>
                                 </div>
                                 <div class="detail-field">
                                     <div class="detail-label">Model</div>
                                     <div class="detail-value">Carrier 58STA</div>
                                 </div>
                                 <div class="detail-field">
                                     <div class="detail-label">Installation Date</div>
                                     <div class="detail-value">2019-11-05</div>
                                 </div>
                                 <div class="detail-actions">
                                     <button class="action-icon edit" onclick="editDetail('hvac')"><i class="fas fa-edit"></i></button>
                                     <button class="action-icon delete" onclick="deleteDetail('hvac')"><i class="fas fa-trash"></i></button>
                                 </div>
                             </div>
                             <div class="detail-row">
                                 <div class="detail-field">
                                     <div class="detail-label">AC Unit</div>
                                     <div class="detail-value">Central Air, 3.5 Ton</div>
                                 </div>
                                 <div class="detail-field">
                                     <div class="detail-label">Filter Size</div>
                                     <div class="detail-value">16x20x1</div>
                                 </div>
                                 <div class="detail-field">
                                     <div class="detail-label">Last Service</div>
                                     <div class="detail-value">2024-05-20</div>
                                 </div>
                                 <div class="detail-actions">
                                     <button class="action-icon edit" onclick="editDetail('hvac')"><i class="fas fa-edit"></i></button>
                                     <button class="action-icon delete" onclick="deleteDetail('hvac')"><i class="fas fa-trash"></i></button>
                                 </div>
                             </div>
                             <button class="add-detail-btn" onclick="addDetail('hvac')">
                                 <i class="fas fa-plus"></i> Add HVAC Detail
                             </button>
                         </div>
                     </div>
                 </div>

                 <!-- Plumbing Section -->
                 <div class="section-item">
                     <div class="section-header" onclick="toggleSection('plumbing')">
                         <h3><i class="fas fa-tint"></i> Plumbing & Water Systems</h3>
                         <button class="section-toggle" id="plumbing-toggle">â–¼</button>
                     </div>
                     <div class="section-content" id="plumbing-content">
                         <div class="section-details">
                             <div class="detail-row">
                                 <div class="detail-field">
                                     <div class="detail-label">Water Heater</div>
                                     <div class="detail-value">Gas, 50 Gallon</div>
                                 </div>
                                 <div class="detail-field">
                                     <div class="detail-label">Model</div>
                                     <div class="detail-value">Rheem XG50T12HE40U0</div>
                                 </div>
                                 <div class="detail-field">
                                     <div class="detail-label">Installation Date</div>
                                     <div class="detail-value">2021-03-12</div>
                                 </div>
                                 <div class="detail-actions">
                                     <button class="action-icon edit" onclick="editDetail('plumbing')"><i class="fas fa-edit"></i></button>
                                     <button class="action-icon delete" onclick="deleteDetail('plumbing')"><i class="fas fa-trash"></i></button>
                                 </div>
                             </div>
                             <div class="detail-row">
                                 <div class="detail-field">
                                     <div class="detail-label">Main Water Line</div>
                                     <div class="detail-value">Copper, 3/4"</div>
                                 </div>
                                 <div class="detail-field">
                                     <div class="detail-label">Sewer Type</div>
                                     <div class="detail-value">Municipal</div>
                                 </div>
                                 <div class="detail-field">
                                     <div class="detail-label">Last Inspection</div>
                                     <div class="detail-value">2024-02-08</div>
                                 </div>
                                 <div class="detail-actions">
                                     <button class="action-icon edit" onclick="editDetail('plumbing')"><i class="fas fa-edit"></i></button>
                                     <button class="action-icon delete" onclick="deleteDetail('plumbing')"><i class="fas fa-trash"></i></button>
                                 </div>
                             </div>
                             <button class="add-detail-btn" onclick="addDetail('plumbing')">
                                 <i class="fas fa-plus"></i> Add Plumbing Detail
                             </button>
                         </div>
                     </div>
                 </div>

                 <!-- Electrical Section -->
                 <div class="section-item">
                     <div class="section-header" onclick="toggleSection('electrical')">
                         <h3><i class="fas fa-bolt"></i> Electrical Systems</h3>
                         <button class="section-toggle" id="electrical-toggle">â–¼</button>
                     </div>
                     <div class="section-content" id="electrical-content">
                         <div class="section-details">
                             <div class="detail-row">
                                 <div class="detail-field">
                                     <div class="detail-label">Panel Type</div>
                                     <div class="detail-value">200 Amp, Square D</div>
                                 </div>
                                 <div class="detail-field">
                                     <div class="detail-label">Circuit Count</div>
                                     <div class="detail-value">24 Circuits</div>
                                 </div>
                                 <div class="detail-field">
                                     <div class="detail-label">Last Inspection</div>
                                     <div class="detail-value">2023-09-15</div>
                                 </div>
                                 <div class="detail-actions">
                                     <button class="action-icon edit" onclick="editDetail('electrical')"><i class="fas fa-edit"></i></button>
                                     <button class="action-icon delete" onclick="deleteDetail('electrical')"><i class="fas fa-trash"></i></button>
                                 </div>
                             </div>
                             <div class="detail-row">
                                 <div class="detail-field">
                                     <div class="detail-label">Wiring Type</div>
                                     <div class="detail-value">Copper, 12/2</div>
                                 </div>
                                 <div class="detail-field">
                                     <div class="detail-label">Outlets</div>
                                     <div class="detail-value">GFCI in Kitchen/Bath</div>
                                 </div>
                                 <div class="detail-field">
                                     <div class="detail-label">Smoke Detectors</div>
                                     <div class="detail-value">6 Total</div>
                                 </div>
                                 <div class="detail-actions">
                                     <button class="action-icon edit" onclick="editDetail('electrical')"><i class="fas fa-edit"></i></button>
                                     <button class="action-icon delete" onclick="deleteDetail('electrical')"><i class="fas fa-trash"></i></button>
                                 </div>
                             </div>
                             <button class="add-detail-btn" onclick="addDetail('electrical')">
                                 <i class="fas fa-plus"></i> Add Electrical Detail
                             </button>
                         </div>
                     </div>
                 </div>

                 <!-- Interior Section -->
                 <div class="section-item">
                     <div class="section-header" onclick="toggleSection('interior')">
                         <h3><i class="fas fa-couch"></i> Interior & Finishes</h3>
                         <button class="section-toggle" id="interior-toggle">â–¼</button>
                     </div>
                     <div class="section-content" id="interior-content">
                         <div class="section-details">
                             <div class="detail-row">
                                 <div class="detail-field">
                                     <div class="detail-label">Flooring</div>
                                     <div class="detail-value">Hardwood, Carpet, Tile</div>
                                 </div>
                                 <div class="detail-field">
                                     <div class="detail-label">Wall Material</div>
                                     <div class="detail-value">Drywall</div>
                                 </div>
                                 <div class="detail-field">
                                     <div class="detail-label">Ceiling Height</div>
                                     <div class="detail-value">9' Standard</div>
                                 </div>
                                 <div class="detail-actions">
                                     <button class="action-icon edit" onclick="editDetail('interior')"><i class="fas fa-edit"></i></button>
                                     <button class="action-icon delete" onclick="deleteDetail('interior')"><i class="fas fa-trash"></i></button>
                                 </div>
                             </div>
                             <div class="detail-row">
                                 <div class="detail-field">
                                     <div class="detail-label">Windows</div>
                                     <div class="detail-value">Double Pane, Vinyl</div>
                                 </div>
                                 <div class="detail-field">
                                     <div class="detail-label">Doors</div>
                                     <div class="detail-value">Solid Core Interior</div>
                                 </div>
                                 <div class="detail-field">
                                     <div class="detail-label">Last Paint</div>
                                     <div class="detail-value">2023-06-10</div>
                                 </div>
                                 <div class="detail-actions">
                                     <button class="action-icon edit" onclick="editDetail('interior')"><i class="fas fa-edit"></i></button>
                                     <button class="action-icon delete" onclick="deleteDetail('interior')"><i class="fas fa-trash"></i></button>
                                 </div>
                             </div>
                             <button class="add-detail-btn" onclick="addDetail('interior')">
                                 <i class="fas fa-plus"></i> Add Interior Detail
                             </button>
                         </div>
                     </div>
                 </div>

                                   <!-- Foundation Section -->
                  <div class="section-item">
                      <div class="section-header" onclick="toggleSection('foundation')">
                          <h3><i class="fas fa-layer-group"></i> Foundation & Structure</h3>
                          <button class="section-toggle" id="foundation-toggle">â–¼</button>
                      </div>
                      <div class="section-content" id="foundation-content">
                          <div class="section-details">
                              <div class="detail-row">
                                  <div class="detail-field">
                                      <div class="detail-label">Foundation Type</div>
                                      <div class="detail-value">Poured Concrete</div>
                                  </div>
                                  <div class="detail-field">
                                      <div class="detail-label">Basement</div>
                                      <div class="detail-value">Finished, 1,200 sq ft</div>
                                  </div>
                                  <div class="detail-field">
                                      <div class="detail-label">Last Inspection</div>
                                      <div class="detail-value">2024-01-20</div>
                                  </div>
                                  <div class="detail-actions">
                                      <button class="action-icon edit" onclick="editDetail('foundation')"><i class="fas fa-edit"></i></button>
                                      <button class="action-icon delete" onclick="deleteDetail('foundation')"><i class="fas fa-trash"></i></button>
                                  </div>
                              </div>
                              <div class="detail-row">
                                  <div class="detail-field">
                                      <div class="detail-label">Framing</div>
                                      <div class="detail-value">2x6 Studs, 16" OC</div>
                                  </div>
                                  <div class="detail-field">
                                      <div class="detail-label">Insulation</div>
                                      <div class="detail-value">R-19 Walls, R-30 Ceiling</div>
                                  </div>
                                  <div class="detail-field">
                                      <div class="detail-label">Vapor Barrier</div>
                                      <div class="detail-value">6 Mil Polyethylene</div>
                                  </div>
                                  <div class="detail-actions">
                                      <button class="action-icon edit" onclick="editDetail('foundation')"><i class="fas fa-edit"></i></button>
                                      <button class="action-icon delete" onclick="deleteDetail('foundation')"><i class="fas fa-trash"></i></button>
                                  </div>
                              </div>
                              <button class="add-detail-btn" onclick="addDetail('foundation')">
                                  <i class="fas fa-plus"></i> Add Foundation Detail
                              </button>
                          </div>
                      </div>
                  </div>

                  <!-- Garage Section -->
                  <div class="section-item">
                      <div class="section-header" onclick="toggleSection('garage')">
                          <h3><i class="fas fa-warehouse"></i> Garage & Parking</h3>
                          <button class="section-toggle" id="garage-toggle">â–¼</button>
                      </div>
                      <div class="section-content" id="garage-content">
                          <div class="section-details">
                              <div class="detail-row">
                                  <div class="detail-field">
                                      <div class="detail-label">Garage Type</div>
                                      <div class="detail-value">Attached, 2-Car</div>
                                  </div>
                                  <div class="detail-field">
                                      <div class="detail-label">Size</div>
                                      <div class="detail-value">24' x 20'</div>
                                  </div>
                                  <div class="detail-field">
                                      <div class="detail-label">Door Type</div>
                                      <div class="detail-value">Automatic, 2 Doors</div>
                                  </div>
                                  <div class="detail-actions">
                                      <button class="action-icon edit" onclick="editDetail('garage')"><i class="fas fa-edit"></i></button>
                                      <button class="action-icon delete" onclick="deleteDetail('garage')"><i class="fas fa-trash"></i></button>
                                  </div>
                              </div>
                              <div class="detail-row">
                                  <div class="detail-field">
                                      <div class="detail-label">Flooring</div>
                                      <div class="detail-value">Concrete, Epoxy Coated</div>
                                  </div>
                                  <div class="detail-field">
                                      <div class="detail-label">Storage</div>
                                      <div class="detail-value">Overhead Racks, Cabinets</div>
                                  </div>
                                  <div class="detail-field">
                                      <div class="detail-label">Last Maintenance</div>
                                      <div class="detail-value">2024-02-15</div>
                                  </div>
                                  <div class="detail-actions">
                                      <button class="action-icon edit" onclick="editDetail('garage')"><i class="fas fa-edit"></i></button>
                                      <button class="action-icon delete" onclick="deleteDetail('garage')"><i class="fas fa-trash"></i></button>
                                  </div>
                              </div>
                              <button class="add-detail-btn" onclick="addDetail('garage')">
                                  <i class="fas fa-plus"></i> Add Garage Detail
                              </button>
                          </div>
                      </div>
                  </div>

                  <!-- Windows Section -->
                  <div class="section-item">
                      <div class="section-header" onclick="toggleSection('windows')">
                          <h3><i class="fas fa-window-maximize"></i> Windows & Glazing</h3>
                          <button class="section-toggle" id="windows-toggle">â–¼</button>
                      </div>
                      <div class="section-content" id="windows-content">
                          <div class="section-details">
                              <div class="detail-row">
                                  <div class="detail-field">
                                      <div class="detail-label">Window Type</div>
                                      <div class="detail-value">Double Hung, Vinyl</div>
                                  </div>
                                  <div class="detail-field">
                                      <div class="detail-label">Glazing</div>
                                      <div class="detail-value">Double Pane, Low-E</div>
                                  </div>
                                  <div class="detail-field">
                                      <div class="detail-label">Total Count</div>
                                      <div class="detail-value">12 Windows</div>
                                  </div>
                                  <div class="detail-actions">
                                      <button class="action-icon edit" onclick="editDetail('windows')"><i class="fas fa-edit"></i></button>
                                      <button class="action-icon delete" onclick="deleteDetail('windows')"><i class="fas fa-trash"></i></button>
                                  </div>
                              </div>
                              <div class="detail-row">
                                  <div class="detail-field">
                                      <div class="detail-label">Installation Date</div>
                                      <div class="detail-value">2021-08-10</div>
                                  </div>
                                  <div class="detail-field">
                                      <div class="detail-label">Warranty</div>
                                      <div class="detail-value">Lifetime</div>
                                  </div>
                                  <div class="detail-field">
                                      <div class="detail-label">Last Cleaning</div>
                                      <div class="detail-value">2024-03-25</div>
                                  </div>
                                  <div class="detail-actions">
                                      <button class="action-icon edit" onclick="editDetail('windows')"><i class="fas fa-edit"></i></button>
                                      <button class="action-icon delete" onclick="deleteDetail('windows')"><i class="fas fa-trash"></i></button>
                                  </div>
                              </div>
                              <button class="add-detail-btn" onclick="addDetail('windows')">
                                  <i class="fas fa-plus"></i> Add Window Detail
                              </button>
                          </div>
                      </div>
                  </div>

                  <!-- Doors Section -->
                  <div class="section-item">
                      <div class="section-header" onclick="toggleSection('doors')">
                          <h3><i class="fas fa-door-open"></i> Doors & Entryways</h3>
                          <button class="section-toggle" id="doors-toggle">â–¼</button>
                      </div>
                      <div class="section-content" id="doors-content">
                          <div class="section-details">
                              <div class="detail-row">
                                  <div class="detail-field">
                                      <div class="detail-label">Front Door</div>
                                      <div class="detail-value">Steel, 36" x 80"</div>
                                  </div>
                                  <div class="detail-field">
                                      <div class="detail-label">Lock Type</div>
                                      <div class="detail-value">Smart Lock, Keypad</div>
                                  </div>
                                  <div class="detail-field">
                                      <div class="detail-label">Installation Date</div>
                                      <div class="detail-value">2022-05-12</div>
                                  </div>
                                  <div class="detail-actions">
                                      <button class="action-icon edit" onclick="editDetail('doors')"><i class="fas fa-edit"></i></button>
                                      <button class="action-icon delete" onclick="deleteDetail('doors')"><i class="fas fa-trash"></i></button>
                                  </div>
                              </div>
                              <div class="detail-row">
                                  <div class="detail-field">
                                      <div class="detail-label">Interior Doors</div>
                                      <div class="detail-value">Solid Core, 6-Panel</div>
                                  </div>
                                  <div class="detail-field">
                                      <div class="detail-label">Hardware</div>
                                      <div class="detail-value">Brass, Privacy Locks</div>
                                  </div>
                                  <div class="detail-field">
                                      <div class="detail-label">Total Count</div>
                                      <div class="detail-value">8 Interior Doors</div>
                                  </div>
                                  <div class="detail-actions">
                                      <button class="action-icon edit" onclick="editDetail('doors')"><i class="fas fa-edit"></i></button>
                                      <button class="action-icon delete" onclick="deleteDetail('doors')"><i class="fas fa-trash"></i></button>
                                  </div>
                              </div>
                              <button class="add-detail-btn" onclick="addDetail('doors')">
                                  <i class="fas fa-plus"></i> Add Door Detail
                              </button>
                          </div>
                      </div>
                  </div>

                  <!-- Decks & Patios Section -->
                  <div class="section-item">
                      <div class="section-header" onclick="toggleSection('outdoor')">
                          <h3><i class="fas fa-umbrella-beach"></i> Decks, Patios & Outdoor</h3>
                          <button class="section-toggle" id="outdoor-toggle">â–¼</button>
                      </div>
                      <div class="section-content" id="outdoor-content">
                          <div class="section-details">
                              <div class="detail-row">
                                  <div class="detail-field">
                                      <div class="detail-label">Deck Material</div>
                                      <div class="detail-value">Composite, 12' x 16'</div>
                                  </div>
                                  <div class="detail-field">
                                      <div class="detail-label">Railings</div>
                                      <div class="detail-value">Aluminum, 42" Height</div>
                                  </div>
                                  <div class="detail-field">
                                      <div class="detail-label">Installation Date</div>
                                      <div class="detail-value">2023-06-20</div>
                                  </div>
                                  <div class="detail-actions">
                                      <button class="action-icon edit" onclick="editDetail('outdoor')"><i class="fas fa-edit"></i></button>
                                      <button class="action-icon delete" onclick="deleteDetail('outdoor')"><i class="fas fa-trash"></i></button>
                                  </div>
                              </div>
                              <div class="detail-row">
                                  <div class="detail-field">
                                      <div class="detail-label">Patio</div>
                                      <div class="detail-value">Concrete, 20' x 15'</div>
                                  </div>
                                  <div class="detail-field">
                                      <div class="detail-label">Coverage</div>
                                      <div class="detail-value">Pergola, 10' x 12'</div>
                                  </div>
                                  <div class="detail-field">
                                      <div class="detail-label">Last Sealing</div>
                                      <div class="detail-value">2024-04-10</div>
                                  </div>
                                  <div class="detail-actions">
                                      <button class="action-icon edit" onclick="editDetail('outdoor')"><i class="fas fa-edit"></i></button>
                                      <button class="action-icon delete" onclick="deleteDetail('outdoor')"><i class="fas fa-trash"></i></button>
                                  </div>
                              </div>
                              <button class="add-detail-btn" onclick="addDetail('outdoor')">
                                  <i class="fas fa-plus"></i> Add Outdoor Detail
                              </button>
                          </div>
                      </div>
                  </div>

                  <!-- Lot & Landscaping Section -->
                  <div class="section-item">
                      <div class="section-header" onclick="toggleSection('landscaping')">
                          <h3><i class="fas fa-seedling"></i> Lot & Landscaping</h3>
                          <button class="section-toggle" id="landscaping-toggle">â–¼</button>
                      </div>
                      <div class="section-content" id="landscaping-content">
                          <div class="section-details">
                              <div class="detail-row">
                                  <div class="detail-field">
                                      <div class="detail-label">Lot Size</div>
                                      <div class="detail-value">0.35 Acres</div>
                                  </div>
                                  <div class="detail-field">
                                      <div class="detail-label">Dimensions</div>
                                      <div class="detail-value">100' x 150'</div>
                                  </div>
                                  <div class="detail-field">
                                      <div class="detail-label">Zoning</div>
                                      <div class="detail-value">Residential R-1</div>
                                  </div>
                                  <div class="detail-actions">
                                      <button class="action-icon edit" onclick="editDetail('landscaping')"><i class="fas fa-edit"></i></button>
                                      <button class="action-icon delete" onclick="deleteDetail('landscaping')"><i class="fas fa-trash"></i></button>
                                  </div>
                              </div>
                              <div class="detail-row">
                                  <div class="detail-field">
                                      <div class="detail-label">Trees</div>
                                      <div class="detail-value">5 Mature, 3 New</div>
                                  </div>
                                  <div class="detail-field">
                                      <div class="detail-label">Lawn Type</div>
                                      <div class="detail-value">Kentucky Bluegrass</div>
                                  </div>
                                  <div class="detail-field">
                                      <div class="detail-label">Last Maintenance</div>
                                      <div class="detail-value">2024-05-15</div>
                                  </div>
                                  <div class="detail-actions">
                                      <button class="action-icon edit" onclick="editDetail('landscaping')"><i class="fas fa-edit"></i></button>
                                      <button class="action-icon delete" onclick="deleteDetail('landscaping')"><i class="fas fa-trash"></i></button>
                                  </div>
                              </div>
                              <button class="add-detail-btn" onclick="addDetail('landscaping')">
                                  <i class="fas fa-plus"></i> Add Landscaping Detail
                              </button>
                          </div>
                      </div>
                  </div>

                  <!-- Irrigation Section -->
                  <div class="section-item">
                      <div class="section-header" onclick="toggleSection('irrigation')">
                          <h3><i class="fas fa-tint"></i> Irrigation & Watering</h3>
                          <button class="section-toggle" id="irrigation-toggle">â–¼</button>
                      </div>
                      <div class="section-content" id="irrigation-content">
                          <div class="section-details">
                              <div class="detail-row">
                                  <div class="detail-field">
                                      <div class="detail-label">System Type</div>
                                      <div class="detail-value">Automatic Sprinkler</div>
                                  </div>
                                  <div class="detail-field">
                                      <div class="detail-label">Zones</div>
                                      <div class="detail-value">6 Zones</div>
                                  </div>
                                  <div class="detail-field">
                                      <div class="detail-label">Controller</div>
                                      <div class="detail-value">Smart Controller</div>
                                  </div>
                                  <div class="detail-actions">
                                      <button class="action-icon edit" onclick="editDetail('irrigation')"><i class="fas fa-edit"></i></button>
                                      <button class="action-icon delete" onclick="deleteDetail('irrigation')"><i class="fas fa-trash"></i></button>
                                  </div>
                              </div>
                              <div class="detail-row">
                                  <div class="detail-field">
                                      <div class="detail-label">Heads</div>
                                      <div class="detail-value">24 Sprinkler Heads</div>
                                  </div>
                                  <div class="detail-field">
                                      <div class="detail-label">Installation Date</div>
                                      <div class="detail-value">2022-04-08</div>
                                  </div>
                                  <div class="detail-field">
                                      <div class="detail-label">Last Service</div>
                                      <div class="detail-value">2024-04-20</div>
                                  </div>
                                  <div class="detail-actions">
                                      <button class="action-icon edit" onclick="editDetail('irrigation')"><i class="fas fa-edit"></i></button>
                                      <button class="action-icon delete" onclick="deleteDetail('irrigation')"><i class="fas fa-trash"></i></button>
                                  </div>
                              </div>
                              <button class="add-detail-btn" onclick="addDetail('irrigation')">
                                  <i class="fas fa-plus"></i> Add Irrigation Detail
                              </button>
                          </div>
                      </div>
                  </div>

                  <!-- Fencing Section -->
                  <div class="section-item">
                      <div class="section-header" onclick="toggleSection('fencing')">
                          <h3><i class="fas fa-border-all"></i> Fencing & Boundaries</h3>
                          <button class="section-toggle" id="fencing-toggle">â–¼</button>
                      </div>
                      <div class="section-content" id="fencing-content">
                          <div class="section-details">
                              <div class="detail-row">
                                  <div class="detail-field">
                                      <div class="detail-label">Fence Type</div>
                                      <div class="detail-value">Privacy, 6' Height</div>
                                  </div>
                                  <div class="detail-field">
                                      <div class="detail-label">Material</div>
                                      <div class="detail-value">Vinyl, White</div>
                                  </div>
                                  <div class="detail-field">
                                      <div class="detail-label">Length</div>
                                      <div class="detail-value">300 Linear Feet</div>
                                  </div>
                                  <div class="detail-actions">
                                      <button class="action-icon edit" onclick="editDetail('fencing')"><i class="fas fa-edit"></i></button>
                                      <button class="action-icon delete" onclick="deleteDetail('fencing')"><i class="fas fa-trash"></i></button>
                                  </div>
                              </div>
                              <div class="detail-row">
                                  <div class="detail-field">
                                      <div class="detail-label">Gates</div>
                                      <div class="detail-value">2 Gates, Automatic</div>
                                  </div>
                                  <div class="detail-field">
                                      <div class="detail-label">Installation Date</div>
                                      <div class="detail-value">2021-09-15</div>
                                  </div>
                                  <div class="detail-field">
                                      <div class="detail-label">Warranty</div>
                                      <div class="detail-value">Lifetime</div>
                                  </div>
                                  <div class="detail-actions">
                                      <button class="action-icon edit" onclick="editDetail('fencing')"><i class="fas fa-edit"></i></button>
                                      <button class="action-icon delete" onclick="deleteDetail('fencing')"><i class="fas fa-trash"></i></button>
                                  </div>
                              </div>
                              <button class="add-detail-btn" onclick="addDetail('fencing')">
                                  <i class="fas fa-plus"></i> Add Fencing Detail
                              </button>
                          </div>
                      </div>
                  </div>

                  <!-- Room Management Section -->
                  <div class="section-item">
                      <div class="section-header" onclick="toggleSection('rooms')">
                          <h3><i class="fas fa-door-closed"></i> Room-by-Room Details</h3>
                          <button class="section-toggle" id="rooms-toggle">â–¼</button>
                      </div>
                      <div class="section-content" id="rooms-content">
                          <div class="section-details">
                              <!-- Room Selection and Management -->
                              <div class="room-management">
                                  <div class="room-controls">
                                      <div class="room-selector">
                                          <label for="roomSelect">Select Room:</label>
                                          <select id="roomSelect" onchange="showRoomDetails()">
                                              <option value="">Choose a room...</option>
                                          </select>
                                      </div>
                                      <button class="btn btn-primary" onclick="openAddRoomModal()">
                                          <i class="fas fa-plus"></i> Add New Room
                                      </button>
                                  </div>
                                  
                                  <!-- Room Details Display -->
                                  <div id="roomDetailsContainer" style="display: none;">
                                      <div class="room-header">
                                          <h4 id="currentRoomName">Room Name</h4>
                                          <div class="room-actions">
                                              <button class="btn btn-secondary" onclick="editRoomInfo()">
                                                  <i class="fas fa-edit"></i> Edit Room Info
                                              </button>
                                              <button class="btn btn-danger" onclick="deleteRoom()">
                                                  <i class="fas fa-trash"></i> Delete Room
                                              </button>
                                          </div>
                                      </div>
                                      
                                      <div id="roomDetailsList">
                                          <!-- Room details will be populated here -->
                                      </div>
                                      
                                      <button class="add-detail-btn" onclick="addRoomDetail()">
                                          <i class="fas fa-plus"></i> Add Room Detail
                                      </button>
                                  </div>
                              </div>
                          </div>
                      </div>
                  </div>
             </div>
        </div>
    </div>

    <!-- Add Home Modal -->
    <div id="addHomeModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Add New Home</h3>
                <button class="close-btn" onclick="closeModal('addHomeModal')">&times;</button>
            </div>
            <form id="addHomeForm">
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Home Name</label>
                        <input type="text" class="form-input" id="homeName" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Address</label>
                        <input type="text" class="form-input" id="homeAddress" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Year Built</label>
                        <input type="number" class="form-input" id="yearBuilt" min="1800" max="2030">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Square Feet</label>
                        <input type="number" class="form-input" id="squareFeet" min="100">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Bedrooms</label>
                        <input type="number" class="form-input" id="bedrooms" min="0" max="20">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Bathrooms</label>
                        <input type="number" class="form-input" id="bathrooms" min="0" max="20" step="0.5">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Purchase Price</label>
                        <input type="number" class="form-input" id="purchasePrice" min="0">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Property Type</label>
                        <select class="form-input" id="propertyType">
                            <option value="single-family">Single Family</option>
                            <option value="townhouse">Townhouse</option>
                            <option value="condo">Condo</option>
                            <option value="apartment">Apartment</option>
                            <option value="multi-family">Multi-Family</option>
                        </select>
                    </div>
                </div>
                <div class="btn-group">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('addHomeModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Home</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Task Modal -->
    <div id="addTaskModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Add Maintenance Task</h3>
                <button class="close-btn" onclick="closeModal('addTaskModal')">&times;</button>
            </div>
            <form id="addTaskForm">
                <div class="form-group">
                    <label class="form-label">Task Title</label>
                    <input type="text" class="form-input" id="taskTitle" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Description</label>
                    <textarea class="form-input" id="taskDescription" rows="3"></textarea>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Due Date</label>
                        <input type="date" class="form-input" id="taskDueDate" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Priority</label>
                        <select class="form-input" id="taskPriority">
                            <option value="low">Low</option>
                            <option value="medium">Medium</option>
                            <option value="high">High</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Category</label>
                    <select class="form-input" id="taskCategory">
                        <option value="air-filter">Air Filter Replacement</option>
                        <option value="hvac">HVAC Maintenance</option>
                        <option value="plumbing">Plumbing</option>
                        <option value="electrical">Electrical</option>
                        <option value="roofing">Roofing</option>
                        <option value="landscaping">Landscaping</option>
                        <option value="cleaning">Cleaning</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                <div class="task-form-info">
                    <div class="auto-save-indicator">
                        <i class="fas fa-calendar-check"></i>
                        <span>This task will be automatically added to your maintenance calendar</span>
                    </div>
                    <div class="calendar-sync-status" id="calendarSyncStatus" style="display: none;">
                        <div class="sync-error">
                            <i class="fas fa-exclamation-triangle"></i>
                            <span id="syncErrorMessage">Calendar sync failed</span>
                            <button type="button" class="btn btn-sm btn-primary" onclick="retryCalendarSync()">
                                <i class="fas fa-sync"></i> Retry
                            </button>
                        </div>
                    </div>
                </div>
                <div class="btn-group">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('addTaskModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Task</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Home Modal -->
    <div id="editHomeModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Edit Home Details</h3>
                <button class="close-btn" onclick="closeModal('editHomeModal')">&times;</button>
            </div>
            <form id="editHomeForm">
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Home Name</label>
                        <input type="text" class="form-input" id="editHomeName" name="editHomeName" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Address</label>
                        <input type="text" class="form-input" id="editHomeAddress" name="editHomeAddress" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Year Built</label>
                        <input type="number" class="form-input" id="editYearBuilt" name="editYearBuilt" min="1800" max="2030">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Square Feet</label>
                        <input type="number" class="form-input" id="editSquareFeet" name="editSquareFeet" min="100">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Bedrooms</label>
                        <input type="number" class="form-input" id="editBedrooms" name="editBedrooms" min="0" max="20">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Bathrooms</label>
                        <input type="number" class="form-input" id="editBathrooms" name="editBathrooms" min="0" max="20" step="0.5">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Purchase Price</label>
                        <input type="number" class="form-input" id="editPurchasePrice" name="editPurchasePrice" min="0">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Property Type</label>
                        <select class="form-input" id="editPropertyType" name="editPropertyType">
                            <option value="single-family">Single Family</option>
                            <option value="townhouse">Townhouse</option>
                            <option value="condo">Condo</option>
                            <option value="apartment">Apartment</option>
                            <option value="multi-family">Multi-Family</option>
                        </select>
                    </div>
                </div>
                <div class="btn-group">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('editHomeModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Profile Modal -->
    <div id="profileModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">User Profile</h3>
                <button class="close-btn" onclick="closeModal('profileModal')">&times;</button>
            </div>
            <form id="profileForm">
                <div class="profile-avatar-section">
                    <div class="profile-avatar">
                        <img id="profileAvatar" src="https://ui-avatars.com/api/?name=User&size=120&background=2563eb&color=fff" alt="Profile Avatar">
                        <div class="avatar-overlay">
                            <label for="avatarInput" class="avatar-upload-btn">
                                <i class="fas fa-camera"></i>
                            </label>
                            <input type="file" id="avatarInput" accept="image/*" style="display: none;">
                        </div>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Full Name</label>
                        <input type="text" class="form-input" id="profileName" name="profileName" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-input" id="profileEmail" name="profileEmail" required readonly>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Phone Number</label>
                        <input type="tel" class="form-input" id="profilePhone" name="profilePhone">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Address</label>
                        <input type="text" class="form-input" id="profileAddress" name="profileAddress">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Bio</label>
                    <textarea class="form-input" id="profileBio" name="profileBio" rows="3" placeholder="Tell us about yourself..."></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Notification Preferences</label>
                    <div class="checkbox-group">
                        <label class="checkbox-item">
                            <input type="checkbox" id="emailNotifications" name="emailNotifications" checked>
                            <span>Email Notifications</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="taskReminders" name="taskReminders" checked>
                            <span>Task Reminders</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="maintenanceAlerts" name="maintenanceAlerts" checked>
                            <span>Maintenance Alerts</span>
                        </label>
                    </div>
                </div>
                <div class="btn-group">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('profileModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Profile</button>
                </div>
                <div class="profile-actions">
                                    <button type="button" class="btn btn-danger" onclick="openDeleteProfileModal()">
                    <i class="fas fa-trash"></i>
                    Delete Profile
                </button>
                    <button type="button" class="btn btn-warning" onclick="checkUserStatus()" style="margin-top: 10px;">
                        <i class="fas fa-bug"></i>
                        Debug: Check User Status
                    </button>
                    <button type="button" class="btn btn-info" onclick="debugAccountType()" style="margin-top: 10px;">
                        <i class="fas fa-search"></i>
                        Debug: Account Type Detection
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Delete Profile Confirmation Modal -->
    <div id="deleteProfileModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Delete Profile</h3>
                <button class="close-btn" onclick="closeModal('deleteProfileModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="delete-warning">
                    <i class="fas fa-exclamation-triangle"></i>
                    <h4>Warning: This action cannot be undone</h4>
                    <p>Deleting your profile will permanently remove all your data including:</p>
                    <ul>
                        <li>Profile information</li>
                        <li>Home details and settings</li>
                        <li>Tasks and reminders</li>
                        <li>Maintenance records</li>
                        <li>All uploaded files and documents</li>
                    </ul>
                    <p><strong>This action is irreversible!</strong></p>
                </div>
                <form id="deleteProfileForm">
                    <div class="form-group">
                        <label for="deletePassword">Enter your password to confirm</label>
                        <input type="password" id="deletePassword" class="form-input" required placeholder="Enter your password">
                    </div>
                    <div class="btn-group">
                        <button type="button" class="btn btn-secondary" onclick="closeModal('deleteProfileModal')">Cancel</button>
                        <button type="submit" class="btn btn-danger">
                            <i class="fas fa-trash"></i>
                            Delete Profile Permanently
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Add Reminder Modal -->
    <div id="addReminderModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Add Maintenance Reminder</h3>
                <button class="close-btn" onclick="closeModal('addReminderModal')">&times;</button>
            </div>
            <form id="addReminderForm" onsubmit="addReminder(event)">
                <div class="modal-body">
                    <div class="form-group">
                        <label for="reminderTitle">Reminder Title</label>
                        <input type="text" id="reminderTitle" name="reminderTitle" required>
                    </div>
                    <div class="form-group">
                        <label for="reminderDescription">Description</label>
                        <textarea id="reminderDescription" name="reminderDescription" rows="3"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="reminderDate">Date</label>
                        <input type="date" id="reminderDate" name="reminderDate" required>
                    </div>
                    <div class="form-group">
                        <label for="reminderTime">Time</label>
                        <input type="time" id="reminderTime" name="reminderTime" value="09:00">
                    </div>
                    <div class="form-group">
                        <label for="reminderCategory">Category</label>
                        <select id="reminderCategory" name="reminderCategory" required>
                            <option value="">Select category...</option>
                            <option value="HVAC">HVAC Maintenance</option>
                            <option value="Plumbing">Plumbing</option>
                            <option value="Electrical">Electrical</option>
                            <option value="Roof">Roof & Attic</option>
                            <option value="Exterior">Exterior & Siding</option>
                            <option value="Interior">Interior & Finishes</option>
                            <option value="Foundation">Foundation</option>
                            <option value="Garage">Garage & Parking</option>
                            <option value="Windows">Windows & Glazing</option>
                            <option value="Doors">Doors & Entryways</option>
                            <option value="Outdoor">Decks & Patios</option>
                            <option value="Landscaping">Landscaping</option>
                            <option value="Irrigation">Irrigation</option>
                            <option value="Fencing">Fencing & Boundaries</option>
                            <option value="General">General Maintenance</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="reminderPriority">Priority</label>
                        <select id="reminderPriority" name="reminderPriority" required>
                            <option value="low">Low</option>
                            <option value="medium" selected>Medium</option>
                            <option value="high">High</option>
                            <option value="urgent">Urgent</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="reminderRepeat">Repeat</label>
                        <select id="reminderRepeat" name="reminderRepeat">
                            <option value="none">No Repeat</option>
                            <option value="weekly">Weekly</option>
                            <option value="monthly">Monthly</option>
                            <option value="quarterly">Quarterly</option>
                            <option value="yearly">Yearly</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="reminderNotification" name="reminderNotification" checked>
                            Send notification reminder
                        </label>
                    </div>
                </div>
                <div class="modal-footer">
                    <div class="btn-group">
                        <button type="button" class="btn btn-secondary" onclick="closeModal('addReminderModal')">Cancel</button>
                        <button type="submit" class="btn btn-primary">Add Reminder</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Calendar Settings Modal -->
    <div id="calendarSettingsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Calendar Settings</h3>
                <button class="close-btn" onclick="closeModal('calendarSettingsModal')">&times;</button>
            </div>
            <form id="calendarSettingsForm" onsubmit="saveCalendarSettings(event)">
                <div class="modal-body">
                    <div class="form-group">
                        <label for="defaultReminderTime">Default Reminder Time</label>
                        <input type="time" id="defaultReminderTime" name="defaultReminderTime" value="09:00">
                    </div>
                    <div class="form-group">
                        <label for="reminderAdvanceDays">Remind Days in Advance</label>
                        <select id="reminderAdvanceDays" name="reminderAdvanceDays">
                            <option value="0">Same day</option>
                            <option value="1" selected>1 day before</option>
                            <option value="3">3 days before</option>
                            <option value="7">1 week before</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="showCompletedTasks" name="showCompletedTasks" checked>
                            Show completed tasks on calendar
                        </label>
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="autoCreateFromTasks" name="autoCreateFromTasks" checked>
                            Automatically create reminders from maintenance tasks
                        </label>
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="confirmDeleteReminders" name="confirmDeleteReminders" checked>
                            Always confirm before deleting reminders
                        </label>
                    </div>
                    <div class="form-group">
                        <button type="button" class="btn btn-primary" onclick="syncTasksWithReminders()">
                            <i class="fas fa-sync"></i>
                            Sync Tasks with Calendar
                        </button>
                    </div>
                    <div class="form-group">
                        <button type="button" class="btn btn-danger" onclick="openBulkDeleteModal()">
                            <i class="fas fa-trash"></i>
                            Bulk Delete Reminders
                        </button>
                    </div>
                </div>
                <div class="modal-footer">
                    <div class="btn-group">
                        <button type="button" class="btn btn-secondary" onclick="closeModal('calendarSettingsModal')">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save Settings</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Day Details Modal -->
    <div id="dayDetailsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Day Details</h3>
                <button class="close-btn" onclick="closeModal('dayDetailsModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div id="dayDetailsContent">
                    <!-- Day details will be populated by JavaScript -->
                </div>
            </div>
            <div class="modal-footer">
                <div class="btn-group" id="dayDetailsFooter">
                    <!-- Footer buttons will be populated by JavaScript -->
                </div>
            </div>
        </div>
    </div>

    <!-- Bulk Delete Modal -->
    <div id="bulkDeleteModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Bulk Delete Reminders</h3>
                <button class="close-btn" onclick="closeModal('bulkDeleteModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Delete Options</label>
                    <div class="checkbox-group">
                        <label class="checkbox-item">
                            <input type="checkbox" id="deleteCompleted" name="deleteCompleted">
                            <span>Delete all completed reminders</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="deleteOverdue" name="deleteOverdue">
                            <span>Delete all overdue reminders</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="deleteByCategory" name="deleteByCategory">
                            <span>Delete by category</span>
                        </label>
                    </div>
                </div>
                
                <div id="categoryDeleteSection" style="display: none;">
                    <div class="form-group">
                        <label class="form-label">Select Category</label>
                        <select id="deleteCategory" class="form-input">
                            <option value="">Select category...</option>
                            <option value="HVAC">HVAC Maintenance</option>
                            <option value="Plumbing">Plumbing</option>
                            <option value="Electrical">Electrical</option>
                            <option value="Roof">Roof & Attic</option>
                            <option value="Exterior">Exterior & Siding</option>
                            <option value="Interior">Interior & Finishes</option>
                            <option value="Foundation">Foundation</option>
                            <option value="Garage">Garage & Parking</option>
                            <option value="Windows">Windows & Glazing</option>
                            <option value="Doors">Doors & Entryways</option>
                            <option value="Outdoor">Decks & Patios</option>
                            <option value="Landscaping">Landscaping</option>
                            <option value="Irrigation">Irrigation</option>
                            <option value="Fencing">Fencing & Boundaries</option>
                            <option value="General">General Maintenance</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Date Range (Optional)</label>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">From</label>
                            <input type="date" id="deleteFromDate" class="form-input">
                        </div>
                        <div class="form-group">
                            <label class="form-label">To</label>
                            <input type="date" id="deleteToDate" class="form-input">
                        </div>
                    </div>
                </div>
                
                <div id="bulkDeletePreview" class="form-group" style="display: none;">
                    <label class="form-label">Preview</label>
                    <div class="bulk-delete-preview">
                        <div id="bulkDeleteCount">0 reminders will be deleted</div>
                        <div id="bulkDeleteDates"></div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <div class="btn-group">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('bulkDeleteModal')">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="previewBulkDelete()">Preview</button>
                    <button type="button" class="btn btn-danger" onclick="executeBulkDelete()" id="executeBulkDeleteBtn" disabled>
                        <i class="fas fa-trash"></i>
                        Delete Reminders
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global data structures
        let homes = {};
        let tasks = {};
        let homeDetails = {}; // Store home details sections data
        let reminders = {}; // Store calendar reminders
        let calendarSettings = {
            defaultReminderTime: '09:00',
            reminderAdvanceDays: 1,
            showCompletedTasks: true,
            autoCreateFromTasks: true
        };

        // Ensure calendar settings are properly initialized
        function ensureCalendarSettings() {
            if (!calendarSettings) {
                calendarSettings = {
                    defaultReminderTime: '09:00',
                    reminderAdvanceDays: 1,
                    showCompletedTasks: true,
                    autoCreateFromTasks: true
                };
            }
            
            // Ensure all required properties exist
            calendarSettings.defaultReminderTime = calendarSettings.defaultReminderTime || '09:00';
            calendarSettings.reminderAdvanceDays = calendarSettings.reminderAdvanceDays || 1;
            calendarSettings.showCompletedTasks = calendarSettings.showCompletedTasks !== false;
            calendarSettings.autoCreateFromTasks = calendarSettings.autoCreateFromTasks !== false;
            
            console.log('Calendar settings ensured:', calendarSettings);
        }
        let currentDate = new Date();
        let selectedDate = new Date();

        // Load homes from AWS
        async function loadHomesFromAWS() {
            if (!currentUserId || !dynamodb) {
                console.log('User not authenticated or AWS not ready');
                return;
            }

            try {
                console.log('Loading homes from Firebase for user:', currentUserId);
                
                const homesQuery = window.firebaseServices.query(
                    window.firebaseServices.collection(window.firebaseDB, 'homes'),
                    window.firebaseServices.where('userId', '==', currentUserId)
                );
                
                const querySnapshot = await window.firebaseServices.getDocs(homesQuery);
                
                // Clear existing homes
                homes = {};
                
                querySnapshot.forEach((doc) => {
                    const homeData = doc.data();
                    homes[doc.id] = { id: doc.id, ...homeData };
                });
                
                console.log('Loaded homes:', homes);
                
                // Update home selector dropdown
                updateHomeSelector();
                
            } catch (error) {
                console.error('Error loading homes from Firebase:', error);
            }
        }

        // Load tasks from Firebase
        async function loadTasksFromAWS() {
            if (!currentUserId || !dynamodb) {
                console.log('User not authenticated or AWS not ready');
                return;
            }

            try {
                console.log('Loading tasks from AWS');
                
                const tasksQuery = window.firebaseServices.query(
                    window.firebaseServices.collection(window.firebaseDB, 'tasks'),
                    window.firebaseServices.where('userId', '==', currentUserId)
                );
                
                const querySnapshot = await window.firebaseServices.getDocs(tasksQuery);
                
                // Clear existing tasks
                tasks = {};
                
                querySnapshot.forEach((doc) => {
                    const taskData = doc.data();
                    tasks[doc.id] = { id: doc.id, ...taskData };
                });
                
                console.log('Loaded tasks:', tasks);
                
                // Update task list display
                updateTaskList();
                
            } catch (error) {
                console.error('Error loading tasks from Firebase:', error);
            }
        }

        // Load home details sections from Firebase
        async function loadHomeDetailsFromFirebase() {
            if (!currentUserId || !dynamodb) {
                console.log('User not authenticated or AWS not ready');
                return;
            }

            try {
                console.log('Loading home details from Firebase for user:', currentUserId);
                
                const homeDetailsQuery = window.firebaseServices.query(
                    window.firebaseServices.collection(window.firebaseDB, 'homeDetails'),
                    window.firebaseServices.where('userId', '==', currentUserId)
                );
                
                const querySnapshot = await window.firebaseServices.getDocs(homeDetailsQuery);
                
                // Clear existing home details
                homeDetails = {};
                
                querySnapshot.forEach((doc) => {
                    const detailsData = doc.data();
                    homeDetails[doc.id] = { id: doc.id, ...detailsData };
                });
                
                console.log('Loaded home details:', homeDetails);
                
                // Update home details sections display
                updateHomeDetailsSections();
                
            } catch (error) {
                console.error('Error loading home details from Firebase:', error);
            }
        }

        // Update home selector dropdown
        function updateHomeSelector() {
            const homeSelect = document.getElementById('homeSelect');
            
            // Clear existing options except the first one
            while (homeSelect.children.length > 1) {
                homeSelect.removeChild(homeSelect.lastChild);
            }
            
            // Add homes to dropdown
            Object.values(homes).forEach(home => {
                const option = document.createElement('option');
                option.value = home.id;
                option.textContent = home.name || 'Unnamed Home';
                homeSelect.appendChild(option);
            });
        }

        // Update task list display
        function updateTaskList() {
            const taskList = document.getElementById('taskList');
            
            if (!taskList) {
                console.error('Task list element not found');
                return;
            }
            
            // Clear existing tasks
            taskList.innerHTML = '';
            
            // Sort tasks by due date (earliest first)
            const sortedTasks = Object.values(tasks).sort((a, b) => {
                const dateA = new Date(a.dueDate);
                const dateB = new Date(b.dueDate);
                return dateA - dateB;
            });
            
            if (sortedTasks.length === 0) {
                taskList.innerHTML = `
                    <div class="task-item empty-state">
                        <div class="task-content">
                            <div class="task-title">No tasks yet</div>
                            <div class="task-due">Click "Add Task" to create your first maintenance task</div>
                        </div>
                    </div>
                `;
                return;
            }
            
            // Add tasks to list
            sortedTasks.forEach(task => {
                const taskElement = createTaskElement(task);
                taskList.appendChild(taskElement);
            });
            
            // Update sync status display
            updateTaskSyncStatus();
        }

        // Update task sync status display
        function updateTaskSyncStatus() {
            // Ensure objects exist
            if (!tasks) {
                tasks = {};
            }
            if (!reminders) {
                reminders = {};
            }
            
            const totalTasks = Object.values(tasks).filter(task => task.dueDate && !task.completed).length;
            const syncedTasks = Object.values(tasks).filter(task => {
                if (!task.dueDate || task.completed) return false;
                const dateString = task.dueDate;
                const dayReminders = reminders[dateString] || [];
                return dayReminders.some(r => r.taskId === task.id);
            }).length;
            
            // Add sync status to task manager header if it doesn't exist
            let syncStatusElement = document.getElementById('taskSyncStatus');
            if (!syncStatusElement) {
                const taskManagerCard = document.querySelector('.card:has(#taskList)');
                if (taskManagerCard) {
                    const cardHeader = taskManagerCard.querySelector('.card-header');
                    if (cardHeader) {
                        syncStatusElement = document.createElement('div');
                        syncStatusElement.id = 'taskSyncStatus';
                        syncStatusElement.className = 'task-sync-status';
                        cardHeader.appendChild(syncStatusElement);
                    }
                }
            }
            
            if (syncStatusElement) {
                if (totalTasks > 0) {
                    const syncPercentage = Math.round((syncedTasks / totalTasks) * 100);
                    syncStatusElement.innerHTML = `
                        <div class="sync-indicator ${syncPercentage === 100 ? 'synced' : 'partial'}">
                            <i class="fas fa-${syncPercentage === 100 ? 'check-circle' : 'exclamation-circle'}"></i>
                            <span>${syncedTasks}/${totalTasks} tasks synced with calendar (${syncPercentage}%)</span>
                        </div>
                    `;
                } else {
                    syncStatusElement.innerHTML = '';
                }
            }
        }

        // Update home details sections display
        function updateHomeDetailsSections() {
            // Get all section IDs (excluding 'rooms' as requested)
            const sectionIds = ['roof', 'exterior', 'hvac', 'plumbing', 'electrical', 'interior', 'foundation', 'garage', 'windows', 'doors', 'outdoor', 'landscaping', 'irrigation', 'fencing'];
            
            sectionIds.forEach(sectionId => {
                const sectionData = Object.values(homeDetails).find(detail => detail.sectionId === sectionId);
                if (sectionData && sectionData.details) {
                    populateSectionWithData(sectionId, sectionData.details);
                }
            });
        }

        // Populate section with saved data
        function populateSectionWithData(sectionId, details) {
            const sectionDetails = document.querySelector(`#${sectionId}-content .section-details`);
            if (!sectionDetails) return;
            
            // Clear existing details (except add button)
            const addButton = sectionDetails.querySelector('.add-detail-btn');
            sectionDetails.innerHTML = '';
            if (addButton) sectionDetails.appendChild(addButton);
            
            // Add saved details
            if (details && Array.isArray(details)) {
                details.forEach(detail => {
                    const detailRow = createDetailRow(sectionId, detail);
                    sectionDetails.insertBefore(detailRow, addButton);
                });
            }
        }

        // Create detail row from data
        function createDetailRow(sectionId, detail) {
            const detailRow = document.createElement('div');
            detailRow.className = 'detail-row';
            detailRow.innerHTML = `
                <div class="detail-field">
                    <div class="detail-label">${detail.label1 || 'Detail'}</div>
                    <div class="detail-value">${detail.value1 || 'Not specified'}</div>
                </div>
                <div class="detail-field">
                    <div class="detail-label">${detail.label2 || 'Specification'}</div>
                    <div class="detail-value">${detail.value2 || 'Not specified'}</div>
                </div>
                <div class="detail-field">
                    <div class="detail-label">Date/Info</div>
                    <div class="detail-value">${detail.date || 'Not specified'}</div>
                </div>
                <div class="detail-actions">
                    <button class="action-icon edit" onclick="editDetail('${sectionId}')"><i class="fas fa-edit"></i></button>
                    <button class="action-icon delete" onclick="deleteDetail('${sectionId}')"><i class="fas fa-trash"></i></button>
                </div>
            `;
            return detailRow;
        }

        // Create task element
        function createTaskElement(task) {
            const taskDiv = document.createElement('div');
            taskDiv.className = 'task-item';
            taskDiv.setAttribute('data-task-id', task.id);
            
            const dueDate = new Date(task.dueDate);
            const isOverdue = dueDate < new Date() && !task.completed;
            const isCompleted = task.completed;
            
            // Ensure reminders object exists
            if (!reminders) {
                reminders = {};
            }
            
            // Check if task has a corresponding calendar reminder
            const hasCalendarReminder = Object.values(reminders).some(dayReminders => 
                dayReminders.some(reminder => reminder.taskId === task.id)
            );
            
            taskDiv.innerHTML = `
                <input type="checkbox" class="task-checkbox" onchange="toggleTask('${task.id}', this)" ${isCompleted ? 'checked' : ''}>
                <div class="task-content">
                    <div class="task-title ${isCompleted ? 'completed' : ''}">
                        ${task.title}
                        ${hasCalendarReminder ? '<i class="fas fa-calendar-check task-calendar-indicator" title="Added to calendar"></i>' : ''}
                    </div>
                    <div class="task-due ${isOverdue ? 'overdue' : ''}">Due: ${dueDate.toLocaleDateString()}</div>
                    ${task.description ? `<div class="task-description">${task.description}</div>` : ''}
                </div>
                <span class="task-priority priority-${task.priority}">${task.priority}</span>
                <button class="btn btn-secondary" onclick="deleteTask('${task.id}')" style="padding: 4px 8px;">
                    <i class="fas fa-trash"></i>
                </button>
            `;
            
            if (isCompleted) {
                taskDiv.style.opacity = '0.6';
            }
            
            return taskDiv;
        }

        // Load home data when a home is selected
        async function loadHomeData() {
            const homeSelect = document.getElementById('homeSelect');
            const selectedHomeId = homeSelect.value;
            const deleteHomeBtn = document.getElementById('deleteHomeBtn');
            
            if (!selectedHomeId || selectedHomeId === '') {
                console.log('No home selected');
                clearHomeDetails();
                deleteHomeBtn.style.display = 'none';
                return;
            }
            
            const selectedHome = homes[selectedHomeId];
            
            if (!selectedHome) {
                console.log('Selected home not found in local data');
                deleteHomeBtn.style.display = 'none';
                return;
            }
            
            console.log('Loading home details:', selectedHome);
            displayHomeDetails(selectedHome);
            deleteHomeBtn.style.display = 'inline-flex';
        }

        // Delete current home
        async function deleteCurrentHome() {
            const homeSelect = document.getElementById('homeSelect');
            const selectedHomeId = homeSelect.value;
            
            if (!selectedHomeId || selectedHomeId === '') {
                alert('No home selected to delete.');
                return;
            }
            
            const selectedHome = homes[selectedHomeId];
            
            if (!selectedHome) {
                alert('Selected home not found. Please refresh and try again.');
                return;
            }
            
            // Confirm deletion
            const confirmMessage = `Are you sure you want to delete "${selectedHome.name}"?\n\nThis action cannot be undone and will permanently remove all data associated with this home.`;
            const confirmed = confirm(confirmMessage);
            
            if (!confirmed) {
                return;
            }
            
            console.log('Deleting home:', selectedHome.name);
            
            // Delete from Firebase
            const success = await deleteHomeFromFirebase(selectedHomeId);
            
            if (success) {
                alert(`"${selectedHome.name}" has been deleted successfully.`);
                
                // Update home selector dropdown
                updateHomeSelector();
                
                // Clear home details
                clearHomeDetails();
                
                // Hide delete button
                document.getElementById('deleteHomeBtn').style.display = 'none';
                
                // Reset home selector to first option
                homeSelect.value = '';
                
                // If no homes left, show message and ensure hasInitializedHomes flag remains true
                if (Object.keys(homes).length === 0) {
                    const homeDetailsContent = document.getElementById('homeDetailsContent');
                    homeDetailsContent.innerHTML = `
                        <div class="details-grid">
                            <div class="detail-item">
                                <div class="detail-label">No Homes</div>
                                <div class="detail-value">You haven't added any homes yet. Click "Add Home" to get started!</div>
                            </div>
                        </div>
                    `;
                    
                    // Ensure hasInitializedHomes flag remains true to prevent sample homes from being recreated
                    try {
                        const userProfileRef = window.firebaseServices.doc(window.firebaseDB, 'userProfiles', currentUserId);
                        await window.firebaseServices.setDoc(userProfileRef, {
                            hasInitializedHomes: true,
                            lastUpdated: new Date().toISOString()
                        }, { merge: true });
                        console.log('Updated hasInitializedHomes flag to prevent sample home recreation');
                    } catch (error) {
                        console.error('Error updating hasInitializedHomes flag:', error);
                    }
                }
            } else {
                alert('Error deleting home. Please try again.');
            }
        }

        // Display home details in the home details section
        function displayHomeDetails(home) {
            const homeDetailsContent = document.getElementById('homeDetailsContent');
            
            homeDetailsContent.innerHTML = `
                <div class="details-grid">
                    <div class="detail-item">
                        <div class="detail-label">Home Name</div>
                        <div class="detail-value">${home.name || 'Not specified'}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Address</div>
                        <div class="detail-value">${home.address || 'Not specified'}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Year Built</div>
                        <div class="detail-value">${home.yearBuilt || 'Not specified'}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Square Feet</div>
                        <div class="detail-value">${home.squareFeet ? home.squareFeet.toLocaleString() : 'Not specified'}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Bedrooms</div>
                        <div class="detail-value">${home.bedrooms || 'Not specified'}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Bathrooms</div>
                        <div class="detail-value">${home.bathrooms || 'Not specified'}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Purchase Price</div>
                        <div class="detail-value">${home.purchasePrice ? '$' + home.purchasePrice.toLocaleString() : 'Not specified'}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Property Type</div>
                        <div class="detail-value">${home.propertyType || 'Not specified'}</div>
                    </div>
                </div>
            `;
        }

        // Clear home details when no home is selected
        function clearHomeDetails() {
            const homeDetailsContent = document.getElementById('homeDetailsContent');
            const deleteHomeBtn = document.getElementById('deleteHomeBtn');
            
            homeDetailsContent.innerHTML = `
                <div class="details-grid">
                    <div class="detail-item">
                        <div class="detail-label">Home Name</div>
                        <div class="detail-value">Select a home to view details</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Address</div>
                        <div class="detail-value">-</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Year Built</div>
                        <div class="detail-value">-</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Square Feet</div>
                        <div class="detail-value">-</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Bedrooms</div>
                        <div class="detail-value">-</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Bathrooms</div>
                        <div class="detail-value">-</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Purchase Price</div>
                        <div class="detail-value">-</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Property Type</div>
                        <div class="detail-value">-</div>
                    </div>
                </div>
            `;
            
            // Hide delete button
            deleteHomeBtn.style.display = 'none';
        }

        function openAddHomeModal() {
            document.getElementById('addHomeModal').classList.add('show');
            // Reinitialize autocomplete for the address field in the modal
            setTimeout(() => {
                initializeGoogleMapsAutocomplete();
            }, 100);
        }

        // Save home to Firebase
        async function saveHomeToFirebase(homeData) {
            if (!currentUserId || !dynamodb) {
                console.error('User not authenticated or Firebase not ready');
                return null;
            }

            try {
                const homeWithUserId = {
                    ...homeData,
                    userId: currentUserId,
                    createdAt: new Date(),
                    updatedAt: new Date()
                };
                
                console.log('Saving home to Firebase:', homeWithUserId);
                
                const docRef = await window.firebaseServices.addDoc(
                    window.firebaseServices.collection(window.firebaseDB, 'homes'),
                    homeWithUserId
                );
                
                console.log('Home saved to Firebase with ID:', docRef.id);
                
                // Add to local homes object
                homes[docRef.id] = { id: docRef.id, ...homeWithUserId };
                
                // Update home selector dropdown
                updateHomeSelector();
                
                // Mark that user has initialized homes (so sample homes won't be created again)
                try {
                    const userProfileRef = window.firebaseServices.doc(window.firebaseDB, 'userProfiles', currentUserId);
                    await window.firebaseServices.setDoc(userProfileRef, {
                        hasInitializedHomes: true,
                        lastUpdated: new Date().toISOString()
                    }, { merge: true });
                    console.log('Marked user as having initialized homes');
                } catch (error) {
                    console.error('Error updating user profile flag:', error);
                }
                
                return docRef.id;
            } catch (error) {
                console.error('Error saving home to Firebase:', error);
                return null;
            }
        }

        // Save task to Firebase
        async function saveTaskToFirebase(taskData) {
            if (!currentUserId || !dynamodb) {
                console.error('User not authenticated or Firebase not ready');
                return null;
            }

            try {
                const taskWithUserId = {
                    ...taskData,
                    userId: currentUserId,
                    completed: false,
                    createdAt: new Date(),
                    updatedAt: new Date()
                };
                
                console.log('Saving task to Firebase:', taskWithUserId);
                
                const docRef = await window.firebaseServices.addDoc(
                    window.firebaseServices.collection(window.firebaseDB, 'tasks'),
                    taskWithUserId
                );
                
                console.log('Task saved to Firebase with ID:', docRef.id);
                
                // Add to local tasks object
                tasks[docRef.id] = { id: docRef.id, ...taskWithUserId };
                
                // Update task list display
                updateTaskList();
                
                // Set flag to prevent duplicate sync and store the task ID
                window.justCreatedTask = true;
                window.lastCreatedTaskId = docRef.id;
                
                // Automatically create calendar reminder for this task
                if (calendarSettings.autoCreateFromTasks) {
                    console.log('Auto-create is enabled, creating calendar reminder...');
                    try {
                        await createReminderFromTask(taskWithUserId);
                        console.log('Calendar reminder created successfully');
                    } catch (calendarError) {
                        console.error('Error creating calendar reminder:', calendarError);
                        // Don't fail the entire task creation if calendar fails
                        showNotification(`Task created successfully, but failed to add to calendar: ${calendarError.message}`);
                        showCalendarSyncError(`Failed to add to calendar: ${calendarError.message}`);
                    }
                } else {
                    console.log('Auto-create is disabled, skipping calendar reminder');
                }
                
                return docRef.id;
            } catch (error) {
                console.error('Error saving task to Firebase:', error);
                return null;
            }
        }

        // Save home details section to Firebase
        async function saveHomeDetailsSection(sectionId, sectionData) {
            console.log('ðŸ” saveHomeDetailsSection called with:', sectionId, sectionData);
            console.log('ðŸ” currentUserId:', currentUserId);
            console.log('ðŸ” firebaseDB:', window.firebaseDB);
            console.log('ðŸ” firebaseServices:', window.firebaseServices);
            
            if (!currentUserId || !dynamodb) {
                console.error('âŒ User not authenticated or Firebase not ready');
                console.error('âŒ currentUserId:', currentUserId);
                console.error('âŒ firebaseDB:', window.firebaseDB);
                console.error('âŒ firebaseServices:', window.firebaseServices);
                return false;
            }

            try {
                const detailsWithMetadata = {
                    sectionId: sectionId,
                    userId: currentUserId,
                    details: sectionData,
                    updatedAt: new Date()
                };
                
                console.log('Saving home details section to Firebase:', sectionId, detailsWithMetadata);
                
                // Check if section already exists
                const existingSection = Object.values(homeDetails).find(detail => detail.sectionId === sectionId);
                
                if (existingSection) {
                    // Update existing section
                    const sectionRef = window.firebaseServices.doc(window.firebaseDB, 'homeDetails', existingSection.id);
                    await window.firebaseServices.updateDoc(sectionRef, {
                        details: sectionData,
                        updatedAt: new Date()
                    });
                    
                    // Update local data
                    homeDetails[existingSection.id].details = sectionData;
                    homeDetails[existingSection.id].updatedAt = new Date();
                } else {
                    // Create new section
                    const docRef = await window.firebaseServices.addDoc(
                        window.firebaseServices.collection(window.firebaseDB, 'homeDetails'),
                        detailsWithMetadata
                    );
                    
                    // Add to local data
                    homeDetails[docRef.id] = { id: docRef.id, ...detailsWithMetadata };
                }
                
                console.log('Home details section saved to Firebase successfully');
                return true;
            } catch (error) {
                console.error('Error saving home details section to Firebase:', error);
                return false;
            }
        }

        // Save section to Firebase (collects all details from section)
        async function saveSectionToFirebase(sectionId) {
            console.log('ðŸ” saveSectionToFirebase called with sectionId:', sectionId);
            const sectionDetails = document.querySelector(`#${sectionId}-content .section-details`);
            if (!sectionDetails) {
                console.error('âŒ Section details not found for:', sectionId);
                return;
            }
            console.log('âœ… Section details found:', sectionDetails);
            
            // Collect all detail rows (excluding add button)
            const detailRows = sectionDetails.querySelectorAll('.detail-row');
            const sectionData = [];
            
            detailRows.forEach(row => {
                const fields = row.querySelectorAll('.detail-field');
                const detail = {
                    label1: fields[0]?.querySelector('.detail-label')?.textContent || '',
                    value1: fields[0]?.querySelector('.detail-value')?.textContent || '',
                    label2: fields[1]?.querySelector('.detail-label')?.textContent || '',
                    value2: fields[1]?.querySelector('.detail-value')?.textContent || '',
                    date: fields[2]?.querySelector('.detail-value')?.textContent || ''
                };
                sectionData.push(detail);
            });
            
            // Save to Firebase
            const success = await saveHomeDetailsSection(sectionId, sectionData);
            
            if (success) {
                console.log(`âœ… Section ${sectionId} saved successfully`);
                // Show success message to user
                showSaveSuccessMessage(sectionId);
            } else {
                console.error(`âŒ Failed to save section ${sectionId}`);
                // Show error message to user
                showSaveErrorMessage(sectionId);
            }
        }

        // Show save success message
        function showSaveSuccessMessage(sectionId) {
            const sectionElement = document.querySelector(`#${sectionId}-content`);
            if (sectionElement) {
                // Create or update success message
                let successMsg = sectionElement.querySelector('.save-success-msg');
                if (!successMsg) {
                    successMsg = document.createElement('div');
                    successMsg.className = 'save-success-msg';
                    successMsg.style.cssText = 'color: green; font-size: 12px; margin-top: 5px;';
                    sectionElement.appendChild(successMsg);
                }
                successMsg.textContent = 'âœ… Saved successfully';
                
                // Hide after 3 seconds
                setTimeout(() => {
                    if (successMsg) successMsg.textContent = '';
                }, 3000);
            }
        }

        // Show save error message
        function showSaveErrorMessage(sectionId) {
            const sectionElement = document.querySelector(`#${sectionId}-content`);
            if (sectionElement) {
                // Create or update error message
                let errorMsg = sectionElement.querySelector('.save-error-msg');
                if (!errorMsg) {
                    errorMsg = document.createElement('div');
                    errorMsg.className = 'save-error-msg';
                    errorMsg.style.cssText = 'color: red; font-size: 12px; margin-top: 5px;';
                    sectionElement.appendChild(errorMsg);
                }
                errorMsg.textContent = 'âŒ Save failed - check console';
                
                // Hide after 5 seconds
                setTimeout(() => {
                    if (errorMsg) errorMsg.textContent = '';
                }, 5000);
            }
        }

        // Save all sections function (can be called manually)
        async function saveAllSections() {
            console.log('ðŸ” saveAllSections called');
            const sections = ['general', 'builder', 'bedrooms', 'bathrooms', 'roofs', 'crawlspace', 'appliances'];
            
            for (const sectionId of sections) {
                try {
                    await saveSectionToFirebase(sectionId);
                } catch (error) {
                    console.error(`Error saving section ${sectionId}:`, error);
                }
            }
        }

        // Auto-save function (saves all sections)
        function autoSave() {
            console.log('ðŸ”„ Auto-saving all sections...');
            saveAllSections();
        }

        // Add auto-save every 30 seconds
        setInterval(autoSave, 30000);

        // Update home in Firebase
        async function updateHomeInFirebase(homeId, homeData) {
            if (!currentUserId || !dynamodb) {
                console.error('User not authenticated or Firebase not ready');
                return false;
            }

            try {
                const homeWithUserId = {
                    ...homeData,
                    userId: currentUserId,
                    updatedAt: new Date()
                };
                
                console.log('Updating home in Firebase:', homeId, homeWithUserId);
                
                const homeRef = window.firebaseServices.doc(window.firebaseDB, 'homes', homeId);
                await window.firebaseServices.updateDoc(homeRef, homeWithUserId);
                
                console.log('Updated in AWS');
                
                // Update local homes object
                homes[homeId] = { ...homes[homeId], ...homeWithUserId };
                
                return true;
            } catch (error) {
                console.error('Error updating home in Firebase:', error);
                return false;
            }
        }

        // Delete home from Firebase
        async function deleteHomeFromFirebase(homeId) {
            if (!currentUserId || !dynamodb) {
                console.error('User not authenticated or Firebase not ready');
                return false;
            }

            try {
                console.log('Deleting home from Firebase:', homeId);
                
                const homeRef = window.firebaseServices.doc(window.firebaseDB, 'homes', homeId);
                await window.firebaseServices.deleteDoc(homeRef);
                
                console.log('Home deleted from Firebase successfully');
                
                // Remove from local homes object
                delete homes[homeId];
                
                return true;
            } catch (error) {
                console.error('Error deleting home from Firebase:', error);
                return false;
            }
        }

        // Initialize sample homes if none exist (only for new users)
        async function initializeSampleHomes() {
            if (Object.keys(homes).length === 0) {
                console.log('No homes found, checking if user is new...');
                
                // Check if user has ever had homes by looking for a flag in user profile
                try {
                    const userProfileRef = window.firebaseServices.doc(window.firebaseDB, 'userProfiles', currentUserId);
                    const userProfileDoc = await window.firebaseServices.getDoc(userProfileRef);
                    
                    if (userProfileDoc.exists()) {
                        const userData = userProfileDoc.data();
                        
                        // If user has the hasInitializedHomes flag, don't create sample homes
                        if (userData.hasInitializedHomes) {
                            console.log('User has previously initialized homes, skipping sample home creation');
                            return;
                        }
                    }
                    
                    console.log('New user detected, initializing sample homes...');
                    
                    const sampleHomes = [
                        {
                            name: 'My First Home',
                            address: '123 Main St, City, State',
                            yearBuilt: 2020,
                            squareFeet: 2500,
                            bedrooms: 3,
                            bathrooms: 2.5,
                            purchasePrice: 350000,
                            propertyType: 'single-family'
                        },
                        {
                            name: 'Vacation Home',
                            address: '456 Beach Blvd, Coastal City, State',
                            yearBuilt: 2018,
                            squareFeet: 1800,
                            bedrooms: 2,
                            bathrooms: 2,
                            purchasePrice: 280000,
                            propertyType: 'condo'
                        }
                    ];
                    
                    for (const homeData of sampleHomes) {
                        await saveHomeToFirebase(homeData);
                    }
                    
                    // Mark that user has initialized homes
                    await window.firebaseServices.setDoc(userProfileRef, {
                        hasInitializedHomes: true,
                        lastUpdated: new Date().toISOString()
                    }, { merge: true });
                    
                    console.log('Sample homes initialized for new user');
                    
                } catch (error) {
                    console.error('Error checking user profile for sample home initialization:', error);
                    // If there's an error, don't create sample homes to be safe
                }
            }
        }

        // Initialize Google Maps Autocomplete
        function initializeGoogleMapsAutocomplete() {
            // Wait for Google Maps API to load
            if (typeof google === 'undefined' || !google.maps || !google.maps.places) {
                console.log('Google Maps API not loaded yet, retrying in 1 second...');
                setTimeout(initializeGoogleMapsAutocomplete, 1000);
                return;
            }

            console.log('Initializing Google Maps Autocomplete...');

            // Initialize autocomplete for address fields
            const addressFields = [
                'homeAddress', // Add Home form
                'editHomeAddress' // Edit Home form (if it exists)
            ];

            addressFields.forEach(fieldId => {
                const addressInput = document.getElementById(fieldId);
                if (addressInput) {
                    console.log('Setting up autocomplete for:', fieldId);
                    
                    const autocomplete = new google.maps.places.Autocomplete(addressInput, {
                        types: ['address'],
                        componentRestrictions: { country: 'us' }, // Restrict to US addresses
                        fields: ['formatted_address', 'geometry', 'address_components']
                    });

                    // Prevent form submission when Enter is pressed while dropdown is open
                    addressInput.addEventListener('keydown', function(e) {
                        if (e.key === 'Enter' && document.querySelector('.pac-container')) {
                            e.preventDefault();
                        }
                    });

                    // Handle place selection
                    autocomplete.addListener('place_changed', function() {
                        const place = autocomplete.getPlace();
                        
                        if (!place.geometry) {
                            console.log('No geometry available for selected place');
                            return;
                        }

                        console.log('Selected place:', place);
                        
                        // Update the address field with the formatted address
                        addressInput.value = place.formatted_address;
                        
                        // You can also extract additional information if needed
                        // For example, you could populate city, state, zip separately
                        const addressComponents = place.address_components;
                        let city = '';
                        let state = '';
                        let zipCode = '';
                        
                        addressComponents.forEach(component => {
                            const types = component.types;
                            
                            if (types.includes('locality')) {
                                city = component.long_name;
                            } else if (types.includes('administrative_area_level_1')) {
                                state = component.short_name;
                            } else if (types.includes('postal_code')) {
                                zipCode = component.long_name;
                            }
                        });
                        
                        console.log('Extracted components:', { city, state, zipCode });
                        
                        // Trigger any additional validation or form updates
                        addressInput.dispatchEvent(new Event('input', { bubbles: true }));
                    });
                } else {
                    console.log('Address field not found:', fieldId);
                }
            });
        }

        function openAddTaskModal() {
            document.getElementById('addTaskModal').classList.add('show');
        }

        function openEditHomeModal() {
            // Get the currently selected home
            const homeSelect = document.getElementById('homeSelect');
            const selectedHomeId = homeSelect.value;
            
            if (!selectedHomeId || selectedHomeId === '') {
                alert('Please select a home to edit first.');
                return;
            }
            
            const selectedHome = homes[selectedHomeId];
            
            if (!selectedHome) {
                alert('Selected home not found. Please refresh and try again.');
                return;
            }
            
            // Populate the edit form with current home data
            populateEditHomeForm(selectedHome);
            
            // Store the home ID being edited
            document.getElementById('editHomeModal').setAttribute('data-editing-home-id', selectedHomeId);
            
            // Open the modal
            document.getElementById('editHomeModal').classList.add('show');
            
            // Reinitialize autocomplete for the address field in the modal
            setTimeout(() => {
                initializeGoogleMapsAutocomplete();
            }, 100);
        }

        // Profile Modal Functions
        function openProfileModal() {
            // Load current user profile data
            loadUserProfile();
            
            // Open the modal
            document.getElementById('profileModal').classList.add('show');
            
            // Reinitialize autocomplete for the address field in the modal
            setTimeout(() => {
                initializeGoogleMapsAutocomplete();
            }, 100);
        }

        // Load user profile data
        async function loadUserProfile() {
            if (!currentUserId || !dynamodb) {
                console.log('User not authenticated or AWS not ready');
                return;
            }

            try {
                // Get user profile from Firebase
                const userProfileRef = window.firebaseServices.doc(window.firebaseDB, 'userProfiles', currentUserId);
                const userProfileDoc = await window.firebaseServices.getDoc(userProfileRef);
                
                if (userProfileDoc.exists()) {
                    const profileData = userProfileDoc.data();
                    populateProfileForm(profileData);
                } else {
                    // Create default profile with Firebase user data
                    const defaultProfile = {
                        name: window.firebaseAuth.currentUser?.displayName || '',
                        email: window.firebaseAuth.currentUser?.email || '',
                        phone: '',
                        address: '',
                        bio: '',
                        avatarUrl: window.firebaseAuth.currentUser?.photoURL || '',
                        notifications: {
                            email: true,
                            taskReminders: true,
                            maintenanceAlerts: true
                        }
                    };
                    populateProfileForm(defaultProfile);
                }
            } catch (error) {
                console.error('Error loading user profile:', error);
                // Fallback to default profile
                const defaultProfile = {
                    name: window.firebaseAuth.currentUser?.displayName || '',
                    email: window.firebaseAuth.currentUser?.email || '',
                    phone: '',
                    address: '',
                    bio: '',
                    avatarUrl: window.firebaseAuth.currentUser?.photoURL || '',
                    notifications: {
                        email: true,
                        taskReminders: true,
                        maintenanceAlerts: true
                    }
                };
                populateProfileForm(defaultProfile);
            }
        }

        // Populate profile form with user data
        function populateProfileForm(profileData) {
            document.getElementById('profileName').value = profileData.name || '';
            document.getElementById('profileEmail').value = profileData.email || '';
            document.getElementById('profilePhone').value = profileData.phone || '';
            document.getElementById('profileAddress').value = profileData.address || '';
            document.getElementById('profileBio').value = profileData.bio || '';
            
            // Set avatar
            if (profileData.avatarUrl) {
                document.getElementById('profileAvatar').src = profileData.avatarUrl;
            } else {
                // Generate avatar from name
                const name = profileData.name || 'User';
                document.getElementById('profileAvatar').src = `https://ui-avatars.com/api/?name=${encodeURIComponent(name)}&size=120&background=2563eb&color=fff`;
            }
            
            // Set notification preferences
            const notifications = profileData.notifications || {};
            document.getElementById('emailNotifications').checked = notifications.email !== false;
            document.getElementById('taskReminders').checked = notifications.taskReminders !== false;
            document.getElementById('maintenanceAlerts').checked = notifications.maintenanceAlerts !== false;
        }

        // Save user profile to Firebase
        async function saveUserProfile(profileData) {
            console.log('=== saveUserProfile called ===');
            console.log('currentUserId:', currentUserId);
            console.log('firebaseDB available:', !!window.firebaseDB);
            console.log('firebaseServices available:', !!window.firebaseServices);
            console.log('profileData:', profileData);
            
            if (!currentUserId || !dynamodb) {
                console.error('User not authenticated or Firebase not ready');
                console.error('currentUserId:', currentUserId);
                console.error('firebaseDB:', window.firebaseDB);
                console.error('firebaseServices:', window.firebaseServices);
                return false;
            }

            try {
                const profileWithMetadata = {
                    ...profileData,
                    userId: currentUserId,
                    updatedAt: new Date()
                };
                
                console.log('Saving user profile to Firebase:', profileWithMetadata);
                
                const userProfileRef = window.firebaseServices.doc(window.firebaseDB, 'userProfiles', currentUserId);
                console.log('User profile reference created:', userProfileRef);
                
                await window.firebaseServices.setDoc(userProfileRef, profileWithMetadata, { merge: true });
                
                console.log('User profile saved to Firebase successfully');
                
                // Update Firebase Auth display name if it changed
                if (profileData.name && profileData.name !== window.firebaseAuth.currentUser?.displayName) {
                    console.log('Updating Firebase Auth display name from', window.firebaseAuth.currentUser?.displayName, 'to', profileData.name);
                    await window.firebaseServices.updateProfile(window.firebaseAuth.currentUser, {
                        displayName: profileData.name
                    });
                    console.log('Firebase Auth display name updated');
                }
                
                return true;
            } catch (error) {
                console.error('=== Error saving user profile to Firebase ===');
                console.error('Error object:', error);
                console.error('Error code:', error.code);
                console.error('Error message:', error.message);
                console.error('Error stack:', error.stack);
                return false;
            }
        }

        // Populate edit home form with current home data
        function populateEditHomeForm(home) {
            document.getElementById('editHomeName').value = home.name || '';
            document.getElementById('editHomeAddress').value = home.address || '';
            document.getElementById('editYearBuilt').value = home.yearBuilt || '';
            document.getElementById('editSquareFeet').value = home.squareFeet || '';
            document.getElementById('editBedrooms').value = home.bedrooms || '';
            document.getElementById('editBathrooms').value = home.bathrooms || '';
            document.getElementById('editPurchasePrice').value = home.purchasePrice || '';
            document.getElementById('editPropertyType').value = home.propertyType || 'single-family';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('show');
        }

        // Toggle task completion
        async function toggleTask(taskId, checkbox) {
            const task = tasks[taskId];
            if (!task) {
                console.error('Task not found:', taskId);
                return;
            }
            
            const isCompleted = checkbox.checked;
            
            try {
                // Update in Firebase
                const taskRef = window.firebaseServices.doc(window.firebaseDB, 'tasks', taskId);
                await window.firebaseServices.updateDoc(taskRef, {
                    completed: isCompleted,
                    updatedAt: new Date()
                });
                
                // Update local task
                tasks[taskId].completed = isCompleted;
                
                // Update UI
                const taskItem = checkbox.closest('.task-item');
                const taskTitle = taskItem.querySelector('.task-title');
                
                if (isCompleted) {
                    taskItem.style.opacity = '0.6';
                    taskTitle.classList.add('completed');
                } else {
                    taskItem.style.opacity = '1';
                    taskTitle.classList.remove('completed');
                }
                
                // Update corresponding calendar reminder
                await updateReminderFromTask(task, isCompleted);
                
                console.log('Task toggled successfully:', taskId, isCompleted);
            } catch (error) {
                console.error('Error toggling task:', error);
                // Revert checkbox state
                checkbox.checked = !isCompleted;
            }
        }

        // Delete task
        async function deleteTask(taskId) {
            const task = tasks[taskId];
            if (!task) {
                console.error('Task not found:', taskId);
                return;
            }
            
            if (confirm(`Are you sure you want to delete "${task.title}"?`)) {
                try {
                    // Delete from Firebase
                    const taskRef = window.firebaseServices.doc(window.firebaseDB, 'tasks', taskId);
                    await window.firebaseServices.deleteDoc(taskRef);
                    
                    // Remove from local tasks
                    delete tasks[taskId];
                    
                    // Delete corresponding calendar reminder
                    await deleteReminderFromTask(task);
                    
                    // Update task list display
                    updateTaskList();
                    
                    console.log('Task deleted successfully:', taskId);
                } catch (error) {
                    console.error('Error deleting task:', error);
                    alert('Error deleting task. Please try again.');
                }
            }
        }

        // Delete reminder when task is deleted
        async function deleteReminderFromTask(task) {
            if (!task.dueDate) return;
            
            // Ensure reminders object exists
            if (!reminders) {
                reminders = {};
            }
            
            const dateString = task.dueDate;
            const dayReminders = reminders[dateString] || [];
            
            // Find the reminder linked to this task
            const taskReminder = dayReminders.find(r => r.taskId === task.id);
            
            if (taskReminder) {
                try {
                    // Delete from Firebase
                    const reminderRef = window.firebaseServices.doc(window.firebaseDB, 'reminders', taskReminder.id);
                    await window.firebaseServices.deleteDoc(reminderRef);
                    
                    // Remove from local reminders
                    const reminderIndex = dayReminders.indexOf(taskReminder);
                    if (reminderIndex > -1) {
                        dayReminders.splice(reminderIndex, 1);
                    }
                    
                    // If no more reminders for this date, remove the date entry
                    if (dayReminders.length === 0) {
                        delete reminders[dateString];
                    }
                    
                    console.log('Deleted reminder for task:', task.title);
                    
                } catch (error) {
                    console.error('Error deleting reminder from task:', error);
                }
            }
        }

        async function signOut() {
            if (confirm('Are you sure you want to sign out?')) {
                try {
                    // Sign out from Firebase
                    await window.firebaseServices.signOut(window.firebaseAuth);
                    console.log('User signed out successfully');
                    // Redirect to index.html after successful sign out
                    window.location.href = 'index.html';
                } catch (error) {
                    console.error('Sign out error:', error);
                    alert('Error signing out. Please try again.');
                }
            }
        }

        function exportData() {
            window.open('import-export-files.html', '_blank');
        }

        // Home Details Section Management
        function toggleSection(sectionId) {
            const content = document.getElementById(sectionId + '-content');
            const toggle = document.getElementById(sectionId + '-toggle');
            
            if (content.classList.contains('expanded')) {
                content.classList.remove('expanded');
                toggle.textContent = 'â–¼';
            } else {
                content.classList.add('expanded');
                toggle.textContent = 'â–²';
            }
        }

        function addDetail(sectionId) {
            const sectionDetails = document.querySelector(`#${sectionId}-content .section-details`);
            const newRow = document.createElement('div');
            newRow.className = 'detail-row';
            newRow.innerHTML = `
                <div class="detail-field">
                    <div class="detail-label">New Detail</div>
                    <div class="detail-value">Click edit to add details</div>
                </div>
                <div class="detail-field">
                    <div class="detail-label">Specification</div>
                    <div class="detail-value">Click edit to add details</div>
                </div>
                <div class="detail-field">
                    <div class="detail-label">Date/Info</div>
                    <div class="detail-value">Click edit to add details</div>
                </div>
                <div class="detail-actions">
                    <button class="action-icon edit" onclick="editDetail('${sectionId}')"><i class="fas fa-edit"></i></button>
                    <button class="action-icon delete" onclick="deleteDetail('${sectionId}')"><i class="fas fa-trash"></i></button>
                </div>
            `;
            
            // Insert before the add button
            const addButton = sectionDetails.querySelector('.add-detail-btn');
            sectionDetails.insertBefore(newRow, addButton);
            
            // Auto-edit the new row
            setTimeout(() => editDetail(sectionId, sectionDetails.children.length - 2), 100);
        }

        function editDetail(sectionId, rowIndex) {
            const sectionDetails = document.querySelector(`#${sectionId}-content .section-details`);
            
            // If rowIndex is not provided, find it from the clicked element
            if (rowIndex === undefined || rowIndex === null) {
                const clickedButton = event.target.closest('button');
                const detailRow = clickedButton.closest('.detail-row');
                const allRows = sectionDetails.querySelectorAll('.detail-row');
                rowIndex = Array.from(allRows).indexOf(detailRow);
            }
            
            const detailRow = sectionDetails.children[rowIndex];
            
            if (!detailRow || detailRow.classList.contains('detail-row')) {
                const fields = detailRow.querySelectorAll('.detail-field');
                const labels = [];
                const values = [];
                
                fields.forEach(field => {
                    labels.push(field.querySelector('.detail-label').textContent);
                    values.push(field.querySelector('.detail-value').textContent);
                });
                
                // Create edit form
                const editForm = document.createElement('div');
                editForm.className = 'edit-form show';
                editForm.innerHTML = `
                    <div class="edit-form-row">
                        <input type="text" placeholder="Label 1" value="${labels[0] || ''}" id="edit-label-1">
                        <input type="text" placeholder="Value 1" value="${values[0] || ''}" id="edit-value-1">
                        <input type="text" placeholder="Date/Info" value="${values[2] || ''}" id="edit-date-1">
                    </div>
                    <div class="edit-form-row">
                        <input type="text" placeholder="Label 2" value="${labels[1] || ''}" id="edit-label-2">
                        <input type="text" placeholder="Value 2" value="${values[1] || ''}" id="edit-value-2">
                        <textarea placeholder="Additional Notes" id="edit-notes-1">${values[3] || ''}</textarea>
                    </div>
                    <div class="edit-form-buttons">
                        <button class="btn btn-secondary" onclick="cancelEdit('${sectionId}', ${rowIndex})">Cancel</button>
                        <button class="btn btn-primary" onclick="saveEdit('${sectionId}', ${rowIndex})">Save</button>
                    </div>
                `;
                
                // Hide the original row and show edit form
                detailRow.style.display = 'none';
                detailRow.parentNode.insertBefore(editForm, detailRow.nextSibling);
            }
        }

        function saveEdit(sectionId, rowIndex) {
            const sectionDetails = document.querySelector(`#${sectionId}-content .section-details`);
            const detailRow = sectionDetails.children[rowIndex];
            const editForm = detailRow.nextSibling;
            
            // Get values from edit form
            const label1 = document.getElementById('edit-label-1').value;
            const value1 = document.getElementById('edit-value-1').value;
            const date1 = document.getElementById('edit-date-1').value;
            const label2 = document.getElementById('edit-label-2').value;
            const value2 = document.getElementById('edit-value-2').value;
            const notes = document.getElementById('edit-notes-1').value;
            
            // Update the detail row
            const fields = detailRow.querySelectorAll('.detail-field');
            if (fields[0]) fields[0].querySelector('.detail-label').textContent = label1 || 'Detail';
            if (fields[0]) fields[0].querySelector('.detail-value').textContent = value1 || 'Not specified';
            if (fields[1]) fields[1].querySelector('.detail-label').textContent = label2 || 'Specification';
            if (fields[1]) fields[1].querySelector('.detail-value').textContent = value2 || 'Not specified';
            if (fields[2]) fields[2].querySelector('.detail-label').textContent = 'Date/Info';
            if (fields[2]) fields[2].querySelector('.detail-value').textContent = date1 || 'Not specified';
            
            // Show the row and remove edit form
            detailRow.style.display = 'grid';
            editForm.remove();
            
            // Save to Firebase
            saveSectionToFirebase(sectionId);
        }

        function cancelEdit(sectionId, rowIndex) {
            const sectionDetails = document.querySelector(`#${sectionId}-content .section-details`);
            const detailRow = sectionDetails.children[rowIndex];
            const editForm = detailRow.nextSibling;
            
            // Show the row and remove edit form
            detailRow.style.display = 'grid';
            editForm.remove();
        }

        function deleteDetail(sectionId, rowIndex) {
            if (confirm('Are you sure you want to delete this detail?')) {
                const sectionDetails = document.querySelector(`#${sectionId}-content .section-details`);
                
                // If rowIndex is not provided, find it from the clicked element
                if (rowIndex === undefined || rowIndex === null) {
                    const clickedButton = event.target.closest('button');
                    const detailRow = clickedButton.closest('.detail-row');
                    const allRows = sectionDetails.querySelectorAll('.detail-row');
                    rowIndex = Array.from(allRows).indexOf(detailRow);
                }
                
                const detailRow = sectionDetails.children[rowIndex];
                
                if (detailRow && detailRow.classList.contains('detail-row')) {
                    detailRow.remove();
                    
                    // Save to Firebase
                    saveSectionToFirebase(sectionId);
                    console.log(`Deleted detail from ${sectionId} section, row ${rowIndex}`);
                } else {
                    console.error(`Could not find detail row at index ${rowIndex} in section ${sectionId}`);
                }
            }
        }

        // Form submissions
        document.getElementById('addHomeForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // Get form data
            const formData = new FormData(e.target);
            const homeData = {
                name: formData.get('homeName') || document.getElementById('homeName').value,
                address: formData.get('homeAddress') || document.getElementById('homeAddress').value,
                yearBuilt: parseInt(formData.get('yearBuilt') || document.getElementById('yearBuilt').value) || null,
                squareFeet: parseInt(formData.get('squareFeet') || document.getElementById('squareFeet').value) || null,
                bedrooms: parseInt(formData.get('bedrooms') || document.getElementById('bedrooms').value) || null,
                bathrooms: parseFloat(formData.get('bathrooms') || document.getElementById('bathrooms').value) || null,
                purchasePrice: parseInt(formData.get('purchasePrice') || document.getElementById('purchasePrice').value.replace(/[$,]/g, '')) || null,
                propertyType: formData.get('propertyType') || document.getElementById('propertyType').value
            };
            
            console.log('Adding home with data:', homeData);
            
            // Save to Firebase
            const homeId = await saveHomeToFirebase(homeData);
            
            if (homeId) {
                alert('Home added successfully!');
                closeModal('addHomeModal');
                document.getElementById('addHomeForm').reset();
                
                // Select the newly added home
                const homeSelect = document.getElementById('homeSelect');
                homeSelect.value = homeId;
                loadHomeData();
            } else {
                alert('Error adding home. Please try again.');
            }
        });

        document.getElementById('addTaskForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // Get form data
            const taskData = {
                title: document.getElementById('taskTitle').value.trim(),
                description: document.getElementById('taskDescription').value.trim(),
                dueDate: document.getElementById('taskDueDate').value,
                priority: document.getElementById('taskPriority').value,
                category: document.getElementById('taskCategory').value
            };
            
            // Validate required fields
            if (!taskData.title || !taskData.dueDate) {
                alert('Please fill in the task title and due date.');
                return;
            }
            
            console.log('Adding task with data:', taskData);
            
            // Save to Firebase
            const taskId = await saveTaskToFirebase(taskData);
            
            if (taskId) {
                // Show success message with calendar info
                const dueDate = new Date(taskData.dueDate);
                const successMessage = `Task "${taskData.title}" added successfully!\n\nDue: ${dueDate.toLocaleDateString()}\n\n${calendarSettings.autoCreateFromTasks ? 'âœ“ Automatically added to calendar' : 'âš  Calendar auto-save is disabled'}`;
                alert(successMessage);
                
                closeModal('addTaskModal');
                document.getElementById('addTaskForm').reset();
                
                // Force calendar refresh to show new reminder
                renderCalendar();
            } else {
                alert('Error adding task. Please try again.');
            }
        });

        document.getElementById('editHomeForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // Get the home ID being edited
            const homeId = document.getElementById('editHomeModal').getAttribute('data-editing-home-id');
            
            if (!homeId) {
                alert('Error: No home selected for editing.');
                return;
            }
            
            // Get form data
            const formData = new FormData(e.target);
            const homeData = {
                name: formData.get('editHomeName') || document.getElementById('editHomeName').value,
                address: formData.get('editHomeAddress') || document.getElementById('editHomeAddress').value,
                yearBuilt: parseInt(formData.get('editYearBuilt') || document.getElementById('editYearBuilt').value) || null,
                squareFeet: parseInt(formData.get('editSquareFeet') || document.getElementById('editSquareFeet').value) || null,
                bedrooms: parseInt(formData.get('editBedrooms') || document.getElementById('editBedrooms').value) || null,
                bathrooms: parseFloat(formData.get('editBathrooms') || document.getElementById('editBathrooms').value) || null,
                purchasePrice: parseInt(formData.get('editPurchasePrice') || document.getElementById('editPurchasePrice').value.replace(/[$,]/g, '')) || null,
                propertyType: formData.get('editPropertyType') || document.getElementById('editPropertyType').value
            };
            
            console.log('Updating home with data:', homeData);
            
            // Update in Firebase
            const success = await updateHomeInFirebase(homeId, homeData);
            
            if (success) {
                alert('Home updated successfully!');
                closeModal('editHomeModal');
                
                // Refresh the home details display
                loadHomeData();
                
                // Clear the editing home ID
                document.getElementById('editHomeModal').removeAttribute('data-editing-home-id');
            } else {
                alert('Error updating home. Please try again.');
            }
        });

        // Delete Profile Functions
        function openDeleteProfileModal() {
            // Close the profile modal first
            closeModal('profileModal');
            // Open the delete confirmation modal
            document.getElementById('deleteProfileModal').classList.add('show');
        }

        // Delete profile with password confirmation - DIRECT VERSION
        async function deleteUserProfile(password) {
            try {
                console.log('=== DELETE USER PROFILE STARTED ===');
                console.log('Password length:', password.length);
                
                // Check if Firebase services are available
                console.log('Firebase Auth available:', !!window.firebaseAuth);
                console.log('Firebase DB available:', !!window.firebaseDB);
                console.log('Firebase Services available:', !!window.firebaseServices);
                
                const user = window.firebaseAuth.currentUser;
                if (!user) {
                    console.error('No user logged in');
                    alert('No user logged in');
                    return;
                }
                
                console.log('Current user:', user.email);
                console.log('User UID:', user.uid);
                
                // Re-authenticate user with password
                console.log('Creating credential...');
                const credential = window.firebaseServices.EmailAuthProvider.credential(user.email, password);
                console.log('Credential created, re-authenticating...');
                await window.firebaseServices.reauthenticateWithCredential(user, credential);
                console.log('User re-authenticated successfully');
                
                // Delete user data from all collections
                console.log('Starting data deletion...');
                await deleteUserData(user.uid);
                console.log('Data deletion completed');
                
                // Delete the Firebase Authentication account
                console.log('Deleting Firebase Authentication account...');
                await window.firebaseServices.deleteUser(user);
                console.log('Firebase Authentication account deleted');
                
                // Sign out user
                console.log('Signing out user...');
                await window.firebaseServices.signOut(window.firebaseAuth);
                console.log('User signed out successfully');
                
                // Show success message and redirect
                console.log('Showing success message and redirecting...');
                alert('Your profile and all associated data have been permanently deleted. You will be redirected to the sign-in page.');
                window.location.href = 'login-aws.html';
                
            } catch (error) {
                console.error('Error in deleteUserProfile:', error);
                
                let errorMessage = 'An error occurred while deleting your account.';
                if (error.code === 'auth/wrong-password') {
                    errorMessage = 'Incorrect password. Please try again.';
                } else if (error.code === 'auth/requires-recent-login') {
                    errorMessage = 'For security reasons, please sign out and sign in again before deleting your profile.';
                } else if (error.code === 'auth/user-not-found') {
                    errorMessage = 'User account not found. It may have already been deleted.';
                }
                
                alert(errorMessage);
            }
        }
        
        // Helper function to delete user data
        async function deleteUserData(uid) {
            console.log('=== DELETE USER DATA STARTED ===');
            console.log('UID:', uid);
            
            const collections = [
                'userProfiles',
                'salesReps',
                'homes',
                'tasks',
                'reminders',
                'files',
                'warranties',
                'homeDetails',
                'salesRepProfiles',  // Additional sales rep collections
                'salesRepData',
                'salesRepSettings'
            ];
            
            console.log('Collections to delete from:', collections);
            
            for (const collectionName of collections) {
                console.log(`Deleting from collection: ${collectionName}`);
                await deleteFromCollection(collectionName, uid);
                console.log(`Completed deletion from: ${collectionName}`);
            }
            
            // Delete calendar settings
            try {
                const calendarSettingsRef = window.firebaseServices.doc(window.firebaseDB, 'calendarSettings', uid);
                await window.firebaseServices.deleteDoc(calendarSettingsRef);
                console.log('Calendar settings deleted');
            } catch (error) {
                console.log('Calendar settings not found or already deleted');
            }
            
            // Also check for any documents with the user's email (in case they're stored by email instead of UID)
            await deleteByEmail(uid);
        }
        
        // Helper function to delete from a collection
        async function deleteFromCollection(collectionName, uid) {
            try {
                console.log(`  Starting deletion from ${collectionName} for UID: ${uid}`);
                
                if (collectionName === 'userProfiles' || collectionName === 'salesReps') {
                    // For profile collections, try to delete by document ID first
                    console.log(`  Attempting to delete ${collectionName} document by ID`);
                    try {
                        const docRef = window.firebaseServices.doc(window.firebaseDB, collectionName, uid);
                        console.log(`  Document reference created for ${collectionName}:`, uid);
                        await window.firebaseServices.deleteDoc(docRef);
                        console.log(`  âœ… ${collectionName} document deleted successfully`);
                    } catch (error) {
                        console.log(`  âš ï¸ ${collectionName} document not found or already deleted:`, error.message);
                    }
                } else {
                    // For other collections, query by userId field
                    console.log(`  Querying ${collectionName} for userId: ${uid}`);
                    const collectionRef = window.firebaseServices.collection(window.firebaseDB, collectionName);
                    const query = window.firebaseServices.query(collectionRef, window.firebaseServices.where('userId', '==', uid));
                    const snapshot = await window.firebaseServices.getDocs(query);
                    
                    console.log(`  Found ${snapshot.size} documents in ${collectionName}`);
                    
                    if (!snapshot.empty) {
                        console.log(`  Deleting ${snapshot.size} documents from ${collectionName}`);
                        const deletePromises = snapshot.docs.map(doc => 
                            window.firebaseServices.deleteDoc(doc.ref)
                        );
                        await Promise.all(deletePromises);
                        console.log(`  âœ… ${collectionName} documents deleted:`, snapshot.docs.length);
                    } else {
                        console.log(`  â„¹ï¸ No ${collectionName} documents found for user`);
                    }
                }
            } catch (error) {
                console.error(`  âŒ Error deleting from ${collectionName}:`, error);
            }
                }
        
        // Helper function to delete data by email (in case some data is stored by email instead of UID)
        async function deleteByEmail(uid) {
            try {
                const user = window.firebaseAuth.currentUser;
                if (!user || !user.email) {
                    console.log('No user email available for email-based deletion');
                    return;
                }
                
                console.log('=== DELETING BY EMAIL ===');
                console.log('User email:', user.email);
                
                const emailCollections = [
                    'userProfiles',
                    'salesReps',
                    'salesRepProfiles',
                    'salesRepData',
                    'salesRepSettings'
                ];
                
                for (const collectionName of emailCollections) {
                    try {
                        console.log(`  Checking ${collectionName} for email: ${user.email}`);
                        const collectionRef = window.firebaseServices.collection(window.firebaseDB, collectionName);
                        const query = window.firebaseServices.query(collectionRef, window.firebaseServices.where('email', '==', user.email));
                        const snapshot = await window.firebaseServices.getDocs(query);
                        
                        console.log(`  Found ${snapshot.size} documents in ${collectionName} with email ${user.email}`);
                        
                        if (!snapshot.empty) {
                            const deletePromises = snapshot.docs.map(doc => {
                                console.log(`    Deleting document ${doc.id} from ${collectionName}`);
                                return window.firebaseServices.deleteDoc(doc.ref);
                            });
                            await Promise.all(deletePromises);
                            console.log(`  âœ… Deleted ${snapshot.size} documents from ${collectionName} by email`);
                        }
                    } catch (error) {
                        console.log(`  âš ï¸ Error checking ${collectionName} by email:`, error.message);
                    }
                }
            } catch (error) {
                console.error('Error in deleteByEmail:', error);
            }
        }
        
        // Debug function to check user status
        async function checkUserStatus() {
            const user = window.firebaseAuth.currentUser;
            if (!user) {
                alert('No user logged in');
                return;
            }
            
            console.log('=== USER STATUS CHECK ===');
            console.log('User UID:', user.uid);
            console.log('User Email:', user.email);
            
            try {
                // Check userProfiles
                const userProfileRef = window.firebaseServices.doc(window.firebaseDB, 'userProfiles', user.uid);
                const userProfileDoc = await window.firebaseServices.getDoc(userProfileRef);
                console.log('User Profile exists:', userProfileDoc.exists());
                
                if (userProfileDoc.exists()) {
                    console.log('User Profile data:', userProfileDoc.data());
                }
                
                // Check salesReps
                const salesRepsRef = window.firebaseServices.collection(window.firebaseDB, 'salesReps');
                const salesQuery = window.firebaseServices.query(salesRepsRef, window.firebaseServices.where('email', '==', user.email));
                const salesSnapshot = await window.firebaseServices.getDocs(salesQuery);
                console.log('Sales Rep documents found:', salesSnapshot.size);
                
                if (!salesSnapshot.empty) {
                    salesSnapshot.forEach(doc => {
                        console.log('Sales Rep data:', doc.data());
                    });
                }
                
                alert('Check console for detailed user status information');
                
            } catch (error) {
                console.error('Error checking user status:', error);
                alert('Error checking user status: ' + error.message);
            }
        }



        // Debug function to test account type detection
        async function debugAccountType() {
            const user = window.firebaseAuth.currentUser;
            if (!user) {
                alert('No user logged in');
                return;
            }
            
            console.log('=== ACCOUNT TYPE DETECTION DEBUG ===');
            console.log('Current user UID:', user.uid);
            console.log('Current user email:', user.email);
            
            try {
                // Check if user exists in userProfiles (regular user)
                const userProfileRef = window.firebaseServices.doc(window.firebaseDB, 'userProfiles', user.uid);
                const userProfileDoc = await window.firebaseServices.getDoc(userProfileRef);
                console.log('User profile exists (by UID):', userProfileDoc.exists());
                
                // Check if user exists in salesReps (sales rep)
                const salesRepRef = window.firebaseServices.doc(window.firebaseDB, 'salesReps', user.uid);
                const salesRepDoc = await window.firebaseServices.getDoc(salesRepRef);
                console.log('Sales rep exists (by UID):', salesRepDoc.exists());
                
                // Check by email
                const userProfilesByEmailRef = window.firebaseServices.collection(window.firebaseDB, 'userProfiles');
                const userProfilesQuery = window.firebaseServices.query(userProfilesByEmailRef, window.firebaseServices.where('email', '==', user.email));
                const userProfilesSnapshot = await window.firebaseServices.getDocs(userProfilesQuery);
                console.log('UserProfiles found by email:', userProfilesSnapshot.size);
                
                const salesRepsByEmailRef = window.firebaseServices.collection(window.firebaseDB, 'salesReps');
                const salesRepsQuery = window.firebaseServices.query(salesRepsByEmailRef, window.firebaseServices.where('email', '==', user.email));
                const salesRepsSnapshot = await window.firebaseServices.getDocs(salesRepsQuery);
                console.log('SalesReps found by email:', salesRepsSnapshot.size);
                
                // Log all found documents
                userProfilesSnapshot.forEach((doc, index) => {
                    console.log(`UserProfile ${index}:`, doc.id, doc.data());
                });
                salesRepsSnapshot.forEach((doc, index) => {
                    console.log(`SalesRep ${index}:`, doc.id, doc.data());
                });
                
                // Determine account type
                let accountType = 'unknown';
                if (userProfileDoc.exists()) {
                    accountType = 'regular';
                } else if (salesRepDoc.exists()) {
                    accountType = 'sales';
                } else if (!userProfilesSnapshot.empty) {
                    accountType = 'regular (by email)';
                } else if (!salesRepsSnapshot.empty) {
                    accountType = 'sales (by email)';
                }
                
                console.log('=== ACCOUNT TYPE RESULT ===');
                console.log('Detected Account Type:', accountType);
                
                alert(`Account Type: ${accountType}\n\nCheck console for detailed information.`);
                
            } catch (error) {
                console.error('Error in account type detection:', error);
                alert('Error in account type detection: ' + error.message);
            }
        }

        // Profile form submission
        document.getElementById('profileForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // Get form data
            const formData = new FormData(e.target);
            const profileData = {
                name: formData.get('profileName') || document.getElementById('profileName').value,
                email: formData.get('profileEmail') || document.getElementById('profileEmail').value,
                phone: formData.get('profilePhone') || document.getElementById('profilePhone').value,
                address: formData.get('profileAddress') || document.getElementById('profileAddress').value,
                bio: formData.get('profileBio') || document.getElementById('profileBio').value,
                avatarUrl: document.getElementById('profileAvatar').src,
                notifications: {
                    email: document.getElementById('emailNotifications').checked,
                    taskReminders: document.getElementById('taskReminders').checked,
                    maintenanceAlerts: document.getElementById('maintenanceAlerts').checked
                }
            };
            
            console.log('Saving profile with data:', profileData);
            
            // Save to Firebase
            const success = await saveUserProfile(profileData);
            
            if (success) {
                alert('Profile updated successfully!');
                closeModal('profileModal');
                
                // Update the user email display in header
                document.getElementById('userEmail').textContent = profileData.name || profileData.email || 'User';
            } else {
                alert('Error updating profile. Please try again.');
            }
        });

        // Avatar upload functionality
        document.getElementById('avatarInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    document.getElementById('profileAvatar').src = event.target.result;
                };
                reader.readAsDataURL(file);
            }
        });

        // Delete profile form submission
        document.getElementById('deleteProfileForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            console.log('=== DELETE PROFILE FORM SUBMITTED ===');
            
            const password = document.getElementById('deletePassword').value;
            if (!password) {
                alert('Please enter your password to confirm deletion.');
                return;
            }

            console.log('Password entered, length:', password.length);
            console.log('Calling deleteUserProfile...');
            
            try {
                // Call the delete profile function
                await deleteUserProfile(password);
                console.log('deleteUserProfile completed');
            } catch (error) {
                console.error('Error in form submission:', error);
                alert('Error: ' + error.message);
            }
        });

        // Close modals when clicking outside
        window.addEventListener('click', function(e) {
            if (e.target.classList.contains('modal')) {
                e.target.classList.remove('show');
            }
        });

        // Calendar Functions
        function initializeCalendar() {
            console.log('=== Initializing Calendar ===');
            ensureCalendarSettings();
            renderCalendar();
            loadRemindersFromFirebase();
            loadCalendarSettingsFromFirebase();
        }

        function renderCalendar() {
            const calendarGrid = document.getElementById('calendarGrid');
            const currentMonthElement = document.getElementById('currentMonth');
            
            if (!calendarGrid || !currentMonthElement) return;
            
            // Ensure reminders object exists
            if (!reminders) {
                reminders = {};
            }

            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            
            // Update month display
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                              'July', 'August', 'September', 'October', 'November', 'December'];
            currentMonthElement.textContent = `${monthNames[month]} ${year}`;

            // Get first day of month and number of days
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const startDate = new Date(firstDay);
            startDate.setDate(startDate.getDate() - firstDay.getDay());

            calendarGrid.innerHTML = '';

            // Generate calendar days
            for (let i = 0; i < 42; i++) {
                const date = new Date(startDate);
                date.setDate(startDate.getDate() + i);

                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day';
                
                if (date.getMonth() !== month) {
                    dayElement.classList.add('other-month');
                }

                const today = new Date();
                if (date.toDateString() === today.toDateString()) {
                    dayElement.classList.add('today');
                }

                // Check if day has reminders
                const dateString = date.toISOString().split('T')[0];
                if (reminders[dateString] && reminders[dateString].length > 0) {
                    dayElement.classList.add('has-reminder');
                    
                    // Check if all reminders are completed
                    const allCompleted = reminders[dateString].every(r => r.completed);
                    if (allCompleted) {
                        dayElement.classList.add('all-completed');
                    }
                }

                dayElement.innerHTML = `
                    <div class="day-number">${date.getDate()}</div>
                    ${reminders[dateString] && reminders[dateString].length > 0 ? 
                        `<div class="reminder-indicator ${reminders[dateString].every(r => r.completed) ? 'completed' : ''}">${reminders[dateString].length} reminder${reminders[dateString].length > 1 ? 's' : ''}</div>` : ''}
                `;

                dayElement.onclick = () => openDayDetails(date);
                
                // Add right-click context menu for days with reminders
                if (reminders[dateString] && reminders[dateString].length > 0) {
                    dayElement.addEventListener('contextmenu', (e) => {
                        e.preventDefault();
                        showDayContextMenu(e, date, dateString);
                    });
                }
                
                calendarGrid.appendChild(dayElement);
            }
        }

        function previousMonth() {
            currentDate.setMonth(currentDate.getMonth() - 1);
            renderCalendar();
        }

        function nextMonth() {
            currentDate.setMonth(currentDate.getMonth() + 1);
            renderCalendar();
        }

        function openDayDetails(date) {
            selectedDate = date;
            const dateString = date.toISOString().split('T')[0];
            
            console.log('showDayDetails called for date:', dateString);
            console.log('Current reminders object:', reminders);
            
            // Ensure reminders object exists
            if (!reminders) {
                reminders = {};
            }
            
            const dayReminders = reminders[dateString] || [];
            console.log('Day reminders for', dateString, ':', dayReminders);
            console.log('All tasks:', tasks);
            console.log('All reminders:', reminders);
            
            const modal = document.getElementById('dayDetailsModal');
            const content = document.getElementById('dayDetailsContent');
            
            const dateOptions = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            const formattedDate = date.toLocaleDateString('en-US', dateOptions);
            
            let html = `<h4>${formattedDate}</h4>`;
            
            if (dayReminders.length > 0) {
                html += '<div class="day-reminders">';
                dayReminders.forEach((reminder, index) => {
                    const priorityClass = `priority-${reminder.priority}`;
                    const completedClass = reminder.completed ? 'completed' : '';
                    html += `
                        <div class="reminder-item ${priorityClass} ${completedClass}">
                            <div class="reminder-header">
                                <h5>${reminder.title}</h5>
                                <div class="reminder-actions">
                                    ${reminder.taskId ? `
                                        <button onclick="toggleTaskFromReminder('${reminder.taskId}')" class="btn-icon" title="${reminder.completed ? 'Mark as incomplete' : 'Mark as complete'}">
                                            <i class="fas fa-${reminder.completed ? 'undo' : 'check'}"></i>
                                        </button>
                                    ` : ''}
                                    <button onclick="editReminder('${reminder.id}')" class="btn-icon">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button onclick="deleteReminder('${reminder.id}')" class="btn-icon">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                            <p>${reminder.description || 'No description'}</p>
                            <div class="reminder-meta">
                                <span class="reminder-time">${reminder.time}</span>
                                <span class="reminder-category">${reminder.category}</span>
                                <span class="reminder-priority">${reminder.priority}</span>
                                ${reminder.completed ? '<span class="reminder-status completed">âœ“ Completed</span>' : ''}
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
            } else {
                html += '<p>No reminders for this day.</p>';
                
                // Check if there are tasks for this date
                if (tasks) {
                    const dayTasks = Object.values(tasks).filter(task => task.dueDate === dateString);
                    if (dayTasks.length > 0) {
                        html += `<p><strong>Tasks for this day (${dayTasks.length}):</strong></p>`;
                        html += '<ul>';
                        dayTasks.forEach(task => {
                            html += `<li>${task.title} - ${task.completed ? 'Completed' : 'Pending'}</li>`;
                        });
                        html += '</ul>';
                        html += '<p><em>Click "Sync Tasks" to create reminders from these tasks.</em></p>';
                    }
                }
            }
            
            content.innerHTML = html;
            
            // Populate footer buttons
            const footer = document.getElementById('dayDetailsFooter');
            let footerHtml = '';
            
            if (dayReminders.length > 0) {
                footerHtml += `
                    <button type="button" class="btn btn-danger" onclick="deleteAllRemindersForDay('${dateString}')">
                        <i class="fas fa-trash"></i>
                        Delete All (${dayReminders.length})
                    </button>
                `;
            }
            
            footerHtml += `
                <button type="button" class="btn btn-secondary" onclick="closeModal('dayDetailsModal')">Close</button>
                <button type="button" class="btn btn-primary" onclick="openAddReminderModal()">Add Reminder</button>
                <button type="button" class="btn btn-outline" onclick="syncTasksWithReminders()">Sync Tasks</button>
            `;
            
            footer.innerHTML = footerHtml;
            modal.classList.add('show');
        }

        function openAddReminderModal() {
            const modal = document.getElementById('addReminderModal');
            const dateInput = document.getElementById('reminderDate');
            const timeInput = document.getElementById('reminderTime');
            
            // Set default date to selected date or today
            const defaultDate = selectedDate || new Date();
            dateInput.value = defaultDate.toISOString().split('T')[0];
            timeInput.value = calendarSettings.defaultReminderTime;
            
            modal.classList.add('show');
        }

        function openCalendarSettings() {
            const modal = document.getElementById('calendarSettingsModal');
            const form = document.getElementById('calendarSettingsForm');
            
            // Populate form with current settings
            document.getElementById('defaultReminderTime').value = calendarSettings.defaultReminderTime;
            document.getElementById('reminderAdvanceDays').value = calendarSettings.reminderAdvanceDays;
            document.getElementById('showCompletedTasks').checked = calendarSettings.showCompletedTasks;
            document.getElementById('autoCreateFromTasks').checked = calendarSettings.autoCreateFromTasks;
            
            modal.classList.add('show');
        }

        async function addReminder(event) {
            event.preventDefault();
            
            const formData = new FormData(event.target);
            const reminderData = {
                title: formData.get('reminderTitle'),
                description: formData.get('reminderDescription'),
                date: formData.get('reminderDate'),
                time: formData.get('reminderTime'),
                category: formData.get('reminderCategory'),
                priority: formData.get('reminderPriority'),
                repeat: formData.get('reminderRepeat'),
                notification: formData.get('reminderNotification') === 'on',
                userId: currentUserId,
                createdAt: new Date().toISOString()
            };

            try {
                // Save to Firebase
                const docRef = await window.firebaseServices.addDoc(
                    window.firebaseServices.collection(window.firebaseDB, 'reminders'),
                    reminderData
                );
                
                reminderData.id = docRef.id;
                
                // Add to local reminders
                if (!reminders[reminderData.date]) {
                    reminders[reminderData.date] = [];
                }
                reminders[reminderData.date].push(reminderData);
                
                // Re-render calendar
                renderCalendar();
                
                // Close modal and reset form
                closeModal('addReminderModal');
                event.target.reset();
                
                console.log('Reminder added successfully:', reminderData);
                
            } catch (error) {
                console.error('Error adding reminder:', error);
                alert('Failed to add reminder. Please try again.');
            }
        }

        async function saveCalendarSettings(event) {
            event.preventDefault();
            
            const formData = new FormData(event.target);
            const settings = {
                defaultReminderTime: formData.get('defaultReminderTime'),
                reminderAdvanceDays: parseInt(formData.get('reminderAdvanceDays')),
                showCompletedTasks: formData.get('showCompletedTasks') === 'on',
                autoCreateFromTasks: formData.get('autoCreateFromTasks') === 'on',
                userId: currentUserId
            };

            try {
                // Save to Firebase
                await window.firebaseServices.setDoc(
                    window.firebaseServices.doc(window.firebaseDB, 'calendarSettings', currentUserId),
                    settings
                );
                
                // Update local settings
                calendarSettings = settings;
                
                // Close modal
                closeModal('calendarSettingsModal');
                
                console.log('Calendar settings saved successfully');
                
            } catch (error) {
                console.error('Error saving calendar settings:', error);
                alert('Failed to save settings. Please try again.');
            }
        }

        async function loadRemindersFromFirebase() {
            if (!currentUserId || !dynamodb) {
                return;
            }

            try {
                const remindersQuery = window.firebaseServices.query(
                    window.firebaseServices.collection(window.firebaseDB, 'reminders'),
                    window.firebaseServices.where('userId', '==', currentUserId)
                );
                
                const querySnapshot = await window.firebaseServices.getDocs(remindersQuery);
                
                reminders = {};
                
                querySnapshot.forEach((doc) => {
                    const reminderData = doc.data();
                    const dateString = reminderData.date;
                    
                    if (!reminders[dateString]) {
                        reminders[dateString] = [];
                    }
                    reminders[dateString].push({ id: doc.id, ...reminderData });
                });
                
                // Check for any tasks that don't have corresponding reminders and create them
                // Skip this if we just created a task to prevent duplicates
                if (calendarSettings.autoCreateFromTasks && !window.justCreatedTask) {
                    await syncTasksWithReminders();
                }
                
                // Reset the flag after a delay to ensure all operations are complete
                setTimeout(() => {
                    window.justCreatedTask = false;
                    window.lastCreatedTaskId = null;
                    console.log('Reset justCreatedTask flag after delay');
                }, 2000); // 2 second delay
                
                renderCalendar();
                
            } catch (error) {
                console.error('Error loading reminders from Firebase:', error);
            }
        }

        // Sync tasks with reminders to ensure all tasks have calendar entries
        async function syncTasksWithReminders() {
            console.log('Syncing tasks with reminders...');
            console.log('justCreatedTask flag:', window.justCreatedTask);
            console.log('lastCreatedTaskId:', window.lastCreatedTaskId);
            let syncedCount = 0;
            
            // Ensure tasks and reminders objects exist
            if (!tasks) {
                console.warn('Tasks object not found, skipping sync');
                return;
            }
            
            if (!reminders) {
                reminders = {};
            }
            
            for (const task of Object.values(tasks)) {
                if (task.dueDate && !task.completed) {
                    // Skip the task that was just created to prevent duplicates
                    if (window.justCreatedTask && task.id === window.lastCreatedTaskId) {
                        console.log('Skipping recently created task:', task.title, 'to prevent duplicate');
                        continue;
                    }
                    
                    const dateString = task.dueDate;
                    const dayReminders = reminders[dateString] || [];
                    
                    // Check if there's already a reminder for this task
                    const existingReminder = dayReminders.find(r => r.taskId === task.id);
                    
                    if (!existingReminder) {
                        console.log('No existing reminder found for task:', task.title, 'creating one...');
                        // Create reminder for this task
                        const reminderId = await createReminderFromTask(task);
                        if (reminderId) {
                            syncedCount++;
                        }
                    } else {
                        console.log('Reminder already exists for task:', task.title, 'skipping...');
                    }
                }
            }
            
            if (syncedCount > 0) {
                console.log(`Synced ${syncedCount} tasks with calendar`);
                showNotification(`Synced ${syncedCount} task${syncedCount > 1 ? 's' : ''} with calendar`);
            } else {
                console.log('No new tasks to sync with calendar');
            }
        }

        async function loadCalendarSettingsFromFirebase() {
            if (!currentUserId || !dynamodb) {
                return;
            }

            try {
                const docRef = window.firebaseServices.doc(window.firebaseDB, 'calendarSettings', currentUserId);
                const docSnap = await window.firebaseServices.getDoc(docRef);
                
                if (docSnap.exists()) {
                    calendarSettings = { ...calendarSettings, ...docSnap.data() };
                }
                
            } catch (error) {
                console.error('Error loading calendar settings from Firebase:', error);
            }
        }

        function editReminder(reminderId) {
            // TODO: Implement edit reminder functionality
            console.log('Edit reminder:', reminderId);
        }

        async function deleteReminder(reminderId) {
            if (confirm('Are you sure you want to delete this reminder?')) {
                try {
                    // Ensure reminders object exists
                    if (!reminders) {
                        reminders = {};
                    }
                    
                    // Find the reminder in local data
                    let reminderToDelete = null;
                    let reminderDate = null;
                    
                    for (const [date, dayReminders] of Object.entries(reminders)) {
                        const reminder = dayReminders.find(r => r.id === reminderId);
                        if (reminder) {
                            reminderToDelete = reminder;
                            reminderDate = date;
                            break;
                        }
                    }
                    
                    if (!reminderToDelete) {
                        console.error('Reminder not found:', reminderId);
                        return;
                    }
                    
                    // Delete from Firebase
                    const reminderRef = window.firebaseServices.doc(window.firebaseDB, 'reminders', reminderId);
                    await window.firebaseServices.deleteDoc(reminderRef);
                    
                    // Remove from local reminders
                    const dayReminders = reminders[reminderDate];
                    const reminderIndex = dayReminders.findIndex(r => r.id === reminderId);
                    if (reminderIndex > -1) {
                        dayReminders.splice(reminderIndex, 1);
                    }
                    
                    // If no more reminders for this date, remove the date entry
                    if (dayReminders.length === 0) {
                        delete reminders[reminderDate];
                    }
                    
                    // Re-render calendar
                    renderCalendar();
                    
                    // Refresh day details modal if it's open
                    if (selectedDate) {
                        openDayDetails(selectedDate);
                    }
                    
                    console.log('Reminder deleted successfully:', reminderId);
                    
                    // Show notification
                    showNotification(`Reminder "${reminderToDelete.title}" deleted successfully`);
                    
                } catch (error) {
                    console.error('Error deleting reminder:', error);
                    alert('Error deleting reminder. Please try again.');
                }
            }
        }

        // Toggle task completion from reminder
        async function toggleTaskFromReminder(taskId) {
            // Ensure tasks object exists
            if (!tasks) {
                console.error('Tasks object not found');
                return;
            }
            
            const task = tasks[taskId];
            if (!task) {
                console.error('Task not found:', taskId);
                return;
            }
            
            const newCompletedState = !task.completed;
            
            try {
                // Update task in Firebase
                const taskRef = window.firebaseServices.doc(window.firebaseDB, 'tasks', taskId);
                await window.firebaseServices.updateDoc(taskRef, {
                    completed: newCompletedState,
                    updatedAt: new Date()
                });
                
                // Update local task
                tasks[taskId].completed = newCompletedState;
                
                // Update task list display
                updateTaskList();
                
                // Update corresponding reminder
                await updateReminderFromTask(task, newCompletedState);
                
                // Re-render calendar
                renderCalendar();
                
                // Refresh day details modal
                openDayDetails(selectedDate);
                
                console.log('Task toggled from reminder:', taskId, newCompletedState);
            } catch (error) {
                console.error('Error toggling task from reminder:', error);
            }
        }

        // Delete all reminders for a specific day
        async function deleteAllRemindersForDay(dateString) {
            // Ensure reminders object exists
            if (!reminders) {
                reminders = {};
            }
            
            const dayReminders = reminders[dateString] || [];
            
            if (dayReminders.length === 0) {
                alert('No reminders to delete for this day.');
                return;
            }
            
            const confirmMessage = `Are you sure you want to delete all ${dayReminders.length} reminder${dayReminders.length > 1 ? 's' : ''} for ${new Date(dateString).toLocaleDateString()}?\n\nThis action cannot be undone.`;
            
            if (confirm(confirmMessage)) {
                try {
                    let deletedCount = 0;
                    let errors = [];
                    
                    // Delete each reminder
                    for (const reminder of dayReminders) {
                        try {
                            // Delete from Firebase
                            const reminderRef = window.firebaseServices.doc(window.firebaseDB, 'reminders', reminder.id);
                            await window.firebaseServices.deleteDoc(reminderRef);
                            deletedCount++;
                        } catch (error) {
                            console.error('Error deleting reminder:', reminder.id, error);
                            errors.push(reminder.title);
                        }
                    }
                    
                    // Remove from local reminders
                    delete reminders[dateString];
                    
                    // Re-render calendar
                    renderCalendar();
                    
                    // Close the day details modal
                    closeModal('dayDetailsModal');
                    
                    // Show results
                    if (errors.length === 0) {
                        showNotification(`Successfully deleted ${deletedCount} reminder${deletedCount > 1 ? 's' : ''} for ${new Date(dateString).toLocaleDateString()}`);
                    } else {
                        showNotification(`Deleted ${deletedCount} reminder${deletedCount > 1 ? 's' : ''}, but failed to delete ${errors.length} reminder${errors.length > 1 ? 's' : ''}`);
                    }
                    
                    console.log('Deleted all reminders for day:', dateString, 'Count:', deletedCount);
                    
                } catch (error) {
                    console.error('Error deleting all reminders for day:', error);
                    alert('Error deleting reminders. Please try again.');
                }
            }
        }

        // Show context menu for calendar days
        function showDayContextMenu(event, date, dateString) {
            // Remove any existing context menu
            const existingMenu = document.getElementById('dayContextMenu');
            if (existingMenu) {
                existingMenu.remove();
            }
            
            // Ensure reminders object exists
            if (!reminders) {
                reminders = {};
            }
            
            const dayReminders = reminders[dateString] || [];
            const completedCount = dayReminders.filter(r => r.completed).length;
            const totalCount = dayReminders.length;
            
            const contextMenu = document.createElement('div');
            contextMenu.id = 'dayContextMenu';
            contextMenu.className = 'context-menu';
            contextMenu.innerHTML = `
                <div class="context-menu-header">
                    <strong>${date.toLocaleDateString()}</strong>
                    <span class="context-menu-count">${totalCount} reminder${totalCount > 1 ? 's' : ''}</span>
                </div>
                <div class="context-menu-item" onclick="openDayDetails(new Date('${dateString}'))">
                    <i class="fas fa-eye"></i>
                    View Details
                </div>
                <div class="context-menu-item" onclick="openAddReminderModal()">
                    <i class="fas fa-plus"></i>
                    Add Reminder
                </div>
                ${totalCount > 0 ? `
                    <div class="context-menu-separator"></div>
                    <div class="context-menu-item danger" onclick="deleteAllRemindersForDay('${dateString}')">
                        <i class="fas fa-trash"></i>
                        Delete All Reminders
                    </div>
                    ${completedCount > 0 ? `
                        <div class="context-menu-item" onclick="deleteCompletedRemindersForDay('${dateString}')">
                            <i class="fas fa-check-double"></i>
                            Delete Completed Only (${completedCount})
                        </div>
                    ` : ''}
                ` : ''}
            `;
            
            // Position the context menu
            contextMenu.style.left = event.pageX + 'px';
            contextMenu.style.top = event.pageY + 'px';
            
            document.body.appendChild(contextMenu);
            
            // Close context menu when clicking outside
            setTimeout(() => {
                document.addEventListener('click', function closeContextMenu() {
                    contextMenu.remove();
                    document.removeEventListener('click', closeContextMenu);
                });
            }, 100);
        }

        // Delete only completed reminders for a specific day
        async function deleteCompletedRemindersForDay(dateString) {
            // Ensure reminders object exists
            if (!reminders) {
                reminders = {};
            }
            
            const dayReminders = reminders[dateString] || [];
            const completedReminders = dayReminders.filter(r => r.completed);
            
            if (completedReminders.length === 0) {
                alert('No completed reminders to delete for this day.');
                return;
            }
            
            const confirmMessage = `Are you sure you want to delete ${completedReminders.length} completed reminder${completedReminders.length > 1 ? 's' : ''} for ${new Date(dateString).toLocaleDateString()}?`;
            
            if (confirm(confirmMessage)) {
                try {
                    let deletedCount = 0;
                    let errors = [];
                    
                    // Delete each completed reminder
                    for (const reminder of completedReminders) {
                        try {
                            // Delete from Firebase
                            const reminderRef = window.firebaseServices.doc(window.firebaseDB, 'reminders', reminder.id);
                            await window.firebaseServices.deleteDoc(reminderRef);
                            deletedCount++;
                        } catch (error) {
                            console.error('Error deleting completed reminder:', reminder.id, error);
                            errors.push(reminder.title);
                        }
                    }
                    
                    // Remove from local reminders
                    const remainingReminders = dayReminders.filter(r => !r.completed);
                    if (remainingReminders.length === 0) {
                        delete reminders[dateString];
                    } else {
                        reminders[dateString] = remainingReminders;
                    }
                    
                    // Re-render calendar
                    renderCalendar();
                    
                    // Show results
                    if (errors.length === 0) {
                        showNotification(`Successfully deleted ${deletedCount} completed reminder${deletedCount > 1 ? 's' : ''} for ${new Date(dateString).toLocaleDateString()}`);
                    } else {
                        showNotification(`Deleted ${deletedCount} completed reminder${deletedCount > 1 ? 's' : ''}, but failed to delete ${errors.length} reminder${errors.length > 1 ? 's' : ''}`);
                    }
                    
                    console.log('Deleted completed reminders for day:', dateString, 'Count:', deletedCount);
                    
                } catch (error) {
                    console.error('Error deleting completed reminders for day:', error);
                    alert('Error deleting completed reminders. Please try again.');
                }
            }
        }

        // Open bulk delete modal
        function openBulkDeleteModal() {
            closeModal('calendarSettingsModal');
            document.getElementById('bulkDeleteModal').classList.add('show');
            
            // Set up event listeners for bulk delete options
            setupBulkDeleteListeners();
        }

        // Setup bulk delete event listeners
        function setupBulkDeleteListeners() {
            // Show/hide category section based on checkbox
            document.getElementById('deleteByCategory').addEventListener('change', function() {
                const categorySection = document.getElementById('categoryDeleteSection');
                categorySection.style.display = this.checked ? 'block' : 'none';
            });
        }

        // Preview bulk delete
        function previewBulkDelete() {
            const deleteCompleted = document.getElementById('deleteCompleted').checked;
            const deleteOverdue = document.getElementById('deleteOverdue').checked;
            const deleteByCategory = document.getElementById('deleteByCategory').checked;
            const deleteCategory = document.getElementById('deleteCategory').value;
            const fromDate = document.getElementById('deleteFromDate').value;
            const toDate = document.getElementById('deleteToDate').value;
            
            let remindersToDelete = [];
            
            // Collect all reminders that match the criteria
            for (const [dateString, dayReminders] of Object.entries(reminders)) {
                for (const reminder of dayReminders) {
                    let shouldDelete = false;
                    
                    // Check date range
                    if (fromDate && toDate) {
                        const reminderDate = new Date(reminder.date);
                        const from = new Date(fromDate);
                        const to = new Date(toDate);
                        if (reminderDate < from || reminderDate > to) {
                            continue;
                        }
                    }
                    
                    // Check completed status
                    if (deleteCompleted && reminder.completed) {
                        shouldDelete = true;
                    }
                    
                    // Check overdue status
                    if (deleteOverdue && !reminder.completed) {
                        const reminderDate = new Date(reminder.date);
                        const today = new Date();
                        if (reminderDate < today) {
                            shouldDelete = true;
                        }
                    }
                    
                    // Check category
                    if (deleteByCategory && reminder.category === deleteCategory) {
                        shouldDelete = true;
                    }
                    
                    if (shouldDelete) {
                        remindersToDelete.push(reminder);
                    }
                }
            }
            
            // Show preview
            const previewSection = document.getElementById('bulkDeletePreview');
            const countElement = document.getElementById('bulkDeleteCount');
            const datesElement = document.getElementById('bulkDeleteDates');
            const executeBtn = document.getElementById('executeBulkDeleteBtn');
            
            if (remindersToDelete.length > 0) {
                countElement.textContent = `${remindersToDelete.length} reminder${remindersToDelete.length > 1 ? 's' : ''} will be deleted`;
                
                // Group by date
                const dates = [...new Set(remindersToDelete.map(r => r.date))].sort();
                datesElement.innerHTML = `<strong>Dates:</strong> ${dates.map(d => new Date(d).toLocaleDateString()).join(', ')}`;
                
                previewSection.style.display = 'block';
                executeBtn.disabled = false;
                
                // Store reminders to delete for execution
                window.remindersToDelete = remindersToDelete;
            } else {
                countElement.textContent = 'No reminders match the selected criteria';
                datesElement.innerHTML = '';
                previewSection.style.display = 'block';
                executeBtn.disabled = true;
                window.remindersToDelete = [];
            }
        }

        // Execute bulk delete
        async function executeBulkDelete() {
            const remindersToDelete = window.remindersToDelete || [];
            
            if (remindersToDelete.length === 0) {
                alert('No reminders to delete.');
                return;
            }
            
            const confirmMessage = `Are you sure you want to delete ${remindersToDelete.length} reminder${remindersToDelete.length > 1 ? 's' : ''}?\n\nThis action cannot be undone.`;
            
            if (confirm(confirmMessage)) {
                try {
                    let deletedCount = 0;
                    let errors = [];
                    
                    // Delete each reminder
                    for (const reminder of remindersToDelete) {
                        try {
                            // Delete from Firebase
                            const reminderRef = window.firebaseServices.doc(window.firebaseDB, 'reminders', reminder.id);
                            await window.firebaseServices.deleteDoc(reminderRef);
                            deletedCount++;
                        } catch (error) {
                            console.error('Error deleting reminder:', reminder.id, error);
                            errors.push(reminder.title);
                        }
                    }
                    
                    // Update local reminders
                    for (const reminder of remindersToDelete) {
                        const dateString = reminder.date;
                        if (reminders[dateString]) {
                            const index = reminders[dateString].findIndex(r => r.id === reminder.id);
                            if (index > -1) {
                                reminders[dateString].splice(index, 1);
                            }
                            // Remove empty date entries
                            if (reminders[dateString].length === 0) {
                                delete reminders[dateString];
                            }
                        }
                    }
                    
                    // Re-render calendar
                    renderCalendar();
                    
                    // Close modal
                    closeModal('bulkDeleteModal');
                    
                    // Show results
                    if (errors.length === 0) {
                        showNotification(`Successfully deleted ${deletedCount} reminder${deletedCount > 1 ? 's' : ''}`);
                    } else {
                        showNotification(`Deleted ${deletedCount} reminder${deletedCount > 1 ? 's' : ''}, but failed to delete ${errors.length} reminder${errors.length > 1 ? 's' : ''}`);
                    }
                    
                    console.log('Bulk delete completed. Deleted:', deletedCount);
                    
                } catch (error) {
                    console.error('Error executing bulk delete:', error);
                    alert('Error deleting reminders. Please try again.');
                }
            }
        }

        // Auto-create reminders from tasks (deprecated - use syncTasksWithReminders instead)
        function createRemindersFromTasks() {
            console.warn('createRemindersFromTasks is deprecated. Use syncTasksWithReminders instead.');
            if (!calendarSettings.autoCreateFromTasks) return;
            
            // Use the improved sync function instead
            syncTasksWithReminders();
        }

        // Create a single reminder from a task
        async function createReminderFromTask(task) {
            console.log('=== createReminderFromTask called ===');
            console.log('Task ID:', task.id);
            console.log('Task title:', task.title);
            console.log('Task due date:', task.dueDate);
            console.log('Calendar settings:', calendarSettings);
            console.log('Current user ID:', currentUserId);
            console.log('Firebase services available:', !!window.firebaseServices);
            console.log('Firebase DB available:', !!window.firebaseDB);
            console.log('Call stack:', new Error().stack);
            
            // Add a unique identifier to prevent duplicate calls for the same task
            const callId = `createReminder_${task.id}_${Date.now()}`;
            if (window.activeReminderCreation && window.activeReminderCreation[task.id]) {
                console.log('Reminder creation already in progress for task:', task.title, 'skipping...');
                return window.activeReminderCreation[task.id];
            }
            
            // Mark this task as being processed
            if (!window.activeReminderCreation) window.activeReminderCreation = {};
            window.activeReminderCreation[task.id] = callId;
            
            if (!calendarSettings.autoCreateFromTasks) {
                console.log('Auto-create from tasks is disabled');
                return null;
            }
            
            if (!task.dueDate) {
                console.log('Task has no due date, skipping calendar reminder');
                return null;
            }
            
            if (!currentUserId) {
                console.error('No current user ID available');
                throw new Error('User not authenticated');
            }
            
            if (!window.firebaseServices || !window.firebaseDB) {
                console.error('Firebase services not available');
                throw new Error('Firebase services not initialized');
            }
            
            const reminderData = {
                title: `Task Due: ${task.title}`,
                description: task.description || 'Maintenance task due',
                date: task.dueDate,
                time: calendarSettings.defaultReminderTime || '09:00',
                category: task.category || 'General',
                priority: task.priority || 'medium',
                repeat: 'none',
                notification: true,
                userId: currentUserId,
                taskId: task.id, // Link to the original task
                createdAt: new Date().toISOString()
            };
            
            console.log('Reminder data to save:', reminderData);
            
            try {
                // Check if reminder already exists - check both local reminders and Firebase
                const dateString = task.dueDate;
                
                // Ensure reminders object exists
                if (!reminders) {
                    reminders = {};
                }
                
                const existingReminder = reminders[dateString]?.find(r => r.taskId === task.id);
                
                if (existingReminder) {
                    console.log('Reminder already exists locally for task:', task.title);
                    return existingReminder.id;
                }
                
                // Also check Firebase to prevent duplicates if local data is out of sync
                try {
                    const remindersQuery = window.firebaseServices.query(
                        window.firebaseServices.collection(window.firebaseDB, 'reminders'),
                        window.firebaseServices.where('userId', '==', currentUserId),
                        window.firebaseServices.where('taskId', '==', task.id)
                    );
                    
                    const querySnapshot = await window.firebaseServices.getDocs(remindersQuery);
                    
                    if (!querySnapshot.empty) {
                        console.log('Reminder already exists in Firebase for task:', task.title);
                        const existingDoc = querySnapshot.docs[0];
                        const existingData = existingDoc.data();
                        
                        // Add to local reminders if not already there
                        if (!reminders[dateString]) {
                            reminders[dateString] = [];
                        }
                        
                        const localReminder = reminders[dateString].find(r => r.taskId === task.id);
                        if (!localReminder) {
                            reminders[dateString].push({ id: existingDoc.id, ...existingData });
                        }
                        
                        return existingDoc.id;
                    }
                } catch (firebaseCheckError) {
                    console.warn('Could not check Firebase for existing reminders:', firebaseCheckError);
                    // Continue with creation if we can't check Firebase
                }
                
                console.log('Saving reminder to Firebase...');
                
                // Save to Firebase
                const docRef = await window.firebaseServices.addDoc(
                    window.firebaseServices.collection(window.firebaseDB, 'reminders'),
                    reminderData
                );
                
                console.log('Reminder saved to Firebase with ID:', docRef.id);
                
                reminderData.id = docRef.id;
                
                // Add to local reminders
                if (!reminders[dateString]) {
                    reminders[dateString] = [];
                }
                
                reminders[dateString].push(reminderData);
                console.log('Created reminder from task:', task.title, 'for date:', dateString);
                console.log('Updated local reminders:', reminders[dateString]);
                
                // Show notification
                showNotification(`Task "${task.title}" automatically added to calendar for ${new Date(task.dueDate).toLocaleDateString()}`);
                
                // Re-render calendar
                renderCalendar();
                
                // Clean up the active creation tracking
                if (window.activeReminderCreation && window.activeReminderCreation[task.id]) {
                    delete window.activeReminderCreation[task.id];
                }
                
                return reminderData.id;
                
            } catch (error) {
                console.error('=== Error creating reminder from task ===');
                console.error('Error object:', error);
                console.error('Error code:', error.code);
                console.error('Error message:', error.message);
                console.error('Error stack:', error.stack);
                
                // Clean up the active creation tracking on error too
                if (window.activeReminderCreation && window.activeReminderCreation[task.id]) {
                    delete window.activeReminderCreation[task.id];
                }
                
                // Provide more specific error messages
                let errorMessage = 'Failed to add task to calendar';
                if (error.code === 'permission-denied') {
                    errorMessage = 'Permission denied. Please check Firebase security rules.';
                } else if (error.code === 'unavailable') {
                    errorMessage = 'Firebase service unavailable. Please check your internet connection.';
                } else if (error.message) {
                    errorMessage = error.message;
                }
                
                showNotification(`Failed to add task "${task.title}" to calendar: ${errorMessage}`);
                throw error; // Re-throw to be handled by caller
            }
        }

        // Show notification to user
        function showNotification(message) {
            // Create notification element
            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.innerHTML = `
                <div class="notification-content">
                    <i class="fas fa-calendar-check"></i>
                    <span>${message}</span>
                    <button class="notification-close" onclick="this.parentElement.parentElement.remove()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
            
            // Add to page
            document.body.appendChild(notification);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, 5000);
        }

        // Retry calendar sync for the last created task
        async function retryCalendarSync() {
            const syncStatus = document.getElementById('calendarSyncStatus');
            const errorMessage = document.getElementById('syncErrorMessage');
            
            if (!syncStatus || !errorMessage) {
                console.error('Calendar sync status elements not found');
                return;
            }
            
            try {
                syncStatus.style.display = 'none';
                errorMessage.textContent = 'Retrying calendar sync...';
                
                // Get the most recently created task
                const recentTasks = Object.values(tasks).sort((a, b) => 
                    new Date(b.createdAt) - new Date(a.createdAt)
                );
                
                if (recentTasks.length > 0) {
                    const latestTask = recentTasks[0];
                    console.log('Retrying calendar sync for task:', latestTask);
                    
                    const reminderId = await createReminderFromTask(latestTask);
                    
                    if (reminderId) {
                        showNotification(`Successfully added task "${latestTask.title}" to calendar!`);
                        syncStatus.style.display = 'none';
                    } else {
                        throw new Error('Failed to create reminder');
                    }
                } else {
                    throw new Error('No recent tasks found');
                }
                
            } catch (error) {
                console.error('Retry calendar sync failed:', error);
                if (errorMessage && syncStatus) {
                    errorMessage.textContent = `Retry failed: ${error.message}`;
                    syncStatus.style.display = 'block';
                }
            }
        }

        // Show calendar sync error in task form
        function showCalendarSyncError(message) {
            const syncStatus = document.getElementById('calendarSyncStatus');
            const errorMessage = document.getElementById('syncErrorMessage');
            
            if (syncStatus && errorMessage) {
                errorMessage.textContent = message;
                syncStatus.style.display = 'block';
            } else {
                console.warn('Calendar sync error elements not found, showing notification instead');
                showNotification(`Calendar sync error: ${message}`);
            }
        }

        // Debug function to check calendar sync status
        function debugCalendarSync() {
            console.log('=== Calendar Sync Debug Info ===');
            console.log('Current User ID:', currentUserId);
            console.log('Firebase Services:', !!window.firebaseServices);
            console.log('Firebase DB:', !!window.firebaseDB);
            console.log('Calendar Settings:', calendarSettings);
            console.log('Tasks Count:', Object.keys(tasks).length);
            console.log('Reminders Count:', Object.keys(reminders).length);
            console.log('Sample Task:', Object.values(tasks)[0]);
            console.log('Sample Reminder:', Object.values(reminders)[0]);
            
            // Check if tasks have corresponding reminders
            const tasksWithReminders = Object.values(tasks).filter(task => {
                if (!task.dueDate || task.completed) return false;
                const dateString = task.dueDate;
                const dayReminders = reminders[dateString] || [];
                return dayReminders.some(r => r.taskId === task.id);
            });
            
            console.log('Tasks with reminders:', tasksWithReminders.length);
            console.log('Tasks without reminders:', Object.values(tasks).length - tasksWithReminders.length);
        }

        // Add debug function to global scope for console access
        window.debugCalendarSync = debugCalendarSync;

        // Quick Actions Functions
        function openExpertServices() {
            window.open('expert-services.html', '_blank');
        }

        function openHomeShop() {
            window.open('home-shop.html', '_blank');
        }

        function openMaintenanceGuide() {
            window.open('maintenance-guide.html', '_blank');
        }

        function openInsuranceClaims() {
            window.open('insurance-claims.html', '_blank');
        }

        function openEnergyAudit() {
            window.open('energy-audit.html', '_blank');
        }

        function openHomeValue() {
            window.open('home-value-tracker.html', '_blank');
        }

        function openWarrantyTracker() {
            window.open('warranty-tracker.html', '_blank');
        }

        function openEmergencyContacts() {
            window.open('emergency-contacts.html', '_blank');
        }

        // Helper function to create modals
        function createModal(title, content) {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-content large-modal">
                    <div class="modal-header">
                        <h3 class="modal-title">${title}</h3>
                        <button class="close-btn" onclick="closeQuickActionModal(this)">&times;</button>
                    </div>
                    <div class="modal-body">
                        ${content}
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            
            // Add click outside to close functionality
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    closeQuickActionModal(modal.querySelector('.close-btn'));
                }
            });
            
            return modal;
        }

        // Close quick action modal
        function closeQuickActionModal(closeBtn) {
            const modal = closeBtn.closest('.modal');
            if (modal) {
                modal.remove();
            }
        }

        // Update reminder when task is completed/uncompleted
        async function updateReminderFromTask(task, isCompleted) {
            if (!task.dueDate) return;
            
            // Ensure reminders object exists
            if (!reminders) {
                reminders = {};
            }
            
            const dateString = task.dueDate;
            const dayReminders = reminders[dateString] || [];
            
            // Find the reminder linked to this task
            const taskReminder = dayReminders.find(r => r.taskId === task.id);
            
            if (taskReminder) {
                try {
                    // Update the reminder in Firebase
                    const reminderRef = window.firebaseServices.doc(window.firebaseDB, 'reminders', taskReminder.id);
                    await window.firebaseServices.updateDoc(reminderRef, {
                        completed: isCompleted,
                        updatedAt: new Date()
                    });
                    
                    // Update local reminder
                    taskReminder.completed = isCompleted;
                    
                    // Update visual indicator
                    if (isCompleted) {
                        taskReminder.title = `âœ“ Completed: ${task.title}`;
                    } else {
                        taskReminder.title = `Task Due: ${task.title}`;
                    }
                    
                    console.log('Updated reminder for task:', task.title, 'completed:', isCompleted);
                    
                } catch (error) {
                    console.error('Error updating reminder from task:', error);
                }
            }
        }

        // Check authentication state
        document.addEventListener('DOMContentLoaded', function() {
            console.log('NestMate Dashboard loaded successfully!');

            // Initialize Google Maps Autocomplete
            initializeGoogleMapsAutocomplete();

            // Check if user is authenticated
            if (window.firebaseAuth && window.firebaseServices) {
                console.log('Firebase Auth available, setting up auth state listener');
                console.log('Current Firebase project ID:', window.firebaseAuth.app.options.projectId);
                
                window.firebaseServices.onAuthStateChanged(window.firebaseAuth, async function(user) {
                    console.log('=== AUTH STATE CHANGED ===');
                    console.log('User:', user ? user.email : 'null');
                    console.log('User UID:', user ? user.uid : 'null');
                    console.log('Firebase project:', window.firebaseAuth.app.options.projectId);
                    console.log('Timestamp:', new Date().toISOString());
                    
                    if (!user) {
                        // User is not signed in, redirect to signin page
                        console.log('User not authenticated, redirecting to signin');
                        // Add a small delay to prevent rapid redirects
                        setTimeout(() => {
                        window.location.href = 'login-aws.html';
                        }, 1000);
                    } else {
                        // User is signed in, check if they're a sales rep
                        console.log('User authenticated:', user.email);
                        console.log('User UID:', user.uid);
                        
                        // Check if user is a sales rep but don't auto-redirect
                        try {
                            console.log('Checking if user is a sales rep...');
                            const salesRepDoc = await window.firebaseServices.getDoc(
                                window.firebaseServices.doc(window.firebaseDB, 'salesReps', user.uid)
                            );
                            
                            console.log('Sales rep document exists:', salesRepDoc.exists());
                            
                            if (salesRepDoc.exists()) {
                                console.log('User is a sales rep, but allowing access to NestMate.html');
                                // Don't redirect - let the user choose which dashboard to use
                            }
                            
                            // Check if user is a seller first - if so, redirect them
                            const sellerDoc = await window.firebaseServices.getDoc(
                                window.firebaseServices.doc(window.firebaseDB, 'SELLER USER ACCOUNTS', user.uid)
                            );
                            
                            if (sellerDoc.exists()) {
                                console.log('User is a seller, redirecting to seller dashboard...');
                                window.location.href = 'Sales.html';
                                return;
                            }
                            
                            // Also check if user exists in userProfiles
                            const userProfileDoc = await window.firebaseServices.getDoc(
                                window.firebaseServices.doc(window.firebaseDB, 'userProfiles', user.uid)
                            );
                            
                            console.log('User profile document exists:', userProfileDoc.exists());
                            
                            if (!userProfileDoc.exists()) {
                                console.log('User profile does not exist - creating it now...');
                                // Create user profile if it doesn't exist
                                const userData = {
                                    uid: user.uid,
                                    displayName: user.displayName || 'User',
                                    email: user.email,
                                    role: 'user',
                                    accountType: 'regular',
                                    createdAt: new Date().toISOString(),
                                    updatedAt: new Date().toISOString()
                                };
                                
                                await window.firebaseServices.setDoc(
                                    window.firebaseServices.doc(window.firebaseDB, 'userProfiles', user.uid), 
                                    userData
                                );
                                console.log('User profile created successfully');
                            }
                            
                        } catch (error) {
                            console.log('Error checking user status:', error);
                            // Don't redirect on error - just log it and continue
                        }
                        
                        // User is a regular user, proceed
                        currentUserId = user.uid;
                        document.getElementById('userEmail').textContent = user.email || 'User';
                        
                        console.log('Setting currentUserId:', currentUserId);
                        console.log('User email displayed:', user.email);
                        
                        console.log('About to load homes from Firebase...');
                        // Load user's homes from Firebase
                        try {
                        await loadHomesFromAWS();
                        } catch (error) {
                            console.error('Error loading homes:', error);
                            // Continue anyway - don't let this break the authentication
                        }
                        
                        console.log('About to initialize sample homes...');
                        // Initialize sample homes if none exist (only for truly new users)
                        try {
                            await initializeSampleHomes();
                        } catch (error) {
                            console.error('Error initializing sample homes:', error);
                        }
                        
                        console.log('About to load tasks from Firebase...');
                        // Load user's tasks from Firebase
                        try {
                        await loadTasksFromAWS();
                        } catch (error) {
                            console.error('Error loading tasks:', error);
                        }
                        
                        console.log('About to load home details from Firebase...');
                        // Load user's home details from Firebase
                        try {
                        await loadHomeDetailsFromFirebase();
                        } catch (error) {
                            console.error('Error loading home details:', error);
                        }
                        
                        console.log('About to load rooms from Firebase...');
                        // Load user's rooms from Firebase
                        try {
                        await loadRoomsFromFirebase();
                        } catch (error) {
                            console.error('Error loading rooms:', error);
                        }
                        
                        console.log('About to initialize sample rooms...');
                        // Initialize sample rooms if none exist
                        await initializeSampleRooms();
                        
                        console.log('About to initialize calendar...');
                        // Initialize calendar
                        initializeCalendar();
                        
                        // Note: createRemindersFromTasks is now handled within initializeCalendar
                        // No need to call it separately as it would cause duplicates
                        
                        // Update task sync status
                        updateTaskSyncStatus();
                    }
                });
            } else {
                console.log('Firebase Auth not available!');
            }
        });

        // Room Management Functions with Firebase Integration
        let rooms = {}; // Will be loaded from Firebase
        let currentUserId = null;

        // Load rooms from Firebase
        async function loadRoomsFromFirebase() {
            console.log('=== loadRoomsFromFirebase called ===');
            console.log('currentUserId:', currentUserId);
            console.log('firebaseDB available:', !!window.firebaseDB);
            console.log('firebaseServices available:', !!window.firebaseServices);
            
            if (!currentUserId || !dynamodb) {
                console.log('User not authenticated or AWS not ready');
                console.log('currentUserId:', currentUserId);
                console.log('firebaseDB:', window.firebaseDB);
                console.log('firebaseServices:', window.firebaseServices);
                return;
            }

            try {
                console.log('Creating query for rooms collection...');
                console.log('Query parameters:');
                console.log('- Collection: rooms');
                console.log('- userId filter:', currentUserId);
                console.log('- Order by: name');
                
                const roomsQuery = window.firebaseServices.query(
                    window.firebaseServices.collection(window.firebaseDB, 'rooms'),
                    window.firebaseServices.where('userId', '==', currentUserId)
                );
                
                console.log('Query object created:', roomsQuery);
                console.log('Executing query...');
                const querySnapshot = await window.firebaseServices.getDocs(roomsQuery);
                console.log('Query completed, found', querySnapshot.size, 'rooms');
                console.log('Query snapshot:', querySnapshot);
                
                rooms = {};
                
                const roomSelect = document.getElementById('roomSelect');
                console.log('Room select element found:', roomSelect);
                if (!roomSelect) {
                    console.error('Room select element not found!');
                    return;
                }
                
                console.log('Current dropdown options before clearing:', roomSelect.children.length);
                
                // Clear existing options except the first one (placeholder)
                while (roomSelect.children.length > 1) {
                    roomSelect.removeChild(roomSelect.lastChild);
                }
                console.log('Cleared existing options, remaining:', roomSelect.children.length);
                
                let roomsAdded = 0;
                const roomsArray = [];
                
                querySnapshot.forEach((doc) => {
                    const roomData = doc.data();
                    const roomId = doc.id;
                    console.log('Processing room from Firebase:', roomId, roomData);
                    
                    // Ensure details array exists
                    if (!roomData.details || !Array.isArray(roomData.details)) {
                        roomData.details = [];
                    }
                    
                    rooms[roomId] = { id: roomId, ...roomData };
                    roomsArray.push({ id: roomId, ...roomData });
                });
                
                // Sort rooms alphabetically by name
                roomsArray.sort((a, b) => a.name.localeCompare(b.name));
                
                // Add sorted rooms to dropdown
                roomsArray.forEach(room => {
                    const option = document.createElement('option');
                    option.value = room.id;
                    option.textContent = room.name;
                    roomSelect.appendChild(option);
                    roomsAdded++;
                    console.log('Added option to dropdown:', option.value, option.textContent);
                });
                
                console.log('Final dropdown options count:', roomSelect.children.length);
                console.log('Total rooms added to dropdown:', roomsAdded);
                console.log('Loaded rooms from Firebase:', Object.keys(rooms).length, 'rooms');
                console.log('Rooms object after loading:', rooms);
                
                // Force a visual update of the dropdown
                roomSelect.style.display = 'none';
                roomSelect.offsetHeight; // Trigger reflow
                roomSelect.style.display = '';
                
                console.log('Dropdown refresh completed');
            } catch (error) {
                console.error('Error loading rooms from Firebase:', error);
                console.error('Error details:', error.message, error.code);
                console.error('Error stack:', error.stack);
                
                // Check if it's a security rules error
                if (error.code === 'permission-denied') {
                    console.error('PERMISSION DENIED - Check Firebase security rules');
                    alert('Permission denied when loading rooms. Please check Firebase security rules.');
                } else if (error.code === 'unavailable') {
                    console.error('FIREBASE UNAVAILABLE - Check internet connection');
                    alert('Firebase is unavailable. Please check your internet connection.');
                } else {
                    alert('Error loading rooms: ' + error.message);
                }
            }
        }

        // Save room to Firebase
        async function saveRoomToFirebase(roomData) {
            console.log('=== saveRoomToFirebase called ===');
            console.log('roomData:', roomData);
            console.log('currentUserId:', currentUserId);
            console.log('firebaseDB available:', !!window.firebaseDB);
            console.log('firebaseServices available:', !!window.firebaseServices);
            
            if (!currentUserId || !dynamodb) {
                console.error('User not authenticated or Firebase not ready');
                console.error('currentUserId:', currentUserId);
                console.error('firebaseDB:', window.firebaseDB);
                console.error('firebaseServices:', window.firebaseServices);
                return null;
            }

            try {
                // Ensure roomData has required fields
                const roomWithUserId = {
                    name: roomData.name || 'Unnamed Room',
                    type: roomData.type || 'room',
                    details: roomData.details || [],
                    userId: currentUserId,
                    createdAt: new Date(),
                    updatedAt: new Date()
                };
                
                console.log('Attempting to save room to Firebase:', roomWithUserId);
                console.log('Collection path: rooms');
                console.log('Document data to save:', JSON.stringify(roomWithUserId, null, 2));
                
                const docRef = await window.firebaseServices.addDoc(
                    window.firebaseServices.collection(window.firebaseDB, 'rooms'),
                    roomWithUserId
                );
                
                console.log('Room saved to Firebase with ID:', docRef.id);
                console.log('Document reference:', docRef);
                
                // Immediately update local rooms object
                rooms[docRef.id] = { id: docRef.id, ...roomWithUserId };
                console.log('Updated local rooms object:', rooms);
                
                // Verify the document was actually saved by trying to read it back
                console.log('Verifying document was saved...');
                try {
                    const verifyQuery = window.firebaseServices.query(
                        window.firebaseServices.collection(window.firebaseDB, 'rooms'),
                        window.firebaseServices.where('__name__', '==', docRef.id)
                    );
                    const verifySnapshot = await window.firebaseServices.getDocs(verifyQuery);
                    console.log('Verification query result:', verifySnapshot.size, 'documents found');
                    
                    if (verifySnapshot.size > 0) {
                        const savedData = verifySnapshot.docs[0].data();
                        console.log('Verified saved data:', savedData);
                    } else {
                        console.warn('Document verification failed - document not found after save');
                    }
                } catch (verifyError) {
                    console.warn('Verification failed, but document was created:', verifyError);
                }
                
                return docRef.id;
            } catch (error) {
                console.error('Error saving room to Firebase:', error);
                console.error('Error details:', error.message, error.code);
                console.error('Error stack:', error.stack);
                
                // Check if it's a security rules error
                if (error.code === 'permission-denied') {
                    console.error('PERMISSION DENIED - Check Firebase security rules');
                    alert('Permission denied. Please check Firebase security rules.');
                }
                
                return null;
            }
        }

        // Update room in Firebase
        async function updateRoomInFirebase(roomId, roomData) {
            console.log('=== updateRoomInFirebase called ===');
            console.log('roomId:', roomId);
            console.log('roomData:', roomData);
            console.log('currentUserId:', currentUserId);
            console.log('firebaseDB available:', !!window.firebaseDB);
            console.log('firebaseServices available:', !!window.firebaseServices);
            
            if (!currentUserId || !dynamodb) {
                console.error('User not authenticated or Firebase not ready');
                console.error('currentUserId:', currentUserId);
                console.error('firebaseDB:', window.firebaseDB);
                console.error('firebaseServices:', window.firebaseServices);
                return false;
            }

            try {
                // Check if this roomId is actually a Firebase document ID
                // If not, we need to find the actual document ID by searching
                let actualRoomId = roomId;
                
                // If roomId doesn't look like a Firebase ID (not 20 characters), search for it
                if (roomId.length !== 20) {
                    console.log('RoomId does not look like a Firebase ID, searching for room...');
                    
                    // Search for the room by name and userId
                    const roomQuery = window.firebaseServices.query(
                        window.firebaseServices.collection(window.firebaseDB, 'rooms'),
                        window.firebaseServices.where('name', '==', roomData.name),
                        window.firebaseServices.where('userId', '==', currentUserId)
                    );
                    
                    const querySnapshot = await window.firebaseServices.getDocs(roomQuery);
                    
                    if (querySnapshot.size > 0) {
                        actualRoomId = querySnapshot.docs[0].id;
                        console.log('Found room in Firebase with ID:', actualRoomId);
                    } else {
                        console.log('Room not found in Firebase, creating new document...');
                        // Create new document with addDoc
                        const docRef = await window.firebaseServices.addDoc(
                            window.firebaseServices.collection(window.firebaseDB, 'rooms'),
                            {
                                ...roomData,
                                createdAt: new Date(),
                                updatedAt: new Date()
                            }
                        );
                        actualRoomId = docRef.id;
                        console.log('Created new room document with ID:', actualRoomId);
                        
                        // Update local rooms object with the new ID
                        rooms[actualRoomId] = { ...rooms[roomId], id: actualRoomId };
                        delete rooms[roomId];
                    }
                }
                
                console.log('Using actual room ID:', actualRoomId);
                const roomRef = window.firebaseServices.doc(window.firebaseDB, 'rooms', actualRoomId);
                console.log('Room reference created:', roomRef);
                
                const updateData = {
                    ...roomData,
                    updatedAt: new Date()
                };
                
                console.log('Attempting to save room in Firebase with data:', updateData);
                
                // Use setDoc with merge option to create or update the document
                await window.firebaseServices.setDoc(roomRef, updateData, { merge: true });
                
                console.log('Room saved successfully in Firebase:', actualRoomId);
                return true;
            } catch (error) {
                console.error('=== Error saving room in Firebase ===');
                console.error('Error object:', error);
                console.error('Error code:', error.code);
                console.error('Error message:', error.message);
                console.error('Error stack:', error.stack);
                console.error('Error name:', error.name);
                
                // Check for specific Firebase error codes
                if (error.code === 'permission-denied') {
                    console.error('Permission denied - check Firebase security rules');
                    console.error('This usually means the security rules are blocking the save');
                } else if (error.code === 'unavailable') {
                    console.error('Firebase service unavailable');
                    console.error('Firebase service is temporarily unavailable');
                } else if (error.code === 'invalid-argument') {
                    console.error('Invalid argument provided to setDoc');
                    console.error('Check if roomData contains invalid values');
                } else {
                    console.error('Unknown Firebase error occurred');
                }
                
                return false;
            }
        }

        // Delete room from Firebase
        async function deleteRoomFromFirebase(roomId) {
            if (!currentUserId || !dynamodb) {
                console.error('User not authenticated or Firebase not ready');
                return false;
            }

            try {
                // First, find the room in Firebase by name and userId
                const room = rooms[roomId];
                if (!room) {
                    console.error('Room not found in local data:', roomId);
                    return false;
                }

                console.log('Searching for room in Firebase to delete:', room.name);
                
                // Search for the room by name and userId
                const roomQuery = window.firebaseServices.query(
                    window.firebaseServices.collection(window.firebaseDB, 'rooms'),
                    window.firebaseServices.where('name', '==', room.name),
                    window.firebaseServices.where('userId', '==', currentUserId)
                );
                
                const querySnapshot = await window.firebaseServices.getDocs(roomQuery);
                console.log('Found', querySnapshot.size, 'matching rooms to delete');
                
                if (querySnapshot.size > 0) {
                    // Delete the first matching room document
                    const roomDoc = querySnapshot.docs[0];
                    const roomRef = window.firebaseServices.doc(window.firebaseDB, 'rooms', roomDoc.id);
                    await window.firebaseServices.deleteDoc(roomRef);
                    
                    console.log('Room deleted from Firebase:', roomDoc.id, 'Name:', room.name);
                    return true;
                } else {
                    console.error('Room not found in Firebase:', room.name);
                    return false;
                }
            } catch (error) {
                console.error('Error deleting room from Firebase:', error);
                return false;
            }
        }

        // Initialize sample data if no rooms exist
        async function initializeSampleRooms() {
            console.log('=== initializeSampleRooms called ===');
            console.log('currentUserId:', currentUserId);
            console.log('rooms object keys:', Object.keys(rooms));
            console.log('rooms object length:', Object.keys(rooms).length);
            
            if (!currentUserId) {
                console.log('Skipping sample room initialization - user not authenticated');
                return; // User not authenticated
            }
            
            if (Object.keys(rooms).length > 0) {
                console.log('Skipping sample room initialization - rooms already exist');
                return; // Rooms already exist
            }

            const sampleRooms = [
                {
                    name: 'Living Room',
                    type: 'living-room',
                    dimensions: '15\' x 18\'',
                    floor: 'first',
                    details: [
                        { type: 'flooring', description: 'Hardwood Oak', spec: '3/4 inch, Natural finish', date: '2022-03-15' },
                        { type: 'lighting', description: 'Recessed LED', spec: '8 fixtures, Dimmable', date: '2022-03-15' },
                        { type: 'blinds', description: 'Cellular Shades', spec: 'Inside mount, 48" x 72", Light filtering', date: '2022-03-15' }
                    ]
                },
                {
                    name: 'Master Bedroom',
                    type: 'bedroom',
                    dimensions: '14\' x 16\'',
                    floor: 'second',
                    details: [
                        { type: 'flooring', description: 'Carpet', spec: 'Berber, Beige', date: '2021-08-10' },
                        { type: 'blinds', description: 'Roman Shades', spec: 'Inside mount, 36" x 60", Blackout fabric', date: '2021-08-10' }
                    ]
                }
            ];

            for (const sampleRoom of sampleRooms) {
                await saveRoomToFirebase(sampleRoom);
            }
            
            // Reload rooms after adding samples
            await loadRoomsFromFirebase();
        }

        function showRoomDetails() {
            console.log('=== showRoomDetails called ===');
            const roomSelect = document.getElementById('roomSelect');
            const selectedRoom = roomSelect.value;
            console.log('Selected room:', selectedRoom);
            const container = document.getElementById('roomDetailsContainer');
            const roomName = document.getElementById('currentRoomName');
            const detailsList = document.getElementById('roomDetailsList');

            if (!selectedRoom || !rooms[selectedRoom]) {
                console.log('No room selected or room not found in rooms object');
                container.style.display = 'none';
                currentEditingRoom = null; // Clear current editing room
                return;
            }

            const room = rooms[selectedRoom];
            console.log('Room object:', room);
            console.log('Available rooms:', Object.keys(rooms));
            roomName.textContent = room.name;
            container.style.display = 'block';
            
            // Set currentEditingRoom to the selected room
            currentEditingRoom = selectedRoom;
            console.log('currentEditingRoom set to:', currentEditingRoom);

            // Clear and populate room details
            detailsList.innerHTML = '';
            
            // Ensure room.details exists and is an array
            if (!room.details || !Array.isArray(room.details)) {
                room.details = [];
            }
            
            if (room.details.length > 0) {
                room.details.forEach((detail, index) => {
                    const detailItem = document.createElement('div');
                    detailItem.className = 'room-detail-item';
                    
                    // Format the detail type for display
                    const displayType = detail.type ? detail.type.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase()) : 'Unknown';
                    
                    detailItem.innerHTML = `
                        <div class="detail-field">
                            <div class="detail-label">${displayType}</div>
                            <div class="detail-value">${detail.description || 'No description'}</div>
                        </div>
                        <div class="detail-field">
                            <div class="detail-label">Specification</div>
                            <div class="detail-value">${detail.spec || 'Not specified'}</div>
                        </div>
                        <div class="detail-field">
                            <div class="detail-label">Date</div>
                            <div class="detail-value">${detail.date || 'Not specified'}</div>
                        </div>
                        ${detail.notes ? `
                        <div class="detail-field">
                            <div class="detail-label">Notes</div>
                            <div class="detail-value">${detail.notes}</div>
                        </div>
                        ` : ''}
                        <div class="detail-actions">
                            <button class="action-icon edit" onclick="editRoomDetail('${selectedRoom}', ${index})"><i class="fas fa-edit"></i></button>
                            <button class="action-icon delete" onclick="deleteRoomDetail('${selectedRoom}', ${index})"><i class="fas fa-trash"></i></button>
                        </div>
                    `;
                    detailsList.appendChild(detailItem);
                });
            } else {
                detailsList.innerHTML = '<p>No details added yet. Click "Add Room Detail" to get started.</p>';
            }
        }

        function openAddRoomModal() {
            document.getElementById('addRoomModal').classList.add('show');
        }

        function closeRoomModal() {
            document.getElementById('addRoomModal').classList.remove('show');
            document.getElementById('addRoomForm').reset();
        }

        function openRoomDetailModal(roomId = null, detailIndex = null) {
            currentEditingRoom = roomId;
            currentEditingDetail = detailIndex;
            
            if (roomId && detailIndex !== null && rooms[roomId] && rooms[roomId].details[detailIndex]) {
                const detail = rooms[roomId].details[detailIndex];
                document.getElementById('detailType').value = detail.type;
                document.getElementById('detailDescription').value = detail.description;
                document.getElementById('detailSpec').value = detail.spec || '';
                document.getElementById('detailDate').value = detail.date || '';
                document.getElementById('detailNotes').value = detail.notes || '';
            }
            
            document.getElementById('roomDetailModal').classList.add('show');
        }

        function closeRoomDetailModal() {
            document.getElementById('roomDetailModal').classList.remove('show');
            document.getElementById('roomDetailForm').reset();
            currentEditingRoom = null;
            currentEditingDetail = null;
        }

        function addRoomDetail() {
            const roomSelect = document.getElementById('roomSelect');
            const selectedRoom = roomSelect.value;
            if (!selectedRoom) {
                alert('Please select a room first!');
                return;
            }
            openRoomDetailModal(selectedRoom);
        }

        function editRoomDetail(roomId, detailIndex) {
            openRoomDetailModal(roomId, detailIndex);
        }

        async function deleteRoomDetail(roomId, detailIndex) {
            if (confirm('Are you sure you want to delete this room detail?')) {
                try {
                    // Remove from local data
                    rooms[roomId].details.splice(detailIndex, 1);
                    
                    // Update room in Firebase with removed detail
                    const roomData = {
                        name: rooms[roomId].name,
                        type: rooms[roomId].type,
                        dimensions: rooms[roomId].dimensions,
                        floor: rooms[roomId].floor,
                        notes: rooms[roomId].notes,
                        details: rooms[roomId].details,
                        userId: currentUserId // Add userId to ensure proper Firebase update
                    };
                    
                    const success = await updateRoomInFirebase(roomId, roomData);
                    if (success) {
                        showRoomDetails(); // Refresh the display
                        console.log('Room detail deleted and auto-saved successfully');
                    } else {
                        alert('Error deleting room detail. Please try again.');
                    }
                } catch (error) {
                    console.error('Error deleting room detail:', error);
                    alert('Error deleting room detail. Please try again.');
                }
            }
        }

        function editRoomInfo() {
            const roomSelect = document.getElementById('roomSelect');
            const selectedRoom = roomSelect.value;
            if (!selectedRoom) return;
            
            const room = rooms[selectedRoom];
            document.getElementById('roomName').value = room.name;
            document.getElementById('roomType').value = room.type;
            document.getElementById('roomDimensions').value = room.dimensions || '';
            document.getElementById('roomFloor').value = room.floor || '';
            document.getElementById('roomNotes').value = room.notes || '';
            
            currentEditingRoom = selectedRoom;
            openAddRoomModal();
            
            // Add automatic saving for room form fields
            setupRoomFormAutoSave();
        }

        // Setup automatic saving for room form fields
        function setupRoomFormAutoSave() {
            const roomForm = document.getElementById('addRoomForm');
            if (!roomForm) return;
            
            // Remove existing listeners to avoid duplicates
            const newForm = roomForm.cloneNode(true);
            roomForm.parentNode.replaceChild(newForm, roomForm);
            
            // Add input event listeners for automatic saving
            const inputs = newForm.querySelectorAll('input, textarea, select');
            inputs.forEach(input => {
                input.addEventListener('input', debounce(() => {
                    if (currentEditingRoom) {
                        autoSaveRoomInfo();
                    }
                }, 1000)); // Save after 1 second of inactivity
            });
        }

        // Debounce function to prevent too many saves
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Automatically save room information
        async function autoSaveRoomInfo() {
            if (!currentEditingRoom || !rooms[currentEditingRoom]) return;
            
            const roomName = document.getElementById('roomName')?.value || '';
            const roomType = document.getElementById('roomType')?.value || '';
            const roomDimensions = document.getElementById('roomDimensions')?.value || '';
            const roomFloor = document.getElementById('roomFloor')?.value || '';
            const roomNotes = document.getElementById('roomNotes')?.value || '';
            
            // Update local room data
            rooms[currentEditingRoom] = {
                ...rooms[currentEditingRoom],
                name: roomName,
                type: roomType,
                dimensions: roomDimensions,
                floor: roomFloor,
                notes: roomNotes
            };
            
            // Save to Firebase
            try {
                const roomData = {
                    name: roomName,
                    type: roomType,
                    dimensions: roomDimensions,
                    floor: roomFloor,
                    notes: roomNotes,
                    details: rooms[currentEditingRoom].details || [],
                    userId: currentUserId
                };
                
                const success = await updateRoomInFirebase(currentEditingRoom, roomData);
                if (success) {
                    console.log('Room info auto-saved successfully');
                } else {
                    console.error('Failed to auto-save room info');
                }
            } catch (error) {
                console.error('Error auto-saving room info:', error);
            }
        }

        async function deleteRoom() {
            const roomSelect = document.getElementById('roomSelect');
            const selectedRoom = roomSelect.value;
            if (!selectedRoom) return;
            
            if (confirm('Are you sure you want to delete this entire room and all its details?')) {
                try {
                    const success = await deleteRoomFromFirebase(selectedRoom);
                    if (success) {
                        // Remove from local data
                        delete rooms[selectedRoom];
                        
                        // Remove from select dropdown
                        const option = roomSelect.querySelector(`option[value="${selectedRoom}"]`);
                        if (option) option.remove();
                        
                        // Reset selection
                        roomSelect.value = '';
                        document.getElementById('roomDetailsContainer').style.display = 'none';
                        
                        alert('Room deleted successfully!');
                    } else {
                        alert('Error deleting room. Please try again.');
                    }
                } catch (error) {
                    console.error('Error deleting room:', error);
                    alert('Error deleting room. Please try again.');
                }
            }
        }

        let currentEditingRoom = null;
        let currentEditingDetail = null;



        function updateDetailForm() {
            const detailType = document.getElementById('detailType').value;
            const dynamicFields = document.getElementById('dynamicFormFields');
            
            // Clear existing fields
            dynamicFields.innerHTML = '';
            
            // Base fields for all types
            let baseFields = `
                <div class="form-group">
                    <label for="detailDescription">Description</label>
                    <input type="text" id="detailDescription" placeholder="Enter description..." required>
                </div>
                <div class="form-group">
                    <label for="detailDate">Installation/Update Date</label>
                    <input type="date" id="detailDate">
                </div>
                <div class="form-group">
                    <label for="detailNotes">Additional Notes</label>
                    <textarea id="detailNotes" placeholder="Any additional information..."></textarea>
                </div>
            `;
            
            // Add specific fields based on detail type
            let specificFields = '';
            
            switch(detailType) {
                case 'blinds':
                    specificFields = `
                        <div class="form-group">
                            <label for="blindType">Blind Type</label>
                            <select id="blindType">
                                <option value="">Select type...</option>
                                <option value="cellular">Cellular/Honeycomb</option>
                                <option value="roman">Roman Shades</option>
                                <option value="roller">Roller Shades</option>
                                <option value="venetian">Venetian Blinds</option>
                                <option value="faux-wood">Faux Wood</option>
                                <option value="real-wood">Real Wood</option>
                                <option value="aluminum">Aluminum</option>
                                <option value="vertical">Vertical Blinds</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="mountType">Mount Type</label>
                            <select id="mountType">
                                <option value="">Select mount...</option>
                                <option value="inside">Inside Mount</option>
                                <option value="outside">Outside Mount</option>
                                <option value="ceiling">Ceiling Mount</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="blindDimensions">Dimensions</label>
                            <input type="text" id="blindDimensions" placeholder="e.g., 48\" x 72\"" >
                        </div>
                        <div class="form-group">
                            <label for="blindColor">Color/Material</label>
                            <input type="text" id="blindColor" placeholder="e.g., White, Light filtering">
                        </div>
                        <div class="form-group">
                            <label for="blindControl">Control Type</label>
                            <select id="blindControl">
                                <option value="">Select control...</option>
                                <option value="cord">Cord Control</option>
                                <option value="wand">Wand Control</option>
                                <option value="motorized">Motorized</option>
                                <option value="smart">Smart/App Control</option>
                            </select>
                        </div>
                    `;
                    break;
                    
                case 'curtains':
                    specificFields = `
                        <div class="form-group">
                            <label for="curtainType">Curtain Type</label>
                            <select id="curtainType">
                                <option value="">Select type...</option>
                                <option value="sheer">Sheer Panels</option>
                                <option value="thermal">Thermal/Insulated</option>
                                <option value="blackout">Blackout</option>
                                <option value="cafe">Cafe Curtains</option>
                                <option value="valance">Valance</option>
                                <option value="drapes">Drapes</option>
                                <option value="panels">Decorative Panels</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="curtainMount">Mount Type</label>
                            <select id="curtainMount">
                                <option value="">Select mount...</option>
                                <option value="inside">Inside Mount</option>
                                <option value="outside">Outside Mount</option>
                                <option value="ceiling">Ceiling Mount</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="curtainDimensions">Dimensions</label>
                            <input type="text" id="curtainDimensions" placeholder="e.g., 54\" x 84\"" >
                        </div>
                        <div class="form-group">
                            <label for="curtainColor">Color/Pattern</label>
                            <input type="text" id="curtainColor" placeholder="e.g., Ivory, Floral pattern">
                        </div>
                        <div class="form-group">
                            <label for="curtainFabric">Fabric Type</label>
                            <input type="text" id="curtainFabric" placeholder="e.g., Polyester, Linen blend">
                        </div>
                        <div class="form-group">
                            <label for="curtainHardware">Hardware</label>
                            <input type="text" id="curtainHardware" placeholder="e.g., Brass rod, Ring clips">
                        </div>
                    `;
                    break;
                    
                case 'crown-molding':
                    specificFields = `
                        <div class="form-group">
                            <label for="crownStyle">Crown Style</label>
                            <select id="crownStyle">
                                <option value="">Select style...</option>
                                <option value="classic">Classic</option>
                                <option value="modern">Modern</option>
                                <option value="colonial">Colonial</option>
                                <option value="victorian">Victorian</option>
                                <option value="craftsman">Craftsman</option>
                                <option value="minimalist">Minimalist</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="crownHeight">Height</label>
                            <input type="text" id="crownHeight" placeholder="e.g., 4-1/4\"" >
                        </div>
                        <div class="form-group">
                            <label for="crownMaterial">Material</label>
                            <select id="crownMaterial">
                                <option value="">Select material...</option>
                                <option value="mdf">MDF (Primed)</option>
                                <option value="pine">Pine</option>
                                <option value="oak">Oak</option>
                                <option value="poplar">Poplar</option>
                                <option value="polyurethane">Polyurethane</option>
                                <option value="plaster">Plaster</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="crownFinish">Finish</label>
                            <input type="text" id="crownFinish" placeholder="e.g., White painted, Stained oak">
                        </div>
                    `;
                    break;
                    
                case 'baseboards':
                    specificFields = `
                        <div class="form-group">
                            <label for="baseboardHeight">Height</label>
                            <input type="text" id="baseboardHeight" placeholder="e.g., 5-1/4\"" >
                        </div>
                        <div class="form-group">
                            <label for="baseboardStyle">Style</label>
                            <select id="baseboardStyle">
                                <option value="">Select style...</option>
                                <option value="standard">Standard</option>
                                <option value="slim">Slim</option>
                                <option value="colonial">Colonial</option>
                                <option value="modern">Modern</option>
                                <option value="tall">Tall</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="baseboardMaterial">Material</label>
                            <select id="baseboardMaterial">
                                <option value="">Select material...</option>
                                <option value="mdf">MDF</option>
                                <option value="pine">Pine</option>
                                <option value="oak">Oak</option>
                                <option value="poplar">Poplar</option>
                                <option value="tile">Tile</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="baseboardFinish">Finish</label>
                            <input type="text" id="baseboardFinish" placeholder="e.g., White painted, Stained">
                        </div>
                    `;
                    break;
                    
                case 'paint':
                    specificFields = `
                        <div class="form-group">
                            <label for="paintBrand">Paint Brand</label>
                            <select id="paintBrand">
                                <option value="">Select brand...</option>
                                <option value="sherwin-williams">Sherwin Williams</option>
                                <option value="benjamin-moore">Benjamin Moore</option>
                                <option value="valspar">Valspar</option>
                                <option value="behr">Behr</option>
                                <option value="ppg">PPG</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="paintColor">Color Name/Code</label>
                            <input type="text" id="paintColor" placeholder="e.g., SW 7008 Alabaster">
                        </div>
                        <div class="form-group">
                            <label for="paintFinish">Finish</label>
                                <select id="paintFinish">
                                    <option value="">Select finish...</option>
                                    <option value="flat">Flat</option>
                                    <option value="eggshell">Eggshell</option>
                                    <option value="satin">Satin</option>
                                    <option value="semi-gloss">Semi-Gloss</option>
                                    <option value="gloss">Gloss</option>
                                    <option value="matte">Matte</option>
                                </select>
                        </div>
                        <div class="form-group">
                            <label for="paintSurface">Surface</label>
                            <input type="text" id="paintSurface" placeholder="e.g., Walls, Ceiling, Trim">
                        </div>
                    `;
                    break;
                    
                case 'windows':
                    specificFields = `
                        <div class="form-group">
                            <label for="windowType">Window Type</label>
                            <select id="windowType">
                                <option value="">Select type...</option>
                                <option value="double-hung">Double Hung</option>
                                <option value="single-hung">Single Hung</option>
                                <option value="casement">Casement</option>
                                <option value="awning">Awning</option>
                                <option value="slider">Slider</option>
                                <option value="picture">Picture</option>
                                <option value="bay">Bay</option>
                                <option value="bow">Bow</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="windowDimensions">Dimensions</label>
                            <input type="text" id="windowDimensions" placeholder="e.g., 36\" x 60\"" >
                        </div>
                        <div class="form-group">
                            <label for="windowMaterial">Frame Material</label>
                            <select id="windowMaterial">
                                <option value="">Select material...</option>
                                <option value="vinyl">Vinyl</option>
                                <option value="aluminum">Aluminum</option>
                                <option value="wood">Wood</option>
                                <option value="fiberglass">Fiberglass</option>
                                <option value="composite">Composite</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="windowGlazing">Glazing</label>
                            <select id="windowGlazing">
                                <option value="">Select glazing...</option>
                                <option value="single-pane">Single Pane</option>
                                <option value="double-pane">Double Pane</option>
                                <option value="triple-pane">Triple Pane</option>
                                <option value="low-e">Low-E</option>
                                <option value="tinted">Tinted</option>
                            </select>
                        </div>
                    `;
                    break;
                    
                default:
                    // For other types, use the standard specification field
                    specificFields = `
                        <div class="form-group">
                            <label for="detailSpec">Specification</label>
                            <input type="text" id="detailSpec" placeholder="Enter specifications...">
                        </div>
                    `;
            }
            
            dynamicFields.innerHTML = baseFields + specificFields;
        }

        // Handle room form submission
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOMContentLoaded - Setting up room form listener');
            const addRoomForm = document.getElementById('addRoomForm');
            console.log('addRoomForm element found:', addRoomForm);
            
            if (!addRoomForm) {
                console.error('addRoomForm element not found!');
                return;
            }
            
            addRoomForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                console.log('Room form submitted!');
                
                const roomNameElement = document.getElementById('roomName');
                const roomTypeElement = document.getElementById('roomType');
                const roomDimensionsElement = document.getElementById('roomDimensions');
                const roomFloorElement = document.getElementById('roomFloor');
                const roomNotesElement = document.getElementById('roomNotes');
                
                console.log('Form elements found:', {
                    roomName: !!roomNameElement,
                    roomType: !!roomTypeElement,
                    roomDimensions: !!roomDimensionsElement,
                    roomFloor: !!roomFloorElement,
                    roomNotes: !!roomNotesElement
                });
                
                const roomName = roomNameElement ? roomNameElement.value : '';
                const roomType = roomTypeElement ? roomTypeElement.value : '';
                const roomDimensions = roomDimensionsElement ? roomDimensionsElement.value : '';
                const roomFloor = roomFloorElement ? roomFloorElement.value : '';
                const roomNotes = roomNotesElement ? roomNotesElement.value : '';
                
                console.log('Form values:', { roomName, roomType, roomDimensions, roomFloor, roomNotes });
                
                const roomData = {
                    name: roomName,
                    type: roomType,
                    dimensions: roomDimensions,
                    floor: roomFloor,
                    notes: roomNotes,
                    details: currentEditingRoom ? rooms[currentEditingRoom].details : [],
                    userId: currentUserId // Add userId to ensure proper Firebase operations
                };
                
                console.log('Room data to save:', roomData);
                console.log('currentEditingRoom:', currentEditingRoom);
                console.log('currentUserId check:', currentUserId);
                console.log('Firebase services check:', !!window.firebaseServices);
                console.log('Firebase DB check:', !!window.firebaseDB);
                
                try {
                    if (currentEditingRoom) {
                        console.log('Updating existing room...');
                        
                        // Find the room in Firebase and update it directly
                        const roomQuery = window.firebaseServices.query(
                            window.firebaseServices.collection(window.firebaseDB, 'rooms'),
                            window.firebaseServices.where('name', '==', roomData.name),
                            window.firebaseServices.where('userId', '==', currentUserId)
                        );
                        
                        const querySnapshot = await window.firebaseServices.getDocs(roomQuery);
                        
                        if (querySnapshot.size > 0) {
                            const roomDoc = querySnapshot.docs[0];
                            const roomRef = window.firebaseServices.doc(window.firebaseDB, 'rooms', roomDoc.id);
                            
                            await window.firebaseServices.updateDoc(roomRef, {
                                ...roomData,
                                updatedAt: new Date()
                            });
                            
                            console.log('Room updated successfully in Firebase');
                            
                            // Reload rooms to ensure data consistency
                            await loadRoomsFromFirebase();
                            showRoomDetails(); // Refresh display
                            console.log('Room updated and auto-saved successfully');
                        } else {
                            alert('Room not found in Firebase. Please try again.');
                        }
                    } else {
                        console.log('Adding new room...');
                        // Add new room to Firebase
                        const newRoomId = await saveRoomToFirebase(roomData);
                        console.log('saveRoomToFirebase returned:', newRoomId);
                        
                        if (newRoomId) {
                            console.log('Room saved successfully, adding to local rooms object');
                            
                            // Add the new room to the local rooms object immediately
                            rooms[newRoomId] = {
                                id: newRoomId,
                                ...roomData,
                                details: roomData.details || []
                            };
                            
                            console.log('Added room to local object:', rooms[newRoomId]);
                            
                            // Add to dropdown immediately
                            const roomSelect = document.getElementById('roomSelect');
                            if (roomSelect) {
                                const option = document.createElement('option');
                                option.value = newRoomId;
                                option.textContent = roomData.name;
                                roomSelect.appendChild(option);
                                console.log('Added option to dropdown immediately:', option.value, option.textContent);
                                
                                // Select the newly created room
                                roomSelect.value = newRoomId;
                                showRoomDetails();
                            }
                            
                            console.log('Room created and auto-saved successfully');
                        } else {
                            console.log('Failed to save room to Firebase');
                            alert('Error adding room. Please try again.');
                        }
                    }
                } catch (error) {
                    console.error('Error saving room:', error);
                    alert('Error saving room. Please try again.');
                }
                
                closeRoomModal();
                currentEditingRoom = null;
            });

            // Handle room detail form submission
            document.getElementById('roomDetailForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                console.log('Room detail form submitted!');
                
                // Get basic form data
                const detailType = document.getElementById('detailType').value;
                const detailDescription = document.getElementById('detailDescription').value;
                const detailSpec = document.getElementById('detailSpec').value;
                const detailDate = document.getElementById('detailDate').value;
                const detailNotes = document.getElementById('detailNotes').value;
                
                console.log('Form values:', { detailType, detailDescription, detailSpec, detailDate, detailNotes });
                
                // Validate required fields
                if (!detailType || !detailDescription) {
                    alert('Please fill in the detail type and description.');
                    return;
                }
                
                // Check if room is selected
                if (!currentEditingRoom) {
                    alert('No room selected. Please select a room first.');
                    return;
                }
                
                // Check if room exists
                if (!rooms[currentEditingRoom]) {
                    alert('Selected room not found. Please refresh and try again.');
                    return;
                }
                
                // Create simple detail object
                const detail = {
                    type: detailType,
                    description: detailDescription,
                    spec: detailSpec,
                    date: detailDate,
                    notes: detailNotes
                };
                
                console.log('Created detail object:', detail);
                
                try {
                    // Ensure room has details array
                    if (!rooms[currentEditingRoom].details) {
                        rooms[currentEditingRoom].details = [];
                    }
                    
                    // Add detail to room
                    rooms[currentEditingRoom].details.push(detail);
                    console.log('Added detail to room. Total details:', rooms[currentEditingRoom].details.length);
                    
                    // First, let's find the actual Firebase document ID for this room
                    console.log('Searching for room in Firebase...');
                    console.log('Room name:', rooms[currentEditingRoom].name);
                    console.log('Current room ID:', currentEditingRoom);
                    
                    // Search for the room by name and userId
                    const roomQuery = window.firebaseServices.query(
                        window.firebaseServices.collection(window.firebaseDB, 'rooms'),
                        window.firebaseServices.where('name', '==', rooms[currentEditingRoom].name),
                        window.firebaseServices.where('userId', '==', currentUserId)
                    );
                    
                    const querySnapshot = await window.firebaseServices.getDocs(roomQuery);
                    console.log('Found', querySnapshot.size, 'matching rooms');
                    
                    let roomDocId = null;
                    if (querySnapshot.size > 0) {
                        roomDocId = querySnapshot.docs[0].id;
                        console.log('Found existing room document with ID:', roomDocId);
                        
                        // Update the existing room document
                        const roomRef = window.firebaseServices.doc(window.firebaseDB, 'rooms', roomDocId);
                        await window.firebaseServices.updateDoc(roomRef, {
                            details: rooms[currentEditingRoom].details,
                            updatedAt: new Date()
                        });
                        
                        console.log('Updated existing room document successfully');
                    } else {
                        console.log('Room not found in Firebase, creating new room document...');
                        
                        // Create new room document
                        const roomData = {
                            name: rooms[currentEditingRoom].name,
                            type: rooms[currentEditingRoom].type,
                            details: rooms[currentEditingRoom].details,
                            userId: currentUserId,
                            createdAt: new Date(),
                            updatedAt: new Date()
                        };
                        
                        const docRef = await window.firebaseServices.addDoc(
                            window.firebaseServices.collection(window.firebaseDB, 'rooms'),
                            roomData
                        );
                        
                        roomDocId = docRef.id;
                        console.log('Created new room document with ID:', roomDocId);
                        
                        // Update local rooms object with the new Firebase ID
                        rooms[roomDocId] = { ...rooms[currentEditingRoom], id: roomDocId };
                        delete rooms[currentEditingRoom];
                        currentEditingRoom = roomDocId;
                    }
                    
                    // Refresh the display
                    closeRoomDetailModal();
                    showRoomDetails();
                    console.log('Room detail added and auto-saved successfully');
                    
                } catch (error) {
                    console.error('ERROR in room detail save:', error);
                    alert('Error saving room detail: ' + error.message);
                }
            });
        });

    </script>

    <!-- Add Room Modal -->
    <div id="addRoomModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Add New Room</h3>
                <button class="close-modal" onclick="closeRoomModal()">&times;</button>
            </div>
            <form id="addRoomForm">
                <div class="form-group">
                    <label for="roomName">Room Name</label>
                    <input type="text" id="roomName" placeholder="e.g., Master Bedroom" required>
                </div>
                <div class="form-group">
                    <label for="roomType">Room Type</label>
                    <select id="roomType" required>
                        <option value="">Select room type...</option>
                        <option value="bedroom">Bedroom</option>
                        <option value="bathroom">Bathroom</option>
                        <option value="kitchen">Kitchen</option>
                        <option value="living-room">Living Room</option>
                        <option value="dining-room">Dining Room</option>
                        <option value="office">Office/Study</option>
                        <option value="garage">Garage</option>
                        <option value="basement">Basement</option>
                        <option value="attic">Attic</option>
                        <option value="laundry">Laundry Room</option>
                        <option value="closet">Closet</option>
                        <option value="pantry">Pantry</option>
                        <option value="mudroom">Mudroom</option>
                        <option value="sunroom">Sunroom</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="roomDimensions">Dimensions</label>
                    <input type="text" id="roomDimensions" placeholder="e.g., 12' x 14'">
                </div>
                <div class="form-group">
                    <label for="roomFloor">Floor Level</label>
                    <select id="roomFloor">
                        <option value="">Select floor...</option>
                        <option value="basement">Basement</option>
                        <option value="ground">Ground Floor</option>
                        <option value="first">First Floor</option>
                        <option value="second">Second Floor</option>
                        <option value="third">Third Floor</option>
                        <option value="attic">Attic</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="roomNotes">Notes</label>
                    <textarea id="roomNotes" placeholder="Additional information about this room..."></textarea>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeRoomModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Room</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Room Detail Modal -->
    <div id="roomDetailModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Add/Edit Room Detail</h3>
                <button class="close-modal" onclick="closeRoomDetailModal()">&times;</button>
            </div>
            <form id="roomDetailForm">
                <div class="form-group">
                    <label for="detailType">Detail Type</label>
                    <select id="detailType" required onchange="updateDetailForm()">
                        <option value="">Select detail type...</option>
                        <option value="flooring">Flooring</option>
                        <option value="walls">Walls</option>
                        <option value="ceiling">Ceiling</option>
                        <option value="lighting">Lighting</option>
                        <option value="windows">Windows</option>
                        <option value="window-treatments">Window Treatments</option>
                        <option value="blinds">Blinds</option>
                        <option value="curtains">Curtains</option>
                        <option value="trim">Trim & Molding</option>
                        <option value="crown-molding">Crown Molding</option>
                        <option value="baseboards">Baseboards</option>
                        <option value="door-trim">Door Trim</option>
                        <option value="window-trim">Window Trim</option>
                        <option value="outlets">Electrical Outlets</option>
                        <option value="heating">Heating/Cooling</option>
                        <option value="plumbing">Plumbing</option>
                        <option value="fixtures">Fixtures</option>
                        <option value="storage">Storage</option>
                        <option value="dimensions">Measurements</option>
                        <option value="paint">Paint Colors</option>
                        <option value="texture">Wall Texture</option>
                        <option value="hardware">Hardware</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                
                <!-- Dynamic form fields based on detail type -->
                <div id="dynamicFormFields">
                    <div class="form-group">
                        <label for="detailDescription">Description</label>
                        <input type="text" id="detailDescription" placeholder="e.g., Hardwood Oak" required>
                    </div>
                    <div class="form-group">
                        <label for="detailSpec">Specification</label>
                        <input type="text" id="detailSpec" placeholder="e.g., 3/4 inch, Natural finish">
                    </div>
                    <div class="form-group">
                        <label for="detailDate">Installation/Update Date</label>
                        <input type="date" id="detailDate">
                    </div>
                    <div class="form-group">
                        <label for="detailNotes">Additional Notes</label>
                        <textarea id="detailNotes" placeholder="Any additional information..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeRoomDetailModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Detail</button>
                </div>
            </form>
        </div>
    </div>

    </script>
</body>
</html>
