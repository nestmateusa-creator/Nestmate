<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Floor Plan Designer - NestMate</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Inter', sans-serif;
      background: #1a1a1a;
      color: white;
      overflow: hidden;
    }
    
    .designer-header {
      background: #2d2d2d;
      padding: 15px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid #444;
    }
    
    .designer-title {
      font-size: 18px;
      font-weight: 600;
      color: #8b5cf6;
    }
    
    .designer-controls {
      display: flex;
      gap: 10px;
      align-items: center;
    }
    
    .control-btn {
      background: #8b5cf6;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      transition: background 0.2s;
    }
    
    .control-btn:hover {
      background: #7c3aed;
    }
    
    .control-btn.secondary {
      background: #444;
    }
    
    .control-btn.secondary:hover {
      background: #555;
    }
    
    .designer-content {
      display: flex;
      height: calc(100vh - 70px);
    }
    
    .toolbar {
      width: 200px;
      background: #2d2d2d;
      border-right: 1px solid #444;
      padding: 20px;
      overflow-y: auto;
    }
    
    .tool-section {
      margin-bottom: 25px;
    }
    
    .tool-section h3 {
      color: #8b5cf6;
      font-size: 14px;
      margin-bottom: 10px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .tool-btn {
      width: 100%;
      background: #444;
      color: white;
      border: none;
      padding: 12px;
      border-radius: 6px;
      cursor: pointer;
      margin-bottom: 8px;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .tool-btn:hover {
      background: #555;
    }
    
    .tool-btn.active {
      background: #8b5cf6;
    }
    
    .canvas-container {
      flex: 1;
      position: relative;
      overflow: auto;
      background: #f8f9fa;
    }
    
    #floorPlanCanvas {
      display: block;
      background: white;
      cursor: crosshair;
      background-image: 
        linear-gradient(rgba(0,0,0,0.1) 1px, transparent 1px),
        linear-gradient(90deg, rgba(0,0,0,0.1) 1px, transparent 1px);
      background-size: 20px 20px;
    }
    
    .stats {
      position: absolute;
      top: 10px;
      right: 10px;
      background: rgba(0,0,0,0.8);
      padding: 10px;
      border-radius: 6px;
      font-size: 12px;
    }
    
    .room-templates {
      margin-top: 20px;
    }
    
    .template-item {
      background: #444;
      padding: 10px;
      border-radius: 6px;
      margin-bottom: 8px;
      cursor: pointer;
      transition: background 0.2s;
      text-align: center;
    }
    
    .template-item:hover {
      background: #555;
    }
    
    .template-icon {
      font-size: 20px;
      margin-bottom: 5px;
      color: #8b5cf6;
    }
    
    .template-name {
      font-size: 12px;
    }
    
    .style-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 5px;
      margin-bottom: 10px;
    }
    
    .style-item {
      background: #444;
      padding: 8px;
      border-radius: 4px;
      cursor: pointer;
      transition: background 0.2s;
      text-align: center;
      min-height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .style-item:hover {
      background: #555;
    }
    
    .style-icon {
      font-size: 16px;
    }
    
    .save-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.8);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    
    .save-modal-content {
      background: #2d2d2d;
      padding: 30px;
      border-radius: 12px;
      width: 400px;
      max-width: 90%;
    }
    
    .save-modal h2 {
      color: #8b5cf6;
      margin-bottom: 20px;
      text-align: center;
    }
    
    .save-modal input {
      width: 100%;
      padding: 12px;
      border: 1px solid #444;
      border-radius: 6px;
      background: #444;
      color: white;
      margin-bottom: 15px;
    }
    
    .save-modal input::placeholder {
      color: #888;
    }
    
    .save-modal-buttons {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
    }
  </style>
</head>
<body>
  <div class="designer-header">
    <div class="designer-title">
      <i class="fas fa-drafting-compass"></i> Floor Plan Designer
    </div>
    <div class="designer-controls">
      <button class="control-btn secondary" onclick="toggle3D()">
        <i class="fas fa-cube"></i> 3D View
      </button>
      <button class="control-btn secondary" onclick="clearCanvas()">
        <i class="fas fa-trash"></i> Clear
      </button>
      <button class="control-btn secondary" onclick="exportFloorPlan()">
        <i class="fas fa-download"></i> Export
      </button>
      <button class="control-btn" onclick="showSaveModal()">
        <i class="fas fa-save"></i> Save
      </button>
    </div>
  </div>
  
  <div class="designer-content">
    <div class="toolbar">
      <div class="tool-section">
        <h3>Drawing Tools</h3>
        <button class="tool-btn active" onclick="setTool('wall')">
          <i class="fas fa-minus"></i> Wall
        </button>
        <button class="tool-btn" onclick="setTool('curved_wall')">
          <i class="fas fa-circle"></i> Curved Wall
        </button>
        <button class="tool-btn" onclick="setTool('dimension')">
          <i class="fas fa-ruler"></i> Dimension
        </button>
        <button class="tool-btn" onclick="setTool('select')">
          <i class="fas fa-mouse-pointer"></i> Select
        </button>
        <button class="tool-btn" onclick="setTool('room')">
          <i class="fas fa-home"></i> Room
        </button>
        <button class="tool-btn" onclick="setTool('text')">
          <i class="fas fa-font"></i> Text
        </button>
      </div>
      
      <div class="tool-section">
        <h3>Doors & Windows</h3>
        <div class="style-grid">
          <div class="style-item" onclick="addDoor('standard')" title="Standard Door">
            <div class="style-icon"><i class="fas fa-door-open"></i></div>
          </div>
          <div class="style-item" onclick="addDoor('double')" title="Double Door">
            <div class="style-icon"><i class="fas fa-door-closed"></i></div>
          </div>
          <div class="style-item" onclick="addDoor('sliding')" title="Sliding Door">
            <div class="style-icon"><i class="fas fa-arrows-alt-h"></i></div>
          </div>
          <div class="style-item" onclick="addWindow('standard')" title="Standard Window">
            <div class="style-icon"><i class="fas fa-window-maximize"></i></div>
          </div>
          <div class="style-item" onclick="addWindow('bay')" title="Bay Window">
            <div class="style-icon"><i class="fas fa-window-restore"></i></div>
          </div>
          <div class="style-item" onclick="addWindow('skylight')" title="Skylight">
            <div class="style-icon"><i class="fas fa-sun"></i></div>
          </div>
        </div>
      </div>
      
      <div class="tool-section">
        <h3>Furniture</h3>
        <div class="style-grid">
          <div class="style-item" onclick="addFurniture('sofa')" title="Sofa">
            <div class="style-icon"><i class="fas fa-couch"></i></div>
          </div>
          <div class="style-item" onclick="addFurniture('bed')" title="Bed">
            <div class="style-icon"><i class="fas fa-bed"></i></div>
          </div>
          <div class="style-item" onclick="addFurniture('table')" title="Dining Table">
            <div class="style-icon"><i class="fas fa-table"></i></div>
          </div>
          <div class="style-item" onclick="addFurniture('chair')" title="Chair">
            <div class="style-icon"><i class="fas fa-chair"></i></div>
          </div>
          <div class="style-item" onclick="addFurniture('desk')" title="Desk">
            <div class="style-icon"><i class="fas fa-desktop"></i></div>
          </div>
          <div class="style-item" onclick="addFurniture('dresser')" title="Dresser">
            <div class="style-icon"><i class="fas fa-archive"></i></div>
          </div>
          <div class="style-item" onclick="addFurniture('bookshelf')" title="Bookshelf">
            <div class="style-icon"><i class="fas fa-book"></i></div>
          </div>
          <div class="style-item" onclick="addFurniture('tv')" title="TV">
            <div class="style-icon"><i class="fas fa-tv"></i></div>
          </div>
        </div>
      </div>
      
      <div class="tool-section">
        <h3>Kitchen</h3>
        <div class="style-grid">
          <div class="style-item" onclick="addFurniture('stove')" title="Stove">
            <div class="style-icon"><i class="fas fa-fire"></i></div>
          </div>
          <div class="style-item" onclick="addFurniture('refrigerator')" title="Refrigerator">
            <div class="style-icon"><i class="fas fa-snowflake"></i></div>
          </div>
          <div class="style-item" onclick="addFurniture('sink')" title="Kitchen Sink">
            <div class="style-icon"><i class="fas fa-tint"></i></div>
          </div>
          <div class="style-item" onclick="addFurniture('dishwasher')" title="Dishwasher">
            <div class="style-icon"><i class="fas fa-spray-can"></i></div>
          </div>
          <div class="style-item" onclick="addFurniture('microwave')" title="Microwave">
            <div class="style-icon"><i class="fas fa-microchip"></i></div>
          </div>
          <div class="style-item" onclick="addFurniture('cabinet')" title="Cabinet">
            <div class="style-icon"><i class="fas fa-box"></i></div>
          </div>
        </div>
      </div>
      
      <div class="tool-section">
        <h3>Bathroom</h3>
        <div class="style-grid">
          <div class="style-item" onclick="addFurniture('toilet')" title="Toilet">
            <div class="style-icon"><i class="fas fa-toilet"></i></div>
          </div>
          <div class="style-item" onclick="addFurniture('bathtub')" title="Bathtub">
            <div class="style-icon"><i class="fas fa-bath"></i></div>
          </div>
          <div class="style-item" onclick="addFurniture('shower')" title="Shower">
            <div class="style-icon"><i class="fas fa-shower"></i></div>
          </div>
          <div class="style-item" onclick="addFurniture('vanity')" title="Vanity">
            <div class="style-icon"><i class="fas fa-mirror"></i></div>
          </div>
        </div>
      </div>
      
      <div class="tool-section">
        <h3>Electrical</h3>
        <div class="style-grid">
          <div class="style-item" onclick="addElectrical('outlet')" title="Electrical Outlet">
            <div class="style-icon"><i class="fas fa-plug"></i></div>
          </div>
          <div class="style-item" onclick="addElectrical('switch')" title="Light Switch">
            <div class="style-icon"><i class="fas fa-toggle-on"></i></div>
          </div>
          <div class="style-item" onclick="addElectrical('ceiling_light')" title="Ceiling Light">
            <div class="style-icon"><i class="fas fa-lightbulb"></i></div>
          </div>
          <div class="style-item" onclick="addElectrical('ceiling_fan')" title="Ceiling Fan">
            <div class="style-icon"><i class="fas fa-fan"></i></div>
          </div>
          <div class="style-item" onclick="addElectrical('chandelier')" title="Chandelier">
            <div class="style-icon"><i class="fas fa-gem"></i></div>
          </div>
          <div class="style-item" onclick="addElectrical('smoke_detector')" title="Smoke Detector">
            <div class="style-icon"><i class="fas fa-exclamation-triangle"></i></div>
          </div>
        </div>
      </div>
      
      <div class="tool-section">
        <h3>Actions</h3>
        <button class="control-btn secondary" onclick="undo()">
          <i class="fas fa-undo"></i> Undo
        </button>
        <button class="control-btn secondary" onclick="redo()">
          <i class="fas fa-redo"></i> Redo
        </button>
        <button class="control-btn secondary" id="dimensionToggle" onclick="toggleDimensions()">
          <i class="fas fa-ruler"></i> Show Dimensions
        </button>
      </div>
      
      <div class="room-templates">
        <h3>Room Templates</h3>
        <div class="template-item" onclick="addRoomTemplate('living')">
          <div class="template-icon"><i class="fas fa-couch"></i></div>
          <div class="template-name">Living Room</div>
        </div>
        <div class="template-item" onclick="addRoomTemplate('kitchen')">
          <div class="template-icon"><i class="fas fa-utensils"></i></div>
          <div class="template-name">Kitchen</div>
        </div>
        <div class="template-item" onclick="addRoomTemplate('bedroom')">
          <div class="template-icon"><i class="fas fa-bed"></i></div>
          <div class="template-name">Bedroom</div>
        </div>
        <div class="template-item" onclick="addRoomTemplate('bathroom')">
          <div class="template-icon"><i class="fas fa-bath"></i></div>
          <div class="template-name">Bathroom</div>
        </div>
        <div class="template-item" onclick="addRoomTemplate('dining')">
          <div class="template-icon"><i class="fas fa-chair"></i></div>
          <div class="template-name">Dining Room</div>
        </div>
        <div class="template-item" onclick="addRoomTemplate('office')">
          <div class="template-icon"><i class="fas fa-laptop"></i></div>
          <div class="template-name">Office</div>
        </div>
      </div>
    </div>
    
    <div class="canvas-container">
      <canvas id="floorPlanCanvas" width="1200" height="800"></canvas>
      <div class="stats" id="stats">
        0 Walls • 0 Doors • 0 Windows • 0 Rooms
      </div>
    </div>
  </div>
  
  <!-- Save Modal -->
  <div class="save-modal" id="saveModal">
    <div class="save-modal-content">
      <h2>Save Floor Plan</h2>
      <input type="text" id="floorPlanName" placeholder="Enter floor plan name..." value="My Floor Plan">
      <div class="save-modal-buttons">
        <button class="control-btn secondary" onclick="hideSaveModal()">Cancel</button>
        <button class="control-btn" onclick="saveFloorPlan()">Save</button>
      </div>
    </div>
  </div>
  
  <script>
    let canvas, ctx;
    let currentTool = 'wall';
    let isDrawing = false;
    let startX, startY;
    let walls = [];
    let curvedWalls = [];
    let dimensions = [];
    let doors = [];
    let windows = [];
    let rooms = [];
    let furniture = [];
    let electrical = [];
    let history = [];
    let historyIndex = -1;
    let is3DMode = false;
    let selectedElement = null;
    let isDragging = false;
    let dragOffset = { x: 0, y: 0 };
    let currentCurve = null;
    let showDimensions = false;
    
    // Initialize the designer
    window.onload = function() {
      canvas = document.getElementById('floorPlanCanvas');
      ctx = canvas.getContext('2d');
      
      // Set up canvas event listeners
      canvas.addEventListener('mousedown', startDrawing);
      canvas.addEventListener('mousemove', draw);
      canvas.addEventListener('mouseup', stopDrawing);
      canvas.addEventListener('mouseout', stopDrawing);
      
      // Set up keyboard event listeners
      document.addEventListener('keydown', handleKeyPress);
      
      // Initialize canvas
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      drawGrid();
    };
    
    function setTool(tool) {
      currentTool = tool;
      document.querySelectorAll('.tool-btn').forEach(btn => btn.classList.remove('active'));
      event.target.classList.add('active');
      console.log('Tool set to:', tool);
      
      // Clear selection when switching tools
      selectedElement = null;
      redrawCanvas();
    }
    
    function addDoor(style) {
      console.log('Adding door style:', style);
      currentTool = 'door';
      
      // Add a door at a default position
      const door = {
        x: 100,
        y: 100,
        width: 30,
        height: 60,
        id: Date.now(),
        type: 'door',
        style: style
      };
      
      doors.push(door);
      redrawCanvas();
      updateStats();
    }
    
    function addWindow(style) {
      console.log('Adding window style:', style);
      currentTool = 'window';
      
      // Add a window at a default position
      const window = {
        x: 200,
        y: 100,
        width: 40,
        height: 20,
        id: Date.now(),
        type: 'window',
        style: style
      };
      
      windows.push(window);
      redrawCanvas();
      updateStats();
    }
    
    function addFurniture(furnitureType) {
      console.log('Adding furniture:', furnitureType);
      currentTool = 'furniture';
      
      const furnitureItem = {
        x: 300,
        y: 100,
        width: getFurnitureWidth(furnitureType),
        height: getFurnitureHeight(furnitureType),
        id: Date.now(),
        type: 'furniture',
        furnitureType: furnitureType
      };
      
      furniture.push(furnitureItem);
      redrawCanvas();
      updateStats();
    }
    
    function addElectrical(electricalType) {
      console.log('Adding electrical:', electricalType);
      currentTool = 'electrical';
      
      const electricalItem = {
        x: 400,
        y: 100,
        width: 15,
        height: 15,
        id: Date.now(),
        type: 'electrical',
        electricalType: electricalType
      };
      
      electrical.push(electricalItem);
      redrawCanvas();
      updateStats();
    }
    
    function getFurnitureWidth(type) {
      const sizes = {
        'sofa': 80, 'bed': 60, 'table': 50, 'chair': 20, 'desk': 60,
        'dresser': 40, 'bookshelf': 30, 'tv': 40, 'stove': 30, 'refrigerator': 30,
        'sink': 25, 'dishwasher': 25, 'microwave': 20, 'cabinet': 30,
        'toilet': 20, 'bathtub': 30, 'shower': 25, 'vanity': 35
      };
      return sizes[type] || 30;
    }
    
    function getFurnitureHeight(type) {
      const sizes = {
        'sofa': 30, 'bed': 40, 'table': 30, 'chair': 20, 'desk': 30,
        'dresser': 20, 'bookshelf': 40, 'tv': 25, 'stove': 25, 'refrigerator': 50,
        'sink': 20, 'dishwasher': 30, 'microwave': 15, 'cabinet': 20,
        'toilet': 25, 'bathtub': 40, 'shower': 30, 'vanity': 20
      };
      return sizes[type] || 20;
    }
    
    function startDrawing(e) {
      const rect = canvas.getBoundingClientRect();
      const rawX = e.clientX - rect.left;
      const rawY = e.clientY - rect.top;
      
      // Snap to grid
      const mouseX = Math.round(rawX / 20) * 20;
      const mouseY = Math.round(rawY / 20) * 20;
      
      if (currentTool === 'select') {
        // Handle selection
        selectedElement = getElementAt(mouseX, mouseY);
        if (selectedElement) {
          isDragging = true;
          if (selectedElement.type === 'wall' || selectedElement.type === 'room') {
            dragOffset.x = mouseX - selectedElement.startX;
            dragOffset.y = mouseY - selectedElement.startY;
          } else {
            dragOffset.x = mouseX - selectedElement.x;
            dragOffset.y = mouseY - selectedElement.y;
          }
          console.log('Selected element:', selectedElement);
        } else {
          selectedElement = null;
        }
        redrawCanvas();
        return;
      }
      
      console.log('Starting to draw with tool:', currentTool);
      isDrawing = true;
      startX = mouseX;
      startY = mouseY;
      
      console.log('Start position (snapped):', startX, startY);
      saveState();
    }
    
    function draw(e) {
      const rect = canvas.getBoundingClientRect();
      const rawX = e.clientX - rect.left;
      const rawY = e.clientY - rect.top;
      
      // Snap to grid
      const currentX = Math.round(rawX / 20) * 20;
      const currentY = Math.round(rawY / 20) * 20;
      
      if (isDragging && selectedElement) {
        // Handle dragging selected element
        if (selectedElement.type === 'wall' || selectedElement.type === 'room') {
          const newStartX = currentX - dragOffset.x;
          const newStartY = currentY - dragOffset.y;
          const newEndX = newStartX + (selectedElement.endX - selectedElement.startX);
          const newEndY = newStartY + (selectedElement.endY - selectedElement.startY);
          
          selectedElement.startX = newStartX;
          selectedElement.startY = newStartY;
          selectedElement.endX = newEndX;
          selectedElement.endY = newEndY;
        } else {
          // Handle furniture, doors, windows, electrical
          selectedElement.x = currentX - dragOffset.x;
          selectedElement.y = currentY - dragOffset.y;
        }
        
        redrawCanvas();
        return;
      }
      
      if (!isDrawing) return;
      
      // Clear canvas and redraw everything
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      
      // Draw grid
      drawGrid();
      
      // Draw existing elements
      drawElements();
      
      // Draw current element being drawn with preview
      ctx.strokeStyle = '#8b5cf6';
      ctx.lineWidth = 3;
      ctx.setLineDash([5, 5]); // Dashed line for preview
      ctx.beginPath();
      
      if (currentTool === 'room') {
        // Draw rectangle for room
        ctx.rect(startX, startY, currentX - startX, currentY - startY);
      } else if (currentTool === 'curved_wall') {
        // Draw curved wall preview
        const centerX = (startX + currentX) / 2;
        const centerY = (startY + currentY) / 2;
        const radius = Math.sqrt(Math.pow(currentX - startX, 2) + Math.pow(currentY - startY, 2)) / 2;
        const startAngle = Math.atan2(startY - centerY, startX - centerX);
        const endAngle = Math.atan2(currentY - centerY, currentX - centerX);
        ctx.arc(centerX, centerY, radius, startAngle, endAngle);
      } else if (currentTool === 'dimension') {
        // Draw dimension line preview
        ctx.moveTo(startX, startY);
        ctx.lineTo(currentX, currentY);
      } else {
        // Draw line for walls, doors, windows
        ctx.moveTo(startX, startY);
        ctx.lineTo(currentX, currentY);
      }
      ctx.stroke();
      ctx.setLineDash([]); // Reset line dash
    }
    
    function stopDrawing(e) {
      if (isDragging) {
        isDragging = false;
        return;
      }
      
      if (!isDrawing) return;
      
      console.log('Stopping drawing with tool:', currentTool);
      isDrawing = false;
      const rect = canvas.getBoundingClientRect();
      const rawX = e.clientX - rect.left;
      const rawY = e.clientY - rect.top;
      
      // Snap to grid
      const endX = Math.round(rawX / 20) * 20;
      const endY = Math.round(rawY / 20) * 20;
      
      console.log('End position (snapped):', endX, endY);
      
      // Add element based on current tool
      switch(currentTool) {
        case 'wall':
          walls.push({startX, startY, endX, endY, id: Date.now(), type: 'wall'});
          console.log('Added wall, total walls:', walls.length);
          break;
        case 'curved_wall':
          const centerX = (startX + endX) / 2;
          const centerY = (startY + endY) / 2;
          const radius = Math.sqrt(Math.pow(endX - startX, 2) + Math.pow(endY - startY, 2)) / 2;
          const startAngle = Math.atan2(startY - centerY, startX - centerX);
          const endAngle = Math.atan2(endY - centerY, endX - centerX);
          curvedWalls.push({centerX, centerY, radius, startAngle, endAngle, id: Date.now(), type: 'curved_wall'});
          console.log('Added curved wall, total curved walls:', curvedWalls.length);
          break;
        case 'dimension':
          dimensions.push({startX, startY, endX, endY, id: Date.now(), type: 'dimension'});
          console.log('Added dimension, total dimensions:', dimensions.length);
          break;
        case 'room':
          rooms.push({startX, startY, endX, endY, id: Date.now(), type: 'room'});
          console.log('Added room, total rooms:', rooms.length);
          break;
      }
      
      redrawCanvas();
      updateStats();
    }
    
    function getElementAt(x, y) {
      // Check furniture first (most specific)
      for (let item of furniture) {
        if (x >= item.x && x <= item.x + item.width && y >= item.y && y <= item.y + item.height) {
          return item;
        }
      }
      
      // Check electrical
      for (let item of electrical) {
        if (x >= item.x && x <= item.x + item.width && y >= item.y && y <= item.y + item.height) {
          return item;
        }
      }
      
      // Check doors
      for (let door of doors) {
        if (x >= door.x && x <= door.x + door.width && y >= door.y && y <= door.y + door.height) {
          return door;
        }
      }
      
      // Check windows
      for (let window of windows) {
        if (x >= window.x && x <= window.x + window.width && y >= window.y && y <= window.y + window.height) {
          return window;
        }
      }
      
      // Check walls
      for (let wall of walls) {
        if (isPointOnLine(x, y, wall.startX, wall.startY, wall.endX, wall.endY, 15)) {
          return wall;
        }
      }
      
      // Check rooms last (least specific)
      for (let room of rooms) {
        if (x >= room.startX && x <= room.endX && y >= room.startY && y <= room.endY) {
          return room;
        }
      }
      
      return null;
    }
    
    function isPointOnLine(px, py, x1, y1, x2, y2, tolerance) {
      const A = px - x1;
      const B = py - y1;
      const C = x2 - x1;
      const D = y2 - y1;
      
      const dot = A * C + B * D;
      const lenSq = C * C + D * D;
      let param = -1;
      
      if (lenSq !== 0) {
        param = dot / lenSq;
      }
      
      let xx, yy;
      
      if (param < 0) {
        xx = x1;
        yy = y1;
      } else if (param > 1) {
        xx = x2;
        yy = y2;
      } else {
        xx = x1 + param * C;
        yy = y1 + param * D;
      }
      
      const dx = px - xx;
      const dy = py - yy;
      return Math.sqrt(dx * dx + dy * dy) <= tolerance;
    }
    
    function handleKeyPress(e) {
      if (e.key === 'Delete' || e.key === 'Backspace') {
        if (selectedElement) {
          console.log('Deleting selected element:', selectedElement);
          
          // Remove from appropriate array
          if (selectedElement.type === 'wall') {
            const index = walls.indexOf(selectedElement);
            if (index > -1) walls.splice(index, 1);
          } else if (selectedElement.type === 'door') {
            const index = doors.indexOf(selectedElement);
            if (index > -1) doors.splice(index, 1);
          } else if (selectedElement.type === 'window') {
            const index = windows.indexOf(selectedElement);
            if (index > -1) windows.splice(index, 1);
          } else if (selectedElement.type === 'furniture') {
            const index = furniture.indexOf(selectedElement);
            if (index > -1) furniture.splice(index, 1);
          } else if (selectedElement.type === 'electrical') {
            const index = electrical.indexOf(selectedElement);
            if (index > -1) electrical.splice(index, 1);
          } else if (selectedElement.type === 'room') {
            const index = rooms.indexOf(selectedElement);
            if (index > -1) rooms.splice(index, 1);
          }
          
          selectedElement = null;
          redrawCanvas();
          updateStats();
        }
      }
    }
    
    function drawGrid() {
      ctx.strokeStyle = 'rgba(0,0,0,0.1)';
      ctx.lineWidth = 1;
      
      // Vertical lines
      for (let x = 0; x <= canvas.width; x += 20) {
        ctx.beginPath();
        ctx.moveTo(x, 0);
        ctx.lineTo(x, canvas.height);
        ctx.stroke();
      }
      
      // Horizontal lines
      for (let y = 0; y <= canvas.height; y += 20) {
        ctx.beginPath();
        ctx.moveTo(0, y);
        ctx.lineTo(canvas.width, y);
        ctx.stroke();
      }
    }
    
    function drawElements() {
      // Draw rooms first (background)
      ctx.fillStyle = 'rgba(240, 248, 255, 0.3)';
      ctx.strokeStyle = '#4a5568';
      ctx.lineWidth = 2;
      rooms.forEach(room => {
        ctx.beginPath();
        ctx.rect(room.startX, room.startY, room.endX - room.startX, room.endY - room.startY);
        ctx.fill();
        ctx.stroke();
        
        // Add room label
        ctx.fillStyle = '#4a5568';
        ctx.font = 'bold 12px Arial';
        ctx.textAlign = 'center';
        const roomCenterX = room.startX + (room.endX - room.startX) / 2;
        const roomCenterY = room.startY + (room.endY - room.startY) / 2;
        ctx.fillText(room.name || 'Room', roomCenterX, roomCenterY);
        ctx.textAlign = 'left';
      });
      
      // Draw walls
      ctx.strokeStyle = '#2d3748';
      ctx.lineWidth = 8;
      walls.forEach(wall => {
        ctx.beginPath();
        ctx.moveTo(wall.startX, wall.startY);
        ctx.lineTo(wall.endX, wall.endY);
        ctx.stroke();
        
        // Add dimension if toggle is on
        if (showDimensions) {
          const distance = Math.sqrt(Math.pow(wall.endX - wall.startX, 2) + Math.pow(wall.endY - wall.startY, 2));
          const feet = Math.floor(distance / 20);
          const inches = Math.round((distance % 20) / 20 * 12);
          const text = inches > 0 ? `${feet}'${inches}"` : `${feet}'`;
          
          ctx.fillStyle = '#4a5568';
          ctx.font = 'bold 10px Arial';
          ctx.textAlign = 'center';
          const centerX = (wall.startX + wall.endX) / 2;
          const centerY = (wall.startY + wall.endY) / 2;
          ctx.fillText(text, centerX, centerY - 15);
          ctx.textAlign = 'left';
        }
      });
      
      // Draw curved walls
      ctx.strokeStyle = '#2d3748';
      ctx.lineWidth = 8;
      curvedWalls.forEach(curve => {
        ctx.beginPath();
        ctx.arc(curve.centerX, curve.centerY, curve.radius, curve.startAngle, curve.endAngle);
        ctx.stroke();
      });
      
      // Draw dimensions
      ctx.strokeStyle = '#4a5568';
      ctx.lineWidth = 1;
      ctx.fillStyle = '#4a5568';
      ctx.font = '10px Arial';
      dimensions.forEach(dim => {
        // Draw dimension line
        ctx.beginPath();
        ctx.moveTo(dim.startX, dim.startY);
        ctx.lineTo(dim.endX, dim.endY);
        ctx.stroke();
        
        // Draw dimension arrows
        const angle = Math.atan2(dim.endY - dim.startY, dim.endX - dim.startX);
        const arrowLength = 5;
        ctx.beginPath();
        ctx.moveTo(dim.startX, dim.startY);
        ctx.lineTo(dim.startX + arrowLength * Math.cos(angle - Math.PI/6), dim.startY + arrowLength * Math.sin(angle - Math.PI/6));
        ctx.moveTo(dim.startX, dim.startY);
        ctx.lineTo(dim.startX + arrowLength * Math.cos(angle + Math.PI/6), dim.startY + arrowLength * Math.sin(angle + Math.PI/6));
        ctx.moveTo(dim.endX, dim.endY);
        ctx.lineTo(dim.endX - arrowLength * Math.cos(angle - Math.PI/6), dim.endY - arrowLength * Math.sin(angle - Math.PI/6));
        ctx.moveTo(dim.endX, dim.endY);
        ctx.lineTo(dim.endX - arrowLength * Math.cos(angle + Math.PI/6), dim.endY - arrowLength * Math.sin(angle + Math.PI/6));
        ctx.stroke();
        
        // Draw dimension text
        const centerX = (dim.startX + dim.endX) / 2;
        const centerY = (dim.startY + dim.endY) / 2;
        const distance = Math.sqrt(Math.pow(dim.endX - dim.startX, 2) + Math.pow(dim.endY - dim.startY, 2));
        const feet = Math.floor(distance / 20);
        const inches = Math.round((distance % 20) / 20 * 12);
        const text = inches > 0 ? `${feet}'${inches}"` : `${feet}'`;
        ctx.fillText(text, centerX, centerY - 5);
      });
      
      // Draw doors with perfect architectural floor plan symbols
      doors.forEach(door => {
        // Highlight if selected
        if (selectedElement === door) {
          ctx.strokeStyle = '#e53e3e';
          ctx.lineWidth = 3;
        } else {
          ctx.strokeStyle = '#2d3748';
          ctx.lineWidth = 2;
        }
        
        // Draw door opening (gap in wall) - white line to show opening
        ctx.strokeStyle = '#ffffff';
        ctx.lineWidth = 8;
        ctx.beginPath();
        ctx.moveTo(door.x, door.y);
        ctx.lineTo(door.x + door.width, door.y + door.height);
        ctx.stroke();
        
        // Draw door swing arc (quarter circle) - perfect arc
        ctx.strokeStyle = '#2d3748';
        ctx.lineWidth = 2;
        ctx.beginPath();
        const radius = Math.min(door.width, door.height) * 0.85;
        ctx.arc(door.x, door.y, radius, 0, Math.PI / 2);
        ctx.stroke();
        
        // Draw door panel line (architectural symbol) - clean diagonal
        ctx.strokeStyle = '#2d3748';
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.moveTo(door.x, door.y);
        ctx.lineTo(door.x + door.width, door.y + door.height);
        ctx.stroke();
        
        // Add dimension if toggle is on
        if (showDimensions) {
          const distance = Math.sqrt(Math.pow(door.width, 2) + Math.pow(door.height, 2));
          const feet = Math.floor(distance / 20);
          const inches = Math.round((distance % 20) / 20 * 12);
          const text = inches > 0 ? `${feet}'${inches}"` : `${feet}'`;
          
          ctx.fillStyle = '#4a5568';
          ctx.font = 'bold 10px Arial';
          ctx.textAlign = 'center';
          const centerX = door.x + door.width / 2;
          const centerY = door.y + door.height / 2;
          ctx.fillText(text, centerX, centerY - 10);
          ctx.textAlign = 'left';
        }
      });
      
      // Draw windows with architectural floor plan symbols
      windows.forEach(window => {
        const centerX = window.x + window.width / 2;
        const centerY = window.y + window.height / 2;
        
        // Highlight if selected
        if (selectedElement === window) {
          ctx.strokeStyle = '#e53e3e';
          ctx.lineWidth = 3;
        } else {
          ctx.strokeStyle = '#2d3748';
          ctx.lineWidth = 2;
        }
        
        // Draw window opening (gap in wall) - architectural symbol
        ctx.strokeStyle = '#ffffff';
        ctx.lineWidth = 8;
        ctx.beginPath();
        ctx.moveTo(window.x, window.y);
        ctx.lineTo(window.x + window.width, window.y + window.height);
        ctx.stroke();
        
        // Draw window frame lines (architectural symbol)
        ctx.strokeStyle = '#2d3748';
        ctx.lineWidth = 2;
        ctx.beginPath();
        // Top and bottom frame lines
        ctx.moveTo(window.x, window.y);
        ctx.lineTo(window.x + window.width, window.y + window.height);
        ctx.moveTo(window.x, window.y + window.height);
        ctx.lineTo(window.x + window.width, window.y);
        ctx.stroke();
        
        // Draw window cross (architectural symbol)
        ctx.strokeStyle = '#2d3748';
        ctx.lineWidth = 1;
        ctx.beginPath();
        ctx.moveTo(window.x, centerY);
        ctx.lineTo(window.x + window.width, centerY);
        ctx.moveTo(centerX, window.y);
        ctx.lineTo(centerX, window.y + window.height);
        ctx.stroke();
        
        // Add dimension if toggle is on
        if (showDimensions) {
          const distance = Math.sqrt(Math.pow(window.width, 2) + Math.pow(window.height, 2));
          const feet = Math.floor(distance / 20);
          const inches = Math.round((distance % 20) / 20 * 12);
          const text = inches > 0 ? `${feet}'${inches}"` : `${feet}'`;
          
          ctx.fillStyle = '#4a5568';
          ctx.font = 'bold 10px Arial';
          ctx.textAlign = 'center';
          ctx.fillText(text, centerX, centerY - 10);
          ctx.textAlign = 'left';
        }
      });
      
      // Draw furniture with realistic shapes
      furniture.forEach(item => {
        // Highlight if selected
        if (selectedElement === item) {
          ctx.strokeStyle = '#e53e3e';
          ctx.lineWidth = 3;
        } else {
          ctx.strokeStyle = '#4a5568';
          ctx.lineWidth = 2;
        }
        
        // Draw furniture based on type
        drawFurnitureShape(item);
      });
      
      // Draw electrical with professional styling
      electrical.forEach(item => {
        // Highlight if selected
        if (selectedElement === item) {
          ctx.strokeStyle = '#e53e3e';
          ctx.lineWidth = 3;
        } else {
          ctx.strokeStyle = '#f6ad55';
          ctx.lineWidth = 2;
        }
        
        // Draw electrical based on type
        drawElectricalShape(item);
      });
    }
    
    function drawFurnitureShape(item) {
      const x = item.x;
      const y = item.y;
      const w = item.width;
      const h = item.height;
      const centerX = x + w / 2;
      const centerY = y + h / 2;
      
      ctx.fillStyle = '#f7fafc';
      ctx.strokeStyle = '#4a5568';
      ctx.lineWidth = 2;
      
      switch(item.furnitureType) {
        case 'sofa':
          // Draw sofa seat
          ctx.beginPath();
          ctx.rect(x, y + h/3, w, h*2/3);
          ctx.fill();
          ctx.stroke();
          // Back rest
          ctx.beginPath();
          ctx.rect(x, y, w, h/3);
          ctx.fill();
          ctx.stroke();
          // Armrests (more realistic)
          ctx.beginPath();
          ctx.rect(x, y + h/5, w/8, h*3/5);
          ctx.rect(x + w*7/8, y + h/5, w/8, h*3/5);
          ctx.fill();
          ctx.stroke();
          // Cushion lines
          ctx.strokeStyle = '#cbd5e0';
          ctx.lineWidth = 0.5;
          ctx.beginPath();
          ctx.moveTo(x + w/3, y + h/3);
          ctx.lineTo(x + w/3, y + h);
          ctx.moveTo(x + w*2/3, y + h/3);
          ctx.lineTo(x + w*2/3, y + h);
          ctx.stroke();
          break;
          
        case 'bed':
          // Draw bed mattress
          ctx.beginPath();
          ctx.rect(x, y + h/4, w, h*3/4);
          ctx.fill();
          ctx.stroke();
          // Headboard (more realistic)
          ctx.beginPath();
          ctx.rect(x + w/6, y, w*2/3, h/4);
          ctx.fill();
          ctx.stroke();
          // Pillows
          ctx.fillStyle = '#e2e8f0';
          ctx.beginPath();
          ctx.rect(x + w/8, y + h/6, w/4, h/8);
          ctx.rect(x + w*5/8, y + h/6, w/4, h/8);
          ctx.fill();
          // Bed frame lines
          ctx.strokeStyle = '#cbd5e0';
          ctx.lineWidth = 0.5;
          ctx.beginPath();
          ctx.moveTo(x + w/3, y + h/4);
          ctx.lineTo(x + w/3, y + h);
          ctx.moveTo(x + w*2/3, y + h/4);
          ctx.lineTo(x + w*2/3, y + h);
          ctx.stroke();
          break;
          
        case 'table':
          // Draw table with legs
          ctx.beginPath();
          ctx.rect(x, y, w, h);
          ctx.fill();
          ctx.stroke();
          // Table legs
          ctx.strokeStyle = '#4a5568';
          ctx.lineWidth = 1;
          ctx.beginPath();
          ctx.moveTo(x + w/6, y + h);
          ctx.lineTo(x + w/6, y + h + 5);
          ctx.moveTo(x + w*5/6, y + h);
          ctx.lineTo(x + w*5/6, y + h + 5);
          ctx.moveTo(x + w/6, y);
          ctx.lineTo(x + w/6, y - 5);
          ctx.moveTo(x + w*5/6, y);
          ctx.lineTo(x + w*5/6, y - 5);
          ctx.stroke();
          break;
          
        case 'chair':
          // Draw chair with back
          ctx.beginPath();
          ctx.rect(x, y + h/3, w, h*2/3);
          ctx.fill();
          ctx.stroke();
          // Back rest
          ctx.beginPath();
          ctx.rect(x, y, w, h/3);
          ctx.fill();
          ctx.stroke();
          break;
          
        case 'toilet':
          // Draw toilet bowl
          ctx.beginPath();
          ctx.ellipse(centerX, centerY + h/4, w/2, h/3, 0, 0, 2 * Math.PI);
          ctx.fill();
          ctx.stroke();
          // Tank
          ctx.beginPath();
          ctx.rect(x + w/4, y, w/2, h/2);
          ctx.fill();
          ctx.stroke();
          break;
          
        case 'bathtub':
          // Draw bathtub
          ctx.beginPath();
          ctx.rect(x, y, w, h);
          ctx.fill();
          ctx.stroke();
          // Inner tub
          ctx.beginPath();
          ctx.rect(x + 3, y + 3, w - 6, h - 6);
          ctx.stroke();
          break;
          
        case 'refrigerator':
          // Draw fridge with handle
          ctx.beginPath();
          ctx.rect(x, y, w, h);
          ctx.fill();
          ctx.stroke();
          // Handle
          ctx.strokeStyle = '#4a5568';
          ctx.lineWidth = 1;
          ctx.beginPath();
          ctx.rect(x + w - 8, y + h/3, 4, h/3);
          ctx.stroke();
          break;
          
        case 'stove':
          // Draw stove with burners
          ctx.beginPath();
          ctx.rect(x, y, w, h);
          ctx.fill();
          ctx.stroke();
          // Burners
          ctx.fillStyle = '#2d3748';
          ctx.beginPath();
          ctx.arc(x + w/4, y + h/3, 3, 0, 2 * Math.PI);
          ctx.arc(x + w*3/4, y + h/3, 3, 0, 2 * Math.PI);
          ctx.arc(x + w/4, y + h*2/3, 3, 0, 2 * Math.PI);
          ctx.arc(x + w*3/4, y + h*2/3, 3, 0, 2 * Math.PI);
          ctx.fill();
          break;
          
        default:
          // Default rectangle for other furniture
          ctx.beginPath();
          ctx.rect(x, y, w, h);
          ctx.fill();
          ctx.stroke();
      }
      
      // Add furniture label
      ctx.fillStyle = '#4a5568';
      ctx.font = 'bold 10px Arial';
      ctx.textAlign = 'center';
      ctx.fillText(item.furnitureType, centerX, y - 5);
      ctx.textAlign = 'left';
    }
    
    function drawElectricalShape(item) {
      const x = item.x;
      const y = item.y;
      const w = item.width;
      const h = item.height;
      const centerX = x + w / 2;
      const centerY = y + h / 2;
      
      ctx.fillStyle = '#fff5f5';
      ctx.strokeStyle = '#f6ad55';
      ctx.lineWidth = 2;
      
      switch(item.electricalType) {
        case 'outlet':
          // Draw outlet
          ctx.beginPath();
          ctx.rect(x, y, w, h);
          ctx.fill();
          ctx.stroke();
          // Outlet holes
          ctx.fillStyle = '#2d3748';
          ctx.beginPath();
          ctx.rect(x + 2, y + 3, 3, 2);
          ctx.rect(x + 6, y + 3, 3, 2);
          ctx.rect(x + 4, y + 7, 3, 1);
          ctx.fill();
          break;
          
        case 'switch':
          // Draw light switch
          ctx.beginPath();
          ctx.rect(x, y, w, h);
          ctx.fill();
          ctx.stroke();
          // Switch toggle
          ctx.fillStyle = '#4a5568';
          ctx.beginPath();
          ctx.rect(x + 2, y + 2, w - 4, h - 4);
          ctx.fill();
          break;
          
        case 'ceiling_light':
          // Draw ceiling light
          ctx.beginPath();
          ctx.arc(centerX, centerY, w/2, 0, 2 * Math.PI);
          ctx.fill();
          ctx.stroke();
          // Light rays
          ctx.strokeStyle = '#f6ad55';
          ctx.lineWidth = 1;
          ctx.beginPath();
          for(let i = 0; i < 8; i++) {
            const angle = (i * Math.PI * 2) / 8;
            const startX = centerX + Math.cos(angle) * w/2;
            const startY = centerY + Math.sin(angle) * w/2;
            const endX = centerX + Math.cos(angle) * w;
            const endY = centerY + Math.sin(angle) * w;
            ctx.moveTo(startX, startY);
            ctx.lineTo(endX, endY);
          }
          ctx.stroke();
          break;
          
        case 'ceiling_fan':
          // Draw ceiling fan
          ctx.beginPath();
          ctx.arc(centerX, centerY, w/2, 0, 2 * Math.PI);
          ctx.fill();
          ctx.stroke();
          // Fan blades
          ctx.strokeStyle = '#4a5568';
          ctx.lineWidth = 1;
          ctx.beginPath();
          for(let i = 0; i < 4; i++) {
            const angle = (i * Math.PI * 2) / 4;
            const endX = centerX + Math.cos(angle) * w;
            const endY = centerY + Math.sin(angle) * w;
            ctx.moveTo(centerX, centerY);
            ctx.lineTo(endX, endY);
          }
          ctx.stroke();
          break;
          
        default:
          // Default circle for other electrical
          ctx.beginPath();
          ctx.arc(centerX, centerY, w/2, 0, 2 * Math.PI);
          ctx.fill();
          ctx.stroke();
      }
      
      // Add electrical label
      ctx.fillStyle = '#f6ad55';
      ctx.font = 'bold 8px Arial';
      ctx.textAlign = 'center';
      ctx.fillText(item.electricalType, centerX, y - 5);
      ctx.textAlign = 'left';
    }
    
    function redrawCanvas() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      drawGrid();
      drawElements();
    }
    
    function updateStats() {
      document.getElementById('stats').textContent = 
        `${walls.length} Walls • ${curvedWalls.length} Curved • ${dimensions.length} Dimensions • ${doors.length} Doors • ${windows.length} Windows • ${rooms.length} Rooms • ${furniture.length} Furniture • ${electrical.length} Electrical`;
    }
    
    function saveState() {
      historyIndex++;
      if (historyIndex < history.length) {
        history.length = historyIndex;
      }
      history.push({
        walls: JSON.parse(JSON.stringify(walls)),
        curvedWalls: JSON.parse(JSON.stringify(curvedWalls)),
        dimensions: JSON.parse(JSON.stringify(dimensions)),
        doors: JSON.parse(JSON.stringify(doors)),
        windows: JSON.parse(JSON.stringify(windows)),
        rooms: JSON.parse(JSON.stringify(rooms)),
        furniture: JSON.parse(JSON.stringify(furniture)),
        electrical: JSON.parse(JSON.stringify(electrical))
      });
    }
    
    function undo() {
      if (historyIndex > 0) {
        historyIndex--;
        const state = history[historyIndex];
        walls = state.walls;
        curvedWalls = state.curvedWalls;
        dimensions = state.dimensions;
        doors = state.doors;
        windows = state.windows;
        rooms = state.rooms;
        furniture = state.furniture;
        electrical = state.electrical;
        redrawCanvas();
        updateStats();
      }
    }
    
    function redo() {
      if (historyIndex < history.length - 1) {
        historyIndex++;
        const state = history[historyIndex];
        walls = state.walls;
        curvedWalls = state.curvedWalls;
        dimensions = state.dimensions;
        doors = state.doors;
        windows = state.windows;
        rooms = state.rooms;
        furniture = state.furniture;
        electrical = state.electrical;
        redrawCanvas();
        updateStats();
      }
    }
    
    function addRoomTemplate(roomType) {
      console.log('Adding room template:', roomType);
      
      const templates = {
        living: { width: 200, height: 150, name: 'Living Room' },
        kitchen: { width: 150, height: 120, name: 'Kitchen' },
        bedroom: { width: 120, height: 100, name: 'Bedroom' },
        bathroom: { width: 80, height: 80, name: 'Bathroom' },
        dining: { width: 150, height: 100, name: 'Dining Room' },
        office: { width: 100, height: 80, name: 'Office' }
      };
      
      const template = templates[roomType];
      if (template) {
        console.log('Template found:', template);
        saveState();
        rooms.push({
          startX: 100,
          startY: 100,
          endX: 100 + template.width,
          endY: 100 + template.height,
          id: Date.now(),
          name: template.name
        });
        console.log('Added room template, total rooms:', rooms.length);
        redrawCanvas();
        updateStats();
      } else {
        console.log('Template not found for:', roomType);
      }
    }
    
    function clearCanvas() {
      console.log('Clearing canvas...');
      saveState();
      walls = [];
      curvedWalls = [];
      dimensions = [];
      doors = [];
      windows = [];
      rooms = [];
      furniture = [];
      electrical = [];
      redrawCanvas();
      updateStats();
    }
    
    function exportFloorPlan() {
      const link = document.createElement('a');
      link.download = 'floor-plan.png';
      link.href = canvas.toDataURL();
      link.click();
    }
    
    function showSaveModal() {
      document.getElementById('saveModal').style.display = 'flex';
    }
    
    function hideSaveModal() {
      document.getElementById('saveModal').style.display = 'none';
    }
    
    function toggle3D() {
      is3DMode = !is3DMode;
      console.log('3D Mode:', is3DMode ? 'ON' : 'OFF');
      
      if (is3DMode) {
        draw3DView();
      } else {
        redrawCanvas();
      }
    }
    
    function draw3DView() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      
      // Draw 3D perspective
      ctx.fillStyle = '#f0f0f0';
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      
      // Draw rooms in 3D
      rooms.forEach(room => {
        const width = room.endX - room.startX;
        const height = room.endY - room.startY;
        
        // Floor
        ctx.fillStyle = 'rgba(200, 200, 200, 0.8)';
        ctx.fillRect(room.startX, room.startY, width, height);
        
        // Walls in 3D perspective
        ctx.strokeStyle = '#666';
        ctx.lineWidth = 3;
        ctx.beginPath();
        
        // Front wall
        ctx.moveTo(room.startX, room.startY);
        ctx.lineTo(room.endX, room.startY);
        
        // Right wall (perspective)
        ctx.lineTo(room.endX + 20, room.startY - 20);
        ctx.lineTo(room.endX + 20, room.endY - 20);
        
        // Back wall
        ctx.lineTo(room.startX + 20, room.endY - 20);
        ctx.lineTo(room.startX, room.endY);
        
        // Left wall
        ctx.lineTo(room.startX, room.startY);
        ctx.stroke();
      });
      
      // Draw walls in 3D
      walls.forEach(wall => {
        ctx.strokeStyle = '#333';
        ctx.lineWidth = 8;
        ctx.beginPath();
        ctx.moveTo(wall.startX, wall.startY);
        ctx.lineTo(wall.endX, wall.endY);
        ctx.stroke();
        
        // 3D depth
        ctx.strokeStyle = '#555';
        ctx.lineWidth = 4;
        ctx.beginPath();
        ctx.moveTo(wall.startX + 10, wall.startY - 10);
        ctx.lineTo(wall.endX + 10, wall.endY - 10);
        ctx.stroke();
      });
      
      // Draw doors in 3D
      doors.forEach(door => {
        const centerX = (door.startX + door.endX) / 2;
        const centerY = (door.startY + door.endY) / 2;
        
        ctx.strokeStyle = '#8b5cf6';
        ctx.lineWidth = 6;
        ctx.beginPath();
        ctx.moveTo(door.startX, door.startY);
        ctx.lineTo(door.endX, door.endY);
        ctx.stroke();
        
        // Door arc in 3D
        ctx.strokeStyle = '#8b5cf6';
        ctx.lineWidth = 3;
        ctx.beginPath();
        const length = Math.sqrt(Math.pow(door.endX - door.startX, 2) + Math.pow(door.endY - door.startY, 2));
        const radius = length * 0.8;
        ctx.arc(centerX, centerY, radius, 0, Math.PI / 2);
        ctx.stroke();
      });
      
      // Draw windows in 3D
      windows.forEach(window => {
        const centerX = (window.startX + window.endX) / 2;
        const centerY = (window.startY + window.endY) / 2;
        
        ctx.strokeStyle = '#06b6d4';
        ctx.lineWidth = 6;
        ctx.beginPath();
        ctx.moveTo(window.startX, window.startY);
        ctx.lineTo(window.endX, window.endY);
        ctx.stroke();
        
        // Window frame in 3D
        ctx.strokeStyle = '#06b6d4';
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.rect(centerX - 15, centerY - 15, 30, 30);
        ctx.stroke();
      });
      
      // Add 3D title
      ctx.fillStyle = '#333';
      ctx.font = 'bold 24px Arial';
      ctx.fillText('3D VIEW', 20, 40);
    }
    
    function toggleDimensions() {
      showDimensions = !showDimensions;
      const button = document.getElementById('dimensionToggle');
      if (showDimensions) {
        button.innerHTML = '<i class="fas fa-ruler"></i> Hide Dimensions';
        button.classList.add('active');
      } else {
        button.innerHTML = '<i class="fas fa-ruler"></i> Show Dimensions';
        button.classList.remove('active');
      }
      redrawCanvas();
    }
    
    function saveFloorPlan() {
      console.log('Saving floor plan...');
      const floorPlanName = document.getElementById('floorPlanName').value || 'My Floor Plan';
      
      const floorPlanData = {
        name: floorPlanName,
        walls,
        curvedWalls,
        dimensions,
        doors,
        windows,
        rooms,
        furniture,
        electrical,
        timestamp: new Date().toISOString()
      };
      
      console.log('Floor plan data:', floorPlanData);
      
      // Save to localStorage
      const savedPlans = JSON.parse(localStorage.getItem('savedFloorPlans') || '[]');
      savedPlans.push(floorPlanData);
      localStorage.setItem('savedFloorPlans', JSON.stringify(savedPlans));
      
      // Also save as downloadable file
      const dataStr = JSON.stringify(floorPlanData, null, 2);
      const dataBlob = new Blob([dataStr], {type: 'application/json'});
      const url = URL.createObjectURL(dataBlob);
      
      const link = document.createElement('a');
      link.href = url;
      link.download = `${floorPlanName.replace(/[^a-z0-9]/gi, '_').toLowerCase()}.json`;
      link.click();
      
      URL.revokeObjectURL(url);
      
      // Show success message
      alert(`Floor plan "${floorPlanName}" saved successfully!`);
      hideSaveModal();
    }
  </script>
</body>
</html>
