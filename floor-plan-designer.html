<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Floor Plan Designer - NestMate</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Inter', sans-serif;
      background: #1a1a1a;
      color: white;
      overflow: hidden;
    }
    
    .designer-header {
      background: #2d2d2d;
      padding: 15px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid #444;
    }
    
    .designer-title {
      font-size: 18px;
      font-weight: 600;
      color: #8b5cf6;
    }
    
    .designer-controls {
      display: flex;
      gap: 10px;
      align-items: center;
    }
    
    .control-btn {
      background: #8b5cf6;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      transition: background 0.2s;
    }
    
    .control-btn:hover {
      background: #7c3aed;
    }
    
    .control-btn.secondary {
      background: #444;
    }
    
    .control-btn.secondary:hover {
      background: #555;
    }
    
    .designer-content {
      display: flex;
      height: calc(100vh - 70px);
    }
    
    .toolbar {
      width: 200px;
      background: #2d2d2d;
      border-right: 1px solid #444;
      padding: 20px;
      overflow-y: auto;
    }
    
    .tool-section {
      margin-bottom: 25px;
    }
    
    .tool-section h3 {
      color: #8b5cf6;
      font-size: 14px;
      margin-bottom: 10px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .tool-btn {
      width: 100%;
      background: #444;
      color: white;
      border: none;
      padding: 12px;
      border-radius: 6px;
      cursor: pointer;
      margin-bottom: 8px;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .tool-btn:hover {
      background: #555;
    }
    
    .tool-btn.active {
      background: #8b5cf6;
    }
    
    .canvas-container {
      flex: 1;
      position: relative;
      overflow: auto;
      background: #f8f9fa;
    }
    
    #floorPlanCanvas {
      display: block;
      background: white;
      cursor: crosshair;
      background-image: 
        linear-gradient(rgba(0,0,0,0.1) 1px, transparent 1px),
        linear-gradient(90deg, rgba(0,0,0,0.1) 1px, transparent 1px);
      background-size: 20px 20px;
    }
    
    .stats {
      position: absolute;
      top: 10px;
      right: 10px;
      background: rgba(0,0,0,0.8);
      padding: 10px;
      border-radius: 6px;
      font-size: 12px;
    }
    
    .room-templates {
      margin-top: 20px;
    }
    
    .template-item {
      background: #444;
      padding: 10px;
      border-radius: 6px;
      margin-bottom: 8px;
      cursor: pointer;
      transition: background 0.2s;
      text-align: center;
    }
    
    .template-item:hover {
      background: #555;
    }
    
    .template-icon {
      font-size: 20px;
      margin-bottom: 5px;
      color: #8b5cf6;
    }
    
    .template-name {
      font-size: 12px;
    }
    
    .style-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 5px;
      margin-bottom: 10px;
    }
    
    .style-item {
      background: #444;
      padding: 8px;
      border-radius: 4px;
      cursor: pointer;
      transition: background 0.2s;
      text-align: center;
      min-height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .style-item:hover {
      background: #555;
    }
    
    .style-icon {
      font-size: 16px;
    }
    
    .save-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.8);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    
    .save-modal-content {
      background: #2d2d2d;
      padding: 30px;
      border-radius: 12px;
      width: 400px;
      max-width: 90%;
    }
    
    .save-modal h2 {
      color: #8b5cf6;
      margin-bottom: 20px;
      text-align: center;
    }
    
    .save-modal input {
      width: 100%;
      padding: 12px;
      border: 1px solid #444;
      border-radius: 6px;
      background: #444;
      color: white;
      margin-bottom: 15px;
    }
    
    .save-modal input::placeholder {
      color: #888;
    }
    
    .save-modal-buttons {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
    }
  </style>
</head>
<body>
  <div class="designer-header">
    <div class="designer-title">
      <i class="fas fa-drafting-compass"></i> Floor Plan Designer
    </div>
    <div class="designer-controls">
      <button class="control-btn secondary" onclick="toggle3D()">
        <i class="fas fa-cube"></i> 3D View
      </button>
      <button class="control-btn secondary" onclick="clearCanvas()">
        <i class="fas fa-trash"></i> Clear
      </button>
      <button class="control-btn secondary" onclick="exportFloorPlan()">
        <i class="fas fa-download"></i> Export
      </button>
      <button class="control-btn" onclick="showSaveModal()">
        <i class="fas fa-save"></i> Save
      </button>
    </div>
  </div>
  
  <div class="designer-content">
    <div class="toolbar">
      <div class="tool-section">
        <h3>Drawing Tools</h3>
        <button class="tool-btn active" onclick="setTool('wall')">
          <i class="fas fa-minus"></i> Wall
        </button>
        <button class="tool-btn" onclick="setTool('select')">
          <i class="fas fa-mouse-pointer"></i> Select
        </button>
        <button class="tool-btn" onclick="setTool('room')">
          <i class="fas fa-home"></i> Room
        </button>
        <button class="tool-btn" onclick="setTool('text')">
          <i class="fas fa-font"></i> Text
        </button>
      </div>
      
      <div class="tool-section">
        <h3>Doors</h3>
        <div class="style-grid">
          <div class="style-item" onclick="addDoor('single')" title="Single Door">
            <div class="style-icon">üö™</div>
          </div>
          <div class="style-item" onclick="addDoor('double')" title="Double Door">
            <div class="style-icon">üö™üö™</div>
          </div>
          <div class="style-item" onclick="addDoor('sliding')" title="Sliding Door">
            <div class="style-icon">‚¨ÖÔ∏èüö™</div>
          </div>
          <div class="style-item" onclick="addDoor('french')" title="French Door">
            <div class="style-icon">ü™üüö™</div>
          </div>
          <div class="style-item" onclick="addDoor('barn')" title="Barn Door">
            <div class="style-icon">üö™‚¨ÜÔ∏è</div>
          </div>
          <div class="style-item" onclick="addDoor('pocket')" title="Pocket Door">
            <div class="style-icon">‚¨ÖÔ∏è‚¨ÖÔ∏è</div>
          </div>
          <div class="style-item" onclick="addDoor('bifold')" title="Bifold Door">
            <div class="style-icon">üö™üö™</div>
          </div>
          <div class="style-item" onclick="addDoor('accordion')" title="Accordion Door">
            <div class="style-icon">üö™üö™üö™</div>
          </div>
          <div class="style-item" onclick="addDoor('revolving')" title="Revolving Door">
            <div class="style-icon">üîÑ</div>
          </div>
          <div class="style-item" onclick="addDoor('automatic')" title="Automatic Door">
            <div class="style-icon">üö™‚ö°</div>
          </div>
        </div>
      </div>
      
      <div class="tool-section">
        <h3>Windows</h3>
        <div class="style-grid">
          <div class="style-item" onclick="addWindow('single')" title="Single Window">
            <div class="style-icon">ü™ü</div>
          </div>
          <div class="style-item" onclick="addWindow('double')" title="Double Window">
            <div class="style-icon">ü™üü™ü</div>
          </div>
          <div class="style-item" onclick="addWindow('bay')" title="Bay Window">
            <div class="style-icon">ü™üü™üü™ü</div>
          </div>
          <div class="style-item" onclick="addWindow('casement')" title="Casement Window">
            <div class="style-icon">ü™ü‚¨ÖÔ∏è</div>
          </div>
          <div class="style-item" onclick="addWindow('awning')" title="Awning Window">
            <div class="style-icon">ü™ü‚¨ÜÔ∏è</div>
          </div>
          <div class="style-item" onclick="addWindow('sliding')" title="Sliding Window">
            <div class="style-icon">‚¨ÖÔ∏èü™ü</div>
          </div>
          <div class="style-item" onclick="addWindow('picture')" title="Picture Window">
            <div class="style-icon">üñºÔ∏è</div>
          </div>
          <div class="style-item" onclick="addWindow('skylight')" title="Skylight">
            <div class="style-icon">‚òÄÔ∏è</div>
          </div>
          <div class="style-item" onclick="addWindow('transom')" title="Transom Window">
            <div class="style-icon">ü™ü‚¨ÜÔ∏è</div>
          </div>
          <div class="style-item" onclick="addWindow('stained')" title="Stained Glass">
            <div class="style-icon">üåà</div>
          </div>
        </div>
      </div>
      
      <div class="tool-section">
        <h3>Actions</h3>
        <button class="control-btn secondary" onclick="undo()">
          <i class="fas fa-undo"></i> Undo
        </button>
        <button class="control-btn secondary" onclick="redo()">
          <i class="fas fa-redo"></i> Redo
        </button>
      </div>
      
      <div class="room-templates">
        <h3>Room Templates</h3>
        <div class="template-item" onclick="addRoomTemplate('living')">
          <div class="template-icon"><i class="fas fa-couch"></i></div>
          <div class="template-name">Living Room</div>
        </div>
        <div class="template-item" onclick="addRoomTemplate('kitchen')">
          <div class="template-icon"><i class="fas fa-utensils"></i></div>
          <div class="template-name">Kitchen</div>
        </div>
        <div class="template-item" onclick="addRoomTemplate('bedroom')">
          <div class="template-icon"><i class="fas fa-bed"></i></div>
          <div class="template-name">Bedroom</div>
        </div>
        <div class="template-item" onclick="addRoomTemplate('bathroom')">
          <div class="template-icon"><i class="fas fa-bath"></i></div>
          <div class="template-name">Bathroom</div>
        </div>
        <div class="template-item" onclick="addRoomTemplate('dining')">
          <div class="template-icon"><i class="fas fa-chair"></i></div>
          <div class="template-name">Dining Room</div>
        </div>
        <div class="template-item" onclick="addRoomTemplate('office')">
          <div class="template-icon"><i class="fas fa-laptop"></i></div>
          <div class="template-name">Office</div>
        </div>
      </div>
    </div>
    
    <div class="canvas-container">
      <canvas id="floorPlanCanvas" width="1200" height="800"></canvas>
      <div class="stats" id="stats">
        0 Walls ‚Ä¢ 0 Doors ‚Ä¢ 0 Windows ‚Ä¢ 0 Rooms
      </div>
    </div>
  </div>
  
  <!-- Save Modal -->
  <div class="save-modal" id="saveModal">
    <div class="save-modal-content">
      <h2>Save Floor Plan</h2>
      <input type="text" id="floorPlanName" placeholder="Enter floor plan name..." value="My Floor Plan">
      <div class="save-modal-buttons">
        <button class="control-btn secondary" onclick="hideSaveModal()">Cancel</button>
        <button class="control-btn" onclick="saveFloorPlan()">Save</button>
      </div>
    </div>
  </div>
  
  <script>
    let canvas, ctx;
    let currentTool = 'wall';
    let isDrawing = false;
    let startX, startY;
    let walls = [];
    let doors = [];
    let windows = [];
    let rooms = [];
    let history = [];
    let historyIndex = -1;
    let is3DMode = false;
    let selectedElement = null;
    let isDragging = false;
    let dragOffset = { x: 0, y: 0 };
    
    // Initialize the designer
    window.onload = function() {
      canvas = document.getElementById('floorPlanCanvas');
      ctx = canvas.getContext('2d');
      
      // Set up canvas event listeners
      canvas.addEventListener('mousedown', startDrawing);
      canvas.addEventListener('mousemove', draw);
      canvas.addEventListener('mouseup', stopDrawing);
      canvas.addEventListener('mouseout', stopDrawing);
      
      // Set up keyboard event listeners
      document.addEventListener('keydown', handleKeyPress);
      
      // Initialize canvas
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      drawGrid();
    };
    
    function setTool(tool) {
      currentTool = tool;
      document.querySelectorAll('.tool-btn').forEach(btn => btn.classList.remove('active'));
      event.target.classList.add('active');
      console.log('Tool set to:', tool);
      
      // Clear selection when switching tools
      selectedElement = null;
      redrawCanvas();
    }
    
    function addDoor(style) {
      console.log('Adding door style:', style);
      currentTool = 'door';
      selectedDoorStyle = style;
      
      // Add a door at a default position
      const door = {
        startX: 100,
        startY: 100,
        endX: 140,
        endY: 100,
        id: Date.now(),
        type: 'door',
        style: style
      };
      
      doors.push(door);
      redrawCanvas();
      updateStats();
    }
    
    function addWindow(style) {
      console.log('Adding window style:', style);
      currentTool = 'window';
      selectedWindowStyle = style;
      
      // Add a window at a default position
      const window = {
        startX: 200,
        startY: 100,
        endX: 260,
        endY: 100,
        id: Date.now(),
        type: 'window',
        style: style
      };
      
      windows.push(window);
      redrawCanvas();
      updateStats();
    }
    
    function startDrawing(e) {
      const rect = canvas.getBoundingClientRect();
      const rawX = e.clientX - rect.left;
      const rawY = e.clientY - rect.top;
      
      // Snap to grid
      const mouseX = Math.round(rawX / 20) * 20;
      const mouseY = Math.round(rawY / 20) * 20;
      
      if (currentTool === 'select') {
        // Handle selection
        selectedElement = getElementAt(mouseX, mouseY);
        if (selectedElement) {
          isDragging = true;
          dragOffset.x = mouseX - selectedElement.startX;
          dragOffset.y = mouseY - selectedElement.startY;
          console.log('Selected element:', selectedElement);
        } else {
          selectedElement = null;
        }
        redrawCanvas();
        return;
      }
      
      console.log('Starting to draw with tool:', currentTool);
      isDrawing = true;
      startX = mouseX;
      startY = mouseY;
      
      console.log('Start position (snapped):', startX, startY);
      saveState();
    }
    
    function draw(e) {
      const rect = canvas.getBoundingClientRect();
      const rawX = e.clientX - rect.left;
      const rawY = e.clientY - rect.top;
      
      // Snap to grid
      const currentX = Math.round(rawX / 20) * 20;
      const currentY = Math.round(rawY / 20) * 20;
      
      if (isDragging && selectedElement) {
        // Handle dragging selected element
        const newStartX = currentX - dragOffset.x;
        const newStartY = currentY - dragOffset.y;
        const newEndX = newStartX + (selectedElement.endX - selectedElement.startX);
        const newEndY = newStartY + (selectedElement.endY - selectedElement.startY);
        
        selectedElement.startX = newStartX;
        selectedElement.startY = newStartY;
        selectedElement.endX = newEndX;
        selectedElement.endY = newEndY;
        
        redrawCanvas();
        return;
      }
      
      if (!isDrawing) return;
      
      // Clear canvas and redraw everything
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      
      // Draw grid
      drawGrid();
      
      // Draw existing elements
      drawElements();
      
      // Draw current element being drawn with preview
      ctx.strokeStyle = '#8b5cf6';
      ctx.lineWidth = 3;
      ctx.setLineDash([5, 5]); // Dashed line for preview
      ctx.beginPath();
      
      if (currentTool === 'room') {
        // Draw rectangle for room
        ctx.rect(startX, startY, currentX - startX, currentY - startY);
      } else {
        // Draw line for walls, doors, windows
        ctx.moveTo(startX, startY);
        ctx.lineTo(currentX, currentY);
      }
      ctx.stroke();
      ctx.setLineDash([]); // Reset line dash
    }
    
    function stopDrawing(e) {
      if (isDragging) {
        isDragging = false;
        return;
      }
      
      if (!isDrawing) return;
      
      console.log('Stopping drawing with tool:', currentTool);
      isDrawing = false;
      const rect = canvas.getBoundingClientRect();
      const rawX = e.clientX - rect.left;
      const rawY = e.clientY - rect.top;
      
      // Snap to grid
      const endX = Math.round(rawX / 20) * 20;
      const endY = Math.round(rawY / 20) * 20;
      
      console.log('End position (snapped):', endX, endY);
      
      // Add element based on current tool
      switch(currentTool) {
        case 'wall':
          walls.push({startX, startY, endX, endY, id: Date.now(), type: 'wall'});
          console.log('Added wall, total walls:', walls.length);
          break;
        case 'room':
          rooms.push({startX, startY, endX, endY, id: Date.now(), type: 'room'});
          console.log('Added room, total rooms:', rooms.length);
          break;
      }
      
      redrawCanvas();
      updateStats();
    }
    
    function getElementAt(x, y) {
      // Check walls
      for (let wall of walls) {
        if (isPointOnLine(x, y, wall.startX, wall.startY, wall.endX, wall.endY, 10)) {
          return wall;
        }
      }
      
      // Check doors
      for (let door of doors) {
        if (isPointOnLine(x, y, door.startX, door.startY, door.endX, door.endY, 10)) {
          return door;
        }
      }
      
      // Check windows
      for (let window of windows) {
        if (isPointOnLine(x, y, window.startX, window.startY, window.endX, window.endY, 10)) {
          return window;
        }
      }
      
      // Check rooms
      for (let room of rooms) {
        if (x >= room.startX && x <= room.endX && y >= room.startY && y <= room.endY) {
          return room;
        }
      }
      
      return null;
    }
    
    function isPointOnLine(px, py, x1, y1, x2, y2, tolerance) {
      const A = px - x1;
      const B = py - y1;
      const C = x2 - x1;
      const D = y2 - y1;
      
      const dot = A * C + B * D;
      const lenSq = C * C + D * D;
      let param = -1;
      
      if (lenSq !== 0) {
        param = dot / lenSq;
      }
      
      let xx, yy;
      
      if (param < 0) {
        xx = x1;
        yy = y1;
      } else if (param > 1) {
        xx = x2;
        yy = y2;
      } else {
        xx = x1 + param * C;
        yy = y1 + param * D;
      }
      
      const dx = px - xx;
      const dy = py - yy;
      return Math.sqrt(dx * dx + dy * dy) <= tolerance;
    }
    
    function handleKeyPress(e) {
      if (e.key === 'Delete' || e.key === 'Backspace') {
        if (selectedElement) {
          console.log('Deleting selected element:', selectedElement);
          
          // Remove from appropriate array
          if (selectedElement.type === 'wall') {
            const index = walls.indexOf(selectedElement);
            if (index > -1) walls.splice(index, 1);
          } else if (selectedElement.type === 'door') {
            const index = doors.indexOf(selectedElement);
            if (index > -1) doors.splice(index, 1);
          } else if (selectedElement.type === 'window') {
            const index = windows.indexOf(selectedElement);
            if (index > -1) windows.splice(index, 1);
          } else if (selectedElement.type === 'room') {
            const index = rooms.indexOf(selectedElement);
            if (index > -1) rooms.splice(index, 1);
          }
          
          selectedElement = null;
          redrawCanvas();
          updateStats();
        }
      }
    }
    
    function drawGrid() {
      ctx.strokeStyle = 'rgba(0,0,0,0.1)';
      ctx.lineWidth = 1;
      
      // Vertical lines
      for (let x = 0; x <= canvas.width; x += 20) {
        ctx.beginPath();
        ctx.moveTo(x, 0);
        ctx.lineTo(x, canvas.height);
        ctx.stroke();
      }
      
      // Horizontal lines
      for (let y = 0; y <= canvas.height; y += 20) {
        ctx.beginPath();
        ctx.moveTo(0, y);
        ctx.lineTo(canvas.width, y);
        ctx.stroke();
      }
    }
    
    function drawElements() {
      // Draw rooms first (background)
      ctx.fillStyle = 'rgba(139, 92, 246, 0.1)';
      ctx.strokeStyle = '#8b5cf6';
      ctx.lineWidth = 2;
      rooms.forEach(room => {
        ctx.beginPath();
        ctx.rect(room.startX, room.startY, room.endX - room.startX, room.endY - room.startY);
        ctx.fill();
        ctx.stroke();
      });
      
      // Draw walls
      ctx.strokeStyle = '#333';
      ctx.lineWidth = 6;
      walls.forEach(wall => {
        ctx.beginPath();
        ctx.moveTo(wall.startX, wall.startY);
        ctx.lineTo(wall.endX, wall.endY);
        ctx.stroke();
      });
      
      // Draw doors with different styles
      doors.forEach(door => {
        const centerX = (door.startX + door.endX) / 2;
        const centerY = (door.startY + door.endY) / 2;
        const length = Math.sqrt(Math.pow(door.endX - door.startX, 2) + Math.pow(door.endY - door.startY, 2));
        
        // Highlight if selected
        if (selectedElement === door) {
          ctx.strokeStyle = '#ff6b6b';
          ctx.lineWidth = 6;
        } else {
          ctx.strokeStyle = '#8b5cf6';
          ctx.lineWidth = 4;
        }
        
        ctx.beginPath();
        ctx.moveTo(door.startX, door.startY);
        ctx.lineTo(door.endX, door.endY);
        ctx.stroke();
        
        // Draw door style based on type
        ctx.strokeStyle = '#8b5cf6';
        ctx.lineWidth = 2;
        ctx.beginPath();
        
        switch(door.style) {
          case 'single':
            const radius = length * 0.8;
            ctx.arc(centerX, centerY, radius, 0, Math.PI / 2);
            break;
          case 'double':
            ctx.arc(centerX - length/4, centerY, length/2, 0, Math.PI / 2);
            ctx.arc(centerX + length/4, centerY, length/2, Math.PI / 2, Math.PI);
            break;
          case 'sliding':
            ctx.moveTo(centerX - length/2, centerY - 5);
            ctx.lineTo(centerX + length/2, centerY - 5);
            break;
          case 'french':
            ctx.arc(centerX - length/4, centerY, length/3, 0, Math.PI / 2);
            ctx.arc(centerX + length/4, centerY, length/3, Math.PI / 2, Math.PI);
            break;
          default:
            ctx.arc(centerX, centerY, length * 0.8, 0, Math.PI / 2);
        }
        ctx.stroke();
        
        // Add door style indicator
        ctx.fillStyle = '#8b5cf6';
        ctx.font = '8px Arial';
        ctx.fillText(door.style, centerX + 5, centerY - 5);
      });
      
      // Draw windows with different styles
      windows.forEach(window => {
        const centerX = (window.startX + window.endX) / 2;
        const centerY = (window.startY + window.endY) / 2;
        
        // Highlight if selected
        if (selectedElement === window) {
          ctx.strokeStyle = '#ff6b6b';
          ctx.lineWidth = 6;
        } else {
          ctx.strokeStyle = '#06b6d4';
          ctx.lineWidth = 4;
        }
        
        ctx.beginPath();
        ctx.moveTo(window.startX, window.startY);
        ctx.lineTo(window.endX, window.endY);
        ctx.stroke();
        
        // Draw window style based on type
        ctx.strokeStyle = '#06b6d4';
        ctx.lineWidth = 1;
        ctx.beginPath();
        
        switch(window.style) {
          case 'single':
            ctx.moveTo(centerX - 10, centerY);
            ctx.lineTo(centerX + 10, centerY);
            ctx.moveTo(centerX, centerY - 10);
            ctx.lineTo(centerX, centerY + 10);
            break;
          case 'double':
            ctx.moveTo(centerX - 15, centerY);
            ctx.lineTo(centerX + 15, centerY);
            ctx.moveTo(centerX - 15, centerY - 10);
            ctx.lineTo(centerX - 15, centerY + 10);
            ctx.moveTo(centerX + 15, centerY - 10);
            ctx.lineTo(centerX + 15, centerY + 10);
            break;
          case 'bay':
            ctx.moveTo(centerX - 20, centerY);
            ctx.lineTo(centerX + 20, centerY);
            ctx.moveTo(centerX - 20, centerY - 15);
            ctx.lineTo(centerX - 20, centerY + 15);
            ctx.moveTo(centerX, centerY - 15);
            ctx.lineTo(centerX, centerY + 15);
            ctx.moveTo(centerX + 20, centerY - 15);
            ctx.lineTo(centerX + 20, centerY + 15);
            break;
          default:
            ctx.moveTo(centerX - 10, centerY);
            ctx.lineTo(centerX + 10, centerY);
            ctx.moveTo(centerX, centerY - 10);
            ctx.lineTo(centerX, centerY + 10);
        }
        ctx.stroke();
        
        // Add window style indicator
        ctx.fillStyle = '#06b6d4';
        ctx.font = '8px Arial';
        ctx.fillText(window.style, centerX + 5, centerY - 5);
      });
    }
    
    function redrawCanvas() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      drawGrid();
      drawElements();
    }
    
    function updateStats() {
      document.getElementById('stats').textContent = 
        `${walls.length} Walls ‚Ä¢ ${doors.length} Doors ‚Ä¢ ${windows.length} Windows ‚Ä¢ ${rooms.length} Rooms`;
    }
    
    function saveState() {
      historyIndex++;
      if (historyIndex < history.length) {
        history.length = historyIndex;
      }
      history.push({
        walls: JSON.parse(JSON.stringify(walls)),
        doors: JSON.parse(JSON.stringify(doors)),
        windows: JSON.parse(JSON.stringify(windows)),
        rooms: JSON.parse(JSON.stringify(rooms))
      });
    }
    
    function undo() {
      if (historyIndex > 0) {
        historyIndex--;
        const state = history[historyIndex];
        walls = state.walls;
        doors = state.doors;
        windows = state.windows;
        rooms = state.rooms;
        redrawCanvas();
        updateStats();
      }
    }
    
    function redo() {
      if (historyIndex < history.length - 1) {
        historyIndex++;
        const state = history[historyIndex];
        walls = state.walls;
        doors = state.doors;
        windows = state.windows;
        rooms = state.rooms;
        redrawCanvas();
        updateStats();
      }
    }
    
    function addRoomTemplate(roomType) {
      console.log('Adding room template:', roomType);
      
      const templates = {
        living: { width: 200, height: 150, name: 'Living Room' },
        kitchen: { width: 150, height: 120, name: 'Kitchen' },
        bedroom: { width: 120, height: 100, name: 'Bedroom' },
        bathroom: { width: 80, height: 80, name: 'Bathroom' },
        dining: { width: 150, height: 100, name: 'Dining Room' },
        office: { width: 100, height: 80, name: 'Office' }
      };
      
      const template = templates[roomType];
      if (template) {
        console.log('Template found:', template);
        saveState();
        rooms.push({
          startX: 100,
          startY: 100,
          endX: 100 + template.width,
          endY: 100 + template.height,
          id: Date.now(),
          name: template.name
        });
        console.log('Added room template, total rooms:', rooms.length);
        redrawCanvas();
        updateStats();
      } else {
        console.log('Template not found for:', roomType);
      }
    }
    
    function clearCanvas() {
      console.log('Clearing canvas...');
      saveState();
      walls = [];
      doors = [];
      windows = [];
      rooms = [];
      redrawCanvas();
      updateStats();
    }
    
    function exportFloorPlan() {
      const link = document.createElement('a');
      link.download = 'floor-plan.png';
      link.href = canvas.toDataURL();
      link.click();
    }
    
    function showSaveModal() {
      document.getElementById('saveModal').style.display = 'flex';
    }
    
    function hideSaveModal() {
      document.getElementById('saveModal').style.display = 'none';
    }
    
    function toggle3D() {
      is3DMode = !is3DMode;
      console.log('3D Mode:', is3DMode ? 'ON' : 'OFF');
      
      if (is3DMode) {
        draw3DView();
      } else {
        redrawCanvas();
      }
    }
    
    function draw3DView() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      
      // Draw 3D perspective
      ctx.fillStyle = '#f0f0f0';
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      
      // Draw rooms in 3D
      rooms.forEach(room => {
        const width = room.endX - room.startX;
        const height = room.endY - room.startY;
        
        // Floor
        ctx.fillStyle = 'rgba(200, 200, 200, 0.8)';
        ctx.fillRect(room.startX, room.startY, width, height);
        
        // Walls in 3D perspective
        ctx.strokeStyle = '#666';
        ctx.lineWidth = 3;
        ctx.beginPath();
        
        // Front wall
        ctx.moveTo(room.startX, room.startY);
        ctx.lineTo(room.endX, room.startY);
        
        // Right wall (perspective)
        ctx.lineTo(room.endX + 20, room.startY - 20);
        ctx.lineTo(room.endX + 20, room.endY - 20);
        
        // Back wall
        ctx.lineTo(room.startX + 20, room.endY - 20);
        ctx.lineTo(room.startX, room.endY);
        
        // Left wall
        ctx.lineTo(room.startX, room.startY);
        ctx.stroke();
      });
      
      // Draw walls in 3D
      walls.forEach(wall => {
        ctx.strokeStyle = '#333';
        ctx.lineWidth = 8;
        ctx.beginPath();
        ctx.moveTo(wall.startX, wall.startY);
        ctx.lineTo(wall.endX, wall.endY);
        ctx.stroke();
        
        // 3D depth
        ctx.strokeStyle = '#555';
        ctx.lineWidth = 4;
        ctx.beginPath();
        ctx.moveTo(wall.startX + 10, wall.startY - 10);
        ctx.lineTo(wall.endX + 10, wall.endY - 10);
        ctx.stroke();
      });
      
      // Draw doors in 3D
      doors.forEach(door => {
        const centerX = (door.startX + door.endX) / 2;
        const centerY = (door.startY + door.endY) / 2;
        
        ctx.strokeStyle = '#8b5cf6';
        ctx.lineWidth = 6;
        ctx.beginPath();
        ctx.moveTo(door.startX, door.startY);
        ctx.lineTo(door.endX, door.endY);
        ctx.stroke();
        
        // Door arc in 3D
        ctx.strokeStyle = '#8b5cf6';
        ctx.lineWidth = 3;
        ctx.beginPath();
        const length = Math.sqrt(Math.pow(door.endX - door.startX, 2) + Math.pow(door.endY - door.startY, 2));
        const radius = length * 0.8;
        ctx.arc(centerX, centerY, radius, 0, Math.PI / 2);
        ctx.stroke();
      });
      
      // Draw windows in 3D
      windows.forEach(window => {
        const centerX = (window.startX + window.endX) / 2;
        const centerY = (window.startY + window.endY) / 2;
        
        ctx.strokeStyle = '#06b6d4';
        ctx.lineWidth = 6;
        ctx.beginPath();
        ctx.moveTo(window.startX, window.startY);
        ctx.lineTo(window.endX, window.endY);
        ctx.stroke();
        
        // Window frame in 3D
        ctx.strokeStyle = '#06b6d4';
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.rect(centerX - 15, centerY - 15, 30, 30);
        ctx.stroke();
      });
      
      // Add 3D title
      ctx.fillStyle = '#333';
      ctx.font = 'bold 24px Arial';
      ctx.fillText('3D VIEW', 20, 40);
    }
    
    function saveFloorPlan() {
      console.log('Saving floor plan...');
      const floorPlanName = document.getElementById('floorPlanName').value || 'My Floor Plan';
      
      const floorPlanData = {
        name: floorPlanName,
        walls,
        doors,
        windows,
        rooms,
        timestamp: new Date().toISOString()
      };
      
      console.log('Floor plan data:', floorPlanData);
      
      // Save to localStorage
      const savedPlans = JSON.parse(localStorage.getItem('savedFloorPlans') || '[]');
      savedPlans.push(floorPlanData);
      localStorage.setItem('savedFloorPlans', JSON.stringify(savedPlans));
      
      // Also save as downloadable file
      const dataStr = JSON.stringify(floorPlanData, null, 2);
      const dataBlob = new Blob([dataStr], {type: 'application/json'});
      const url = URL.createObjectURL(dataBlob);
      
      const link = document.createElement('a');
      link.href = url;
      link.download = `${floorPlanName.replace(/[^a-z0-9]/gi, '_').toLowerCase()}.json`;
      link.click();
      
      URL.revokeObjectURL(url);
      
      // Show success message
      alert(`Floor plan "${floorPlanName}" saved successfully!`);
      hideSaveModal();
    }
  </script>
</body>
</html>
