<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NestMate - Smart Home Management</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <!-- Google Maps JavaScript API -->
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyC_dBBCQ9R3n0KiZ6RodccRsUHoBov7GSA&libraries=places"></script>
    
    <!-- Firebase SDK v12 -->
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-analytics.js";
        import { getAuth, signOut, onAuthStateChanged, updateProfile } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
        import { getFirestore, collection, doc, getDocs, addDoc, updateDoc, deleteDoc, query, orderBy, where, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyD-4kmEmEH6OPtGK-ez7GkCHV31mg5iNhk",
            authDomain: "nestmateusa-4914c.firebaseapp.com",
            projectId: "nestmateusa-4914c",
            storageBucket: "nestmateusa-4914c.firebasestorage.app",
            messagingSenderId: "907781112999",
            appId: "1:907781112999:web:b9585789c6cceac0e64782",
            measurementId: "G-35WBBNXHB8"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Make Firebase services available globally
        window.firebaseAuth = auth;
        window.firebaseDB = db;
        window.firebaseServices = {
            signOut,
            onAuthStateChanged,
            updateProfile,
            collection,
            doc,
            getDocs,
            addDoc,
            updateDoc,
            deleteDoc,
            query,
            orderBy,
            where,
            getDoc,
            setDoc
        };

        console.log('Firebase initialized successfully in NestMate.html');
    </script>
    
    <style>
        :root {
            --primary: #2563eb;
            --primary-dark: #1d4ed8;
            --secondary: #64748b;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --light: #f8fafc;
            --dark: #1e293b;
            --border: #e2e8f0;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            --radius: 12px;
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: var(--dark);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        .header {
            background: white;
            border-radius: var(--radius);
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: var(--shadow);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 24px;
            font-weight: 700;
            color: var(--primary);
        }

        .logo i {
            font-size: 32px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
        }

        /* Home Selector */
        .home-selector {
            background: white;
            border-radius: var(--radius);
            padding: 20px;
            margin-bottom: 24px;
            box-shadow: var(--shadow);
        }

        .home-selector-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .home-selector h2 {
            color: var(--dark);
            font-size: 18px;
            font-weight: 600;
        }

        .home-dropdown {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        select {
            padding: 8px 16px;
            border: 2px solid var(--border);
            border-radius: var(--radius);
            font-size: 14px;
            background: white;
            cursor: pointer;
            transition: var(--transition);
        }

        select:focus {
            outline: none;
            border-color: var(--primary);
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: var(--radius);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
        }

        .btn-secondary {
            background: var(--light);
            color: var(--dark);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            background: var(--border);
        }

        /* Dashboard Grid */
        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
            margin-bottom: 24px;
        }

        .card {
            background: white;
            border-radius: var(--radius);
            padding: 24px;
            box-shadow: var(--shadow);
            transition: var(--transition);
        }

        .card:hover {
            box-shadow: var(--shadow-lg);
            transform: translateY(-2px);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .card-actions {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .card-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--dark);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .card-title i {
            color: var(--primary);
        }

        /* Home Details */
        .home-details {
            grid-column: 1 / -1;
        }

        .details-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
        }

        .detail-item {
            padding: 16px;
            background: var(--light);
            border-radius: var(--radius);
            border-left: 4px solid var(--primary);
        }

        .detail-label {
            font-size: 12px;
            color: var(--secondary);
            font-weight: 500;
            margin-bottom: 4px;
        }

        .detail-value {
            font-size: 16px;
            font-weight: 600;
            color: var(--dark);
        }

        /* Task Manager */
        .task-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .task-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            margin-bottom: 8px;
            transition: var(--transition);
        }

        .task-item:hover {
            background: var(--light);
        }

        .task-checkbox {
            width: 20px;
            height: 20px;
            accent-color: var(--success);
        }

        .task-content {
            flex: 1;
        }

        .task-title {
            font-weight: 500;
            margin-bottom: 4px;
        }

        .task-due {
            font-size: 12px;
            color: var(--secondary);
        }

        .task-priority {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
        }

        .priority-high {
            background: #fef2f2;
            color: var(--danger);
        }

        .priority-medium {
            background: #fffbeb;
            color: var(--warning);
        }

        .priority-low {
            background: #f0fdf4;
            color: var(--success);
        }

        /* Quick Actions */
        .quick-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 12px;
        }

        /* Home Details Sections */
        .home-sections {
            grid-column: 1 / -1;
        }

        .section-item {
            background: white;
            border-radius: var(--radius);
            margin-bottom: 16px;
            box-shadow: var(--shadow);
            overflow: hidden;
        }

        .section-header {
            background: var(--light);
            padding: 16px 20px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border);
            transition: var(--transition);
        }

        .section-header:hover {
            background: var(--border);
        }

        .section-header h3 {
            font-size: 16px;
            font-weight: 600;
            color: var(--dark);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .section-header i {
            color: var(--primary);
        }

        .section-toggle {
            background: none;
            border: none;
            font-size: 18px;
            color: var(--secondary);
            cursor: pointer;
            transition: var(--transition);
        }

        .section-toggle:hover {
            color: var(--primary);
        }

        .section-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .section-content.expanded {
            max-height: 2000px;
        }

        .section-details {
            padding: 20px;
        }

        .detail-row {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr auto;
            gap: 16px;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid var(--border);
        }

        .detail-row:last-child {
            border-bottom: none;
        }

        .detail-field {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .detail-label {
            font-size: 12px;
            color: var(--secondary);
            font-weight: 500;
        }

        .detail-value {
            font-size: 14px;
            color: var(--dark);
            font-weight: 500;
        }

        .detail-actions {
            display: flex;
            gap: 8px;
        }

        .action-icon {
            background: none;
            border: none;
            font-size: 14px;
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            transition: var(--transition);
        }

        .action-icon.edit {
            color: var(--primary);
        }

        .action-icon.delete {
            color: var(--danger);
        }

        .action-icon:hover {
            background: var(--light);
        }

        .add-detail-btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: var(--radius);
            font-size: 14px;
            cursor: pointer;
            transition: var(--transition);
            margin-top: 16px;
        }

        .add-detail-btn:hover {
            background: var(--primary-dark);
        }

        .edit-form {
            display: none;
            background: var(--light);
            padding: 16px;
            border-radius: var(--radius);
            margin-top: 12px;
        }

        .edit-form.show {
            display: block;
        }

        .edit-form-row {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 12px;
            margin-bottom: 12px;
        }

        .edit-form input,
        .edit-form select,
        .edit-form textarea {
            padding: 8px 12px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 14px;
        }

        .edit-form textarea {
            resize: vertical;
            min-height: 60px;
        }

        .edit-form-buttons {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
        }

        /* Room Management Styles */
        .room-management {
            padding: 20px 0;
        }

        .room-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 16px;
            background: var(--light);
            border-radius: var(--radius);
        }

        .room-selector {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .room-selector label {
            font-weight: 600;
            color: var(--dark);
            font-size: 14px;
        }

        .room-selector select {
            padding: 8px 12px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 14px;
            min-width: 200px;
        }

        .room-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 16px;
            background: var(--primary);
            color: white;
            border-radius: var(--radius);
        }

        .room-header h4 {
            margin: 0;
            font-size: 18px;
        }

        .room-actions {
            display: flex;
            gap: 8px;
        }

        .room-actions .btn {
            font-size: 12px;
            padding: 6px 12px;
        }

        .room-detail-item {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr auto;
            gap: 16px;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid var(--border);
        }

        .room-detail-item:last-child {
            border-bottom: none;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }

        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            border-radius: var(--radius);
            padding: 24px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--border);
        }

        .modal-header h3 {
            margin: 0;
            color: var(--dark);
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--secondary);
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            color: var(--dark);
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 14px;
            box-sizing: border-box;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .modal-footer {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            margin-top: 20px;
            padding-top: 12px;
            border-top: 1px solid var(--border);
        }

        .action-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            padding: 16px;
            border: 2px solid var(--border);
            border-radius: var(--radius);
            background: white;
            cursor: pointer;
            transition: var(--transition);
            text-decoration: none;
            color: var(--dark);
        }

        .action-btn:hover {
            border-color: var(--primary);
            background: var(--light);
        }

        .action-btn i {
            font-size: 24px;
            color: var(--primary);
        }

        .action-btn span {
            font-size: 12px;
            font-weight: 500;
            text-align: center;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            backdrop-filter: blur(4px);
        }

        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            border-radius: var(--radius);
            padding: 32px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-lg);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--dark);
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--secondary);
            padding: 4px;
        }

        .close-btn:hover {
            color: var(--danger);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--dark);
        }

        .form-input {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--border);
            border-radius: var(--radius);
            font-size: 14px;
            transition: var(--transition);
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        /* Google Maps Autocomplete Styles */
        .pac-container {
            border-radius: var(--radius);
            border: 2px solid var(--primary);
            box-shadow: var(--shadow-lg);
            font-family: 'Inter', sans-serif;
            z-index: 9999;
        }

        .pac-item {
            padding: 12px 16px;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            transition: var(--transition);
        }

        .pac-item:hover {
            background-color: var(--light);
        }

        .pac-item:last-child {
            border-bottom: none;
        }

        .pac-item-query {
            font-weight: 600;
            color: var(--dark);
        }

        .pac-matched {
            font-weight: 600;
            color: var(--primary);
        }

        .pac-secondary-text {
            color: var(--secondary);
            font-size: 14px;
        }

        /* Ensure autocomplete dropdown appears above modals */
        .modal .pac-container {
            z-index: 10000;
        }

        /* Style for autocomplete input focus */
        .form-input:focus + .pac-container {
            border-color: var(--primary);
        }

        /* Profile Modal Styles */
        .profile-avatar-section {
            text-align: center;
            margin-bottom: 24px;
        }

        .profile-avatar {
            position: relative;
            display: inline-block;
            width: 120px;
            height: 120px;
            border-radius: 50%;
            overflow: hidden;
            border: 4px solid var(--primary);
            background: var(--light);
        }

        .profile-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .avatar-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.7);
            padding: 8px;
            transform: translateY(100%);
            transition: var(--transition);
        }

        .profile-avatar:hover .avatar-overlay {
            transform: translateY(0);
        }

        .avatar-upload-btn {
            color: white;
            cursor: pointer;
            font-size: 16px;
        }

        .avatar-upload-btn:hover {
            color: var(--primary);
        }

        .checkbox-group {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            padding: 8px;
            border-radius: var(--radius);
            transition: var(--transition);
        }

        .checkbox-item:hover {
            background: var(--light);
        }

        .checkbox-item input[type="checkbox"] {
            width: 16px;
            height: 16px;
            accent-color: var(--primary);
        }

        .checkbox-item span {
            font-size: 14px;
            color: var(--dark);
        }

        /* User avatar hover effect */
        .user-avatar:hover {
            background: var(--light);
            transform: scale(1.05);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        .btn-group {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            margin-top: 24px;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .header {
                flex-direction: column;
                gap: 16px;
            }

            .home-selector-header {
                flex-direction: column;
                gap: 12px;
                align-items: stretch;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="logo">
                <i class="fas fa-home"></i>
                NestMate
            </div>
            <div class="user-info">
                <span id="userEmail">Demo User</span>
                <div class="user-avatar" onclick="openProfileModal()" style="cursor: pointer;">
                    <i class="fas fa-user"></i>
                </div>
                <button class="btn btn-secondary" onclick="signOut()">
                    <i class="fas fa-sign-out-alt"></i>
                    Sign Out
                </button>
            </div>
        </div>

        <!-- Home Selector -->
        <div class="home-selector">
            <div class="home-selector-header">
                <h2>Select Your Home</h2>
                <div class="home-dropdown">
                    <select id="homeSelect" onchange="loadHomeData()">
                        <option value="">Select a home...</option>
                        <option value="home1">My First Home</option>
                        <option value="home2">Vacation House</option>
                    </select>
                    <button class="btn btn-primary" onclick="openAddHomeModal()">
                        <i class="fas fa-plus"></i>
                        Add Home
                    </button>
                </div>
            </div>
        </div>

        <!-- Dashboard Grid -->
        <div class="dashboard-grid">
            <!-- Home Details -->
            <div class="card home-details">
                <div class="card-header">
                    <h3 class="card-title">
                        <i class="fas fa-info-circle"></i>
                        Home Details
                    </h3>
                    <div class="card-actions">
                        <button class="btn btn-secondary" onclick="openEditHomeModal()">
                            <i class="fas fa-edit"></i>
                            Edit
                        </button>
                        <button class="btn btn-danger" onclick="deleteCurrentHome()" id="deleteHomeBtn" style="display: none;">
                            <i class="fas fa-trash"></i>
                            Delete
                        </button>
                    </div>
                </div>
                <div id="homeDetailsContent">
                    <div class="details-grid">
                        <div class="detail-item">
                            <div class="detail-label">Home Name</div>
                            <div class="detail-value">My First Home</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Address</div>
                            <div class="detail-value">123 Main St, City, State</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Year Built</div>
                            <div class="detail-value">2020</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Square Feet</div>
                            <div class="detail-value">2,500</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Bedrooms</div>
                            <div class="detail-value">3</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Bathrooms</div>
                            <div class="detail-value">2.5</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Purchase Price</div>
                            <div class="detail-value">$350,000</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Property Type</div>
                            <div class="detail-value">Single Family</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Task Manager -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">
                        <i class="fas fa-tasks"></i>
                        Maintenance Tasks
                    </h3>
                    <button class="btn btn-primary" onclick="openAddTaskModal()">
                        <i class="fas fa-plus"></i>
                        Add Task
                    </button>
                </div>
                <div id="taskList" class="task-list">
                    <div class="task-item">
                        <input type="checkbox" class="task-checkbox" onchange="toggleTask(this)">
                        <div class="task-content">
                            <div class="task-title">Replace Air Filter</div>
                            <div class="task-due">Due: Dec 15, 2024</div>
                        </div>
                        <span class="task-priority priority-medium">Medium</span>
                        <button class="btn btn-secondary" onclick="deleteTask(this)" style="padding: 4px 8px;">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                    <div class="task-item">
                        <input type="checkbox" class="task-checkbox" onchange="toggleTask(this)">
                        <div class="task-content">
                            <div class="task-title">HVAC Maintenance</div>
                            <div class="task-due">Due: Jan 20, 2025</div>
                        </div>
                        <span class="task-priority priority-high">High</span>
                        <button class="btn btn-secondary" onclick="deleteTask(this)" style="padding: 4px 8px;">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                    <div class="task-item">
                        <input type="checkbox" class="task-checkbox" onchange="toggleTask(this)">
                        <div class="task-content">
                            <div class="task-title">Clean Gutters</div>
                            <div class="task-due">Due: Nov 30, 2024</div>
                        </div>
                        <span class="task-priority priority-low">Low</span>
                        <button class="btn btn-secondary" onclick="deleteTask(this)" style="padding: 4px 8px;">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            </div>

                         <!-- Quick Actions -->
             <div class="card">
                 <div class="card-header">
                     <h3 class="card-title">
                         <i class="fas fa-bolt"></i>
                         Quick Actions
                     </h3>
                 </div>
                 <div class="quick-actions">
                     <button class="action-btn" onclick="openAddTaskModal()">
                         <i class="fas fa-plus-circle"></i>
                         <span>Add Task</span>
                     </button>
                     <button class="action-btn" onclick="openEditHomeModal()">
                         <i class="fas fa-edit"></i>
                         <span>Edit Home</span>
                     </button>
                     <button class="action-btn" onclick="openAddHomeModal()">
                         <i class="fas fa-home"></i>
                         <span>Add Home</span>
                     </button>
                     <button class="action-btn" onclick="exportData()">
                         <i class="fas fa-download"></i>
                         <span>Export Data</span>
                     </button>
                 </div>
             </div>

             <!-- Comprehensive Home Details -->
             <div class="card home-sections">
                 <div class="card-header">
                     <h3 class="card-title">
                         <i class="fas fa-clipboard-list"></i>
                         Home Details & Specifications
                     </h3>
                 </div>
                 
                 <!-- Roof Section -->
                 <div class="section-item">
                     <div class="section-header" onclick="toggleSection('roof')">
                         <h3><i class="fas fa-home"></i> Roof & Attic</h3>
                         <button class="section-toggle" id="roof-toggle">▼</button>
                     </div>
                     <div class="section-content" id="roof-content">
                         <div class="section-details">
                             <div class="detail-row">
                                 <div class="detail-field">
                                     <div class="detail-label">Roof Type</div>
                                     <div class="detail-value">Asphalt Shingle</div>
                                 </div>
                                 <div class="detail-field">
                                     <div class="detail-label">Installation Date</div>
                                     <div class="detail-value">2020-05-15</div>
                                 </div>
                                 <div class="detail-field">
                                     <div class="detail-label">Warranty Expiry</div>
                                     <div class="detail-value">2030-05-15</div>
                                 </div>
                                 <div class="detail-actions">
                                     <button class="action-icon edit" onclick="editDetail('roof', 0)"><i class="fas fa-edit"></i></button>
                                     <button class="action-icon delete" onclick="deleteDetail('roof', 0)"><i class="fas fa-trash"></i></button>
                                 </div>
                             </div>
                             <div class="detail-row">
                                 <div class="detail-field">
                                     <div class="detail-label">Attic Insulation</div>
                                     <div class="detail-value">R-38 Fiberglass</div>
                                 </div>
                                 <div class="detail-field">
                                     <div class="detail-label">Ventilation</div>
                                     <div class="detail-value">Ridge & Soffit Vents</div>
                                 </div>
                                 <div class="detail-field">
                                     <div class="detail-label">Last Inspection</div>
                                     <div class="detail-value">2024-03-10</div>
                                 </div>
                                 <div class="detail-actions">
                                     <button class="action-icon edit" onclick="editDetail('roof', 1)"><i class="fas fa-edit"></i></button>
                                     <button class="action-icon delete" onclick="deleteDetail('roof', 1)"><i class="fas fa-trash"></i></button>
                                 </div>
                             </div>
                             <button class="add-detail-btn" onclick="addDetail('roof')">
                                 <i class="fas fa-plus"></i> Add Roof Detail
                             </button>
                         </div>
                     </div>
                 </div>

                 <!-- Exterior Section -->
                 <div class="section-item">
                     <div class="section-header" onclick="toggleSection('exterior')">
                         <h3><i class="fas fa-paint-brush"></i> Exterior & Siding</h3>
                         <button class="section-toggle" id="exterior-toggle">▼</button>
                     </div>
                     <div class="section-content" id="exterior-content">
                         <div class="section-details">
                             <div class="detail-row">
                                 <div class="detail-field">
                                     <div class="detail-label">Siding Material</div>
                                     <div class="detail-value">Vinyl</div>
                                 </div>
                                 <div class="detail-field">
                                     <div class="detail-label">Color</div>
                                     <div class="detail-value">Beige</div>
                                 </div>
                                 <div class="detail-field">
                                     <div class="detail-label">Last Paint Date</div>
                                     <div class="detail-value">2022-08-20</div>
                                 </div>
                                 <div class="detail-actions">
                                     <button class="action-icon edit" onclick="editDetail('exterior', 0)"><i class="fas fa-edit"></i></button>
                                     <button class="action-icon delete" onclick="deleteDetail('exterior', 0)"><i class="fas fa-trash"></i></button>
                                 </div>
                             </div>
                             <div class="detail-row">
                                 <div class="detail-field">
                                     <div class="detail-label">Gutters</div>
                                     <div class="detail-value">Aluminum, 6"</div>
                                 </div>
                                 <div class="detail-field">
                                     <div class="detail-label">Downspouts</div>
                                     <div class="detail-value">4 total</div>
                                 </div>
                                 <div class="detail-field">
                                     <div class="detail-label">Last Cleaning</div>
                                     <div class="detail-value">2024-04-15</div>
                                 </div>
                                 <div class="detail-actions">
                                     <button class="action-icon edit" onclick="editDetail('exterior', 1)"><i class="fas fa-edit"></i></button>
                                     <button class="action-icon delete" onclick="deleteDetail('exterior', 1)"><i class="fas fa-trash"></i></button>
                                 </div>
                             </div>
                             <button class="add-detail-btn" onclick="addDetail('exterior')">
                                 <i class="fas fa-plus"></i> Add Exterior Detail
                             </button>
                         </div>
                     </div>
                 </div>

                 <!-- HVAC Section -->
                 <div class="section-item">
                     <div class="section-header" onclick="toggleSection('hvac')">
                         <h3><i class="fas fa-thermometer-half"></i> HVAC & Climate Control</h3>
                         <button class="section-toggle" id="hvac-toggle">▼</button>
                     </div>
                     <div class="section-content" id="hvac-content">
                         <div class="section-details">
                             <div class="detail-row">
                                 <div class="detail-field">
                                     <div class="detail-label">Furnace Type</div>
                                     <div class="detail-value">Gas Forced Air</div>
                                 </div>
                                 <div class="detail-field">
                                     <div class="detail-label">Model</div>
                                     <div class="detail-value">Carrier 58STA</div>
                                 </div>
                                 <div class="detail-field">
                                     <div class="detail-label">Installation Date</div>
                                     <div class="detail-value">2019-11-05</div>
                                 </div>
                                 <div class="detail-actions">
                                     <button class="action-icon edit" onclick="editDetail('hvac', 0)"><i class="fas fa-edit"></i></button>
                                     <button class="action-icon delete" onclick="deleteDetail('hvac', 0)"><i class="fas fa-trash"></i></button>
                                 </div>
                             </div>
                             <div class="detail-row">
                                 <div class="detail-field">
                                     <div class="detail-label">AC Unit</div>
                                     <div class="detail-value">Central Air, 3.5 Ton</div>
                                 </div>
                                 <div class="detail-field">
                                     <div class="detail-label">Filter Size</div>
                                     <div class="detail-value">16x20x1</div>
                                 </div>
                                 <div class="detail-field">
                                     <div class="detail-label">Last Service</div>
                                     <div class="detail-value">2024-05-20</div>
                                 </div>
                                 <div class="detail-actions">
                                     <button class="action-icon edit" onclick="editDetail('hvac', 1)"><i class="fas fa-edit"></i></button>
                                     <button class="action-icon delete" onclick="deleteDetail('hvac', 1)"><i class="fas fa-trash"></i></button>
                                 </div>
                             </div>
                             <button class="add-detail-btn" onclick="addDetail('hvac')">
                                 <i class="fas fa-plus"></i> Add HVAC Detail
                             </button>
                         </div>
                     </div>
                 </div>

                 <!-- Plumbing Section -->
                 <div class="section-item">
                     <div class="section-header" onclick="toggleSection('plumbing')">
                         <h3><i class="fas fa-tint"></i> Plumbing & Water Systems</h3>
                         <button class="section-toggle" id="plumbing-toggle">▼</button>
                     </div>
                     <div class="section-content" id="plumbing-content">
                         <div class="section-details">
                             <div class="detail-row">
                                 <div class="detail-field">
                                     <div class="detail-label">Water Heater</div>
                                     <div class="detail-value">Gas, 50 Gallon</div>
                                 </div>
                                 <div class="detail-field">
                                     <div class="detail-label">Model</div>
                                     <div class="detail-value">Rheem XG50T12HE40U0</div>
                                 </div>
                                 <div class="detail-field">
                                     <div class="detail-label">Installation Date</div>
                                     <div class="detail-value">2021-03-12</div>
                                 </div>
                                 <div class="detail-actions">
                                     <button class="action-icon edit" onclick="editDetail('plumbing', 0)"><i class="fas fa-edit"></i></button>
                                     <button class="action-icon delete" onclick="deleteDetail('plumbing', 0)"><i class="fas fa-trash"></i></button>
                                 </div>
                             </div>
                             <div class="detail-row">
                                 <div class="detail-field">
                                     <div class="detail-label">Main Water Line</div>
                                     <div class="detail-value">Copper, 3/4"</div>
                                 </div>
                                 <div class="detail-field">
                                     <div class="detail-label">Sewer Type</div>
                                     <div class="detail-value">Municipal</div>
                                 </div>
                                 <div class="detail-field">
                                     <div class="detail-label">Last Inspection</div>
                                     <div class="detail-value">2024-02-08</div>
                                 </div>
                                 <div class="detail-actions">
                                     <button class="action-icon edit" onclick="editDetail('plumbing', 1)"><i class="fas fa-edit"></i></button>
                                     <button class="action-icon delete" onclick="deleteDetail('plumbing', 1)"><i class="fas fa-trash"></i></button>
                                 </div>
                             </div>
                             <button class="add-detail-btn" onclick="addDetail('plumbing')">
                                 <i class="fas fa-plus"></i> Add Plumbing Detail
                             </button>
                         </div>
                     </div>
                 </div>

                 <!-- Electrical Section -->
                 <div class="section-item">
                     <div class="section-header" onclick="toggleSection('electrical')">
                         <h3><i class="fas fa-bolt"></i> Electrical Systems</h3>
                         <button class="section-toggle" id="electrical-toggle">▼</button>
                     </div>
                     <div class="section-content" id="electrical-content">
                         <div class="section-details">
                             <div class="detail-row">
                                 <div class="detail-field">
                                     <div class="detail-label">Panel Type</div>
                                     <div class="detail-value">200 Amp, Square D</div>
                                 </div>
                                 <div class="detail-field">
                                     <div class="detail-label">Circuit Count</div>
                                     <div class="detail-value">24 Circuits</div>
                                 </div>
                                 <div class="detail-field">
                                     <div class="detail-label">Last Inspection</div>
                                     <div class="detail-value">2023-09-15</div>
                                 </div>
                                 <div class="detail-actions">
                                     <button class="action-icon edit" onclick="editDetail('electrical', 0)"><i class="fas fa-edit"></i></button>
                                     <button class="action-icon delete" onclick="deleteDetail('electrical', 0)"><i class="fas fa-trash"></i></button>
                                 </div>
                             </div>
                             <div class="detail-row">
                                 <div class="detail-field">
                                     <div class="detail-label">Wiring Type</div>
                                     <div class="detail-value">Copper, 12/2</div>
                                 </div>
                                 <div class="detail-field">
                                     <div class="detail-label">Outlets</div>
                                     <div class="detail-value">GFCI in Kitchen/Bath</div>
                                 </div>
                                 <div class="detail-field">
                                     <div class="detail-label">Smoke Detectors</div>
                                     <div class="detail-value">6 Total</div>
                                 </div>
                                 <div class="detail-actions">
                                     <button class="action-icon edit" onclick="editDetail('electrical', 1)"><i class="fas fa-edit"></i></button>
                                     <button class="action-icon delete" onclick="deleteDetail('electrical', 1)"><i class="fas fa-trash"></i></button>
                                 </div>
                             </div>
                             <button class="add-detail-btn" onclick="addDetail('electrical')">
                                 <i class="fas fa-plus"></i> Add Electrical Detail
                             </button>
                         </div>
                     </div>
                 </div>

                 <!-- Interior Section -->
                 <div class="section-item">
                     <div class="section-header" onclick="toggleSection('interior')">
                         <h3><i class="fas fa-couch"></i> Interior & Finishes</h3>
                         <button class="section-toggle" id="interior-toggle">▼</button>
                     </div>
                     <div class="section-content" id="interior-content">
                         <div class="section-details">
                             <div class="detail-row">
                                 <div class="detail-field">
                                     <div class="detail-label">Flooring</div>
                                     <div class="detail-value">Hardwood, Carpet, Tile</div>
                                 </div>
                                 <div class="detail-field">
                                     <div class="detail-label">Wall Material</div>
                                     <div class="detail-value">Drywall</div>
                                 </div>
                                 <div class="detail-field">
                                     <div class="detail-label">Ceiling Height</div>
                                     <div class="detail-value">9' Standard</div>
                                 </div>
                                 <div class="detail-actions">
                                     <button class="action-icon edit" onclick="editDetail('interior', 0)"><i class="fas fa-edit"></i></button>
                                     <button class="action-icon delete" onclick="deleteDetail('interior', 0)"><i class="fas fa-trash"></i></button>
                                 </div>
                             </div>
                             <div class="detail-row">
                                 <div class="detail-field">
                                     <div class="detail-label">Windows</div>
                                     <div class="detail-value">Double Pane, Vinyl</div>
                                 </div>
                                 <div class="detail-field">
                                     <div class="detail-label">Doors</div>
                                     <div class="detail-value">Solid Core Interior</div>
                                 </div>
                                 <div class="detail-field">
                                     <div class="detail-label">Last Paint</div>
                                     <div class="detail-value">2023-06-10</div>
                                 </div>
                                 <div class="detail-actions">
                                     <button class="action-icon edit" onclick="editDetail('interior', 1)"><i class="fas fa-edit"></i></button>
                                     <button class="action-icon delete" onclick="deleteDetail('interior', 1)"><i class="fas fa-trash"></i></button>
                                 </div>
                             </div>
                             <button class="add-detail-btn" onclick="addDetail('interior')">
                                 <i class="fas fa-plus"></i> Add Interior Detail
                             </button>
                         </div>
                     </div>
                 </div>

                                   <!-- Foundation Section -->
                  <div class="section-item">
                      <div class="section-header" onclick="toggleSection('foundation')">
                          <h3><i class="fas fa-layer-group"></i> Foundation & Structure</h3>
                          <button class="section-toggle" id="foundation-toggle">▼</button>
                      </div>
                      <div class="section-content" id="foundation-content">
                          <div class="section-details">
                              <div class="detail-row">
                                  <div class="detail-field">
                                      <div class="detail-label">Foundation Type</div>
                                      <div class="detail-value">Poured Concrete</div>
                                  </div>
                                  <div class="detail-field">
                                      <div class="detail-label">Basement</div>
                                      <div class="detail-value">Finished, 1,200 sq ft</div>
                                  </div>
                                  <div class="detail-field">
                                      <div class="detail-label">Last Inspection</div>
                                      <div class="detail-value">2024-01-20</div>
                                  </div>
                                  <div class="detail-actions">
                                      <button class="action-icon edit" onclick="editDetail('foundation', 0)"><i class="fas fa-edit"></i></button>
                                      <button class="action-icon delete" onclick="deleteDetail('foundation', 0)"><i class="fas fa-trash"></i></button>
                                  </div>
                              </div>
                              <div class="detail-row">
                                  <div class="detail-field">
                                      <div class="detail-label">Framing</div>
                                      <div class="detail-value">2x6 Studs, 16" OC</div>
                                  </div>
                                  <div class="detail-field">
                                      <div class="detail-label">Insulation</div>
                                      <div class="detail-value">R-19 Walls, R-30 Ceiling</div>
                                  </div>
                                  <div class="detail-field">
                                      <div class="detail-label">Vapor Barrier</div>
                                      <div class="detail-value">6 Mil Polyethylene</div>
                                  </div>
                                  <div class="detail-actions">
                                      <button class="action-icon edit" onclick="editDetail('foundation', 1)"><i class="fas fa-edit"></i></button>
                                      <button class="action-icon delete" onclick="deleteDetail('foundation', 1)"><i class="fas fa-trash"></i></button>
                                  </div>
                              </div>
                              <button class="add-detail-btn" onclick="addDetail('foundation')">
                                  <i class="fas fa-plus"></i> Add Foundation Detail
                              </button>
                          </div>
                      </div>
                  </div>

                  <!-- Garage Section -->
                  <div class="section-item">
                      <div class="section-header" onclick="toggleSection('garage')">
                          <h3><i class="fas fa-warehouse"></i> Garage & Parking</h3>
                          <button class="section-toggle" id="garage-toggle">▼</button>
                      </div>
                      <div class="section-content" id="garage-content">
                          <div class="section-details">
                              <div class="detail-row">
                                  <div class="detail-field">
                                      <div class="detail-label">Garage Type</div>
                                      <div class="detail-value">Attached, 2-Car</div>
                                  </div>
                                  <div class="detail-field">
                                      <div class="detail-label">Size</div>
                                      <div class="detail-value">24' x 20'</div>
                                  </div>
                                  <div class="detail-field">
                                      <div class="detail-label">Door Type</div>
                                      <div class="detail-value">Automatic, 2 Doors</div>
                                  </div>
                                  <div class="detail-actions">
                                      <button class="action-icon edit" onclick="editDetail('garage', 0)"><i class="fas fa-edit"></i></button>
                                      <button class="action-icon delete" onclick="deleteDetail('garage', 0)"><i class="fas fa-trash"></i></button>
                                  </div>
                              </div>
                              <div class="detail-row">
                                  <div class="detail-field">
                                      <div class="detail-label">Flooring</div>
                                      <div class="detail-value">Concrete, Epoxy Coated</div>
                                  </div>
                                  <div class="detail-field">
                                      <div class="detail-label">Storage</div>
                                      <div class="detail-value">Overhead Racks, Cabinets</div>
                                  </div>
                                  <div class="detail-field">
                                      <div class="detail-label">Last Maintenance</div>
                                      <div class="detail-value">2024-02-15</div>
                                  </div>
                                  <div class="detail-actions">
                                      <button class="action-icon edit" onclick="editDetail('garage', 1)"><i class="fas fa-edit"></i></button>
                                      <button class="action-icon delete" onclick="deleteDetail('garage', 1)"><i class="fas fa-trash"></i></button>
                                  </div>
                              </div>
                              <button class="add-detail-btn" onclick="addDetail('garage')">
                                  <i class="fas fa-plus"></i> Add Garage Detail
                              </button>
                          </div>
                      </div>
                  </div>

                  <!-- Windows Section -->
                  <div class="section-item">
                      <div class="section-header" onclick="toggleSection('windows')">
                          <h3><i class="fas fa-window-maximize"></i> Windows & Glazing</h3>
                          <button class="section-toggle" id="windows-toggle">▼</button>
                      </div>
                      <div class="section-content" id="windows-content">
                          <div class="section-details">
                              <div class="detail-row">
                                  <div class="detail-field">
                                      <div class="detail-label">Window Type</div>
                                      <div class="detail-value">Double Hung, Vinyl</div>
                                  </div>
                                  <div class="detail-field">
                                      <div class="detail-label">Glazing</div>
                                      <div class="detail-value">Double Pane, Low-E</div>
                                  </div>
                                  <div class="detail-field">
                                      <div class="detail-label">Total Count</div>
                                      <div class="detail-value">12 Windows</div>
                                  </div>
                                  <div class="detail-actions">
                                      <button class="action-icon edit" onclick="editDetail('windows', 0)"><i class="fas fa-edit"></i></button>
                                      <button class="action-icon delete" onclick="deleteDetail('windows', 0)"><i class="fas fa-trash"></i></button>
                                  </div>
                              </div>
                              <div class="detail-row">
                                  <div class="detail-field">
                                      <div class="detail-label">Installation Date</div>
                                      <div class="detail-value">2021-08-10</div>
                                  </div>
                                  <div class="detail-field">
                                      <div class="detail-label">Warranty</div>
                                      <div class="detail-value">Lifetime</div>
                                  </div>
                                  <div class="detail-field">
                                      <div class="detail-label">Last Cleaning</div>
                                      <div class="detail-value">2024-03-25</div>
                                  </div>
                                  <div class="detail-actions">
                                      <button class="action-icon edit" onclick="editDetail('windows', 1)"><i class="fas fa-edit"></i></button>
                                      <button class="action-icon delete" onclick="deleteDetail('windows', 1)"><i class="fas fa-trash"></i></button>
                                  </div>
                              </div>
                              <button class="add-detail-btn" onclick="addDetail('windows')">
                                  <i class="fas fa-plus"></i> Add Window Detail
                              </button>
                          </div>
                      </div>
                  </div>

                  <!-- Doors Section -->
                  <div class="section-item">
                      <div class="section-header" onclick="toggleSection('doors')">
                          <h3><i class="fas fa-door-open"></i> Doors & Entryways</h3>
                          <button class="section-toggle" id="doors-toggle">▼</button>
                      </div>
                      <div class="section-content" id="doors-content">
                          <div class="section-details">
                              <div class="detail-row">
                                  <div class="detail-field">
                                      <div class="detail-label">Front Door</div>
                                      <div class="detail-value">Steel, 36" x 80"</div>
                                  </div>
                                  <div class="detail-field">
                                      <div class="detail-label">Lock Type</div>
                                      <div class="detail-value">Smart Lock, Keypad</div>
                                  </div>
                                  <div class="detail-field">
                                      <div class="detail-label">Installation Date</div>
                                      <div class="detail-value">2022-05-12</div>
                                  </div>
                                  <div class="detail-actions">
                                      <button class="action-icon edit" onclick="editDetail('doors', 0)"><i class="fas fa-edit"></i></button>
                                      <button class="action-icon delete" onclick="deleteDetail('doors', 0)"><i class="fas fa-trash"></i></button>
                                  </div>
                              </div>
                              <div class="detail-row">
                                  <div class="detail-field">
                                      <div class="detail-label">Interior Doors</div>
                                      <div class="detail-value">Solid Core, 6-Panel</div>
                                  </div>
                                  <div class="detail-field">
                                      <div class="detail-label">Hardware</div>
                                      <div class="detail-value">Brass, Privacy Locks</div>
                                  </div>
                                  <div class="detail-field">
                                      <div class="detail-label">Total Count</div>
                                      <div class="detail-value">8 Interior Doors</div>
                                  </div>
                                  <div class="detail-actions">
                                      <button class="action-icon edit" onclick="editDetail('doors', 1)"><i class="fas fa-edit"></i></button>
                                      <button class="action-icon delete" onclick="deleteDetail('doors', 1)"><i class="fas fa-trash"></i></button>
                                  </div>
                              </div>
                              <button class="add-detail-btn" onclick="addDetail('doors')">
                                  <i class="fas fa-plus"></i> Add Door Detail
                              </button>
                          </div>
                      </div>
                  </div>

                  <!-- Decks & Patios Section -->
                  <div class="section-item">
                      <div class="section-header" onclick="toggleSection('outdoor')">
                          <h3><i class="fas fa-umbrella-beach"></i> Decks, Patios & Outdoor</h3>
                          <button class="section-toggle" id="outdoor-toggle">▼</button>
                      </div>
                      <div class="section-content" id="outdoor-content">
                          <div class="section-details">
                              <div class="detail-row">
                                  <div class="detail-field">
                                      <div class="detail-label">Deck Material</div>
                                      <div class="detail-value">Composite, 12' x 16'</div>
                                  </div>
                                  <div class="detail-field">
                                      <div class="detail-label">Railings</div>
                                      <div class="detail-value">Aluminum, 42" Height</div>
                                  </div>
                                  <div class="detail-field">
                                      <div class="detail-label">Installation Date</div>
                                      <div class="detail-value">2023-06-20</div>
                                  </div>
                                  <div class="detail-actions">
                                      <button class="action-icon edit" onclick="editDetail('outdoor', 0)"><i class="fas fa-edit"></i></button>
                                      <button class="action-icon delete" onclick="deleteDetail('outdoor', 0)"><i class="fas fa-trash"></i></button>
                                  </div>
                              </div>
                              <div class="detail-row">
                                  <div class="detail-field">
                                      <div class="detail-label">Patio</div>
                                      <div class="detail-value">Concrete, 20' x 15'</div>
                                  </div>
                                  <div class="detail-field">
                                      <div class="detail-label">Coverage</div>
                                      <div class="detail-value">Pergola, 10' x 12'</div>
                                  </div>
                                  <div class="detail-field">
                                      <div class="detail-label">Last Sealing</div>
                                      <div class="detail-value">2024-04-10</div>
                                  </div>
                                  <div class="detail-actions">
                                      <button class="action-icon edit" onclick="editDetail('outdoor', 1)"><i class="fas fa-edit"></i></button>
                                      <button class="action-icon delete" onclick="deleteDetail('outdoor', 1)"><i class="fas fa-trash"></i></button>
                                  </div>
                              </div>
                              <button class="add-detail-btn" onclick="addDetail('outdoor')">
                                  <i class="fas fa-plus"></i> Add Outdoor Detail
                              </button>
                          </div>
                      </div>
                  </div>

                  <!-- Lot & Landscaping Section -->
                  <div class="section-item">
                      <div class="section-header" onclick="toggleSection('landscaping')">
                          <h3><i class="fas fa-seedling"></i> Lot & Landscaping</h3>
                          <button class="section-toggle" id="landscaping-toggle">▼</button>
                      </div>
                      <div class="section-content" id="landscaping-content">
                          <div class="section-details">
                              <div class="detail-row">
                                  <div class="detail-field">
                                      <div class="detail-label">Lot Size</div>
                                      <div class="detail-value">0.35 Acres</div>
                                  </div>
                                  <div class="detail-field">
                                      <div class="detail-label">Dimensions</div>
                                      <div class="detail-value">100' x 150'</div>
                                  </div>
                                  <div class="detail-field">
                                      <div class="detail-label">Zoning</div>
                                      <div class="detail-value">Residential R-1</div>
                                  </div>
                                  <div class="detail-actions">
                                      <button class="action-icon edit" onclick="editDetail('landscaping', 0)"><i class="fas fa-edit"></i></button>
                                      <button class="action-icon delete" onclick="deleteDetail('landscaping', 0)"><i class="fas fa-trash"></i></button>
                                  </div>
                              </div>
                              <div class="detail-row">
                                  <div class="detail-field">
                                      <div class="detail-label">Trees</div>
                                      <div class="detail-value">5 Mature, 3 New</div>
                                  </div>
                                  <div class="detail-field">
                                      <div class="detail-label">Lawn Type</div>
                                      <div class="detail-value">Kentucky Bluegrass</div>
                                  </div>
                                  <div class="detail-field">
                                      <div class="detail-label">Last Maintenance</div>
                                      <div class="detail-value">2024-05-15</div>
                                  </div>
                                  <div class="detail-actions">
                                      <button class="action-icon edit" onclick="editDetail('landscaping', 1)"><i class="fas fa-edit"></i></button>
                                      <button class="action-icon delete" onclick="deleteDetail('landscaping', 1)"><i class="fas fa-trash"></i></button>
                                  </div>
                              </div>
                              <button class="add-detail-btn" onclick="addDetail('landscaping')">
                                  <i class="fas fa-plus"></i> Add Landscaping Detail
                              </button>
                          </div>
                      </div>
                  </div>

                  <!-- Irrigation Section -->
                  <div class="section-item">
                      <div class="section-header" onclick="toggleSection('irrigation')">
                          <h3><i class="fas fa-tint"></i> Irrigation & Watering</h3>
                          <button class="section-toggle" id="irrigation-toggle">▼</button>
                      </div>
                      <div class="section-content" id="irrigation-content">
                          <div class="section-details">
                              <div class="detail-row">
                                  <div class="detail-field">
                                      <div class="detail-label">System Type</div>
                                      <div class="detail-value">Automatic Sprinkler</div>
                                  </div>
                                  <div class="detail-field">
                                      <div class="detail-label">Zones</div>
                                      <div class="detail-value">6 Zones</div>
                                  </div>
                                  <div class="detail-field">
                                      <div class="detail-label">Controller</div>
                                      <div class="detail-value">Smart Controller</div>
                                  </div>
                                  <div class="detail-actions">
                                      <button class="action-icon edit" onclick="editDetail('irrigation', 0)"><i class="fas fa-edit"></i></button>
                                      <button class="action-icon delete" onclick="deleteDetail('irrigation', 0)"><i class="fas fa-trash"></i></button>
                                  </div>
                              </div>
                              <div class="detail-row">
                                  <div class="detail-field">
                                      <div class="detail-label">Heads</div>
                                      <div class="detail-value">24 Sprinkler Heads</div>
                                  </div>
                                  <div class="detail-field">
                                      <div class="detail-label">Installation Date</div>
                                      <div class="detail-value">2022-04-08</div>
                                  </div>
                                  <div class="detail-field">
                                      <div class="detail-label">Last Service</div>
                                      <div class="detail-value">2024-04-20</div>
                                  </div>
                                  <div class="detail-actions">
                                      <button class="action-icon edit" onclick="editDetail('irrigation', 1)"><i class="fas fa-edit"></i></button>
                                      <button class="action-icon delete" onclick="deleteDetail('irrigation', 1)"><i class="fas fa-trash"></i></button>
                                  </div>
                              </div>
                              <button class="add-detail-btn" onclick="addDetail('irrigation')">
                                  <i class="fas fa-plus"></i> Add Irrigation Detail
                              </button>
                          </div>
                      </div>
                  </div>

                  <!-- Fencing Section -->
                  <div class="section-item">
                      <div class="section-header" onclick="toggleSection('fencing')">
                          <h3><i class="fas fa-border-all"></i> Fencing & Boundaries</h3>
                          <button class="section-toggle" id="fencing-toggle">▼</button>
                      </div>
                      <div class="section-content" id="fencing-content">
                          <div class="section-details">
                              <div class="detail-row">
                                  <div class="detail-field">
                                      <div class="detail-label">Fence Type</div>
                                      <div class="detail-value">Privacy, 6' Height</div>
                                  </div>
                                  <div class="detail-field">
                                      <div class="detail-label">Material</div>
                                      <div class="detail-value">Vinyl, White</div>
                                  </div>
                                  <div class="detail-field">
                                      <div class="detail-label">Length</div>
                                      <div class="detail-value">300 Linear Feet</div>
                                  </div>
                                  <div class="detail-actions">
                                      <button class="action-icon edit" onclick="editDetail('fencing', 0)"><i class="fas fa-edit"></i></button>
                                      <button class="action-icon delete" onclick="deleteDetail('fencing', 0)"><i class="fas fa-trash"></i></button>
                                  </div>
                              </div>
                              <div class="detail-row">
                                  <div class="detail-field">
                                      <div class="detail-label">Gates</div>
                                      <div class="detail-value">2 Gates, Automatic</div>
                                  </div>
                                  <div class="detail-field">
                                      <div class="detail-label">Installation Date</div>
                                      <div class="detail-value">2021-09-15</div>
                                  </div>
                                  <div class="detail-field">
                                      <div class="detail-label">Warranty</div>
                                      <div class="detail-value">Lifetime</div>
                                  </div>
                                  <div class="detail-actions">
                                      <button class="action-icon edit" onclick="editDetail('fencing', 1)"><i class="fas fa-edit"></i></button>
                                      <button class="action-icon delete" onclick="deleteDetail('fencing', 1)"><i class="fas fa-trash"></i></button>
                                  </div>
                              </div>
                              <button class="add-detail-btn" onclick="addDetail('fencing')">
                                  <i class="fas fa-plus"></i> Add Fencing Detail
                              </button>
                          </div>
                      </div>
                  </div>

                  <!-- Room Management Section -->
                  <div class="section-item">
                      <div class="section-header" onclick="toggleSection('rooms')">
                          <h3><i class="fas fa-door-closed"></i> Room-by-Room Details</h3>
                          <button class="section-toggle" id="rooms-toggle">▼</button>
                      </div>
                      <div class="section-content" id="rooms-content">
                          <div class="section-details">
                              <!-- Room Selection and Management -->
                              <div class="room-management">
                                  <div class="room-controls">
                                      <div class="room-selector">
                                          <label for="roomSelect">Select Room:</label>
                                          <select id="roomSelect" onchange="showRoomDetails()">
                                              <option value="">Choose a room...</option>
                                          </select>
                                      </div>
                                      <button class="btn btn-primary" onclick="openAddRoomModal()">
                                          <i class="fas fa-plus"></i> Add New Room
                                      </button>
                                  </div>
                                  
                                  <!-- Room Details Display -->
                                  <div id="roomDetailsContainer" style="display: none;">
                                      <div class="room-header">
                                          <h4 id="currentRoomName">Room Name</h4>
                                          <div class="room-actions">
                                              <button class="btn btn-secondary" onclick="editRoomInfo()">
                                                  <i class="fas fa-edit"></i> Edit Room Info
                                              </button>
                                              <button class="btn btn-danger" onclick="deleteRoom()">
                                                  <i class="fas fa-trash"></i> Delete Room
                                              </button>
                                          </div>
                                      </div>
                                      
                                      <div id="roomDetailsList">
                                          <!-- Room details will be populated here -->
                                      </div>
                                      
                                      <button class="add-detail-btn" onclick="addRoomDetail()">
                                          <i class="fas fa-plus"></i> Add Room Detail
                                      </button>
                                  </div>
                              </div>
                          </div>
                      </div>
                  </div>
             </div>
        </div>
    </div>

    <!-- Add Home Modal -->
    <div id="addHomeModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Add New Home</h3>
                <button class="close-btn" onclick="closeModal('addHomeModal')">&times;</button>
            </div>
            <form id="addHomeForm">
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Home Name</label>
                        <input type="text" class="form-input" id="homeName" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Address</label>
                        <input type="text" class="form-input" id="homeAddress" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Year Built</label>
                        <input type="number" class="form-input" id="yearBuilt" min="1800" max="2030">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Square Feet</label>
                        <input type="number" class="form-input" id="squareFeet" min="100">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Bedrooms</label>
                        <input type="number" class="form-input" id="bedrooms" min="0" max="20">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Bathrooms</label>
                        <input type="number" class="form-input" id="bathrooms" min="0" max="20" step="0.5">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Purchase Price</label>
                        <input type="number" class="form-input" id="purchasePrice" min="0">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Property Type</label>
                        <select class="form-input" id="propertyType">
                            <option value="single-family">Single Family</option>
                            <option value="townhouse">Townhouse</option>
                            <option value="condo">Condo</option>
                            <option value="apartment">Apartment</option>
                            <option value="multi-family">Multi-Family</option>
                        </select>
                    </div>
                </div>
                <div class="btn-group">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('addHomeModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Home</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Task Modal -->
    <div id="addTaskModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Add Maintenance Task</h3>
                <button class="close-btn" onclick="closeModal('addTaskModal')">&times;</button>
            </div>
            <form id="addTaskForm">
                <div class="form-group">
                    <label class="form-label">Task Title</label>
                    <input type="text" class="form-input" id="taskTitle" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Description</label>
                    <textarea class="form-input" id="taskDescription" rows="3"></textarea>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Due Date</label>
                        <input type="date" class="form-input" id="taskDueDate" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Priority</label>
                        <select class="form-input" id="taskPriority">
                            <option value="low">Low</option>
                            <option value="medium">Medium</option>
                            <option value="high">High</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Category</label>
                    <select class="form-input" id="taskCategory">
                        <option value="air-filter">Air Filter Replacement</option>
                        <option value="hvac">HVAC Maintenance</option>
                        <option value="plumbing">Plumbing</option>
                        <option value="electrical">Electrical</option>
                        <option value="roofing">Roofing</option>
                        <option value="landscaping">Landscaping</option>
                        <option value="cleaning">Cleaning</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                <div class="btn-group">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('addTaskModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Task</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Home Modal -->
    <div id="editHomeModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Edit Home Details</h3>
                <button class="close-btn" onclick="closeModal('editHomeModal')">&times;</button>
            </div>
            <form id="editHomeForm">
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Home Name</label>
                        <input type="text" class="form-input" id="editHomeName" name="editHomeName" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Address</label>
                        <input type="text" class="form-input" id="editHomeAddress" name="editHomeAddress" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Year Built</label>
                        <input type="number" class="form-input" id="editYearBuilt" name="editYearBuilt" min="1800" max="2030">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Square Feet</label>
                        <input type="number" class="form-input" id="editSquareFeet" name="editSquareFeet" min="100">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Bedrooms</label>
                        <input type="number" class="form-input" id="editBedrooms" name="editBedrooms" min="0" max="20">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Bathrooms</label>
                        <input type="number" class="form-input" id="editBathrooms" name="editBathrooms" min="0" max="20" step="0.5">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Purchase Price</label>
                        <input type="number" class="form-input" id="editPurchasePrice" name="editPurchasePrice" min="0">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Property Type</label>
                        <select class="form-input" id="editPropertyType" name="editPropertyType">
                            <option value="single-family">Single Family</option>
                            <option value="townhouse">Townhouse</option>
                            <option value="condo">Condo</option>
                            <option value="apartment">Apartment</option>
                            <option value="multi-family">Multi-Family</option>
                        </select>
                    </div>
                </div>
                <div class="btn-group">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('editHomeModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Profile Modal -->
    <div id="profileModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">User Profile</h3>
                <button class="close-btn" onclick="closeModal('profileModal')">&times;</button>
            </div>
            <form id="profileForm">
                <div class="profile-avatar-section">
                    <div class="profile-avatar">
                        <img id="profileAvatar" src="https://ui-avatars.com/api/?name=User&size=120&background=2563eb&color=fff" alt="Profile Avatar">
                        <div class="avatar-overlay">
                            <label for="avatarInput" class="avatar-upload-btn">
                                <i class="fas fa-camera"></i>
                            </label>
                            <input type="file" id="avatarInput" accept="image/*" style="display: none;">
                        </div>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Full Name</label>
                        <input type="text" class="form-input" id="profileName" name="profileName" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-input" id="profileEmail" name="profileEmail" required readonly>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Phone Number</label>
                        <input type="tel" class="form-input" id="profilePhone" name="profilePhone">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Address</label>
                        <input type="text" class="form-input" id="profileAddress" name="profileAddress">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Bio</label>
                    <textarea class="form-input" id="profileBio" name="profileBio" rows="3" placeholder="Tell us about yourself..."></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Notification Preferences</label>
                    <div class="checkbox-group">
                        <label class="checkbox-item">
                            <input type="checkbox" id="emailNotifications" name="emailNotifications" checked>
                            <span>Email Notifications</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="taskReminders" name="taskReminders" checked>
                            <span>Task Reminders</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="maintenanceAlerts" name="maintenanceAlerts" checked>
                            <span>Maintenance Alerts</span>
                        </label>
                    </div>
                </div>
                <div class="btn-group">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('profileModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Profile</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Global homes data structure
        let homes = {};

        // Load homes from Firebase
        async function loadHomesFromFirebase() {
            if (!currentUserId || !window.firebaseDB || !window.firebaseServices) {
                console.log('User not authenticated or Firebase not ready');
                return;
            }

            try {
                console.log('Loading homes from Firebase for user:', currentUserId);
                
                const homesQuery = window.firebaseServices.query(
                    window.firebaseServices.collection(window.firebaseDB, 'homes'),
                    window.firebaseServices.where('userId', '==', currentUserId)
                );
                
                const querySnapshot = await window.firebaseServices.getDocs(homesQuery);
                
                // Clear existing homes
                homes = {};
                
                querySnapshot.forEach((doc) => {
                    const homeData = doc.data();
                    homes[doc.id] = { id: doc.id, ...homeData };
                });
                
                console.log('Loaded homes:', homes);
                
                // Update home selector dropdown
                updateHomeSelector();
                
            } catch (error) {
                console.error('Error loading homes from Firebase:', error);
            }
        }

        // Update home selector dropdown
        function updateHomeSelector() {
            const homeSelect = document.getElementById('homeSelect');
            
            // Clear existing options except the first one
            while (homeSelect.children.length > 1) {
                homeSelect.removeChild(homeSelect.lastChild);
            }
            
            // Add homes to dropdown
            Object.values(homes).forEach(home => {
                const option = document.createElement('option');
                option.value = home.id;
                option.textContent = home.name || 'Unnamed Home';
                homeSelect.appendChild(option);
            });
        }

        // Load home data when a home is selected
        async function loadHomeData() {
            const homeSelect = document.getElementById('homeSelect');
            const selectedHomeId = homeSelect.value;
            const deleteHomeBtn = document.getElementById('deleteHomeBtn');
            
            if (!selectedHomeId || selectedHomeId === '') {
                console.log('No home selected');
                clearHomeDetails();
                deleteHomeBtn.style.display = 'none';
                return;
            }
            
            const selectedHome = homes[selectedHomeId];
            
            if (!selectedHome) {
                console.log('Selected home not found in local data');
                deleteHomeBtn.style.display = 'none';
                return;
            }
            
            console.log('Loading home details:', selectedHome);
            displayHomeDetails(selectedHome);
            deleteHomeBtn.style.display = 'inline-flex';
        }

        // Delete current home
        async function deleteCurrentHome() {
            const homeSelect = document.getElementById('homeSelect');
            const selectedHomeId = homeSelect.value;
            
            if (!selectedHomeId || selectedHomeId === '') {
                alert('No home selected to delete.');
                return;
            }
            
            const selectedHome = homes[selectedHomeId];
            
            if (!selectedHome) {
                alert('Selected home not found. Please refresh and try again.');
                return;
            }
            
            // Confirm deletion
            const confirmMessage = `Are you sure you want to delete "${selectedHome.name}"?\n\nThis action cannot be undone and will permanently remove all data associated with this home.`;
            const confirmed = confirm(confirmMessage);
            
            if (!confirmed) {
                return;
            }
            
            console.log('Deleting home:', selectedHome.name);
            
            // Delete from Firebase
            const success = await deleteHomeFromFirebase(selectedHomeId);
            
            if (success) {
                alert(`"${selectedHome.name}" has been deleted successfully.`);
                
                // Update home selector dropdown
                updateHomeSelector();
                
                // Clear home details
                clearHomeDetails();
                
                // Hide delete button
                document.getElementById('deleteHomeBtn').style.display = 'none';
                
                // Reset home selector to first option
                homeSelect.value = '';
                
                // If no homes left, show message
                if (Object.keys(homes).length === 0) {
                    const homeDetailsContent = document.getElementById('homeDetailsContent');
                    homeDetailsContent.innerHTML = `
                        <div class="details-grid">
                            <div class="detail-item">
                                <div class="detail-label">No Homes</div>
                                <div class="detail-value">You haven't added any homes yet. Click "Add Home" to get started!</div>
                            </div>
                        </div>
                    `;
                }
            } else {
                alert('Error deleting home. Please try again.');
            }
        }

        // Display home details in the home details section
        function displayHomeDetails(home) {
            const homeDetailsContent = document.getElementById('homeDetailsContent');
            
            homeDetailsContent.innerHTML = `
                <div class="details-grid">
                    <div class="detail-item">
                        <div class="detail-label">Home Name</div>
                        <div class="detail-value">${home.name || 'Not specified'}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Address</div>
                        <div class="detail-value">${home.address || 'Not specified'}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Year Built</div>
                        <div class="detail-value">${home.yearBuilt || 'Not specified'}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Square Feet</div>
                        <div class="detail-value">${home.squareFeet ? home.squareFeet.toLocaleString() : 'Not specified'}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Bedrooms</div>
                        <div class="detail-value">${home.bedrooms || 'Not specified'}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Bathrooms</div>
                        <div class="detail-value">${home.bathrooms || 'Not specified'}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Purchase Price</div>
                        <div class="detail-value">${home.purchasePrice ? '$' + home.purchasePrice.toLocaleString() : 'Not specified'}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Property Type</div>
                        <div class="detail-value">${home.propertyType || 'Not specified'}</div>
                    </div>
                </div>
            `;
        }

        // Clear home details when no home is selected
        function clearHomeDetails() {
            const homeDetailsContent = document.getElementById('homeDetailsContent');
            const deleteHomeBtn = document.getElementById('deleteHomeBtn');
            
            homeDetailsContent.innerHTML = `
                <div class="details-grid">
                    <div class="detail-item">
                        <div class="detail-label">Home Name</div>
                        <div class="detail-value">Select a home to view details</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Address</div>
                        <div class="detail-value">-</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Year Built</div>
                        <div class="detail-value">-</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Square Feet</div>
                        <div class="detail-value">-</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Bedrooms</div>
                        <div class="detail-value">-</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Bathrooms</div>
                        <div class="detail-value">-</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Purchase Price</div>
                        <div class="detail-value">-</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Property Type</div>
                        <div class="detail-value">-</div>
                    </div>
                </div>
            `;
            
            // Hide delete button
            deleteHomeBtn.style.display = 'none';
        }

        function openAddHomeModal() {
            document.getElementById('addHomeModal').classList.add('show');
            // Reinitialize autocomplete for the address field in the modal
            setTimeout(() => {
                initializeGoogleMapsAutocomplete();
            }, 100);
        }

        // Save home to Firebase
        async function saveHomeToFirebase(homeData) {
            if (!currentUserId || !window.firebaseDB || !window.firebaseServices) {
                console.error('User not authenticated or Firebase not ready');
                return null;
            }

            try {
                const homeWithUserId = {
                    ...homeData,
                    userId: currentUserId,
                    createdAt: new Date(),
                    updatedAt: new Date()
                };
                
                console.log('Saving home to Firebase:', homeWithUserId);
                
                const docRef = await window.firebaseServices.addDoc(
                    window.firebaseServices.collection(window.firebaseDB, 'homes'),
                    homeWithUserId
                );
                
                console.log('Home saved to Firebase with ID:', docRef.id);
                
                // Add to local homes object
                homes[docRef.id] = { id: docRef.id, ...homeWithUserId };
                
                // Update home selector dropdown
                updateHomeSelector();
                
                return docRef.id;
            } catch (error) {
                console.error('Error saving home to Firebase:', error);
                return null;
            }
        }

        // Update home in Firebase
        async function updateHomeInFirebase(homeId, homeData) {
            if (!currentUserId || !window.firebaseDB || !window.firebaseServices) {
                console.error('User not authenticated or Firebase not ready');
                return false;
            }

            try {
                const homeWithUserId = {
                    ...homeData,
                    userId: currentUserId,
                    updatedAt: new Date()
                };
                
                console.log('Updating home in Firebase:', homeId, homeWithUserId);
                
                const homeRef = window.firebaseServices.doc(window.firebaseDB, 'homes', homeId);
                await window.firebaseServices.updateDoc(homeRef, homeWithUserId);
                
                console.log('Home updated in Firebase successfully');
                
                // Update local homes object
                homes[homeId] = { ...homes[homeId], ...homeWithUserId };
                
                return true;
            } catch (error) {
                console.error('Error updating home in Firebase:', error);
                return false;
            }
        }

        // Delete home from Firebase
        async function deleteHomeFromFirebase(homeId) {
            if (!currentUserId || !window.firebaseDB || !window.firebaseServices) {
                console.error('User not authenticated or Firebase not ready');
                return false;
            }

            try {
                console.log('Deleting home from Firebase:', homeId);
                
                const homeRef = window.firebaseServices.doc(window.firebaseDB, 'homes', homeId);
                await window.firebaseServices.deleteDoc(homeRef);
                
                console.log('Home deleted from Firebase successfully');
                
                // Remove from local homes object
                delete homes[homeId];
                
                return true;
            } catch (error) {
                console.error('Error deleting home from Firebase:', error);
                return false;
            }
        }

        // Initialize sample homes if none exist
        async function initializeSampleHomes() {
            if (Object.keys(homes).length === 0) {
                console.log('No homes found, initializing sample homes...');
                
                const sampleHomes = [
                    {
                        name: 'My First Home',
                        address: '123 Main St, City, State',
                        yearBuilt: 2020,
                        squareFeet: 2500,
                        bedrooms: 3,
                        bathrooms: 2.5,
                        purchasePrice: 350000,
                        propertyType: 'single-family'
                    },
                    {
                        name: 'Vacation Home',
                        address: '456 Beach Blvd, Coastal City, State',
                        yearBuilt: 2018,
                        squareFeet: 1800,
                        bedrooms: 2,
                        bathrooms: 2,
                        purchasePrice: 280000,
                        propertyType: 'condo'
                    }
                ];
                
                for (const homeData of sampleHomes) {
                    await saveHomeToFirebase(homeData);
                }
                
                console.log('Sample homes initialized');
            }
        }

        // Initialize Google Maps Autocomplete
        function initializeGoogleMapsAutocomplete() {
            // Wait for Google Maps API to load
            if (typeof google === 'undefined' || !google.maps || !google.maps.places) {
                console.log('Google Maps API not loaded yet, retrying in 1 second...');
                setTimeout(initializeGoogleMapsAutocomplete, 1000);
                return;
            }

            console.log('Initializing Google Maps Autocomplete...');

            // Initialize autocomplete for address fields
            const addressFields = [
                'homeAddress', // Add Home form
                'editHomeAddress' // Edit Home form (if it exists)
            ];

            addressFields.forEach(fieldId => {
                const addressInput = document.getElementById(fieldId);
                if (addressInput) {
                    console.log('Setting up autocomplete for:', fieldId);
                    
                    const autocomplete = new google.maps.places.Autocomplete(addressInput, {
                        types: ['address'],
                        componentRestrictions: { country: 'us' }, // Restrict to US addresses
                        fields: ['formatted_address', 'geometry', 'address_components']
                    });

                    // Prevent form submission when Enter is pressed while dropdown is open
                    addressInput.addEventListener('keydown', function(e) {
                        if (e.key === 'Enter' && document.querySelector('.pac-container')) {
                            e.preventDefault();
                        }
                    });

                    // Handle place selection
                    autocomplete.addListener('place_changed', function() {
                        const place = autocomplete.getPlace();
                        
                        if (!place.geometry) {
                            console.log('No geometry available for selected place');
                            return;
                        }

                        console.log('Selected place:', place);
                        
                        // Update the address field with the formatted address
                        addressInput.value = place.formatted_address;
                        
                        // You can also extract additional information if needed
                        // For example, you could populate city, state, zip separately
                        const addressComponents = place.address_components;
                        let city = '';
                        let state = '';
                        let zipCode = '';
                        
                        addressComponents.forEach(component => {
                            const types = component.types;
                            
                            if (types.includes('locality')) {
                                city = component.long_name;
                            } else if (types.includes('administrative_area_level_1')) {
                                state = component.short_name;
                            } else if (types.includes('postal_code')) {
                                zipCode = component.long_name;
                            }
                        });
                        
                        console.log('Extracted components:', { city, state, zipCode });
                        
                        // Trigger any additional validation or form updates
                        addressInput.dispatchEvent(new Event('input', { bubbles: true }));
                    });
                } else {
                    console.log('Address field not found:', fieldId);
                }
            });
        }

        function openAddTaskModal() {
            document.getElementById('addTaskModal').classList.add('show');
        }

        function openEditHomeModal() {
            // Get the currently selected home
            const homeSelect = document.getElementById('homeSelect');
            const selectedHomeId = homeSelect.value;
            
            if (!selectedHomeId || selectedHomeId === '') {
                alert('Please select a home to edit first.');
                return;
            }
            
            const selectedHome = homes[selectedHomeId];
            
            if (!selectedHome) {
                alert('Selected home not found. Please refresh and try again.');
                return;
            }
            
            // Populate the edit form with current home data
            populateEditHomeForm(selectedHome);
            
            // Store the home ID being edited
            document.getElementById('editHomeModal').setAttribute('data-editing-home-id', selectedHomeId);
            
            // Open the modal
            document.getElementById('editHomeModal').classList.add('show');
            
            // Reinitialize autocomplete for the address field in the modal
            setTimeout(() => {
                initializeGoogleMapsAutocomplete();
            }, 100);
        }

        // Profile Modal Functions
        function openProfileModal() {
            // Load current user profile data
            loadUserProfile();
            
            // Open the modal
            document.getElementById('profileModal').classList.add('show');
            
            // Reinitialize autocomplete for the address field in the modal
            setTimeout(() => {
                initializeGoogleMapsAutocomplete();
            }, 100);
        }

        // Load user profile data
        async function loadUserProfile() {
            if (!currentUserId || !window.firebaseDB || !window.firebaseServices) {
                console.log('User not authenticated or Firebase not ready');
                return;
            }

            try {
                // Get user profile from Firebase
                const userProfileRef = window.firebaseServices.doc(window.firebaseDB, 'userProfiles', currentUserId);
                const userProfileDoc = await window.firebaseServices.getDoc(userProfileRef);
                
                if (userProfileDoc.exists()) {
                    const profileData = userProfileDoc.data();
                    populateProfileForm(profileData);
                } else {
                    // Create default profile with Firebase user data
                    const defaultProfile = {
                        name: window.firebaseAuth.currentUser?.displayName || '',
                        email: window.firebaseAuth.currentUser?.email || '',
                        phone: '',
                        address: '',
                        bio: '',
                        avatarUrl: window.firebaseAuth.currentUser?.photoURL || '',
                        notifications: {
                            email: true,
                            taskReminders: true,
                            maintenanceAlerts: true
                        }
                    };
                    populateProfileForm(defaultProfile);
                }
            } catch (error) {
                console.error('Error loading user profile:', error);
                // Fallback to default profile
                const defaultProfile = {
                    name: window.firebaseAuth.currentUser?.displayName || '',
                    email: window.firebaseAuth.currentUser?.email || '',
                    phone: '',
                    address: '',
                    bio: '',
                    avatarUrl: window.firebaseAuth.currentUser?.photoURL || '',
                    notifications: {
                        email: true,
                        taskReminders: true,
                        maintenanceAlerts: true
                    }
                };
                populateProfileForm(defaultProfile);
            }
        }

        // Populate profile form with user data
        function populateProfileForm(profileData) {
            document.getElementById('profileName').value = profileData.name || '';
            document.getElementById('profileEmail').value = profileData.email || '';
            document.getElementById('profilePhone').value = profileData.phone || '';
            document.getElementById('profileAddress').value = profileData.address || '';
            document.getElementById('profileBio').value = profileData.bio || '';
            
            // Set avatar
            if (profileData.avatarUrl) {
                document.getElementById('profileAvatar').src = profileData.avatarUrl;
            } else {
                // Generate avatar from name
                const name = profileData.name || 'User';
                document.getElementById('profileAvatar').src = `https://ui-avatars.com/api/?name=${encodeURIComponent(name)}&size=120&background=2563eb&color=fff`;
            }
            
            // Set notification preferences
            const notifications = profileData.notifications || {};
            document.getElementById('emailNotifications').checked = notifications.email !== false;
            document.getElementById('taskReminders').checked = notifications.taskReminders !== false;
            document.getElementById('maintenanceAlerts').checked = notifications.maintenanceAlerts !== false;
        }

        // Save user profile to Firebase
        async function saveUserProfile(profileData) {
            console.log('=== saveUserProfile called ===');
            console.log('currentUserId:', currentUserId);
            console.log('firebaseDB available:', !!window.firebaseDB);
            console.log('firebaseServices available:', !!window.firebaseServices);
            console.log('profileData:', profileData);
            
            if (!currentUserId || !window.firebaseDB || !window.firebaseServices) {
                console.error('User not authenticated or Firebase not ready');
                console.error('currentUserId:', currentUserId);
                console.error('firebaseDB:', window.firebaseDB);
                console.error('firebaseServices:', window.firebaseServices);
                return false;
            }

            try {
                const profileWithMetadata = {
                    ...profileData,
                    userId: currentUserId,
                    updatedAt: new Date()
                };
                
                console.log('Saving user profile to Firebase:', profileWithMetadata);
                
                const userProfileRef = window.firebaseServices.doc(window.firebaseDB, 'userProfiles', currentUserId);
                console.log('User profile reference created:', userProfileRef);
                
                await window.firebaseServices.setDoc(userProfileRef, profileWithMetadata, { merge: true });
                
                console.log('User profile saved to Firebase successfully');
                
                // Update Firebase Auth display name if it changed
                if (profileData.name && profileData.name !== window.firebaseAuth.currentUser?.displayName) {
                    console.log('Updating Firebase Auth display name from', window.firebaseAuth.currentUser?.displayName, 'to', profileData.name);
                    await window.firebaseServices.updateProfile(window.firebaseAuth.currentUser, {
                        displayName: profileData.name
                    });
                    console.log('Firebase Auth display name updated');
                }
                
                return true;
            } catch (error) {
                console.error('=== Error saving user profile to Firebase ===');
                console.error('Error object:', error);
                console.error('Error code:', error.code);
                console.error('Error message:', error.message);
                console.error('Error stack:', error.stack);
                return false;
            }
        }

        // Populate edit home form with current home data
        function populateEditHomeForm(home) {
            document.getElementById('editHomeName').value = home.name || '';
            document.getElementById('editHomeAddress').value = home.address || '';
            document.getElementById('editYearBuilt').value = home.yearBuilt || '';
            document.getElementById('editSquareFeet').value = home.squareFeet || '';
            document.getElementById('editBedrooms').value = home.bedrooms || '';
            document.getElementById('editBathrooms').value = home.bathrooms || '';
            document.getElementById('editPurchasePrice').value = home.purchasePrice || '';
            document.getElementById('editPropertyType').value = home.propertyType || 'single-family';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('show');
        }

        function toggleTask(checkbox) {
            const taskItem = checkbox.closest('.task-item');
            if (checkbox.checked) {
                taskItem.style.opacity = '0.6';
                taskItem.style.textDecoration = 'line-through';
            } else {
                taskItem.style.opacity = '1';
                taskItem.style.textDecoration = 'none';
            }
        }

        function deleteTask(button) {
            if (confirm('Are you sure you want to delete this task?')) {
                const taskItem = button.closest('.task-item');
                taskItem.remove();
            }
        }

        async function signOut() {
            if (confirm('Are you sure you want to sign out?')) {
                try {
                    // Sign out from Firebase
                    await window.firebaseServices.signOut(window.firebaseAuth);
                    console.log('User signed out successfully');
                    // Redirect to index.html after successful sign out
                    window.location.href = 'index.html';
                } catch (error) {
                    console.error('Sign out error:', error);
                    alert('Error signing out. Please try again.');
                }
            }
        }

        function exportData() {
            alert('Export functionality will be available with Firebase integration!');
        }

        // Home Details Section Management
        function toggleSection(sectionId) {
            const content = document.getElementById(sectionId + '-content');
            const toggle = document.getElementById(sectionId + '-toggle');
            
            if (content.classList.contains('expanded')) {
                content.classList.remove('expanded');
                toggle.textContent = '▼';
            } else {
                content.classList.add('expanded');
                toggle.textContent = '▲';
            }
        }

        function addDetail(sectionId) {
            const sectionDetails = document.querySelector(`#${sectionId}-content .section-details`);
            const newRow = document.createElement('div');
            newRow.className = 'detail-row';
            newRow.innerHTML = `
                <div class="detail-field">
                    <div class="detail-label">New Detail</div>
                    <div class="detail-value">Click edit to add details</div>
                </div>
                <div class="detail-field">
                    <div class="detail-label">Specification</div>
                    <div class="detail-value">Click edit to add details</div>
                </div>
                <div class="detail-field">
                    <div class="detail-label">Date/Info</div>
                    <div class="detail-value">Click edit to add details</div>
                </div>
                <div class="detail-actions">
                    <button class="action-icon edit" onclick="editDetail('${sectionId}', ${sectionDetails.children.length - 1})"><i class="fas fa-edit"></i></button>
                    <button class="action-icon delete" onclick="deleteDetail('${sectionId}', ${sectionDetails.children.length - 1})"><i class="fas fa-trash"></i></button>
                </div>
            `;
            
            // Insert before the add button
            const addButton = sectionDetails.querySelector('.add-detail-btn');
            sectionDetails.insertBefore(newRow, addButton);
            
            // Auto-edit the new row
            setTimeout(() => editDetail(sectionId, sectionDetails.children.length - 2), 100);
        }

        function editDetail(sectionId, rowIndex) {
            const sectionDetails = document.querySelector(`#${sectionId}-content .section-details`);
            const detailRow = sectionDetails.children[rowIndex];
            
            if (!detailRow || detailRow.classList.contains('detail-row')) {
                const fields = detailRow.querySelectorAll('.detail-field');
                const labels = [];
                const values = [];
                
                fields.forEach(field => {
                    labels.push(field.querySelector('.detail-label').textContent);
                    values.push(field.querySelector('.detail-value').textContent);
                });
                
                // Create edit form
                const editForm = document.createElement('div');
                editForm.className = 'edit-form show';
                editForm.innerHTML = `
                    <div class="edit-form-row">
                        <input type="text" placeholder="Label 1" value="${labels[0] || ''}" id="edit-label-1">
                        <input type="text" placeholder="Value 1" value="${values[0] || ''}" id="edit-value-1">
                        <input type="text" placeholder="Date/Info" value="${values[2] || ''}" id="edit-date-1">
                    </div>
                    <div class="edit-form-row">
                        <input type="text" placeholder="Label 2" value="${labels[1] || ''}" id="edit-label-2">
                        <input type="text" placeholder="Value 2" value="${values[1] || ''}" id="edit-value-2">
                        <textarea placeholder="Additional Notes" id="edit-notes-1">${values[3] || ''}</textarea>
                    </div>
                    <div class="edit-form-buttons">
                        <button class="btn btn-secondary" onclick="cancelEdit('${sectionId}', ${rowIndex})">Cancel</button>
                        <button class="btn btn-primary" onclick="saveEdit('${sectionId}', ${rowIndex})">Save</button>
                    </div>
                `;
                
                // Hide the original row and show edit form
                detailRow.style.display = 'none';
                detailRow.parentNode.insertBefore(editForm, detailRow.nextSibling);
            }
        }

        function saveEdit(sectionId, rowIndex) {
            const sectionDetails = document.querySelector(`#${sectionId}-content .section-details`);
            const detailRow = sectionDetails.children[rowIndex];
            const editForm = detailRow.nextSibling;
            
            // Get values from edit form
            const label1 = document.getElementById('edit-label-1').value;
            const value1 = document.getElementById('edit-value-1').value;
            const date1 = document.getElementById('edit-date-1').value;
            const label2 = document.getElementById('edit-label-2').value;
            const value2 = document.getElementById('edit-value-2').value;
            const notes = document.getElementById('edit-notes-1').value;
            
            // Update the detail row
            const fields = detailRow.querySelectorAll('.detail-field');
            if (fields[0]) fields[0].querySelector('.detail-label').textContent = label1 || 'Detail';
            if (fields[0]) fields[0].querySelector('.detail-value').textContent = value1 || 'Not specified';
            if (fields[1]) fields[1].querySelector('.detail-label').textContent = label2 || 'Specification';
            if (fields[1]) fields[1].querySelector('.detail-value').textContent = value2 || 'Not specified';
            if (fields[2]) fields[2].querySelector('.detail-label').textContent = 'Date/Info';
            if (fields[2]) fields[2].querySelector('.detail-value').textContent = date1 || 'Not specified';
            
            // Show the row and remove edit form
            detailRow.style.display = 'grid';
            editForm.remove();
            
            // Show success message
            alert('Detail updated successfully!');
        }

        function cancelEdit(sectionId, rowIndex) {
            const sectionDetails = document.querySelector(`#${sectionId}-content .section-details`);
            const detailRow = sectionDetails.children[rowIndex];
            const editForm = detailRow.nextSibling;
            
            // Show the row and remove edit form
            detailRow.style.display = 'grid';
            editForm.remove();
        }

        function deleteDetail(sectionId, rowIndex) {
            if (confirm('Are you sure you want to delete this detail?')) {
                const sectionDetails = document.querySelector(`#${sectionId}-content .section-details`);
                const detailRow = sectionDetails.children[rowIndex];
                
                if (detailRow && detailRow.classList.contains('detail-row')) {
                    detailRow.remove();
                    alert('Detail deleted successfully!');
                }
            }
        }

        // Form submissions
        document.getElementById('addHomeForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // Get form data
            const formData = new FormData(e.target);
            const homeData = {
                name: formData.get('homeName') || document.getElementById('homeName').value,
                address: formData.get('homeAddress') || document.getElementById('homeAddress').value,
                yearBuilt: parseInt(formData.get('yearBuilt') || document.getElementById('yearBuilt').value) || null,
                squareFeet: parseInt(formData.get('squareFeet') || document.getElementById('squareFeet').value) || null,
                bedrooms: parseInt(formData.get('bedrooms') || document.getElementById('bedrooms').value) || null,
                bathrooms: parseFloat(formData.get('bathrooms') || document.getElementById('bathrooms').value) || null,
                purchasePrice: parseInt(formData.get('purchasePrice') || document.getElementById('purchasePrice').value.replace(/[$,]/g, '')) || null,
                propertyType: formData.get('propertyType') || document.getElementById('propertyType').value
            };
            
            console.log('Adding home with data:', homeData);
            
            // Save to Firebase
            const homeId = await saveHomeToFirebase(homeData);
            
            if (homeId) {
                alert('Home added successfully!');
                closeModal('addHomeModal');
                document.getElementById('addHomeForm').reset();
                
                // Select the newly added home
                const homeSelect = document.getElementById('homeSelect');
                homeSelect.value = homeId;
                loadHomeData();
            } else {
                alert('Error adding home. Please try again.');
            }
        });

        document.getElementById('addTaskForm').addEventListener('submit', function(e) {
            e.preventDefault();
            alert('Task added successfully! (Demo mode)');
            closeModal('addTaskModal');
            document.getElementById('addTaskForm').reset();
        });

        document.getElementById('editHomeForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // Get the home ID being edited
            const homeId = document.getElementById('editHomeModal').getAttribute('data-editing-home-id');
            
            if (!homeId) {
                alert('Error: No home selected for editing.');
                return;
            }
            
            // Get form data
            const formData = new FormData(e.target);
            const homeData = {
                name: formData.get('editHomeName') || document.getElementById('editHomeName').value,
                address: formData.get('editHomeAddress') || document.getElementById('editHomeAddress').value,
                yearBuilt: parseInt(formData.get('editYearBuilt') || document.getElementById('editYearBuilt').value) || null,
                squareFeet: parseInt(formData.get('editSquareFeet') || document.getElementById('editSquareFeet').value) || null,
                bedrooms: parseInt(formData.get('editBedrooms') || document.getElementById('editBedrooms').value) || null,
                bathrooms: parseFloat(formData.get('editBathrooms') || document.getElementById('editBathrooms').value) || null,
                purchasePrice: parseInt(formData.get('editPurchasePrice') || document.getElementById('editPurchasePrice').value.replace(/[$,]/g, '')) || null,
                propertyType: formData.get('editPropertyType') || document.getElementById('editPropertyType').value
            };
            
            console.log('Updating home with data:', homeData);
            
            // Update in Firebase
            const success = await updateHomeInFirebase(homeId, homeData);
            
            if (success) {
                alert('Home updated successfully!');
                closeModal('editHomeModal');
                
                // Refresh the home details display
                loadHomeData();
                
                // Clear the editing home ID
                document.getElementById('editHomeModal').removeAttribute('data-editing-home-id');
            } else {
                alert('Error updating home. Please try again.');
            }
        });

        // Profile form submission
        document.getElementById('profileForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // Get form data
            const formData = new FormData(e.target);
            const profileData = {
                name: formData.get('profileName') || document.getElementById('profileName').value,
                email: formData.get('profileEmail') || document.getElementById('profileEmail').value,
                phone: formData.get('profilePhone') || document.getElementById('profilePhone').value,
                address: formData.get('profileAddress') || document.getElementById('profileAddress').value,
                bio: formData.get('profileBio') || document.getElementById('profileBio').value,
                avatarUrl: document.getElementById('profileAvatar').src,
                notifications: {
                    email: document.getElementById('emailNotifications').checked,
                    taskReminders: document.getElementById('taskReminders').checked,
                    maintenanceAlerts: document.getElementById('maintenanceAlerts').checked
                }
            };
            
            console.log('Saving profile with data:', profileData);
            
            // Save to Firebase
            const success = await saveUserProfile(profileData);
            
            if (success) {
                alert('Profile updated successfully!');
                closeModal('profileModal');
                
                // Update the user email display in header
                document.getElementById('userEmail').textContent = profileData.name || profileData.email || 'User';
            } else {
                alert('Error updating profile. Please try again.');
            }
        });

        // Avatar upload functionality
        document.getElementById('avatarInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    document.getElementById('profileAvatar').src = event.target.result;
                };
                reader.readAsDataURL(file);
            }
        });

        // Close modals when clicking outside
        window.addEventListener('click', function(e) {
            if (e.target.classList.contains('modal')) {
                e.target.classList.remove('show');
            }
        });

                // Check authentication state
        document.addEventListener('DOMContentLoaded', function() {
            console.log('NestMate Dashboard loaded successfully!');

            // Initialize Google Maps Autocomplete
            initializeGoogleMapsAutocomplete();

            // Check if user is authenticated
            if (window.firebaseAuth && window.firebaseServices) {
                console.log('Firebase Auth available, setting up auth state listener');
                window.firebaseServices.onAuthStateChanged(window.firebaseAuth, async function(user) {
                    console.log('Auth state changed, user:', user ? user.email : 'null');
                    
                    if (!user) {
                        // User is not signed in, redirect to signin page
                        console.log('User not authenticated, redirecting to signin');
                        window.location.href = 'signin.html';
                    } else {
                        // User is signed in, update user info
                        console.log('User authenticated:', user.email);
                        console.log('User UID:', user.uid);
                        currentUserId = user.uid;
                        document.getElementById('userEmail').textContent = user.email || 'User';
                        
                        console.log('About to load homes from Firebase...');
                        // Load user's homes from Firebase
                        await loadHomesFromFirebase();
                        
                        console.log('About to initialize sample homes...');
                        // Initialize sample homes if none exist
                        await initializeSampleHomes();
                        
                        console.log('About to load rooms from Firebase...');
                        // Load user's rooms from Firebase
                        await loadRoomsFromFirebase();
                        
                        console.log('About to initialize sample rooms...');
                        // Initialize sample rooms if none exist
                        await initializeSampleRooms();
                    }
                });
            } else {
                console.log('Firebase Auth not available!');
            }
        });

        // Room Management Functions with Firebase Integration
        let rooms = {}; // Will be loaded from Firebase
        let currentUserId = null;

        // Load rooms from Firebase
        async function loadRoomsFromFirebase() {
            console.log('=== loadRoomsFromFirebase called ===');
            console.log('currentUserId:', currentUserId);
            console.log('firebaseDB available:', !!window.firebaseDB);
            console.log('firebaseServices available:', !!window.firebaseServices);
            
            if (!currentUserId || !window.firebaseDB || !window.firebaseServices) {
                console.log('User not authenticated or Firebase not ready');
                console.log('currentUserId:', currentUserId);
                console.log('firebaseDB:', window.firebaseDB);
                console.log('firebaseServices:', window.firebaseServices);
                return;
            }

            try {
                console.log('Creating query for rooms collection...');
                console.log('Query parameters:');
                console.log('- Collection: rooms');
                console.log('- userId filter:', currentUserId);
                console.log('- Order by: name');
                
                const roomsQuery = window.firebaseServices.query(
                    window.firebaseServices.collection(window.firebaseDB, 'rooms'),
                    window.firebaseServices.where('userId', '==', currentUserId)
                );
                
                console.log('Query object created:', roomsQuery);
                console.log('Executing query...');
                const querySnapshot = await window.firebaseServices.getDocs(roomsQuery);
                console.log('Query completed, found', querySnapshot.size, 'rooms');
                console.log('Query snapshot:', querySnapshot);
                
                rooms = {};
                
                const roomSelect = document.getElementById('roomSelect');
                console.log('Room select element found:', roomSelect);
                if (!roomSelect) {
                    console.error('Room select element not found!');
                    return;
                }
                
                console.log('Current dropdown options before clearing:', roomSelect.children.length);
                
                // Clear existing options except the first one (placeholder)
                while (roomSelect.children.length > 1) {
                    roomSelect.removeChild(roomSelect.lastChild);
                }
                console.log('Cleared existing options, remaining:', roomSelect.children.length);
                
                let roomsAdded = 0;
                const roomsArray = [];
                
                querySnapshot.forEach((doc) => {
                    const roomData = doc.data();
                    const roomId = doc.id;
                    console.log('Processing room from Firebase:', roomId, roomData);
                    
                    // Ensure details array exists
                    if (!roomData.details || !Array.isArray(roomData.details)) {
                        roomData.details = [];
                    }
                    
                    rooms[roomId] = { id: roomId, ...roomData };
                    roomsArray.push({ id: roomId, ...roomData });
                });
                
                // Sort rooms alphabetically by name
                roomsArray.sort((a, b) => a.name.localeCompare(b.name));
                
                // Add sorted rooms to dropdown
                roomsArray.forEach(room => {
                    const option = document.createElement('option');
                    option.value = room.id;
                    option.textContent = room.name;
                    roomSelect.appendChild(option);
                    roomsAdded++;
                    console.log('Added option to dropdown:', option.value, option.textContent);
                });
                
                console.log('Final dropdown options count:', roomSelect.children.length);
                console.log('Total rooms added to dropdown:', roomsAdded);
                console.log('Loaded rooms from Firebase:', Object.keys(rooms).length, 'rooms');
                console.log('Rooms object after loading:', rooms);
                
                // Force a visual update of the dropdown
                roomSelect.style.display = 'none';
                roomSelect.offsetHeight; // Trigger reflow
                roomSelect.style.display = '';
                
                console.log('Dropdown refresh completed');
            } catch (error) {
                console.error('Error loading rooms from Firebase:', error);
                console.error('Error details:', error.message, error.code);
                console.error('Error stack:', error.stack);
                
                // Check if it's a security rules error
                if (error.code === 'permission-denied') {
                    console.error('PERMISSION DENIED - Check Firebase security rules');
                    alert('Permission denied when loading rooms. Please check Firebase security rules.');
                } else if (error.code === 'unavailable') {
                    console.error('FIREBASE UNAVAILABLE - Check internet connection');
                    alert('Firebase is unavailable. Please check your internet connection.');
                } else {
                    alert('Error loading rooms: ' + error.message);
                }
            }
        }

        // Save room to Firebase
        async function saveRoomToFirebase(roomData) {
            console.log('=== saveRoomToFirebase called ===');
            console.log('roomData:', roomData);
            console.log('currentUserId:', currentUserId);
            console.log('firebaseDB available:', !!window.firebaseDB);
            console.log('firebaseServices available:', !!window.firebaseServices);
            
            if (!currentUserId || !window.firebaseDB || !window.firebaseServices) {
                console.error('User not authenticated or Firebase not ready');
                console.error('currentUserId:', currentUserId);
                console.error('firebaseDB:', window.firebaseDB);
                console.error('firebaseServices:', window.firebaseServices);
                return null;
            }

            try {
                // Ensure roomData has required fields
                const roomWithUserId = {
                    name: roomData.name || 'Unnamed Room',
                    type: roomData.type || 'room',
                    details: roomData.details || [],
                    userId: currentUserId,
                    createdAt: new Date(),
                    updatedAt: new Date()
                };
                
                console.log('Attempting to save room to Firebase:', roomWithUserId);
                console.log('Collection path: rooms');
                console.log('Document data to save:', JSON.stringify(roomWithUserId, null, 2));
                
                const docRef = await window.firebaseServices.addDoc(
                    window.firebaseServices.collection(window.firebaseDB, 'rooms'),
                    roomWithUserId
                );
                
                console.log('Room saved to Firebase with ID:', docRef.id);
                console.log('Document reference:', docRef);
                
                // Immediately update local rooms object
                rooms[docRef.id] = { id: docRef.id, ...roomWithUserId };
                console.log('Updated local rooms object:', rooms);
                
                // Verify the document was actually saved by trying to read it back
                console.log('Verifying document was saved...');
                try {
                    const verifyQuery = window.firebaseServices.query(
                        window.firebaseServices.collection(window.firebaseDB, 'rooms'),
                        window.firebaseServices.where('__name__', '==', docRef.id)
                    );
                    const verifySnapshot = await window.firebaseServices.getDocs(verifyQuery);
                    console.log('Verification query result:', verifySnapshot.size, 'documents found');
                    
                    if (verifySnapshot.size > 0) {
                        const savedData = verifySnapshot.docs[0].data();
                        console.log('Verified saved data:', savedData);
                    } else {
                        console.warn('Document verification failed - document not found after save');
                    }
                } catch (verifyError) {
                    console.warn('Verification failed, but document was created:', verifyError);
                }
                
                return docRef.id;
            } catch (error) {
                console.error('Error saving room to Firebase:', error);
                console.error('Error details:', error.message, error.code);
                console.error('Error stack:', error.stack);
                
                // Check if it's a security rules error
                if (error.code === 'permission-denied') {
                    console.error('PERMISSION DENIED - Check Firebase security rules');
                    alert('Permission denied. Please check Firebase security rules.');
                }
                
                return null;
            }
        }

        // Update room in Firebase
        async function updateRoomInFirebase(roomId, roomData) {
            console.log('=== updateRoomInFirebase called ===');
            console.log('roomId:', roomId);
            console.log('roomData:', roomData);
            console.log('currentUserId:', currentUserId);
            console.log('firebaseDB available:', !!window.firebaseDB);
            console.log('firebaseServices available:', !!window.firebaseServices);
            
            if (!currentUserId || !window.firebaseDB || !window.firebaseServices) {
                console.error('User not authenticated or Firebase not ready');
                console.error('currentUserId:', currentUserId);
                console.error('firebaseDB:', window.firebaseDB);
                console.error('firebaseServices:', window.firebaseServices);
                return false;
            }

            try {
                // Check if this roomId is actually a Firebase document ID
                // If not, we need to find the actual document ID by searching
                let actualRoomId = roomId;
                
                // If roomId doesn't look like a Firebase ID (not 20 characters), search for it
                if (roomId.length !== 20) {
                    console.log('RoomId does not look like a Firebase ID, searching for room...');
                    
                    // Search for the room by name and userId
                    const roomQuery = window.firebaseServices.query(
                        window.firebaseServices.collection(window.firebaseDB, 'rooms'),
                        window.firebaseServices.where('name', '==', roomData.name),
                        window.firebaseServices.where('userId', '==', currentUserId)
                    );
                    
                    const querySnapshot = await window.firebaseServices.getDocs(roomQuery);
                    
                    if (querySnapshot.size > 0) {
                        actualRoomId = querySnapshot.docs[0].id;
                        console.log('Found room in Firebase with ID:', actualRoomId);
                    } else {
                        console.log('Room not found in Firebase, creating new document...');
                        // Create new document with addDoc
                        const docRef = await window.firebaseServices.addDoc(
                            window.firebaseServices.collection(window.firebaseDB, 'rooms'),
                            {
                                ...roomData,
                                createdAt: new Date(),
                                updatedAt: new Date()
                            }
                        );
                        actualRoomId = docRef.id;
                        console.log('Created new room document with ID:', actualRoomId);
                        
                        // Update local rooms object with the new ID
                        rooms[actualRoomId] = { ...rooms[roomId], id: actualRoomId };
                        delete rooms[roomId];
                    }
                }
                
                console.log('Using actual room ID:', actualRoomId);
                const roomRef = window.firebaseServices.doc(window.firebaseDB, 'rooms', actualRoomId);
                console.log('Room reference created:', roomRef);
                
                const updateData = {
                    ...roomData,
                    updatedAt: new Date()
                };
                
                console.log('Attempting to save room in Firebase with data:', updateData);
                
                // Use setDoc with merge option to create or update the document
                await window.firebaseServices.setDoc(roomRef, updateData, { merge: true });
                
                console.log('Room saved successfully in Firebase:', actualRoomId);
                return true;
            } catch (error) {
                console.error('=== Error saving room in Firebase ===');
                console.error('Error object:', error);
                console.error('Error code:', error.code);
                console.error('Error message:', error.message);
                console.error('Error stack:', error.stack);
                console.error('Error name:', error.name);
                
                // Check for specific Firebase error codes
                if (error.code === 'permission-denied') {
                    console.error('Permission denied - check Firebase security rules');
                    console.error('This usually means the security rules are blocking the save');
                } else if (error.code === 'unavailable') {
                    console.error('Firebase service unavailable');
                    console.error('Firebase service is temporarily unavailable');
                } else if (error.code === 'invalid-argument') {
                    console.error('Invalid argument provided to setDoc');
                    console.error('Check if roomData contains invalid values');
                } else {
                    console.error('Unknown Firebase error occurred');
                }
                
                return false;
            }
        }

        // Delete room from Firebase
        async function deleteRoomFromFirebase(roomId) {
            if (!currentUserId || !window.firebaseDB || !window.firebaseServices) {
                console.error('User not authenticated or Firebase not ready');
                return false;
            }

            try {
                const roomRef = window.firebaseServices.doc(window.firebaseDB, 'rooms', roomId);
                await window.firebaseServices.deleteDoc(roomRef);
                
                console.log('Room deleted from Firebase:', roomId);
                return true;
            } catch (error) {
                console.error('Error deleting room from Firebase:', error);
                return false;
            }
        }

        // Initialize sample data if no rooms exist
        async function initializeSampleRooms() {
            console.log('=== initializeSampleRooms called ===');
            console.log('currentUserId:', currentUserId);
            console.log('rooms object keys:', Object.keys(rooms));
            console.log('rooms object length:', Object.keys(rooms).length);
            
            if (!currentUserId) {
                console.log('Skipping sample room initialization - user not authenticated');
                return; // User not authenticated
            }
            
            if (Object.keys(rooms).length > 0) {
                console.log('Skipping sample room initialization - rooms already exist');
                return; // Rooms already exist
            }

            const sampleRooms = [
                {
                    name: 'Living Room',
                    type: 'living-room',
                    dimensions: '15\' x 18\'',
                    floor: 'first',
                    details: [
                        { type: 'flooring', description: 'Hardwood Oak', spec: '3/4 inch, Natural finish', date: '2022-03-15' },
                        { type: 'lighting', description: 'Recessed LED', spec: '8 fixtures, Dimmable', date: '2022-03-15' },
                        { type: 'blinds', description: 'Cellular Shades', spec: 'Inside mount, 48" x 72", Light filtering', date: '2022-03-15' }
                    ]
                },
                {
                    name: 'Master Bedroom',
                    type: 'bedroom',
                    dimensions: '14\' x 16\'',
                    floor: 'second',
                    details: [
                        { type: 'flooring', description: 'Carpet', spec: 'Berber, Beige', date: '2021-08-10' },
                        { type: 'blinds', description: 'Roman Shades', spec: 'Inside mount, 36" x 60", Blackout fabric', date: '2021-08-10' }
                    ]
                }
            ];

            for (const sampleRoom of sampleRooms) {
                await saveRoomToFirebase(sampleRoom);
            }
            
            // Reload rooms after adding samples
            await loadRoomsFromFirebase();
        }

        function showRoomDetails() {
            console.log('=== showRoomDetails called ===');
            const roomSelect = document.getElementById('roomSelect');
            const selectedRoom = roomSelect.value;
            console.log('Selected room:', selectedRoom);
            const container = document.getElementById('roomDetailsContainer');
            const roomName = document.getElementById('currentRoomName');
            const detailsList = document.getElementById('roomDetailsList');

            if (!selectedRoom || !rooms[selectedRoom]) {
                console.log('No room selected or room not found in rooms object');
                container.style.display = 'none';
                currentEditingRoom = null; // Clear current editing room
                return;
            }

            const room = rooms[selectedRoom];
            console.log('Room object:', room);
            console.log('Available rooms:', Object.keys(rooms));
            roomName.textContent = room.name;
            container.style.display = 'block';
            
            // Set currentEditingRoom to the selected room
            currentEditingRoom = selectedRoom;
            console.log('currentEditingRoom set to:', currentEditingRoom);

            // Clear and populate room details
            detailsList.innerHTML = '';
            
            // Ensure room.details exists and is an array
            if (!room.details || !Array.isArray(room.details)) {
                room.details = [];
            }
            
            if (room.details.length > 0) {
                room.details.forEach((detail, index) => {
                    const detailItem = document.createElement('div');
                    detailItem.className = 'room-detail-item';
                    
                    // Format the detail type for display
                    const displayType = detail.type ? detail.type.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase()) : 'Unknown';
                    
                    detailItem.innerHTML = `
                        <div class="detail-field">
                            <div class="detail-label">${displayType}</div>
                            <div class="detail-value">${detail.description || 'No description'}</div>
                        </div>
                        <div class="detail-field">
                            <div class="detail-label">Specification</div>
                            <div class="detail-value">${detail.spec || 'Not specified'}</div>
                        </div>
                        <div class="detail-field">
                            <div class="detail-label">Date</div>
                            <div class="detail-value">${detail.date || 'Not specified'}</div>
                        </div>
                        ${detail.notes ? `
                        <div class="detail-field">
                            <div class="detail-label">Notes</div>
                            <div class="detail-value">${detail.notes}</div>
                        </div>
                        ` : ''}
                        <div class="detail-actions">
                            <button class="action-icon edit" onclick="editRoomDetail('${selectedRoom}', ${index})"><i class="fas fa-edit"></i></button>
                            <button class="action-icon delete" onclick="deleteRoomDetail('${selectedRoom}', ${index})"><i class="fas fa-trash"></i></button>
                        </div>
                    `;
                    detailsList.appendChild(detailItem);
                });
            } else {
                detailsList.innerHTML = '<p>No details added yet. Click "Add Room Detail" to get started.</p>';
            }
        }

        function openAddRoomModal() {
            document.getElementById('addRoomModal').classList.add('show');
        }

        function closeRoomModal() {
            document.getElementById('addRoomModal').classList.remove('show');
            document.getElementById('addRoomForm').reset();
        }

        function openRoomDetailModal(roomId = null, detailIndex = null) {
            currentEditingRoom = roomId;
            currentEditingDetail = detailIndex;
            
            if (roomId && detailIndex !== null && rooms[roomId] && rooms[roomId].details[detailIndex]) {
                const detail = rooms[roomId].details[detailIndex];
                document.getElementById('detailType').value = detail.type;
                document.getElementById('detailDescription').value = detail.description;
                document.getElementById('detailSpec').value = detail.spec || '';
                document.getElementById('detailDate').value = detail.date || '';
                document.getElementById('detailNotes').value = detail.notes || '';
            }
            
            document.getElementById('roomDetailModal').classList.add('show');
        }

        function closeRoomDetailModal() {
            document.getElementById('roomDetailModal').classList.remove('show');
            document.getElementById('roomDetailForm').reset();
            currentEditingRoom = null;
            currentEditingDetail = null;
        }

        function addRoomDetail() {
            const roomSelect = document.getElementById('roomSelect');
            const selectedRoom = roomSelect.value;
            if (!selectedRoom) {
                alert('Please select a room first!');
                return;
            }
            openRoomDetailModal(selectedRoom);
        }

        function editRoomDetail(roomId, detailIndex) {
            openRoomDetailModal(roomId, detailIndex);
        }

        async function deleteRoomDetail(roomId, detailIndex) {
            if (confirm('Are you sure you want to delete this room detail?')) {
                try {
                    // Remove from local data
                    rooms[roomId].details.splice(detailIndex, 1);
                    
                    // Update room in Firebase with removed detail
                    const roomData = {
                        name: rooms[roomId].name,
                        type: rooms[roomId].type,
                        dimensions: rooms[roomId].dimensions,
                        floor: rooms[roomId].floor,
                        notes: rooms[roomId].notes,
                        details: rooms[roomId].details,
                        userId: currentUserId // Add userId to ensure proper Firebase update
                    };
                    
                    const success = await updateRoomInFirebase(roomId, roomData);
                    if (success) {
                        showRoomDetails(); // Refresh the display
                        alert('Room detail deleted successfully!');
                    } else {
                        alert('Error deleting room detail. Please try again.');
                    }
                } catch (error) {
                    console.error('Error deleting room detail:', error);
                    alert('Error deleting room detail. Please try again.');
                }
            }
        }

        function editRoomInfo() {
            const roomSelect = document.getElementById('roomSelect');
            const selectedRoom = roomSelect.value;
            if (!selectedRoom) return;
            
            const room = rooms[selectedRoom];
            document.getElementById('roomName').value = room.name;
            document.getElementById('roomType').value = room.type;
            document.getElementById('roomDimensions').value = room.dimensions || '';
            document.getElementById('roomFloor').value = room.floor || '';
            document.getElementById('roomNotes').value = room.notes || '';
            
            currentEditingRoom = selectedRoom;
            openAddRoomModal();
        }

        async function deleteRoom() {
            const roomSelect = document.getElementById('roomSelect');
            const selectedRoom = roomSelect.value;
            if (!selectedRoom) return;
            
            if (confirm('Are you sure you want to delete this entire room and all its details?')) {
                try {
                    const success = await deleteRoomFromFirebase(selectedRoom);
                    if (success) {
                        // Remove from local data
                        delete rooms[selectedRoom];
                        
                        // Remove from select dropdown
                        const option = roomSelect.querySelector(`option[value="${selectedRoom}"]`);
                        if (option) option.remove();
                        
                        // Reset selection
                        roomSelect.value = '';
                        document.getElementById('roomDetailsContainer').style.display = 'none';
                        
                        alert('Room deleted successfully!');
                    } else {
                        alert('Error deleting room. Please try again.');
                    }
                } catch (error) {
                    console.error('Error deleting room:', error);
                    alert('Error deleting room. Please try again.');
                }
            }
        }

        let currentEditingRoom = null;
        let currentEditingDetail = null;



        function updateDetailForm() {
            const detailType = document.getElementById('detailType').value;
            const dynamicFields = document.getElementById('dynamicFormFields');
            
            // Clear existing fields
            dynamicFields.innerHTML = '';
            
            // Base fields for all types
            let baseFields = `
                <div class="form-group">
                    <label for="detailDescription">Description</label>
                    <input type="text" id="detailDescription" placeholder="Enter description..." required>
                </div>
                <div class="form-group">
                    <label for="detailDate">Installation/Update Date</label>
                    <input type="date" id="detailDate">
                </div>
                <div class="form-group">
                    <label for="detailNotes">Additional Notes</label>
                    <textarea id="detailNotes" placeholder="Any additional information..."></textarea>
                </div>
            `;
            
            // Add specific fields based on detail type
            let specificFields = '';
            
            switch(detailType) {
                case 'blinds':
                    specificFields = `
                        <div class="form-group">
                            <label for="blindType">Blind Type</label>
                            <select id="blindType">
                                <option value="">Select type...</option>
                                <option value="cellular">Cellular/Honeycomb</option>
                                <option value="roman">Roman Shades</option>
                                <option value="roller">Roller Shades</option>
                                <option value="venetian">Venetian Blinds</option>
                                <option value="faux-wood">Faux Wood</option>
                                <option value="real-wood">Real Wood</option>
                                <option value="aluminum">Aluminum</option>
                                <option value="vertical">Vertical Blinds</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="mountType">Mount Type</label>
                            <select id="mountType">
                                <option value="">Select mount...</option>
                                <option value="inside">Inside Mount</option>
                                <option value="outside">Outside Mount</option>
                                <option value="ceiling">Ceiling Mount</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="blindDimensions">Dimensions</label>
                            <input type="text" id="blindDimensions" placeholder="e.g., 48\" x 72\"" >
                        </div>
                        <div class="form-group">
                            <label for="blindColor">Color/Material</label>
                            <input type="text" id="blindColor" placeholder="e.g., White, Light filtering">
                        </div>
                        <div class="form-group">
                            <label for="blindControl">Control Type</label>
                            <select id="blindControl">
                                <option value="">Select control...</option>
                                <option value="cord">Cord Control</option>
                                <option value="wand">Wand Control</option>
                                <option value="motorized">Motorized</option>
                                <option value="smart">Smart/App Control</option>
                            </select>
                        </div>
                    `;
                    break;
                    
                case 'curtains':
                    specificFields = `
                        <div class="form-group">
                            <label for="curtainType">Curtain Type</label>
                            <select id="curtainType">
                                <option value="">Select type...</option>
                                <option value="sheer">Sheer Panels</option>
                                <option value="thermal">Thermal/Insulated</option>
                                <option value="blackout">Blackout</option>
                                <option value="cafe">Cafe Curtains</option>
                                <option value="valance">Valance</option>
                                <option value="drapes">Drapes</option>
                                <option value="panels">Decorative Panels</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="curtainMount">Mount Type</label>
                            <select id="curtainMount">
                                <option value="">Select mount...</option>
                                <option value="inside">Inside Mount</option>
                                <option value="outside">Outside Mount</option>
                                <option value="ceiling">Ceiling Mount</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="curtainDimensions">Dimensions</label>
                            <input type="text" id="curtainDimensions" placeholder="e.g., 54\" x 84\"" >
                        </div>
                        <div class="form-group">
                            <label for="curtainColor">Color/Pattern</label>
                            <input type="text" id="curtainColor" placeholder="e.g., Ivory, Floral pattern">
                        </div>
                        <div class="form-group">
                            <label for="curtainFabric">Fabric Type</label>
                            <input type="text" id="curtainFabric" placeholder="e.g., Polyester, Linen blend">
                        </div>
                        <div class="form-group">
                            <label for="curtainHardware">Hardware</label>
                            <input type="text" id="curtainHardware" placeholder="e.g., Brass rod, Ring clips">
                        </div>
                    `;
                    break;
                    
                case 'crown-molding':
                    specificFields = `
                        <div class="form-group">
                            <label for="crownStyle">Crown Style</label>
                            <select id="crownStyle">
                                <option value="">Select style...</option>
                                <option value="classic">Classic</option>
                                <option value="modern">Modern</option>
                                <option value="colonial">Colonial</option>
                                <option value="victorian">Victorian</option>
                                <option value="craftsman">Craftsman</option>
                                <option value="minimalist">Minimalist</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="crownHeight">Height</label>
                            <input type="text" id="crownHeight" placeholder="e.g., 4-1/4\"" >
                        </div>
                        <div class="form-group">
                            <label for="crownMaterial">Material</label>
                            <select id="crownMaterial">
                                <option value="">Select material...</option>
                                <option value="mdf">MDF (Primed)</option>
                                <option value="pine">Pine</option>
                                <option value="oak">Oak</option>
                                <option value="poplar">Poplar</option>
                                <option value="polyurethane">Polyurethane</option>
                                <option value="plaster">Plaster</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="crownFinish">Finish</label>
                            <input type="text" id="crownFinish" placeholder="e.g., White painted, Stained oak">
                        </div>
                    `;
                    break;
                    
                case 'baseboards':
                    specificFields = `
                        <div class="form-group">
                            <label for="baseboardHeight">Height</label>
                            <input type="text" id="baseboardHeight" placeholder="e.g., 5-1/4\"" >
                        </div>
                        <div class="form-group">
                            <label for="baseboardStyle">Style</label>
                            <select id="baseboardStyle">
                                <option value="">Select style...</option>
                                <option value="standard">Standard</option>
                                <option value="slim">Slim</option>
                                <option value="colonial">Colonial</option>
                                <option value="modern">Modern</option>
                                <option value="tall">Tall</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="baseboardMaterial">Material</label>
                            <select id="baseboardMaterial">
                                <option value="">Select material...</option>
                                <option value="mdf">MDF</option>
                                <option value="pine">Pine</option>
                                <option value="oak">Oak</option>
                                <option value="poplar">Poplar</option>
                                <option value="tile">Tile</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="baseboardFinish">Finish</label>
                            <input type="text" id="baseboardFinish" placeholder="e.g., White painted, Stained">
                        </div>
                    `;
                    break;
                    
                case 'paint':
                    specificFields = `
                        <div class="form-group">
                            <label for="paintBrand">Paint Brand</label>
                            <select id="paintBrand">
                                <option value="">Select brand...</option>
                                <option value="sherwin-williams">Sherwin Williams</option>
                                <option value="benjamin-moore">Benjamin Moore</option>
                                <option value="valspar">Valspar</option>
                                <option value="behr">Behr</option>
                                <option value="ppg">PPG</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="paintColor">Color Name/Code</label>
                            <input type="text" id="paintColor" placeholder="e.g., SW 7008 Alabaster">
                        </div>
                        <div class="form-group">
                            <label for="paintFinish">Finish</label>
                                <select id="paintFinish">
                                    <option value="">Select finish...</option>
                                    <option value="flat">Flat</option>
                                    <option value="eggshell">Eggshell</option>
                                    <option value="satin">Satin</option>
                                    <option value="semi-gloss">Semi-Gloss</option>
                                    <option value="gloss">Gloss</option>
                                    <option value="matte">Matte</option>
                                </select>
                        </div>
                        <div class="form-group">
                            <label for="paintSurface">Surface</label>
                            <input type="text" id="paintSurface" placeholder="e.g., Walls, Ceiling, Trim">
                        </div>
                    `;
                    break;
                    
                case 'windows':
                    specificFields = `
                        <div class="form-group">
                            <label for="windowType">Window Type</label>
                            <select id="windowType">
                                <option value="">Select type...</option>
                                <option value="double-hung">Double Hung</option>
                                <option value="single-hung">Single Hung</option>
                                <option value="casement">Casement</option>
                                <option value="awning">Awning</option>
                                <option value="slider">Slider</option>
                                <option value="picture">Picture</option>
                                <option value="bay">Bay</option>
                                <option value="bow">Bow</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="windowDimensions">Dimensions</label>
                            <input type="text" id="windowDimensions" placeholder="e.g., 36\" x 60\"" >
                        </div>
                        <div class="form-group">
                            <label for="windowMaterial">Frame Material</label>
                            <select id="windowMaterial">
                                <option value="">Select material...</option>
                                <option value="vinyl">Vinyl</option>
                                <option value="aluminum">Aluminum</option>
                                <option value="wood">Wood</option>
                                <option value="fiberglass">Fiberglass</option>
                                <option value="composite">Composite</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="windowGlazing">Glazing</label>
                            <select id="windowGlazing">
                                <option value="">Select glazing...</option>
                                <option value="single-pane">Single Pane</option>
                                <option value="double-pane">Double Pane</option>
                                <option value="triple-pane">Triple Pane</option>
                                <option value="low-e">Low-E</option>
                                <option value="tinted">Tinted</option>
                            </select>
                        </div>
                    `;
                    break;
                    
                default:
                    // For other types, use the standard specification field
                    specificFields = `
                        <div class="form-group">
                            <label for="detailSpec">Specification</label>
                            <input type="text" id="detailSpec" placeholder="Enter specifications...">
                        </div>
                    `;
            }
            
            dynamicFields.innerHTML = baseFields + specificFields;
        }

        // Handle room form submission
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOMContentLoaded - Setting up room form listener');
            const addRoomForm = document.getElementById('addRoomForm');
            console.log('addRoomForm element found:', addRoomForm);
            
            if (!addRoomForm) {
                console.error('addRoomForm element not found!');
                return;
            }
            
            addRoomForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                console.log('Room form submitted!');
                
                const roomNameElement = document.getElementById('roomName');
                const roomTypeElement = document.getElementById('roomType');
                const roomDimensionsElement = document.getElementById('roomDimensions');
                const roomFloorElement = document.getElementById('roomFloor');
                const roomNotesElement = document.getElementById('roomNotes');
                
                console.log('Form elements found:', {
                    roomName: !!roomNameElement,
                    roomType: !!roomTypeElement,
                    roomDimensions: !!roomDimensionsElement,
                    roomFloor: !!roomFloorElement,
                    roomNotes: !!roomNotesElement
                });
                
                const roomName = roomNameElement ? roomNameElement.value : '';
                const roomType = roomTypeElement ? roomTypeElement.value : '';
                const roomDimensions = roomDimensionsElement ? roomDimensionsElement.value : '';
                const roomFloor = roomFloorElement ? roomFloorElement.value : '';
                const roomNotes = roomNotesElement ? roomNotesElement.value : '';
                
                console.log('Form values:', { roomName, roomType, roomDimensions, roomFloor, roomNotes });
                
                const roomData = {
                    name: roomName,
                    type: roomType,
                    dimensions: roomDimensions,
                    floor: roomFloor,
                    notes: roomNotes,
                    details: currentEditingRoom ? rooms[currentEditingRoom].details : [],
                    userId: currentUserId // Add userId to ensure proper Firebase operations
                };
                
                console.log('Room data to save:', roomData);
                console.log('currentEditingRoom:', currentEditingRoom);
                console.log('currentUserId check:', currentUserId);
                console.log('Firebase services check:', !!window.firebaseServices);
                console.log('Firebase DB check:', !!window.firebaseDB);
                
                try {
                    if (currentEditingRoom) {
                        console.log('Updating existing room...');
                        
                        // Find the room in Firebase and update it directly
                        const roomQuery = window.firebaseServices.query(
                            window.firebaseServices.collection(window.firebaseDB, 'rooms'),
                            window.firebaseServices.where('name', '==', roomData.name),
                            window.firebaseServices.where('userId', '==', currentUserId)
                        );
                        
                        const querySnapshot = await window.firebaseServices.getDocs(roomQuery);
                        
                        if (querySnapshot.size > 0) {
                            const roomDoc = querySnapshot.docs[0];
                            const roomRef = window.firebaseServices.doc(window.firebaseDB, 'rooms', roomDoc.id);
                            
                            await window.firebaseServices.updateDoc(roomRef, {
                                ...roomData,
                                updatedAt: new Date()
                            });
                            
                            console.log('Room updated successfully in Firebase');
                            
                            // Reload rooms to ensure data consistency
                            await loadRoomsFromFirebase();
                            showRoomDetails(); // Refresh display
                            alert('Room updated successfully!');
                        } else {
                            alert('Room not found in Firebase. Please try again.');
                        }
                    } else {
                        console.log('Adding new room...');
                        // Add new room to Firebase
                        const newRoomId = await saveRoomToFirebase(roomData);
                        console.log('saveRoomToFirebase returned:', newRoomId);
                        
                        if (newRoomId) {
                            console.log('Room saved successfully, adding to local rooms object');
                            
                            // Add the new room to the local rooms object immediately
                            rooms[newRoomId] = {
                                id: newRoomId,
                                ...roomData,
                                details: roomData.details || []
                            };
                            
                            console.log('Added room to local object:', rooms[newRoomId]);
                            
                            // Add to dropdown immediately
                            const roomSelect = document.getElementById('roomSelect');
                            if (roomSelect) {
                                const option = document.createElement('option');
                                option.value = newRoomId;
                                option.textContent = roomData.name;
                                roomSelect.appendChild(option);
                                console.log('Added option to dropdown immediately:', option.value, option.textContent);
                                
                                // Select the new room
                                roomSelect.value = newRoomId;
                                console.log('Selected new room in dropdown:', newRoomId);
                                
                                // Trigger change event to update display
                                const changeEvent = new Event('change', { bubbles: true });
                                roomSelect.dispatchEvent(changeEvent);
                                
                                showRoomDetails();
                            }
                            
                            // Also reload from Firebase to ensure consistency
                            await loadRoomsFromFirebase();
                            
                            alert('Room added successfully!');
                        } else {
                            console.log('Failed to save room to Firebase');
                            alert('Error adding room. Please try again.');
                        }
                    }
                } catch (error) {
                    console.error('Error saving room:', error);
                    alert('Error saving room. Please try again.');
                }
                
                closeRoomModal();
                currentEditingRoom = null;
            });

            // Handle room detail form submission
            document.getElementById('roomDetailForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                console.log('Room detail form submitted!');
                
                // Get basic form data
                const detailType = document.getElementById('detailType').value;
                const detailDescription = document.getElementById('detailDescription').value;
                const detailSpec = document.getElementById('detailSpec').value;
                const detailDate = document.getElementById('detailDate').value;
                const detailNotes = document.getElementById('detailNotes').value;
                
                console.log('Form values:', { detailType, detailDescription, detailSpec, detailDate, detailNotes });
                
                // Validate required fields
                if (!detailType || !detailDescription) {
                    alert('Please fill in the detail type and description.');
                    return;
                }
                
                // Check if room is selected
                if (!currentEditingRoom) {
                    alert('No room selected. Please select a room first.');
                    return;
                }
                
                // Check if room exists
                if (!rooms[currentEditingRoom]) {
                    alert('Selected room not found. Please refresh and try again.');
                    return;
                }
                
                // Create simple detail object
                const detail = {
                    type: detailType,
                    description: detailDescription,
                    spec: detailSpec,
                    date: detailDate,
                    notes: detailNotes
                };
                
                console.log('Created detail object:', detail);
                
                try {
                    // Ensure room has details array
                    if (!rooms[currentEditingRoom].details) {
                        rooms[currentEditingRoom].details = [];
                    }
                    
                    // Add detail to room
                    rooms[currentEditingRoom].details.push(detail);
                    console.log('Added detail to room. Total details:', rooms[currentEditingRoom].details.length);
                    
                    // First, let's find the actual Firebase document ID for this room
                    console.log('Searching for room in Firebase...');
                    console.log('Room name:', rooms[currentEditingRoom].name);
                    console.log('Current room ID:', currentEditingRoom);
                    
                    // Search for the room by name and userId
                    const roomQuery = window.firebaseServices.query(
                        window.firebaseServices.collection(window.firebaseDB, 'rooms'),
                        window.firebaseServices.where('name', '==', rooms[currentEditingRoom].name),
                        window.firebaseServices.where('userId', '==', currentUserId)
                    );
                    
                    const querySnapshot = await window.firebaseServices.getDocs(roomQuery);
                    console.log('Found', querySnapshot.size, 'matching rooms');
                    
                    let roomDocId = null;
                    if (querySnapshot.size > 0) {
                        roomDocId = querySnapshot.docs[0].id;
                        console.log('Found existing room document with ID:', roomDocId);
                        
                        // Update the existing room document
                        const roomRef = window.firebaseServices.doc(window.firebaseDB, 'rooms', roomDocId);
                        await window.firebaseServices.updateDoc(roomRef, {
                            details: rooms[currentEditingRoom].details,
                            updatedAt: new Date()
                        });
                        
                        console.log('Updated existing room document successfully');
                    } else {
                        console.log('Room not found in Firebase, creating new room document...');
                        
                        // Create new room document
                        const roomData = {
                            name: rooms[currentEditingRoom].name,
                            type: rooms[currentEditingRoom].type,
                            details: rooms[currentEditingRoom].details,
                            userId: currentUserId,
                            createdAt: new Date(),
                            updatedAt: new Date()
                        };
                        
                        const docRef = await window.firebaseServices.addDoc(
                            window.firebaseServices.collection(window.firebaseDB, 'rooms'),
                            roomData
                        );
                        
                        roomDocId = docRef.id;
                        console.log('Created new room document with ID:', roomDocId);
                        
                        // Update local rooms object with the new Firebase ID
                        rooms[roomDocId] = { ...rooms[currentEditingRoom], id: roomDocId };
                        delete rooms[currentEditingRoom];
                        currentEditingRoom = roomDocId;
                    }
                    
                    // Refresh the display
                    closeRoomDetailModal();
                    showRoomDetails();
                    alert('Room detail added successfully!');
                    
                } catch (error) {
                    console.error('ERROR in room detail save:', error);
                    alert('Error saving room detail: ' + error.message);
                }
            });
        });

    </script>

    <!-- Add Room Modal -->
    <div id="addRoomModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Add New Room</h3>
                <button class="close-modal" onclick="closeRoomModal()">&times;</button>
            </div>
            <form id="addRoomForm">
                <div class="form-group">
                    <label for="roomName">Room Name</label>
                    <input type="text" id="roomName" placeholder="e.g., Master Bedroom" required>
                </div>
                <div class="form-group">
                    <label for="roomType">Room Type</label>
                    <select id="roomType" required>
                        <option value="">Select room type...</option>
                        <option value="bedroom">Bedroom</option>
                        <option value="bathroom">Bathroom</option>
                        <option value="kitchen">Kitchen</option>
                        <option value="living-room">Living Room</option>
                        <option value="dining-room">Dining Room</option>
                        <option value="office">Office/Study</option>
                        <option value="garage">Garage</option>
                        <option value="basement">Basement</option>
                        <option value="attic">Attic</option>
                        <option value="laundry">Laundry Room</option>
                        <option value="closet">Closet</option>
                        <option value="pantry">Pantry</option>
                        <option value="mudroom">Mudroom</option>
                        <option value="sunroom">Sunroom</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="roomDimensions">Dimensions</label>
                    <input type="text" id="roomDimensions" placeholder="e.g., 12' x 14'">
                </div>
                <div class="form-group">
                    <label for="roomFloor">Floor Level</label>
                    <select id="roomFloor">
                        <option value="">Select floor...</option>
                        <option value="basement">Basement</option>
                        <option value="ground">Ground Floor</option>
                        <option value="first">First Floor</option>
                        <option value="second">Second Floor</option>
                        <option value="third">Third Floor</option>
                        <option value="attic">Attic</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="roomNotes">Notes</label>
                    <textarea id="roomNotes" placeholder="Additional information about this room..."></textarea>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeRoomModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Room</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Room Detail Modal -->
    <div id="roomDetailModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Add/Edit Room Detail</h3>
                <button class="close-modal" onclick="closeRoomDetailModal()">&times;</button>
            </div>
            <form id="roomDetailForm">
                <div class="form-group">
                    <label for="detailType">Detail Type</label>
                    <select id="detailType" required onchange="updateDetailForm()">
                        <option value="">Select detail type...</option>
                        <option value="flooring">Flooring</option>
                        <option value="walls">Walls</option>
                        <option value="ceiling">Ceiling</option>
                        <option value="lighting">Lighting</option>
                        <option value="windows">Windows</option>
                        <option value="window-treatments">Window Treatments</option>
                        <option value="blinds">Blinds</option>
                        <option value="curtains">Curtains</option>
                        <option value="trim">Trim & Molding</option>
                        <option value="crown-molding">Crown Molding</option>
                        <option value="baseboards">Baseboards</option>
                        <option value="door-trim">Door Trim</option>
                        <option value="window-trim">Window Trim</option>
                        <option value="outlets">Electrical Outlets</option>
                        <option value="heating">Heating/Cooling</option>
                        <option value="plumbing">Plumbing</option>
                        <option value="fixtures">Fixtures</option>
                        <option value="storage">Storage</option>
                        <option value="dimensions">Measurements</option>
                        <option value="paint">Paint Colors</option>
                        <option value="texture">Wall Texture</option>
                        <option value="hardware">Hardware</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                
                <!-- Dynamic form fields based on detail type -->
                <div id="dynamicFormFields">
                    <div class="form-group">
                        <label for="detailDescription">Description</label>
                        <input type="text" id="detailDescription" placeholder="e.g., Hardwood Oak" required>
                    </div>
                    <div class="form-group">
                        <label for="detailSpec">Specification</label>
                        <input type="text" id="detailSpec" placeholder="e.g., 3/4 inch, Natural finish">
                    </div>
                    <div class="form-group">
                        <label for="detailDate">Installation/Update Date</label>
                        <input type="date" id="detailDate">
                    </div>
                    <div class="form-group">
                        <label for="detailNotes">Additional Notes</label>
                        <textarea id="detailNotes" placeholder="Any additional information..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeRoomDetailModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Detail</button>
                </div>
            </form>
        </div>
    </div>

    </script>
</body>
</html>
