<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Basic Dashboard - NestMate</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.0.0/css/all.min.css" onerror="this.onerror=null;">
    <style>
        /* Font fallbacks */
        body, * {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif !important;
        }
        /* Ensure Font Awesome icons display */
        .fas, .far, .fab, .fa, [class*="fa-"] {
            font-family: "Font Awesome 6 Free", "Font Awesome 6 Pro", "Font Awesome 6 Brands", "FontAwesome" !important;
            font-weight: 900;
            display: inline-block;
        }
        .far {
            font-weight: 400;
        }
        .fab {
            font-family: "Font Awesome 6 Brands", "FontAwesome" !important;
            font-weight: 400;
        }
    </style>
    <!-- AWS SDK and Authentication -->
    <script>
    // AWS SDK with fallback CDNs
    (function() {
        const cdnUrls = [
            'https://sdk.amazonaws.com/js/aws-sdk-2.1491.0.min.js',
            'https://cdn.jsdelivr.net/npm/aws-sdk@2.1491.0/dist/aws-sdk.min.js',
            'https://unpkg.com/aws-sdk@2.1491.0/dist/aws-sdk.min.js'
        ];
        
        let loaded = false;
        let currentIndex = 0;
        
        function loadNext() {
            if (currentIndex >= cdnUrls.length) {
                console.error('Failed to load AWS SDK from all CDNs');
                // Create a minimal AWS stub to prevent errors
                window.AWS = window.AWS || {
                    config: { update: function() {} },
                    CognitoIdentityServiceProvider: function() {},
                    DynamoDB: { DocumentClient: function() {} },
                    S3: function() {}
                };
                return;
            }
            
            const script = document.createElement('script');
            script.src = cdnUrls[currentIndex];
            script.onload = function() {
                loaded = true;
                console.log('AWS SDK loaded from:', cdnUrls[currentIndex]);
            };
            script.onerror = function() {
                console.warn('Failed to load AWS SDK from:', cdnUrls[currentIndex]);
                currentIndex++;
                loadNext();
            };
            document.head.appendChild(script);
        }
        
        loadNext();
    })();
</script>
    <script src="auth-aws.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: #1a1d29;
            color: #ffffff;
            line-height: 1.6;
            overflow-x: hidden;
        }

        .dashboard-container {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: 280px;
            background: #1e293b;
            color: white;
            padding: 2rem 0;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            z-index: 1000;
        }

        .sidebar-header {
            padding: 0 2rem 2rem;
            border-bottom: 1px solid #334155;
        }

        .sidebar-header h1 {
            font-size: 1.5rem;
            font-weight: 700;
            color: #f1f5f9;
        }

        .sidebar-header p {
            color: #94a3b8;
            font-size: 0.875rem;
            margin-top: 0.5rem;
        }

        .nav-menu {
            padding: 1rem 0;
        }

        .nav-item {
            display: block;
            padding: 0.75rem 2rem;
            color: #cbd5e1;
            text-decoration: none;
            transition: all 0.2s;
            cursor: pointer;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
            font-size: 0.875rem;
        }

        .nav-item:hover {
            background: #334155;
            color: white;
        }

        .nav-item.active {
            background: #00d4aa;
            color: white;
        }

        .nav-item i {
            width: 20px;
            margin-right: 0.75rem;
        }

        /* Main Content */
        .main-content-wrapper {
            flex: 1;
            margin-left: 280px;
            padding: 2rem;
            max-width: calc(100vw - 280px);
            overflow-x: hidden;
            overflow-y: auto;
            height: 100vh;
            box-sizing: border-box;
            position: relative;
        }
        .main-content-wrapper > * {
            max-width: 100%;
            box-sizing: border-box;
        }

        /* Header */
        .dashboard-header {
            display: flex;
            align-items: center;
            margin-bottom: 2rem;
        }

        .dashboard-header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            color: #00d4aa;
            margin-left: 1rem;
        }

        .dashboard-header i {
            font-size: 3rem;
            color: #00d4aa;
        }

        .dashboard-subtitle {
            color: #94a3b8;
            font-size: 1.1rem;
            margin-left: 4.5rem;
            margin-top: -0.5rem;
        }

        /* Main Content Grid */
        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        /* Cards */
        .card {
            background: #2d3748;
            border-radius: 1rem;
            padding: 2rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border: 1px solid #4a5568;
        }

        .card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 2rem;
        }

        .card-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: #ffffff;
            display: flex;
            align-items: center;
        }

        .card-title i {
            margin-right: 0.75rem;
            color: #00d4aa;
        }

        .card-info {
            color: #94a3b8;
            cursor: pointer;
            font-size: 1.2rem;
        }

        /* Home Health Score */

        .gauge-circle {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: conic-gradient(#00d4aa 0deg 306deg, #4a5568 306deg 360deg);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .gauge-circle::before {
            content: '';
            position: absolute;
            width: 80%;
            height: 80%;
            background: #2d3748;
            border-radius: 50%;
        }

        .gauge-content {
            position: relative;
            z-index: 1;
            text-align: center;
        }

        .gauge-score {
            font-size: 3rem;
            font-weight: 700;
            color: #ffffff;
            line-height: 1;
        }

        .gauge-label {
            font-size: 1rem;
            color: #94a3b8;
            margin-top: 0.5rem;
        }

        /* Progress Bars */
        .progress-section {
            width: 100%;
        }

        .progress-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .progress-label {
            color: #ffffff;
            font-weight: 500;
            min-width: 100px;
        }

        .progress-bar-container {
            flex: 1;
            height: 8px;
            background: #4a5568;
            border-radius: 4px;
            margin: 0 1rem;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background: #00d4aa;
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        .progress-percentage {
            color: #00d4aa;
            font-weight: 600;
            min-width: 40px;
            text-align: right;
        }

        /* Quick Actions */
        .quick-actions-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .action-button {
            background: #4a5568;
            border: none;
            border-radius: 0.75rem;
            padding: 1.5rem 1rem;
            color: #ffffff;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            min-height: 120px;
        }

        .action-button:hover {
            background: #00d4aa;
            transform: translateY(-2px);
        }

        .action-button i {
            font-size: 2rem;
            margin-bottom: 0.75rem;
        }

        .action-button.emergency i {
            color: #ef4444;
        }

        .action-button.emergency:hover i {
            color: #ffffff;
        }

        .action-button-text {
            font-size: 0.875rem;
            font-weight: 500;
            line-height: 1.2;
        }

        .export-button {
            width: 100%;
            background: #4a5568;
            border: none;
            border-radius: 0.75rem;
            padding: 1rem;
            color: #ffffff;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 500;
        }

        .export-button:hover {
            background: #00d4aa;
        }

        .export-button i {
            margin-right: 0.5rem;
            font-size: 1.2rem;
        }

        /* Bottom Sections */
        .bottom-sections {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
        }

        .bottom-section {
            background: #2d3748;
            border-radius: 1rem;
            padding: 1.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border: 1px solid #4a5568;
        }

        .bottom-section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
        }

        .bottom-section-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #ffffff;
            display: flex;
            align-items: center;
        }

        .bottom-section-title i {
            margin-right: 0.5rem;
            color: #00d4aa;
        }

        .external-link {
            color: #94a3b8;
            cursor: pointer;
            font-size: 1rem;
        }

        /* Chatbot Button */
        .chatbot-button {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            width: 60px;
            height: 60px;
            background: #00d4aa;
            border: none;
            border-radius: 50%;
            color: #ffffff;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0, 212, 170, 0.3);
            transition: all 0.2s;
            z-index: 1000;
        }

        .chatbot-button:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 16px rgba(0, 212, 170, 0.4);
        }

        .chatbot-button i {
            font-size: 1.5rem;
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .bottom-sections {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
                transition: transform 0.3s;
            }

            .sidebar.open {
                transform: translateX(0);
            }

            .main-content-wrapper {
                margin-left: 0;
                padding: 1rem;
                max-width: 100vw;
                overflow-x: hidden;
                overflow-y: auto;
                height: 100vh;
                box-sizing: border-box;
            }

            .user-info {
                top: 1rem;
                right: 1rem;
            }
        }

        @media (max-width: 768px) {
            .dashboard-container {
                padding: 1rem;
            }
            
            .quick-actions-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            
            .gauge-score {
                font-size: 2.5rem;
            }
        }

        @media (max-width: 480px) {
            .quick-actions-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Loading States */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
            color: #94a3b8;
        }

        .loading i {
            margin-right: 0.5rem;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* User Info */
        .user-info {
            position: fixed;
            top: 2rem;
            right: 2rem;
            background: #2d3748;
            border-radius: 0.75rem;
            padding: 1rem;
            border: 1px solid #4a5568;
            display: flex;
            align-items: center;
            z-index: 1001;
        }

        .user-profile-clickable {
            display: flex;
            align-items: center;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 0.5rem;
            transition: background-color 0.2s;
        }

        .user-profile-clickable:hover {
            background: #4a5568;
        }

        .user-dropdown-arrow {
            margin-left: 0.5rem;
            color: #a0aec0;
            transition: transform 0.2s;
        }

        .user-profile-clickable:hover .user-dropdown-arrow {
            transform: rotate(180deg);
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            background: #00d4aa;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 0.75rem;
            font-weight: 600;
            color: #ffffff;
        }

        .user-details h3 {
            font-size: 0.875rem;
            font-weight: 600;
            color: #ffffff;
        }

        .user-details p {
            font-size: 0.75rem;
            color: #94a3b8;
        }

        .sign-out-btn {
            background: #ef4444;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            cursor: pointer;
            font-size: 0.875rem;
            margin-left: 0.75rem;
            transition: background 0.2s;
        }

        .sign-out-btn:hover {
            background: #dc2626;
        }

        /* Content Sections */
        .content-section {
            display: none;
            padding: 2rem;
        }

        .content-section.active {
            display: block;
        }

        /* Polished edit panel styling (applies to all sections) */
        .card {
            position: relative;
        }
        .content-section [id$='Form'] {
            /* hidden by default; visibility toggled via JS */
            margin-top: 1rem;
            padding: 1.25rem;
            border-radius: 0.75rem;
            background: rgba(148, 163, 184, 0.08);
            border: 1px solid rgba(148, 163, 184, 0.18);
            box-shadow: 0 6px 24px rgba(0, 0, 0, 0.25);
            backdrop-filter: blur(4px);
        }
        .content-section .form-group {
            margin-bottom: 0.9rem;
        }
        .content-section .form-group label {
            display: block;
            margin-bottom: 0.35rem;
            font-weight: 600;
            color: #d1d5db;
        }
        .content-section .form-group input,
        .content-section .form-group select,
        .content-section .form-group textarea {
            width: 100%;
            padding: 0.65rem 0.75rem;
            border-radius: 0.5rem;
            border: 1px solid #475569;
            background: #1f2937;
            color: #e5e7eb;
            outline: none;
            transition: border-color 140ms ease, box-shadow 140ms ease;
            box-sizing: border-box;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }
        .content-section .form-group input::placeholder,
        .content-section .form-group textarea::placeholder {
            color: #94a3b8;
        }
        .content-section .form-group input:focus,
        .content-section .form-group select:focus,
        .content-section .form-group textarea:focus {
            border-color: #22d3ee;
            box-shadow: 0 0 0 3px rgba(34, 211, 238, 0.18);
        }
        .content-section [id$='Form'] {
            display: none;
        }
        .content-section [id$='Form'].active {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 1rem 1.25rem;
            width: 100%;
            box-sizing: border-box;
            position: relative;
        }
        .content-section [id$='Form'] > div[style*='display: flex'] {
            grid-column: 1 / -1;
            margin-top: 0.25rem;
        }
        .content-section [id$='Form'] .form-group {
            min-width: 0;
            overflow: visible;
            position: relative;
            display: flex;
            flex-direction: column;
        }
        .content-section [id$='Form'] input,
        .content-section [id$='Form'] textarea,
        .content-section [id$='Form'] select {
            width: 100%;
            box-sizing: border-box;
            word-wrap: break-word;
            overflow-wrap: break-word;
            position: relative;
            display: block;
        }
        .card.editing {
            border: 1px solid rgba(34, 211, 238, 0.35);
            box-shadow: 0 8px 32px rgba(34, 211, 238, 0.12);
        }

        .section-title {
            font-size: 2rem;
            font-weight: 700;
            color: #ffffff;
            margin-bottom: 2rem;
            display: flex;
            align-items: center;
        }

        .section-title i {
            margin-right: 1rem;
            color: #00d4aa;
        }

        .list-container {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .list-item {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding: 12px 16px;
            background: #0f172a;
            border: 1px solid #334155;
            border-radius: 10px;
        }
        .list-item-title { font-weight: 600; }
        .list-item-sub { color: #94a3b8; font-size: 0.95rem; margin-top: 6px; }
        .list-item-actions { display: flex; gap: 8px; }
        .empty-state { color: #94a3b8; padding: 16px; background: #0f172a; border: 1px dashed #334155; border-radius: 10px; }

        /* Modal styles */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.6);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 3000;
            overflow-y: auto;
            padding: 20px;
            box-sizing: border-box;
        }
        .modal-overlay.active {
            display: flex;
        }
        .modal {
            display: none;
            background: #1f2937;
            border-radius: 12px;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 2rem;
            position: relative;
            box-sizing: border-box;
            margin: auto;
        }
        .modal.show {
            display: block;
        }
        .modal-content {
            width: min(900px, 92vw);
            max-height: 90vh;
            background: #0b1220;
            border-radius: 12px;
            border: 1px solid #334155;
            box-shadow: 0 10px 30px rgba(0,0,0,0.35);
            overflow-y: auto;
            overflow-x: hidden;
            position: relative;
            margin: 5% auto;
            box-sizing: border-box;
        }
        .modal-header {
            padding: 20px;
            border-bottom: 1px solid #334155;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .modal-header h2 {
            margin: 0;
            color: #f1f5f9;
        }
        .close-btn {
            background: none;
            border: none;
            color: #94a3b8;
            font-size: 24px;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .close-btn:hover {
            color: #f1f5f9;
        }
        .modal-body {
            padding: 20px;
            box-sizing: border-box;
            overflow-x: hidden;
            word-wrap: break-word;
        }
        .modal-body .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1rem;
            box-sizing: border-box;
        }
        .modal-body .form-row .form-group {
            min-width: 0;
            box-sizing: border-box;
        }
        .modal-body .form-group {
            margin-bottom: 1rem;
            box-sizing: border-box;
        }
        .modal-body .form-group input,
        .modal-body .form-group select,
        .modal-body .form-group textarea {
            width: 100%;
            box-sizing: border-box;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }
        @media (max-width: 768px) {
            .modal-body .form-row {
                grid-template-columns: 1fr;
            }
        }
        .modal-footer {
            padding: 20px;
            border-top: 1px solid #334155;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        .upload-section {
            margin: 20px 0;
            padding: 15px;
            background: #1a1d29;
            border-radius: 8px;
            border: 1px solid #334155;
            box-sizing: border-box;
            width: 100%;
            overflow-x: hidden;
        }
        .upload-section h4 {
            margin: 0 0 15px 0;
            color: #f1f5f9;
        }
        .upload-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
        }
        .upload-item {
            display: flex;
            flex-direction: column;
            gap: 10px;
            box-sizing: border-box;
            width: 100%;
        }
        .upload-item input[type="file"] {
            width: 100%;
            box-sizing: border-box;
            word-wrap: break-word;
        }
        .upload-item label {
            box-sizing: border-box;
            word-wrap: break-word;
        }
        .file-list {
            margin-top: 10px;
        }
        .file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: #334155;
            border-radius: 5px;
            margin: 5px 0;
        }
        .file-name {
            color: #f1f5f9;
            font-weight: 500;
        }
        .file-actions {
            display: flex;
            gap: 5px;
        }
        /* Button Styles */
        .btn {
            background: #00d4aa;
            border: none;
            border-radius: 0.5rem;
            padding: 0.75rem 1.5rem;
            color: #ffffff;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            font-weight: 500;
            font-size: 0.875rem;
            text-decoration: none;
        }
        .btn:hover {
            background: #00b894;
            transform: translateY(-1px);
        }
        .btn i {
            font-size: 1rem;
            display: inline-block;
        }
        .btn-secondary {
            background: #4a5568;
        }
        .btn-secondary:hover {
            background: #5a6578;
        }
        .btn-sm {
            padding: 5px 10px;
            font-size: 12px;
        }

        /* Floor Plan Designer Styles */
        .tool-group {
            margin-bottom: 1.5rem;
        }

        .tool-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
        }

        .tool-btn {
            background: #334155;
            border: 1px solid #475569;
            color: #cbd5e1;
            padding: 0.75rem;
            border-radius: 0.375rem;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.25rem;
            font-size: 0.75rem;
        }

        .tool-btn:hover {
            background: #475569;
            border-color: #64748b;
        }

        .tool-btn.active {
            background: #3b82f6;
            border-color: #2563eb;
            color: white;
        }

        .tool-btn i {
            font-size: 1rem;
        }

        .property-controls {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .property-controls input,
        .property-controls select {
            background: #334155;
            border: 1px solid #475569;
            color: white;
            border-radius: 0.25rem;
            padding: 0.5rem;
        }

        .property-controls input[type="range"] {
            background: transparent;
            border: none;
        }

        .property-controls input[type="color"] {
            height: 40px;
            padding: 0;
            border: none;
            border-radius: 0.25rem;
        }

        #floorPlanCanvas {
            border: 1px solid #e2e8f0;
            background: white;
        }

        .floor-plan-card {
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 0.5rem;
            padding: 1rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .floor-plan-card:hover {
            border-color: #3b82f6;
            transform: translateY(-2px);
        }

        .floor-plan-card img {
            width: 100%;
            height: 200px;
            object-fit: cover;
            border-radius: 0.25rem;
            margin-bottom: 0.5rem;
        }

        .floor-plan-card h4 {
            color: #f1f5f9;
            margin-bottom: 0.25rem;
        }

        .floor-plan-card p {
            color: #94a3b8;
            font-size: 0.875rem;
        }
        /* Snap guide visuals */
        .snap-legend { color: #94a3b8; font-size: 0.8rem; }
        .modal h3 { margin-bottom: 12px; }
        .form-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; }
        .form-grid .form-group { display: flex; flex-direction: column; }
        .form-grid input, .form-grid select, .form-grid textarea { 
            background: #0f172a; border: 1px solid #334155; border-radius: 8px; color: #e2e8f0; padding: 10px;
        }
        .form-actions { margin-top: 14px; display: flex; gap: 8px; }
        
        /* Upload sections */
        .upload-section { margin: 20px 0; padding: 16px; background: #0f172a; border: 1px solid #334155; border-radius: 8px; }
        .upload-section h4 { margin-bottom: 12px; color: #f1f5f9; }
        .upload-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
        .upload-item { display: flex; flex-direction: column; gap: 8px; }
        .upload-item label { font-weight: 600; color: #e2e8f0; }
        .file-list { display: flex; flex-direction: column; gap: 6px; margin-top: 8px; }
        .file-item { display: flex; justify-content: space-between; align-items: center; padding: 8px 12px; background: #1e293b; border: 1px solid #334155; border-radius: 6px; }
        .file-item .file-name { color: #e2e8f0; font-size: 0.9rem; }
        .file-item .file-actions { display: flex; gap: 4px; }
        .file-item .btn { padding: 4px 8px; font-size: 0.8rem; }

        /* Photo container styles */
        .photo-container {
            transition: all 0.3s ease;
            border-radius: 0.375rem;
            overflow: hidden;
        }

        .photo-container.expanded {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.9);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .photo-container.expanded img {
            max-width: 90vw;
            max-height: 90vh;
            object-fit: contain;
        }

        /* Account Modal */
        .account-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 4000;
        }

        .account-modal-content {
            background: #1a1d29;
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            border: 1px solid #334155;
        }

        .account-modal-header {
            padding: 20px;
            border-bottom: 1px solid #334155;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .account-modal-header h2 {
            margin: 0;
            color: #f1f5f9;
        }

        .account-modal-close {
            background: none;
            border: none;
            color: #94a3b8;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .account-modal-body {
            padding: 20px;
        }

        .account-section {
            margin-bottom: 30px;
        }

        .account-section h3 {
            color: #00d4aa;
            margin-bottom: 15px;
            border-bottom: 1px solid #334155;
            padding-bottom: 8px;
        }

        .account-info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .account-info-item {
            background: #0f172a;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #334155;
        }

        .account-info-label {
            color: #94a3b8;
            font-size: 0.9rem;
            margin-bottom: 5px;
        }

        .account-info-value {
            color: #f1f5f9;
            font-weight: 500;
        }

        .subscription-plan {
            background: #0f172a;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #334155;
            margin-bottom: 20px;
        }

        .plan-name {
            color: #00d4aa;
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .plan-status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
            margin-bottom: 15px;
        }

        .plan-status.active {
            background: #065f46;
            color: #10b981;
        }

        .plan-status.inactive {
            background: #7f1d1d;
            color: #f87171;
        }

        .account-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .account-actions .btn {
            flex: 1;
            min-width: 120px;
        }

        /* Tasks & Calendar Styles */
        .tasks-view, .calendar-view {
            width: 100%;
        }

        .task-item {
            background: #374151;
            border: 1px solid #4b5563;
            border-radius: 0.5rem;
            padding: 1rem;
            margin-bottom: 0.75rem;
            display: flex;
            align-items: flex-start;
            gap: 1rem;
            transition: all 0.2s;
        }

        .task-item:hover {
            background: #4b5563;
            border-color: #00d4aa;
        }

        .task-item.completed {
            opacity: 0.6;
        }

        .task-item.completed .task-title {
            text-decoration: line-through;
        }

        .task-item.overdue {
            border-left: 4px solid #ef4444;
        }

        .task-checkbox {
            margin-top: 0.25rem;
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .task-content {
            flex: 1;
        }

        .task-title {
            color: #ffffff;
            font-weight: 600;
            margin-bottom: 0.25rem;
            font-size: 1rem;
        }

        .task-description {
            color: #94a3b8;
            font-size: 0.875rem;
            margin-bottom: 0.5rem;
        }

        .task-meta {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            font-size: 0.75rem;
            color: #94a3b8;
        }

        .task-date {
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .task-priority {
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .task-priority.high {
            background: #ef4444;
            color: #ffffff;
        }

        .task-priority.medium {
            background: #f59e0b;
            color: #ffffff;
        }

        .task-priority.low {
            background: #00d4aa;
            color: #ffffff;
        }

        .task-actions {
            display: flex;
            gap: 0.5rem;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 0.5rem;
        }

        .calendar-day-header {
            text-align: center;
            padding: 0.75rem;
            font-weight: 600;
            color: #00d4aa;
            background: #1f2937;
            border-radius: 0.25rem;
        }

        .calendar-day {
            min-height: 100px;
            background: #374151;
            border: 1px solid #4b5563;
            border-radius: 0.25rem;
            padding: 0.5rem;
            position: relative;
            cursor: pointer;
            transition: all 0.2s;
        }

        .calendar-day:hover {
            background: #4b5563;
            border-color: #00d4aa;
        }

        .calendar-day.other-month {
            opacity: 0.4;
        }

        .calendar-day.today {
            border: 2px solid #00d4aa;
            background: #1f2937;
        }

        .calendar-day-number {
            font-weight: 600;
            color: #ffffff;
            margin-bottom: 0.25rem;
        }

        .calendar-day-tasks {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .calendar-task-dot {
            width: 100%;
            height: 4px;
            border-radius: 2px;
            font-size: 0.625rem;
            padding: 0.125rem 0.25rem;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .calendar-task-dot.high {
            background: #ef4444;
        }

        .calendar-task-dot.medium {
            background: #f59e0b;
        }

        .calendar-task-dot.low {
            background: #00d4aa;
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <!-- Sidebar -->
        <nav class="sidebar">
            <div class="sidebar-header">
                <h1>NestMate</h1>
                <p>Basic Plan Dashboard</p>
            </div>

            <div class="nav-menu">
                <button class="nav-item active" onclick="showSection('overview')">
                    <i class="fas fa-home"></i> Dashboard Overview
                </button>
                <button class="nav-item" onclick="showSection('basic')">
                    <i class="fas fa-info-circle"></i> Basic Info
                </button>
                <button class="nav-item" onclick="showSection('structure')">
                    <i class="fas fa-building"></i> Structure
                </button>
                <button class="nav-item" onclick="showSection('systems')">
                    <i class="fas fa-cogs"></i> Systems
                </button>
                <button class="nav-item" onclick="showSection('bedrooms')">
                    <i class="fas fa-bed"></i> Bedrooms
                </button>
                <button class="nav-item" onclick="showSection('bathrooms')">
                    <i class="fas fa-bath"></i> Bathrooms
                </button>
                <button class="nav-item" onclick="showSection('kitchen')">
                    <i class="fas fa-utensils"></i> Kitchen
                </button>
                <button class="nav-item" onclick="showSection('living')">
                    <i class="fas fa-couch"></i> Living Areas
                </button>
                <button class="nav-item" onclick="showSection('garage')">
                    <i class="fas fa-car"></i> Garage
                </button>
                <button class="nav-item" onclick="showSection('exterior')">
                    <i class="fas fa-home"></i> Exterior
                </button>
                <button class="nav-item" onclick="showSection('appliances')">
                    <i class="fas fa-tv"></i> Appliances
                </button>
                <button class="nav-item" onclick="showSection('favorites')">
                    <i class="fas fa-heart"></i> Favorites
                </button>
                <button class="nav-item" onclick="showSection('photos')">
                    <i class="fas fa-camera"></i> Photos
                </button>
                <button class="nav-item" onclick="showSection('renovations')">
                    <i class="fas fa-hammer"></i> Renovations
                </button>
                <button class="nav-item" onclick="showSection('emergency')">
                    <i class="fas fa-phone"></i> Emergency
                </button>
            </div>
        </nav>

        <!-- Main Content Wrapper -->
        <div class="main-content-wrapper">
            <!-- User Info -->
            <div class="user-info">
                <div class="user-profile-clickable" onclick="openAccountModal()">
                    <div class="user-avatar" id="userAvatar">U</div>
                    <div class="user-details">
                        <h3 id="userName">User</h3>
                        <p id="userEmail">Loading...</p>
                    </div>
                    <div class="user-dropdown-arrow">
                        <i class="fas fa-chevron-down"></i>
                    </div>
                </div>
                <button class="sign-out-btn" onclick="signOut()">
                    <i class="fas fa-sign-out-alt"></i> Sign Out
                </button>
            </div>

            <!-- Dashboard Overview Section -->
            <div id="overviewSection" class="content-section active">
                <!-- Dashboard Header -->
                <div class="dashboard-header">
                    <i class="fas fa-home"></i>
                    <div>
                        <h1>Your Home Command Center</h1>
                        <p class="dashboard-subtitle">Complete home intelligence from foundation to roof</p>
                    </div>
                </div>

                <!-- Main Content -->
                <div class="main-content">

                    <!-- Quick Actions Card -->
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">
                                <i class="fas fa-bolt"></i>
                                Quick Actions
                            </h2>
                        </div>

                        <div class="quick-actions-grid">
                            <button class="action-button" onclick="openTasksCalendar()">
                                <i class="fas fa-calendar-check"></i>
                                <span class="action-button-text">Tasks & Calendar</span>
                            </button>
                            <button class="action-button" onclick="openProducts()">
                                <i class="fas fa-shopping-bag"></i>
                                <span class="action-button-text">Products</span>
                            </button>
                            <button class="action-button emergency" onclick="openEmergency()">
                                <i class="fas fa-exclamation-triangle"></i>
                                <span class="action-button-text">Emergency</span>
                            </button>
                            <button class="action-button" onclick="addService()">
                                <i class="fas fa-wrench"></i>
                                <span class="action-button-text">Add Service</span>
                            </button>
                            <button class="action-button" onclick="viewRecords()">
                                <i class="fas fa-clipboard-list"></i>
                                <span class="action-button-text">View Records</span>
                            </button>
                            <button class="action-button" onclick="openHomeDetails()">
                                <i class="fas fa-file-alt"></i>
                                <span class="action-button-text">Home Details</span>
                            </button>
                        </div>

                        <button class="export-button" onclick="exportData()">
                            <i class="fas fa-chart-bar"></i>
                            Export Data
                        </button>
                    </div>
                </div>

                <!-- Bottom Sections -->
                <div class="bottom-sections">
                    <!-- Recent Activity -->
                    <div class="bottom-section">
                        <div class="bottom-section-header">
                            <h3 class="bottom-section-title">
                                <i class="fas fa-clock"></i>
                                Recent Activity
                            </h3>
                            <i class="fas fa-external-link-alt external-link"></i>
                        </div>
                        <div class="loading">
                            <i class="fas fa-spinner"></i>
                            Loading recent activity...
                        </div>
                    </div>

                    <!-- Energy & Savings -->
                    <div class="bottom-section">
                        <div class="bottom-section-header">
                            <h3 class="bottom-section-title">
                                <i class="fas fa-dollar-sign"></i>
                                Energy & Savings
                            </h3>
                            <i class="fas fa-external-link-alt external-link"></i>
                        </div>
                        <div class="loading">
                            <i class="fas fa-spinner"></i>
                            Loading energy data...
                        </div>
                    </div>
                </div>
            </div>

            <!-- Basic Info Section -->
            <div id="basicSection" class="content-section">
                <h2 class="section-title">
                    <i class="fas fa-info-circle"></i> Basic Info
                </h2>
                
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h3>Home Information</h3>
                        <button class="btn" onclick="editBasicInfo()">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                    </div>
                    
                    <div id="basicInfoDisplay">
                        <p><strong>Address:</strong> <span id="displayAddress">Not set</span></p>
                        <p><strong>Year Built:</strong> <span id="displayYearBuilt">Not set</span></p>
                        <p><strong>Square Footage:</strong> <span id="displaySquareFootage">Not set</span></p>
                        <p><strong>Bedrooms:</strong> <span id="displayBedrooms">Not set</span></p>
                        <p><strong>Bathrooms:</strong> <span id="displayBathrooms">Not set</span></p>
                        <p><strong>Home Type:</strong> <span id="displayHomeType">Not set</span></p>
                    </div>
                    
                    <div id="basicInfoForm" style="display: none;">
                        <div class="form-group">
                            <label for="address">Address</label>
                            <input type="text" id="address" placeholder="Enter home address">
                        </div>
                        <div class="form-group">
                            <label for="yearBuilt">Year Built</label>
                            <input type="number" id="yearBuilt" placeholder="Enter year built">
                        </div>
                        <div class="form-group">
                            <label for="squareFootage">Square Footage</label>
                            <input type="number" id="squareFootage" placeholder="Enter square footage">
                        </div>
                        <div class="form-group">
                            <label for="bedrooms">Number of Bedrooms</label>
                            <input type="number" id="bedrooms" placeholder="Enter number of bedrooms">
                        </div>
                        <div class="form-group">
                            <label for="bathrooms">Number of Bathrooms</label>
                            <input type="number" id="bathrooms" placeholder="Enter number of bathrooms">
                        </div>
                        <div class="form-group">
                            <label for="homeType">Home Type</label>
                            <select id="homeType">
                                <option value="">Select home type</option>
                                <option value="single-family">Single Family</option>
                                <option value="condo">Condo</option>
                                <option value="townhouse">Townhouse</option>
                                <option value="apartment">Apartment</option>
                            </select>
                        </div>
                        <div style="display: flex; gap: 1rem;">
                            <button class="btn" onclick="saveBasicInfo()">
                                <i class="fas fa-save"></i> Save
                            </button>
                            <button class="btn btn-secondary" onclick="cancelEditBasicInfo()">
                                <i class="fas fa-times"></i> Cancel
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Structure Section -->
            <div id="structureSection" class="content-section">
                <h2 class="section-title">
                    <i class="fas fa-building"></i> Structure
                </h2>
                
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h3>Structural Information</h3>
                        <button class="btn" onclick="editStructure()">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                    </div>
                    
                    <div id="structureDisplay">
                        <p><strong>Foundation:</strong> <span id="displayFoundation">Not set</span></p>
                        <p><strong>Roof Type:</strong> <span id="displayRoofType">Not set</span></p>
                        <p><strong>Exterior:</strong> <span id="displayExterior">Not set</span></p>
                        <p><strong>Windows:</strong> <span id="displayWindows">Not set</span></p>
                        <p><strong>Insulation:</strong> <span id="displayInsulation">Not set</span></p>
                        <p><strong>Last Inspection:</strong> <span id="displayLastInspection">Not set</span></p>
                    </div>
                    
                    <div id="structureForm" style="display: none;">
                        <div class="form-group">
                            <label for="foundation">Foundation Type</label>
                            <select id="foundation">
                                <option value="">Select foundation type</option>
                                <option value="concrete-slab">Concrete Slab</option>
                                <option value="crawl-space">Crawl Space</option>
                                <option value="basement">Basement</option>
                                <option value="pier-beam">Pier & Beam</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="roofType">Roof Type</label>
                            <select id="roofType">
                                <option value="">Select roof type</option>
                                <option value="asphalt-shingles">Asphalt Shingles</option>
                                <option value="metal">Metal</option>
                                <option value="tile">Tile</option>
                                <option value="slate">Slate</option>
                                <option value="flat">Flat</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="exterior">Exterior Material</label>
                            <select id="exterior">
                                <option value="">Select exterior material</option>
                                <option value="vinyl-siding">Vinyl Siding</option>
                                <option value="brick">Brick</option>
                                <option value="wood-siding">Wood Siding</option>
                                <option value="stucco">Stucco</option>
                                <option value="stone">Stone</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="windows">Window Type</label>
                            <select id="windows">
                                <option value="">Select window type</option>
                                <option value="single-pane">Single Pane</option>
                                <option value="double-pane">Double Pane</option>
                                <option value="triple-pane">Triple Pane</option>
                                <option value="energy-efficient">Energy Efficient</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="insulation">Insulation Type</label>
                            <select id="insulation">
                                <option value="">Select insulation type</option>
                                <option value="fiberglass">Fiberglass</option>
                                <option value="cellulose">Cellulose</option>
                                <option value="spray-foam">Spray Foam</option>
                                <option value="rigid-board">Rigid Board</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="lastInspection">Last Inspection Date</label>
                            <input type="date" id="lastInspection">
                        </div>
                        <div style="display: flex; gap: 1rem;">
                            <button class="btn" onclick="saveStructure()">
                                <i class="fas fa-save"></i> Save
                            </button>
                            <button class="btn btn-secondary" onclick="cancelEditStructure()">
                                <i class="fas fa-times"></i> Cancel
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Systems Section -->
            <div id="systemsSection" class="content-section">
                <h2 class="section-title">
                    <i class="fas fa-cogs"></i> Systems
                </h2>
                
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h3>Home Systems</h3>
                        <button class="btn" onclick="editSystems()">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                    </div>
                    
                    <div id="systemsDisplay">
                        <p><strong>HVAC:</strong> <span id="displayHVAC">Not set</span></p>
                        <p><strong>Electrical:</strong> <span id="displayElectrical">Not set</span></p>
                        <p><strong>Plumbing:</strong> <span id="displayPlumbing">Not set</span></p>
                        <p><strong>Water Heater:</strong> <span id="displayWaterHeater">Not set</span></p>
                        <p><strong>Security System:</strong> <span id="displaySecurity">Not set</span></p>
                        <p><strong>Last Service:</strong> <span id="displayLastService">Not set</span></p>
                    </div>
                    
                    <div id="systemsForm" style="display: none;">
                        <div class="form-group">
                            <label for="hvac">HVAC System</label>
                            <select id="hvac">
                                <option value="">Select HVAC system</option>
                                <option value="central-air-heat">Central Air & Heat</option>
                                <option value="heat-pump">Heat Pump</option>
                                <option value="gas-furnace">Gas Furnace</option>
                                <option value="electric-heat">Electric Heat</option>
                                <option value="window-units">Window Units</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="electrical">Electrical Service</label>
                            <select id="electrical">
                                <option value="">Select electrical service</option>
                                <option value="100-amp">100 Amp</option>
                                <option value="200-amp">200 Amp</option>
                                <option value="400-amp">400 Amp</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="plumbing">Plumbing Material</label>
                            <select id="plumbing">
                                <option value="">Select plumbing material</option>
                                <option value="copper">Copper</option>
                                <option value="pvc">PVC</option>
                                <option value="pex">PEX</option>
                                <option value="galvanized">Galvanized Steel</option>
                                <option value="mixed">Mixed</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="waterHeater">Water Heater</label>
                            <select id="waterHeater">
                                <option value="">Select water heater</option>
                                <option value="gas-40">Gas, 40 gallon</option>
                                <option value="gas-50">Gas, 50 gallon</option>
                                <option value="electric-40">Electric, 40 gallon</option>
                                <option value="electric-50">Electric, 50 gallon</option>
                                <option value="tankless-gas">Tankless Gas</option>
                                <option value="tankless-electric">Tankless Electric</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="security">Security System</label>
                            <select id="security">
                                <option value="">Select security system</option>
                                <option value="none">None</option>
                                <option value="basic-alarm">Basic Alarm</option>
                                <option value="monitored">Monitored System</option>
                                <option value="smart-home">Smart Home System</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="lastService">Last Service Date</label>
                            <input type="date" id="lastService">
                        </div>
                        <div style="display: flex; gap: 1rem;">
                            <button class="btn" onclick="saveSystems()">
                                <i class="fas fa-save"></i> Save
                            </button>
                            <button class="btn btn-secondary" onclick="cancelEditSystems()">
                                <i class="fas fa-times"></i> Cancel
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Bedrooms Section -->
            <div id="bedroomsSection" class="content-section">
                <h2 class="section-title">
                    <i class="fas fa-bed"></i> Bedrooms
                </h2>
                
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h3>Bedroom Information</h3>
                        <div>
                            <button class="btn" onclick="openAddBedroomModal()">
                                <i class="fas fa-plus"></i> Add Bedroom
                            </button>
                        </div>
                    </div>

                    <!-- List of bedrooms -->
                    <div id="bedroomsList" class="list-container">
                        <!-- dynamically rendered -->
                    </div>
                </div>
            </div>

            <!-- Bathrooms Section -->
            <div id="bathroomsSection" class="content-section">
                <h2 class="section-title">
                    <i class="fas fa-bath"></i> Bathrooms
                </h2>
                
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h3>Bathroom Information</h3>
                        <div>
                            <button class="btn" onclick="openAddBathroomModal()">
                                <i class="fas fa-plus"></i> Add Bathroom
                            </button>
                        </div>
                    </div>

                    <!-- List of bathrooms -->
                    <div id="bathroomsList" class="list-container"></div>
                </div>
            </div>

            <!-- Kitchen Section -->
            <div id="kitchenSection" class="content-section">
                <h2 class="section-title">
                    <i class="fas fa-utensils"></i> Kitchen
                </h2>
                
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h3>Kitchen Information</h3>
                        <div>
                            <button class="btn" onclick="openAddKitchenModal()">
                                <i class="fas fa-plus"></i> Add Kitchen
                            </button>
                        </div>
                    </div>

                    <!-- List of kitchens -->
                    <div id="kitchensList" class="list-container"></div>
                    
                    <div id="kitchenForm" style="display: none;">
                        <div class="form-group">
                            <label for="kitchenSize">Kitchen Size</label>
                            <input type="text" id="kitchenSize" placeholder="e.g., 12' x 10'">
                        </div>
                        <div class="form-group">
                            <label for="kitchenAppliances">Appliance Finish</label>
                            <select id="kitchenAppliances">
                                <option value="">Select appliance finish</option>
                                <option value="stainless-steel">Stainless Steel</option>
                                <option value="black-stainless">Black Stainless</option>
                                <option value="white">White</option>
                                <option value="black">Black</option>
                                <option value="custom">Custom Color</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="kitchenCountertops">Countertop Material</label>
                            <select id="kitchenCountertops">
                                <option value="">Select countertop material</option>
                                <option value="granite">Granite</option>
                                <option value="quartz">Quartz</option>
                                <option value="marble">Marble</option>
                                <option value="butcher-block">Butcher Block</option>
                                <option value="laminate">Laminate</option>
                                <option value="concrete">Concrete</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="kitchenCabinets">Cabinet Material</label>
                            <select id="kitchenCabinets">
                                <option value="">Select cabinet material</option>
                                <option value="oak">Oak</option>
                                <option value="maple">Maple</option>
                                <option value="cherry">Cherry</option>
                                <option value="pine">Pine</option>
                                <option value="mdf">MDF</option>
                                <option value="custom">Custom</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="kitchenFlooring">Flooring Type</label>
                            <select id="kitchenFlooring">
                                <option value="">Select flooring type</option>
                                <option value="hardwood">Hardwood</option>
                                <option value="tile">Tile</option>
                                <option value="vinyl">Vinyl</option>
                                <option value="laminate">Laminate</option>
                                <option value="concrete">Concrete</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="kitchenRenovation">Last Renovation Date</label>
                            <input type="date" id="kitchenRenovation">
                        </div>
                        <div style="display: flex; gap: 1rem;">
                            <button class="btn" onclick="saveKitchen()">
                                <i class="fas fa-save"></i> Save
                            </button>
                            <button class="btn btn-secondary" onclick="cancelEditKitchen()">
                                <i class="fas fa-times"></i> Cancel
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Living Areas Section -->
            <div id="livingSection" class="content-section">
                <h2 class="section-title">
                    <i class="fas fa-couch"></i> Living Areas
                </h2>
                
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h3>Living Space Information</h3>
                        <button class="btn" onclick="editLivingAreas()">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                    </div>
                    
                    <div id="livingDisplay">
                        <p><strong>Living Room:</strong> <span id="displayLivingRoom">Not set</span></p>
                        <p><strong>Dining Room:</strong> <span id="displayDiningRoom">Not set</span></p>
                        <p><strong>Family Room:</strong> <span id="displayFamilyRoom">Not set</span></p>
                        <p><strong>Flooring:</strong> <span id="displayLivingFlooring">Not set</span></p>
                        <p><strong>Ceiling Height:</strong> <span id="displayCeilingHeight">Not set</span></p>
                        <p><strong>Fireplace:</strong> <span id="displayFireplace">Not set</span></p>
                    </div>
                    
                    <div id="livingForm" style="display: none;">
                        <div class="form-group">
                            <label for="livingRoom">Living Room Size</label>
                            <input type="text" id="livingRoom" placeholder="e.g., 16' x 14'">
                        </div>
                        <div class="form-group">
                            <label for="diningRoom">Dining Room Size</label>
                            <input type="text" id="diningRoom" placeholder="e.g., 12' x 10'">
                        </div>
                        <div class="form-group">
                            <label for="familyRoom">Family Room Size</label>
                            <input type="text" id="familyRoom" placeholder="e.g., 15' x 12'">
                        </div>
                        <div class="form-group">
                            <label for="livingFlooring">Flooring Type</label>
                            <select id="livingFlooring">
                                <option value="">Select flooring type</option>
                                <option value="hardwood">Hardwood</option>
                                <option value="carpet">Carpet</option>
                                <option value="tile">Tile</option>
                                <option value="laminate">Laminate</option>
                                <option value="vinyl">Vinyl</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="ceilingHeight">Ceiling Height</label>
                            <select id="ceilingHeight">
                                <option value="">Select ceiling height</option>
                                <option value="8-ft">8 feet</option>
                                <option value="9-ft">9 feet</option>
                                <option value="10-ft">10 feet</option>
                                <option value="vaulted">Vaulted</option>
                                <option value="cathedral">Cathedral</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="fireplace">Fireplace</label>
                            <select id="fireplace">
                                <option value="">Select fireplace type</option>
                                <option value="none">No fireplace</option>
                                <option value="wood-burning">Wood Burning</option>
                                <option value="gas">Gas</option>
                                <option value="electric">Electric</option>
                                <option value="pellet">Pellet</option>
                            </select>
                        </div>
                        <div style="display: flex; gap: 1rem;">
                            <button class="btn" onclick="saveLivingAreas()">
                                <i class="fas fa-save"></i> Save
                            </button>
                            <button class="btn btn-secondary" onclick="cancelEditLivingAreas()">
                                <i class="fas fa-times"></i> Cancel
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Garage Section -->
            <div id="garageSection" class="content-section">
                <h2 class="section-title">
                    <i class="fas fa-car"></i> Garage
                </h2>
                
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h3>Garage Information</h3>
                        <button class="btn" onclick="editGarage()">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                    </div>
                    
                    <div id="garageDisplay">
                        <p><strong>Type:</strong> <span id="displayGarageType">Not set</span></p>
                        <p><strong>Size:</strong> <span id="displayGarageSize">Not set</span></p>
                        <p><strong>Door:</strong> <span id="displayGarageDoor">Not set</span></p>
                        <p><strong>Flooring:</strong> <span id="displayGarageFlooring">Not set</span></p>
                        <p><strong>Storage:</strong> <span id="displayGarageStorage">Not set</span></p>
                        <p><strong>Electrical:</strong> <span id="displayGarageElectrical">Not set</span></p>
                    </div>
                    
                    <div id="garageForm" style="display: none;">
                        <div class="form-group">
                            <label for="garageType">Garage Type</label>
                            <select id="garageType">
                                <option value="">Select garage type</option>
                                <option value="1-car-attached">1-car attached</option>
                                <option value="2-car-attached">2-car attached</option>
                                <option value="3-car-attached">3-car attached</option>
                                <option value="1-car-detached">1-car detached</option>
                                <option value="2-car-detached">2-car detached</option>
                                <option value="carport">Carport</option>
                                <option value="none">No garage</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="garageSize">Garage Size</label>
                            <input type="text" id="garageSize" placeholder="e.g., 20' x 20'">
                        </div>
                        <div class="form-group">
                            <label for="garageDoor">Door Type</label>
                            <select id="garageDoor">
                                <option value="">Select door type</option>
                                <option value="automatic-opener">Automatic opener</option>
                                <option value="manual">Manual</option>
                                <option value="keypad">Keypad entry</option>
                                <option value="smart">Smart garage door</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="garageFlooring">Flooring Type</label>
                            <select id="garageFlooring">
                                <option value="">Select flooring type</option>
                                <option value="concrete">Concrete</option>
                                <option value="epoxy">Epoxy coating</option>
                                <option value="tile">Tile</option>
                                <option value="rubber">Rubber mats</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="garageStorage">Storage Features</label>
                            <select id="garageStorage">
                                <option value="">Select storage features</option>
                                <option value="none">No storage</option>
                                <option value="shelving">Shelving</option>
                                <option value="cabinets">Cabinets</option>
                                <option value="overhead">Overhead storage</option>
                                <option value="workbench">Workbench</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="garageElectrical">Electrical Outlets</label>
                            <select id="garageElectrical">
                                <option value="">Select electrical setup</option>
                                <option value="basic">Basic outlets</option>
                                <option value="multiple">Multiple outlets</option>
                                <option value="220v">220V outlet</option>
                                <option value="workshop">Workshop setup</option>
                            </select>
                        </div>
                        <div style="display: flex; gap: 1rem;">
                            <button class="btn" onclick="saveGarage()">
                                <i class="fas fa-save"></i> Save
                            </button>
                            <button class="btn btn-secondary" onclick="cancelEditGarage()">
                                <i class="fas fa-times"></i> Cancel
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Exterior Section -->
            <div id="exteriorSection" class="content-section">
                <h2 class="section-title">
                    <i class="fas fa-home"></i> Exterior
                </h2>
                
                <div class="card">
                    <div class="edit-panel-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h3>Exterior Information</h3>
                        <button class="btn" onclick="editExterior(); this.closest('.card').classList.add('editing');">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                    </div>
                    
                    <div id="exteriorDisplay">
                        <p><strong>Lot Size:</strong> <span id="displayLotSize">Not set</span></p>
                        <p><strong>Landscaping:</strong> <span id="displayLandscaping">Not set</span></p>
                        <p><strong>Driveway:</strong> <span id="displayDriveway">Not set</span></p>
                        <p><strong>Patio/Deck:</strong> <span id="displayPatio">Not set</span></p>
                        <p><strong>Fencing:</strong> <span id="displayFencing">Not set</span></p>
                        <p><strong>Pool:</strong> <span id="displayPool">Not set</span></p>
                    </div>
                    
                    <div id="exteriorForm" style="display: none;">
                        <div class="form-group">
                            <label for="lotSize">Lot Size</label>
                            <input type="text" id="lotSize" placeholder="e.g., 0.25 acres">
                        </div>
                        <div class="form-group">
                            <label for="landscaping">Landscaping</label>
                            <select id="landscaping">
                                <option value="">Select landscaping type</option>
                                <option value="mature-trees">Mature trees and shrubs</option>
                                <option value="minimal">Minimal landscaping</option>
                                <option value="desert">Desert landscaping</option>
                                <option value="tropical">Tropical landscaping</option>
                                <option value="formal">Formal gardens</option>
                                <option value="native">Native plants</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="driveway">Driveway Material</label>
                            <select id="driveway">
                                <option value="">Select driveway material</option>
                                <option value="asphalt">Asphalt</option>
                                <option value="concrete">Concrete</option>
                                <option value="gravel">Gravel</option>
                                <option value="pavers">Pavers</option>
                                <option value="brick">Brick</option>
                                <option value="none">No driveway</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="patio">Patio/Deck</label>
                            <select id="patio">
                                <option value="">Select patio/deck type</option>
                                <option value="none">No patio/deck</option>
                                <option value="concrete-patio">Concrete patio</option>
                                <option value="wood-deck">Wood deck</option>
                                <option value="composite-deck">Composite deck</option>
                                <option value="stone-patio">Stone patio</option>
                                <option value="paver-patio">Paver patio</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="fencing">Fencing</label>
                            <select id="fencing">
                                <option value="">Select fencing type</option>
                                <option value="none">No fencing</option>
                                <option value="wood">Wood fence</option>
                                <option value="vinyl">Vinyl fence</option>
                                <option value="chain-link">Chain link</option>
                                <option value="wrought-iron">Wrought iron</option>
                                <option value="privacy">Privacy fence</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="pool">Pool</label>
                            <select id="pool">
                                <option value="">Select pool type</option>
                                <option value="none">No pool</option>
                                <option value="in-ground">In-ground pool</option>
                                <option value="above-ground">Above-ground pool</option>
                                <option value="hot-tub">Hot tub/spa</option>
                                <option value="swim-spa">Swim spa</option>
                            </select>
                        </div>
                        <div style="display: flex; gap: 1rem;">
                            <button class="btn" onclick="saveExterior(); this.closest('.card').classList.remove('editing');">
                                <i class="fas fa-save"></i> Save
                            </button>
                            <button class="btn btn-secondary" onclick="cancelEditExterior(); this.closest('.card').classList.remove('editing');">
                                <i class="fas fa-times"></i> Cancel
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Appliances Section -->
            <div id="appliancesSection" class="content-section">
                <h2 class="section-title">
                    <i class="fas fa-tv"></i> Appliances
                </h2>
                
                <div class="card">
                    <div class="edit-panel-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h3>Appliance Information</h3>
                        <button class="btn" onclick="editAppliances(); this.closest('.card').classList.add('editing');">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                    </div>
                    
                    <div id="appliancesDisplay">
                        <p><strong>Refrigerator:</strong> <span id="displayRefrigerator">Not set</span></p>
                        <p><strong>Dishwasher:</strong> <span id="displayDishwasher">Not set</span></p>
                        <p><strong>Washer/Dryer:</strong> <span id="displayWasherDryer">Not set</span></p>
                        <p><strong>Stove/Oven:</strong> <span id="displayStove">Not set</span></p>
                        <p><strong>Microwave:</strong> <span id="displayMicrowave">Not set</span></p>
                        <p><strong>Last Service:</strong> <span id="displayApplianceService">Not set</span></p>
                    </div>
                    
                    <div id="appliancesForm" style="display: none;">
                        <div class="form-group">
                            <label for="refrigerator">Refrigerator</label>
                            <input type="text" id="refrigerator" placeholder="e.g., Samsung, 2020">
                        </div>
                        <div class="form-group">
                            <label for="dishwasher">Dishwasher</label>
                            <input type="text" id="dishwasher" placeholder="e.g., Bosch, 2019">
                        </div>
                        <div class="form-group">
                            <label for="washerDryer">Washer/Dryer</label>
                            <input type="text" id="washerDryer" placeholder="e.g., LG, 2021">
                        </div>
                        <div class="form-group">
                            <label for="stove">Stove/Oven</label>
                            <input type="text" id="stove" placeholder="e.g., GE, 2020">
                        </div>
                        <div class="form-group">
                            <label for="microwave">Microwave</label>
                            <input type="text" id="microwave" placeholder="e.g., Whirlpool, 2019">
                        </div>
                        <div class="form-group">
                            <label for="applianceService">Last Service Date</label>
                            <input type="date" id="applianceService">
                        </div>
                        <div style="display: flex; gap: 1rem;">
                            <button class="btn" onclick="saveAppliances(); this.closest('.card').classList.remove('editing');">
                                <i class="fas fa-save"></i> Save
                            </button>
                            <button class="btn btn-secondary" onclick="cancelEditAppliances(); this.closest('.card').classList.remove('editing');">
                                <i class="fas fa-times"></i> Cancel
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Favorites Section -->
            <div id="favoritesSection" class="content-section">
                <h2 class="section-title">
                    <i class="fas fa-heart"></i> Favorites
                </h2>
                <div class="card">
                    <div class="edit-panel-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h3>Favorite Items</h3>
                        <button class="btn" onclick="editFavorites(); this.closest('.card').classList.add('editing');">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                    </div>
                    <div id="favoritesDisplay">
                        <ul id="favoritesList" style="list-style: disc; padding-left: 1.25rem; color: #cbd5e1;"></ul>
                        <p id="favoritesEmpty" style="color:#94a3b8;">No favorites added yet</p>
                    </div>
                    <div id="favoritesForm" style="display:none;">
                        <div class="form-group">
                            <label for="favoriteItem">Add Favorite</label>
                            <input type="text" id="favoriteItem" placeholder="e.g., Water heater manual URL or note">
                        </div>
                        <div style="display:flex; gap: 0.75rem; margin-bottom: 0.75rem;">
                            <button class="btn" onclick="addFavorite()"><i class="fas fa-plus"></i> Add</button>
                            <button class="btn btn-secondary" onclick="clearFavorites()"><i class="fas fa-trash"></i> Clear All</button>
                        </div>
                        <div style="display:flex; gap: 1rem;">
                            <button class="btn" onclick="saveFavorites(); this.closest('.card').classList.remove('editing');"><i class="fas fa-save"></i> Save</button>
                            <button class="btn btn-secondary" onclick="cancelEditFavorites(); this.closest('.card').classList.remove('editing');"><i class="fas fa-times"></i> Cancel</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Photos Section -->
            <div id="photosSection" class="content-section">
                <h2 class="section-title">
                    <i class="fas fa-camera"></i> Photos
                </h2>
                <div class="card">
                    <div class="edit-panel-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h3>Home Photos</h3>
                        <button class="btn" onclick="editPhotos(); this.closest('.card').classList.add('editing');">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                    </div>
                    <div id="photosDisplay">
                        <div id="photosGrid" style="display:grid; grid-template-columns: repeat(3, minmax(0,1fr)); gap: 0.75rem;"></div>
                        <p id="photosEmpty" style="color:#94a3b8;">No photos uploaded yet</p>
                    </div>
                    <div id="photosForm" style="display:none;">
                        <div class="form-container">
                            <div class="form-group">
                                <label for="photoFile">Upload Photo</label>
                                <input type="file" id="photoFile" accept="image/*" multiple>
                                <small style="color: #94a3b8; margin-top: 0.5rem; display: block;">Select multiple images to upload</small>
                            </div>
                            <div class="form-group">
                                <label for="photoUrl">Or paste image URL</label>
                                <input type="url" id="photoUrl" placeholder="Paste an image URL">
                            </div>
                            <div class="form-actions">
                                <button class="btn" onclick="uploadPhotos()"><i class="fas fa-upload"></i> Upload</button>
                                <button class="btn" onclick="addPhotoFromUrl()"><i class="fas fa-plus"></i> Add URL</button>
                                <button class="btn btn-secondary" onclick="clearPhotos()"><i class="fas fa-trash"></i> Clear All</button>
                            </div>
                        </div>
                        <div style="display:flex; gap: 1rem; margin-top: 1rem;">
                            <button class="btn" onclick="savePhotos(); this.closest('.card').classList.remove('editing');"><i class="fas fa-save"></i> Save</button>
                            <button class="btn btn-secondary" onclick="cancelEditPhotos(); this.closest('.card').classList.remove('editing');"><i class="fas fa-times"></i> Cancel</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tasks & Calendar Section -->
            <div id="tasksSection" class="content-section">
                <h2 class="section-title">
                    <i class="fas fa-calendar-check"></i> Tasks & Calendar
                </h2>
                
                <!-- View Toggle -->
                <div style="display: flex; gap: 1rem; margin-bottom: 2rem;">
                    <button class="btn" id="tasksViewBtn" onclick="switchTasksView('tasks')">
                        <i class="fas fa-list"></i> Tasks
                    </button>
                    <button class="btn btn-secondary" id="calendarViewBtn" onclick="switchTasksView('calendar')">
                        <i class="fas fa-calendar"></i> Calendar
                    </button>
                </div>

                <!-- Tasks View -->
                <div id="tasksView" class="tasks-view">
                    <div class="card">
                        <div class="edit-panel-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <h3>My Tasks</h3>
                            <button class="btn" onclick="openAddTaskModal()">
                                <i class="fas fa-plus"></i> Add Task
                            </button>
                        </div>
                        
                        <!-- Task Filters -->
                        <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem; flex-wrap: wrap;">
                            <button class="btn btn-sm" onclick="filterTasks('all')" id="filterAll">All</button>
                            <button class="btn btn-sm btn-secondary" onclick="filterTasks('pending')" id="filterPending">Pending</button>
                            <button class="btn btn-sm btn-secondary" onclick="filterTasks('completed')" id="filterCompleted">Completed</button>
                            <button class="btn btn-sm btn-secondary" onclick="filterTasks('overdue')" id="filterOverdue">Overdue</button>
                        </div>
                        
                        <div id="tasksList">
                            <p style="color: #94a3b8; text-align: center; padding: 2rem;">No tasks yet. Click "Add Task" to get started.</p>
                        </div>
                    </div>
                </div>

                <!-- Calendar View -->
                <div id="calendarView" class="calendar-view" style="display: none;">
                    <div class="card">
                        <div class="calendar-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                            <button class="btn btn-sm" onclick="changeMonth(-1)">
                                <i class="fas fa-chevron-left"></i>
                            </button>
                            <h3 id="calendarMonthYear" style="margin: 0; color: #ffffff;"></h3>
                            <button class="btn btn-sm" onclick="changeMonth(1)">
                                <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                        <div id="calendarGrid" class="calendar-grid"></div>
                    </div>
                </div>
            </div>

            <!-- Renovations and Upgrades Section -->
            <div id="renovationsSection" class="content-section">
                <h2 class="section-title">
                    <i class="fas fa-hammer"></i> Renovations & Upgrades
                </h2>
                <div class="card">
                    <div class="edit-panel-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h3>Project History</h3>
                        <button class="btn" onclick="openAddRenovationModal()">
                            <i class="fas fa-plus"></i> Add Project
                        </button>
                    </div>
                    <div id="renovationsList">
                        <p>No renovation projects yet. Click "Add Project" to get started.</p>
                    </div>
                </div>
            </div>

            <!-- Emergency Section -->
            <div id="emergencySection" class="content-section">
                <h2 class="section-title">
                    <i class="fas fa-phone"></i> Emergency
                </h2>
                <div class="card">
                    <div class="edit-panel-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h3>Emergency Contacts</h3>
                        <button class="btn" onclick="editEmergency(); this.closest('.card').classList.add('editing');">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                    </div>
                    <div id="emergencyDisplay">
                        <p><strong>Police:</strong> <span id="displayPolice">911</span></p>
                        <p><strong>Fire Department:</strong> <span id="displayFire">911</span></p>
                        <p><strong>Electrician:</strong> <span id="displayElectrician">(555) 123-4567</span></p>
                        <p><strong>Plumber:</strong> <span id="displayPlumber">(555) 987-6543</span></p>
                        <p><strong>Emergency Notes:</strong> <span id="displayEmergencyNotes">None</span></p>
                    </div>
                    <div id="emergencyForm" style="display:none;">
                        <div class="form-group"><label for="police">Police</label><input type="text" id="police" placeholder="e.g., 911"></div>
                        <div class="form-group"><label for="fire">Fire Department</label><input type="text" id="fire" placeholder="e.g., 911"></div>
                        <div class="form-group"><label for="electrician">Electrician</label><input type="text" id="electrician" placeholder="Phone"></div>
                        <div class="form-group"><label for="plumber">Plumber</label><input type="text" id="plumber" placeholder="Phone"></div>
                        <div class="form-group"><label for="emergencyNotes">Notes</label><input type="text" id="emergencyNotes" placeholder="Any special notes"></div>
                        <div style="display:flex; gap: 1rem;">
                            <button class="btn" onclick="saveEmergency(); this.closest('.card').classList.remove('editing');"><i class="fas fa-save"></i> Save</button>
                            <button class="btn btn-secondary" onclick="cancelEditEmergency(); this.closest('.card').classList.remove('editing');"><i class="fas fa-times"></i> Cancel</button>
                        </div>
                </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Chatbot Button -->
    <button class="chatbot-button" onclick="openChatbot()">
        <i class="fas fa-robot"></i>
    </button>

    <!-- Task Modal -->
    <div id="taskModal" class="modal" style="display: none !important;">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="taskModalTitle">Add Task</h2>
                <button class="close-btn" onclick="closeTaskModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="taskForm">
                    <div class="form-group">
                        <label for="taskTitle">Task Title *</label>
                        <input type="text" id="taskTitle" required placeholder="e.g., Change air filter">
                    </div>
                    <div class="form-group">
                        <label for="taskDescription">Description</label>
                        <textarea id="taskDescription" rows="3" placeholder="Add details about this task..."></textarea>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="taskDueDate">Due Date *</label>
                            <input type="date" id="taskDueDate" required>
                        </div>
                        <div class="form-group">
                            <label for="taskPriority">Priority</label>
                            <select id="taskPriority">
                                <option value="low">Low</option>
                                <option value="medium" selected>Medium</option>
                                <option value="high">High</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="taskCategory">Category</label>
                        <input type="text" id="taskCategory" placeholder="e.g., Maintenance, Cleaning, Repairs">
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" onclick="closeTaskModal()">
                            <i class="fas fa-times"></i> Cancel
                        </button>
                        <button type="submit" class="btn">
                            <i class="fas fa-save"></i> Save Task
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Renovation Modal -->
    <div id="renovationModal" class="modal" style="display: none !important;">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="renovationModalTitle">Add Renovation Project</h2>
                <button class="close-btn" onclick="closeRenovationModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="renovationForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="projectName">Project Name *</label>
                            <input type="text" id="projectName" required placeholder="e.g., Kitchen Remodel">
                        </div>
                        <div class="form-group">
                            <label for="projectType">Project Type *</label>
                            <select id="projectType" required>
                                <option value="">Select Type</option>
                                <option value="renovation">Renovation</option>
                                <option value="upgrade">Upgrade</option>
                                <option value="repair">Repair</option>
                                <option value="maintenance">Maintenance</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="startDate">Start Date *</label>
                            <input type="date" id="startDate" required>
                        </div>
                        <div class="form-group">
                            <label for="endDate">End Date</label>
                            <input type="date" id="endDate">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="contractor">Contractor/Company</label>
                            <input type="text" id="contractor" placeholder="Contractor name or company">
                        </div>
                        <div class="form-group">
                            <label for="contractorPhone">Contractor Phone</label>
                            <input type="tel" id="contractorPhone" placeholder="(555) 123-4567">
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="projectDescription">Project Description *</label>
                        <textarea id="projectDescription" required rows="3" placeholder="Describe the work performed..."></textarea>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="totalCost">Total Cost</label>
                            <input type="number" id="totalCost" step="0.01" placeholder="0.00">
                        </div>
                        <div class="form-group">
                            <label for="status">Status</label>
                            <select id="status">
                                <option value="planned">Planned</option>
                                <option value="in-progress">In Progress</option>
                                <option value="completed">Completed</option>
                                <option value="on-hold">On Hold</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="warrantyInfo">Warranty Information</label>
                        <textarea id="warrantyInfo" rows="2" placeholder="Warranty details, expiration dates, etc."></textarea>
                    </div>

                    <div class="form-group">
                        <label for="notes">Additional Notes</label>
                        <textarea id="notes" rows="2" placeholder="Any additional notes or comments..."></textarea>
                    </div>

                    <!-- File Upload Sections -->
                    <div class="upload-section">
                        <h4><i class="fas fa-receipt"></i> Receipts & Invoices</h4>
                        <div class="upload-grid">
                            <div class="upload-item">
                                <label for="receiptFiles">Upload Receipts</label>
                                <input type="file" id="receiptFiles" multiple accept=".pdf,.jpg,.jpeg,.png">
                                <div class="file-list" id="receiptList"></div>
                            </div>
                        </div>
                    </div>

                    <div class="upload-section">
                        <h4><i class="fas fa-camera"></i> Project Photos</h4>
                        <div class="upload-grid">
                            <div class="upload-item">
                                <label for="projectPhotos">Upload Photos</label>
                                <input type="file" id="projectPhotos" multiple accept="image/*">
                                <div class="file-list" id="projectPhotosList"></div>
                            </div>
                        </div>
                    </div>

                    <div class="upload-section">
                        <h4><i class="fas fa-file-contract"></i> Permits & Documents</h4>
                        <div class="upload-grid">
                            <div class="upload-item">
                                <label for="permitFiles">Upload Permits/Documents</label>
                                <input type="file" id="permitFiles" multiple accept=".pdf,.jpg,.jpeg,.png">
                                <div class="file-list" id="permitList"></div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeRenovationModal()">Cancel</button>
                <button class="btn" onclick="saveRenovation()">Save Project</button>
            </div>
        </div>
    </div>

    <!-- Floor Plan Upload Modal -->
    <div id="floorPlanUploadModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3><i class="fas fa-upload"></i> Upload Floor Plan</h3>
                <span class="close-btn" onclick="closeFloorPlanUpload()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="floorPlanFile">Select Floor Plan File</label>
                    <input type="file" id="floorPlanFile" accept="image/*,.pdf,.dwg,.dxf" multiple>
                    <small style="color: #94a3b8; margin-top: 0.5rem; display: block;">
                        Supported formats: JPG, PNG, PDF, DWG, DXF. Multiple files allowed.
                    </small>
                </div>
                <div class="form-group">
                    <label for="floorPlanUrl">Or paste file URL</label>
                    <input type="url" id="floorPlanUrl" placeholder="Paste an image or PDF URL">
                </div>
                <div class="form-group">
                    <label for="floorPlanName">Plan Name</label>
                    <input type="text" id="floorPlanName" placeholder="e.g., Main Floor, Basement, Second Floor">
                </div>
                <div class="form-group">
                    <label for="floorPlanDescription">Description (Optional)</label>
                    <textarea id="floorPlanDescription" placeholder="Add notes about this floor plan..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="uploadFloorPlan()">
                    <i class="fas fa-upload"></i> Upload
                </button>
                <button class="btn btn-secondary" onclick="closeFloorPlanUpload()">
                    <i class="fas fa-times"></i> Cancel
                </button>
            </div>
        </div>
    </div>

    <!-- Floor Plan Creator Modal -->
    <div id="floorPlanCreatorModal" class="modal">
        <div class="modal-content" style="max-width: 95vw; max-height: 95vh; width: 1400px;">
            <div class="modal-header">
                <h3><i class="fas fa-drafting-compass"></i> Floor Plan Designer</h3>
                <div style="display: flex; gap: 0.5rem;">
                    <button class="btn btn-sm" onclick="saveFloorPlan()">
                        <i class="fas fa-save"></i> Save
                    </button>
                    <button class="btn btn-sm" onclick="exportFloorPlan()">
                        <i class="fas fa-download"></i> Export
                    </button>
                    <span class="close-btn" onclick="closeFloorPlanCreator()">&times;</span>
                </div>
            </div>
            <div class="modal-body" style="padding: 0; height: 80vh;">
                <!-- Floor Plan Designer Interface -->
                <div id="floorPlanDesigner" style="display: flex; height: 100%;">
                    <!-- Tools Panel -->
                    <div id="toolsPanel" style="width: 250px; background: #1e293b; border-right: 1px solid #334155; padding: 1rem; overflow-y: auto;">
                        <h4 style="margin-bottom: 1rem; color: #f1f5f9;">Drawing Tools</h4>
                        
                        <!-- Basic Tools -->
                        <div class="tool-group">
                            <h5 style="color: #cbd5e1; margin-bottom: 0.5rem;">Basic Tools</h5>
                            <div class="tool-buttons">
                                <button class="tool-btn active" data-tool="select" onclick="selectTool('select')">
                                    <i class="fas fa-mouse-pointer"></i> Select
                                </button>
                                <button class="tool-btn" data-tool="pan" onclick="selectTool('pan')">
                                    <i class="fas fa-hand-paper"></i> Pan
                                </button>
                                <button class="tool-btn" data-tool="zoom" onclick="selectTool('zoom')">
                                    <i class="fas fa-search-plus"></i> Zoom
                                </button>
                                <button class="tool-btn" data-tool="measure" onclick="selectTool('measure')">
                                    <i class="fas fa-ruler"></i> Measure
                                </button>
                            </div>
                        </div>

                        <!-- Walls & Structure -->
                        <div class="tool-group">
                            <h5 style="color: #cbd5e1; margin-bottom: 0.5rem;">Walls & Structure</h5>
                            <div class="tool-buttons">
                                <button class="tool-btn" data-tool="wall" onclick="selectTool('wall')">
                                    <i class="fas fa-square"></i> Wall
                                </button>
                                <button class="tool-btn" data-tool="curved-wall" onclick="selectTool('curved-wall')">
                                    <i class="fas fa-circle"></i> Curved Wall
                                </button>
                                <button class="tool-btn" data-tool="column" onclick="selectTool('column')">
                                    <i class="fas fa-circle"></i> Column
                                </button>
                                <button class="tool-btn" data-tool="beam" onclick="selectTool('beam')">
                                    <i class="fas fa-minus"></i> Beam
                                </button>
                            </div>
                        </div>

                        <!-- Professional Doors -->
                        <div class="tool-group">
                            <h5 style="color: #cbd5e1; margin-bottom: 0.5rem;">Doors</h5>
                            <div class="tool-buttons">
                                <button class="tool-btn" data-tool="door-single" onclick="selectDoorType('single')">
                                    <i class="fas fa-door-open"></i> Single Door
                                </button>
                                <button class="tool-btn" data-tool="door-double" onclick="selectDoorType('double')">
                                    <i class="fas fa-door-open"></i> Double Door
                                </button>
                                <button class="tool-btn" data-tool="door-slider" onclick="selectDoorType('slider')">
                                    <i class="fas fa-arrows-alt-h"></i> Slider Door
                                </button>
                                <button class="tool-btn" data-tool="door-french" onclick="selectDoorType('french')">
                                    <i class="fas fa-door-open"></i> French Door
                                </button>
                                <button class="tool-btn" data-tool="door-exterior" onclick="selectDoorType('exterior')">
                                    <i class="fas fa-home"></i> Exterior Door
                                </button>
                                <button class="tool-btn" data-tool="door-patio" onclick="selectDoorType('patio')">
                                    <i class="fas fa-door-open"></i> Patio Door
                                </button>
                            </div>
                        </div>

                        <!-- Professional Windows -->
                        <div class="tool-group">
                            <h5 style="color: #cbd5e1; margin-bottom: 0.5rem;">Windows</h5>
                            <div class="tool-buttons">
                                <button class="tool-btn" data-tool="window-single" onclick="selectWindowType('single')">
                                    <i class="fas fa-square"></i> Single Window
                                </button>
                                <button class="tool-btn" data-tool="window-double" onclick="selectWindowType('double')">
                                    <i class="fas fa-square"></i> Double Window
                                </button>
                                <button class="tool-btn" data-tool="window-bay" onclick="selectWindowType('bay')">
                                    <i class="fas fa-square"></i> Bay Window
                                </button>
                                <button class="tool-btn" data-tool="window-casement" onclick="selectWindowType('casement')">
                                    <i class="fas fa-square"></i> Casement
                                </button>
                                <button class="tool-btn" data-tool="window-slider" onclick="selectWindowType('slider')">
                                    <i class="fas fa-arrows-alt-h"></i> Slider Window
                                </button>
                                <button class="tool-btn" data-tool="window-picture" onclick="selectWindowType('picture')">
                                    <i class="fas fa-square"></i> Picture Window
                                </button>
                            </div>
                        </div>

                        <!-- Rooms -->
                        <div class="tool-group">
                            <h5 style="color: #cbd5e1; margin-bottom: 0.5rem;">Rooms</h5>
                            <div class="tool-buttons">
                                <button class="tool-btn" data-tool="room" onclick="selectTool('room')">
                                    <i class="fas fa-home"></i> Room
                                </button>
                                <button class="tool-btn" data-tool="text" onclick="selectTool('text')">
                                    <i class="fas fa-font"></i> Text
                                </button>
                                <button class="tool-btn" data-tool="dimension" onclick="selectTool('dimension')">
                                    <i class="fas fa-arrows-alt-h"></i> Dimension
                                </button>
                            </div>
                        </div>

                        <!-- Furniture -->
                        <div class="tool-group">
                            <h5 style="color: #cbd5e1; margin-bottom: 0.5rem;">Furniture</h5>
                            <div class="tool-buttons">
                                <button class="tool-btn" data-tool="bed" onclick="selectTool('bed')">
                                    <i class="fas fa-bed"></i> Bed
                                </button>
                                <button class="tool-btn" data-tool="sofa" onclick="selectTool('sofa')">
                                    <i class="fas fa-couch"></i> Sofa
                                </button>
                                <button class="tool-btn" data-tool="table" onclick="selectTool('table')">
                                    <i class="fas fa-table"></i> Table
                                </button>
                                <button class="tool-btn" data-tool="chair" onclick="selectTool('chair')">
                                    <i class="fas fa-chair"></i> Chair
                                </button>
                                <button class="tool-btn" data-tool="appliance" onclick="selectTool('appliance')">
                                    <i class="fas fa-tv"></i> Appliance
                                </button>
                            </div>
                        </div>

                        <!-- Kitchen & Bathroom -->
                        <div class="tool-group">
                            <h5 style="color: #cbd5e1; margin-bottom: 0.5rem;">Kitchen & Bathroom</h5>
                            <div class="tool-buttons">
                                <button class="tool-btn" data-tool="sink" onclick="selectTool('sink')">
                                    <i class="fas fa-sink"></i> Sink
                                </button>
                                <button class="tool-btn" data-tool="toilet" onclick="selectTool('toilet')">
                                    <i class="fas fa-toilet"></i> Toilet
                                </button>
                                <button class="tool-btn" data-tool="bathtub" onclick="selectTool('bathtub')">
                                    <i class="fas fa-bath"></i> Bathtub
                                </button>
                                <button class="tool-btn" data-tool="shower" onclick="selectTool('shower')">
                                    <i class="fas fa-shower"></i> Shower
                                </button>
                                <button class="tool-btn" data-tool="stove" onclick="selectTool('stove')">
                                    <i class="fas fa-fire"></i> Stove
                                </button>
                                <button class="tool-btn" data-tool="refrigerator" onclick="selectTool('refrigerator')">
                                    <i class="fas fa-snowflake"></i> Refrigerator
                                </button>
                            </div>
                        </div>

                        <!-- Siding & Materials -->
                        <div class="tool-group">
                            <h5 style="color: #cbd5e1; margin-bottom: 0.5rem;">Siding & Materials</h5>
                            <div class="tool-buttons">
                                <button class="tool-btn" data-tool="siding-brick" onclick="selectSidingType('brick')">
                                    <i class="fas fa-square"></i> Brick
                                </button>
                                <button class="tool-btn" data-tool="siding-vinyl" onclick="selectSidingType('vinyl')">
                                    <i class="fas fa-square"></i> Vinyl
                                </button>
                                <button class="tool-btn" data-tool="siding-wood" onclick="selectSidingType('wood')">
                                    <i class="fas fa-tree"></i> Wood
                                </button>
                                <button class="tool-btn" data-tool="siding-stone" onclick="selectSidingType('stone')">
                                    <i class="fas fa-mountain"></i> Stone
                                </button>
                                <button class="tool-btn" data-tool="siding-stucco" onclick="selectSidingType('stucco')">
                                    <i class="fas fa-square"></i> Stucco
                                </button>
                                <button class="tool-btn" data-tool="siding-metal" onclick="selectSidingType('metal')">
                                    <i class="fas fa-square"></i> Metal
                                </button>
                            </div>
                        </div>

                        <!-- Advanced Drawing Tools -->
                        <div class="tool-group">
                            <h5 style="color: #cbd5e1; margin-bottom: 0.5rem;">Advanced Tools</h5>
                            <div class="tool-buttons">
                                <button class="tool-btn" data-tool="polyline" onclick="selectTool('polyline')">
                                    <i class="fas fa-draw-polygon"></i> Polyline
                                </button>
                                <button class="tool-btn" data-tool="arc" onclick="selectTool('arc')">
                                    <i class="fas fa-circle"></i> Arc
                                </button>
                                <button class="tool-btn" data-tool="spline" onclick="selectTool('spline')">
                                    <i class="fas fa-wave-square"></i> Spline
                                </button>
                                <button class="tool-btn" data-tool="circle" onclick="selectTool('circle')">
                                    <i class="fas fa-circle"></i> Circle
                                </button>
                                <button class="tool-btn" data-tool="ellipse" onclick="selectTool('ellipse')">
                                    <i class="fas fa-circle"></i> Ellipse
                                </button>
                                <button class="tool-btn" data-tool="polygon" onclick="selectTool('polygon')">
                                    <i class="fas fa-draw-polygon"></i> Polygon
                                </button>
                            </div>
                        </div>

                        <!-- Electrical & Plumbing -->
                        <div class="tool-group">
                            <h5 style="color: #cbd5e1; margin-bottom: 0.5rem;">Electrical & Plumbing</h5>
                            <div class="tool-buttons">
                                <button class="tool-btn" data-tool="outlet" onclick="selectTool('outlet')">
                                    <i class="fas fa-plug"></i> Outlet
                                </button>
                                <button class="tool-btn" data-tool="switch" onclick="selectTool('switch')">
                                    <i class="fas fa-toggle-on"></i> Switch
                                </button>
                                <button class="tool-btn" data-tool="light" onclick="selectTool('light')">
                                    <i class="fas fa-lightbulb"></i> Light
                                </button>
                                <button class="tool-btn" data-tool="pipe" onclick="selectTool('pipe')">
                                    <i class="fas fa-pipe"></i> Pipe
                                </button>
                            </div>
                        </div>

                        <!-- Professional Sizing -->
                        <div class="tool-group">
                            <h5 style="color: #cbd5e1; margin-bottom: 0.5rem;">Standard Sizes</h5>
                            <div class="property-controls">
                                <label style="color: #94a3b8; font-size: 0.875rem;">Door Width:</label>
                                <select id="doorWidth" style="width: 100%; padding: 0.5rem; background: #334155; color: white; border: 1px solid #475569; border-radius: 0.25rem; margin-bottom: 0.5rem;">
                                    <option value="24">24" (2'0")</option>
                                    <option value="28">28" (2'4")</option>
                                    <option value="30" selected>30" (2'6")</option>
                                    <option value="32">32" (2'8")</option>
                                    <option value="34">34" (2'10")</option>
                                    <option value="36">36" (3'0")</option>
                                    <option value="42">42" (3'6")</option>
                                    <option value="48">48" (4'0")</option>
                                </select>
                                
                                <label style="color: #94a3b8; font-size: 0.875rem;">Window Width:</label>
                                <select id="windowWidth" style="width: 100%; padding: 0.5rem; background: #334155; color: white; border: 1px solid #475569; border-radius: 0.25rem; margin-bottom: 0.5rem;">
                                    <option value="24">24" (2'0")</option>
                                    <option value="30">30" (2'6")</option>
                                    <option value="36" selected>36" (3'0")</option>
                                    <option value="48">48" (4'0")</option>
                                    <option value="60">60" (5'0")</option>
                                    <option value="72">72" (6'0")</option>
                                    <option value="84">84" (7'0")</option>
                                    <option value="96">96" (8'0")</option>
                                </select>
                                
                                <label style="color: #94a3b8; font-size: 0.875rem;">Wall Thickness:</label>
                                <select id="wallThickness" style="width: 100%; padding: 0.5rem; background: #334155; color: white; border: 1px solid #475569; border-radius: 0.25rem; margin-bottom: 0.5rem;">
                                    <option value="4">4" (Interior)</option>
                                    <option value="6" selected>6" (Standard)</option>
                                    <option value="8">8" (Exterior)</option>
                                    <option value="10">10" (Thick)</option>
                                    <option value="12">12" (Insulated)</option>
                                </select>
                            </div>
                        </div>

                        <!-- Snapping & Guides -->
                        <div class="tool-group">
                            <h5 style="color: #cbd5e1; margin-bottom: 0.5rem;">Snapping & Guides</h5>
                            <div class="property-controls">
                                <label style="color:#94a3b8; font-size:0.875rem;">Snap to Grid:</label>
                                <select id="snapToGridSelect" style="width:100%; padding:0.5rem; background:#334155; color:white; border:1px solid #475569; border-radius:0.25rem; margin-bottom:0.5rem;">
                                    <option value="on" selected>On</option>
                                    <option value="off">Off</option>
                                </select>

                                <label style="color:#94a3b8; font-size:0.875rem;">Axis Lock:</label>
                                <select id="axisLockSelect" style="width:100%; padding:0.5rem; background:#334155; color:white; border:1px solid #475569; border-radius:0.25rem; margin-bottom:0.5rem;">
                                    <option value="on" selected>On (H/V)</option>
                                    <option value="off">Off</option>
                                </select>

                                <label style="color:#94a3b8; font-size:0.875rem;">Angle Snap:</label>
                                <select id="angleSnapSelect" style="width:100%; padding:0.5rem; background:#334155; color:white; border:1px solid #475569; border-radius:0.25rem; margin-bottom:0.5rem;">
                                    <option value="0">Off</option>
                                    <option value="15">15</option>
                                    <option value="30">30</option>
                                    <option value="45" selected>45</option>
                                </select>

                                <label style="color:#94a3b8; font-size:0.875rem;">Snap Strength:</label>
                                <input id="snapStrengthRange" type="range" min="2" max="20" value="8" style="width:100%;">
                                <span class="snap-legend">Lower = looser, Higher = stronger snap</span>
                            </div>
                        </div>

                        <!-- Properties Panel -->
                        <div class="tool-group">
                            <h5 style="color: #cbd5e1; margin-bottom: 0.5rem;">Properties</h5>
                            <div class="property-controls">
                                <label style="color: #94a3b8; font-size: 0.875rem;">Line Width:</label>
                                <input type="range" id="lineWidth" min="1" max="10" value="2" style="width: 100%; margin-bottom: 0.5rem;">
                                
                                <label style="color: #94a3b8; font-size: 0.875rem;">Color:</label>
                                <input type="color" id="lineColor" value="#3b82f6" style="width: 100%; margin-bottom: 0.5rem;">
                                
                                <label style="color: #94a3b8; font-size: 0.875rem;">Fill Color:</label>
                                <input type="color" id="fillColor" value="#1e40af" style="width: 100%; margin-bottom: 0.5rem;">
                                
                                <label style="color: #94a3b8; font-size: 0.875rem;">Grid Size:</label>
                                <select id="gridSize" style="width: 100%; padding: 0.5rem; background: #334155; color: white; border: 1px solid #475569; border-radius: 0.25rem;">
                                    <option value="4">4px</option>
                                    <option value="5">5px</option>
                                    <option value="8" selected>8px</option>
                                    <option value="10">10px</option>
                                    <option value="20">20px</option>
                                    <option value="50">50px</option>
                                    <option value="100">100px</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Canvas Area -->
                    <div id="canvasArea" style="flex: 1; position: relative; background: #f8fafc;">
                        <canvas id="floorPlanCanvas" style="width: 100%; height: 100%; cursor: crosshair;"></canvas>
                        
                        <!-- Canvas Controls -->
                        <div id="canvasControls" style="position: absolute; top: 1rem; right: 1rem; display: flex; gap: 0.5rem;">
                            <button class="btn btn-sm" onclick="zoomIn()">
                                <i class="fas fa-search-plus"></i>
                            </button>
                            <button class="btn btn-sm" onclick="zoomOut()">
                                <i class="fas fa-search-minus"></i>
                            </button>
                            <button class="btn btn-sm" onclick="resetZoom()">
                                <i class="fas fa-expand-arrows-alt"></i>
                            </button>
                            <button class="btn btn-sm" onclick="toggleGrid()">
                                <i class="fas fa-th"></i>
                            </button>
                            <button class="btn btn-sm" onclick="toggleSnap()">
                                <i class="fas fa-magnet"></i>
                            </button>
                        </div>

                        <!-- Status Bar -->
                        <div id="statusBar" style="position: absolute; bottom: 1rem; left: 1rem; background: rgba(0,0,0,0.7); color: white; padding: 0.5rem 1rem; border-radius: 0.25rem; font-size: 0.875rem;">
                            <span id="cursorPosition">X: 0, Y: 0</span> | 
                            <span id="currentTool">Tool: Select</span> | 
                            <span id="zoomLevel">Zoom: 100%</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Floor Plan Viewer Modal -->
    <div id="floorPlanViewerModal" class="modal">
        <div class="modal-content" style="max-width: 90vw; max-height: 90vh;">
            <div class="modal-header">
                <h3><i class="fas fa-eye"></i> Floor Plan Gallery</h3>
                <span class="close-btn" onclick="closeFloorPlanViewer()">&times;</span>
            </div>
            <div class="modal-body">
                <div id="floorPlanGallery" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1rem; max-height: 70vh; overflow-y: auto;">
                    <!-- Floor plans will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // Define all functions FIRST before anything else
        function showSection(sectionName) {
            console.log('showSection called with:', sectionName);
            
            // Hide all content sections
            const sections = document.querySelectorAll('.content-section');
            console.log('Found sections:', sections.length);
            sections.forEach(section => {
                section.classList.remove('active');
                console.log('Removed active from:', section.id);
            });
            
            // Remove active from all nav items
            const navItems = document.querySelectorAll('.nav-item');
            navItems.forEach(item => item.classList.remove('active'));
            
            // Show the selected section
            const targetSection = document.getElementById(sectionName + 'Section');
            console.log('Looking for section:', sectionName + 'Section');
            console.log('Target section found:', targetSection);
            
            if (targetSection) {
                targetSection.classList.add('active');
                console.log('Added active to:', targetSection.id);
                
                // If tasks section is shown, ensure calendar is ready
                if (sectionName === 'tasks') {
                    setTimeout(() => {
                        if (document.getElementById('calendarView') && document.getElementById('calendarView').style.display !== 'none') {
                            renderCalendar();
                        }
                    }, 100);
                }
            } else {
                console.error('Section not found:', sectionName + 'Section');
            }
            
            // Add active to clicked nav item
            if (event && event.target) {
                event.target.classList.add('active');
            }
            
            console.log(`Switched to ${sectionName} section`);
        }

        function openTasksCalendar() {
            console.log(' Opening Tasks & Calendar');
            showSection('tasks');
            // Ensure calendar is ready when section is shown
            setTimeout(() => {
                if (document.getElementById('tasksView') && document.getElementById('calendarView')) {
                    // Make sure tasks view is shown by default
                    switchTasksView('tasks');
                }
            }, 100);
        }

        function openProducts() {
            console.log(' Opening Products - redirecting to store');
            window.location.href = 'nestmate-store.html';
        }

        function openEmergency() {
            console.log(' Opening Emergency Contacts');
            showSection('emergency');
        }

        function addService() {
            console.log(' Adding Service');
            showSection('service');
            showAlert('Service management feature coming soon!', 'info');
        }

        function viewRecords() {
            console.log(' Viewing Records');
            showAlert('Service records feature coming soon!', 'info');
        }

        function openHomeDetails() {
            console.log(' Opening Home Details');
            showSection('basic');
        }

        // AWS Configuration
        AWS.config.update({
            region: 'us-east-2',
            accessKeyId: 'AKIAXBLPTGPR44FNAHUL',
            secretAccessKey: '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'
        });

        // DynamoDB client - get from auth-aws.js or initialize if needed
        // Use window.dynamodb if available, otherwise create a local reference
        let dynamodbInitAttempts = 0;
        const maxDynamoDBInitAttempts = 50; // 5 seconds max
        
        function getDynamoDB() {
            // First try to get from window (set by auth-aws.js)
            if (window.dynamodb) {
                return window.dynamodb;
            }
            // Otherwise try to initialize
            if (typeof AWS !== 'undefined' && AWS.DynamoDB && AWS.DynamoDB.DocumentClient) {
                try {
                    const db = new AWS.DynamoDB.DocumentClient();
                    window.dynamodb = db; // Store for future use
                    console.log('DynamoDB initialized in dashboard');
                    return db;
                } catch (error) {
                    console.warn('Error initializing DynamoDB:', error);
                }
            }
            return null;
        }
        
        // Try to get DynamoDB asynchronously without blocking
        function ensureDynamoDB() {
            if (getDynamoDB()) {
                console.log('DynamoDB is ready');
            } else if (dynamodbInitAttempts < maxDynamoDBInitAttempts) {
                dynamodbInitAttempts++;
                setTimeout(ensureDynamoDB, 100);
            } else {
                console.warn('DynamoDB initialization timeout - some features may not work');
            }
        }
        
        // Initialize asynchronously without blocking
        setTimeout(ensureDynamoDB, 100);

        // S3 Upload Functions
        async function getS3PresignedUrl(key, contentType) {
            try {
                console.log('Getting presigned URL for:', key, contentType);
                const response = await fetch('/.netlify/functions/s3-presign', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        bucket: 'nestmate-files-483954734051', // TODO: Make this configurable
                        key, 
                        contentType 
                    })
                });
                console.log('Presigned URL response status:', response.status);
                const data = await response.json();
                console.log('Presigned URL data:', data);
                return data;
            } catch (error) {
                console.error('Error getting presigned URL:', error);
                throw error;
            }
        }

        async function uploadToS3(file, key) {
            try {
                const { uploadUrl, publicUrl } = await getS3PresignedUrl(key, file.type);
                
                const response = await fetch(uploadUrl, {
                    method: 'PUT',
                    body: file,
                    headers: { 'Content-Type': file.type }
                });

                if (response.ok) {
                    return publicUrl;
                } else {
                    throw new Error('Upload failed');
                }
            } catch (error) {
                console.error('S3 upload error:', error);
                throw error;
            }
        }

        // Duplicate functions removed - already defined at top of script

        function exportData() {
            console.log('Exporting Data');
            // You can implement actual data export
        }

        function openChatbot() {
            console.log('Opening Chatbot');
            // You can show a chatbot modal or redirect
        }

        function signOut() {
            if (confirm('Are you sure you want to sign out?')) {
                window.location.href = 'login-aws.html';
            }
        }

        // Make functions globally accessible IMMEDIATELY
        // Structure CRUD Functions
        function editStructure() {
            document.getElementById('structureDisplay').style.display = 'none';
            const form = document.getElementById('structureForm');
            form.style.display = 'grid';
            form.classList.add('active');
        }

        function cancelEditStructure() {
            document.getElementById('structureDisplay').style.display = 'block';
            const form = document.getElementById('structureForm');
            form.style.display = 'none';
            form.classList.remove('active');
        }

        async function saveStructure() {
            const structureData = {
                foundation: document.getElementById('foundation').value,
                roofType: document.getElementById('roofType').value,
                exterior: document.getElementById('exterior').value,
                windows: document.getElementById('windows').value,
                insulation: document.getElementById('insulation').value,
                lastInspection: document.getElementById('lastInspection').value
            };

            try {
                // Save to DynamoDB
                const dynamodb = getDynamoDB();
                if (!dynamodb) {
                    throw new Error('DynamoDB not initialized');
                }
                
                const userId = nestMateAuth.currentUser.userId;
                console.log('Saving structure data for userId:', userId);
                console.log('Structure data:', structureData);
                
                const params = {
                    TableName: 'nestmate-users',
                    Key: { userId: userId },
                    UpdateExpression: 'SET structureInfo = :structure, lastUpdated = :timestamp',
                    ExpressionAttributeValues: {
                        ':structure': structureData,
                        ':timestamp': new Date().toISOString()
                    },
                    ReturnValues: 'UPDATED_NEW'
                };
                
                const result = await dynamodb.update(params).promise();
                console.log('Structure data saved to DynamoDB:', result);

                // Update display
                document.getElementById('displayFoundation').textContent = structureData.foundation || 'Not set';
                document.getElementById('displayRoofType').textContent = structureData.roofType || 'Not set';
                document.getElementById('displayExterior').textContent = structureData.exterior || 'Not set';
                document.getElementById('displayWindows').textContent = structureData.windows || 'Not set';
                document.getElementById('displayInsulation').textContent = structureData.insulation || 'Not set';
                document.getElementById('displayLastInspection').textContent = structureData.lastInspection || 'Not set';
                
                // Hide form
                document.getElementById('structureDisplay').style.display = 'block';
                const form = document.getElementById('structureForm');
                form.style.display = 'none';
                form.classList.remove('active');
                
                showAlert('Structure information saved successfully!', 'success');
            } catch (error) {
                console.error('Error saving structure data:', error);
                showAlert('Error saving structure information. Please try again.', 'error');
            }
        }

        // Systems CRUD Functions
        function editSystems() {
            document.getElementById('systemsDisplay').style.display = 'none';
            const form = document.getElementById('systemsForm');
            form.style.display = 'grid';
            form.classList.add('active');
        }

        function cancelEditSystems() {
            document.getElementById('systemsDisplay').style.display = 'block';
            const form = document.getElementById('systemsForm');
            form.style.display = 'none';
            form.classList.remove('active');
        }

        async function saveSystems() {
            const systemsData = {
                hvac: document.getElementById('hvac').value,
                electrical: document.getElementById('electrical').value,
                plumbing: document.getElementById('plumbing').value,
                waterHeater: document.getElementById('waterHeater').value,
                security: document.getElementById('security').value,
                lastService: document.getElementById('lastService').value
            };

            try {
                // Save to DynamoDB
                const userId = nestMateAuth.currentUser.userId;
                console.log('Saving systems data for userId:', userId);
                console.log('Systems data:', systemsData);
                
                const params = {
                    TableName: 'nestmate-users',
                    Key: { userId: userId },
                    UpdateExpression: 'SET systemsInfo = :systems, lastUpdated = :timestamp',
                    ExpressionAttributeValues: {
                        ':systems': systemsData,
                        ':timestamp': new Date().toISOString()
                    },
                    ReturnValues: 'UPDATED_NEW'
                };
                
                const result = await dynamodb.update(params).promise();
                console.log('Systems data saved to DynamoDB:', result);

                // Update display
                document.getElementById('displayHVAC').textContent = systemsData.hvac || 'Not set';
                document.getElementById('displayElectrical').textContent = systemsData.electrical || 'Not set';
                document.getElementById('displayPlumbing').textContent = systemsData.plumbing || 'Not set';
                document.getElementById('displayWaterHeater').textContent = systemsData.waterHeater || 'Not set';
                document.getElementById('displaySecurity').textContent = systemsData.security || 'Not set';
                document.getElementById('displayLastService').textContent = systemsData.lastService || 'Not set';
                
                // Hide form
                document.getElementById('systemsDisplay').style.display = 'block';
                const form = document.getElementById('systemsForm');
            form.style.display = 'none';
            form.classList.remove('active');
                
                showAlert('Systems information saved successfully!', 'success');
            } catch (error) {
                console.error('Error saving systems data:', error);
                showAlert('Error saving systems information. Please try again.', 'error');
            }
        }

        // Sign out function
        async function signOut() {
            try {
                await nestMateAuth.signOut();
                window.location.href = 'login-aws.html';
            } catch (error) {
                console.error('Sign out error:', error);
                window.location.href = 'login-aws.html';
            }
        }

        window.showSection = showSection;
        window.signOut = signOut;
        window.openTasksCalendar = openTasksCalendar;
        window.openProducts = openProducts;
        window.openEmergency = openEmergency;
        window.addService = addService;
        window.viewRecords = viewRecords;
        window.switchTasksView = switchTasksView;
        window.openAddTaskModal = openAddTaskModal;
        window.openEditTaskModal = openEditTaskModal;
        window.closeTaskModal = closeTaskModal;
        window.saveTask = saveTask;
        window.deleteTask = deleteTask;
        window.toggleTaskComplete = toggleTaskComplete;
        window.filterTasks = filterTasks;
        window.changeMonth = changeMonth;
        window.openDayTasks = openDayTasks;
        
        // Make all CRUD functions globally accessible
        window.editBasicInfo = editBasicInfo;
        window.cancelEditBasicInfo = cancelEditBasicInfo;
        window.saveBasicInfo = saveBasicInfo;
        window.editStructure = editStructure;
        window.cancelEditStructure = cancelEditStructure;
        window.saveStructure = saveStructure;
        window.editSystems = editSystems;
        window.cancelEditSystems = cancelEditSystems;
        window.saveSystems = saveSystems;
        window.editBedrooms = editBedrooms;
        window.cancelEditBedrooms = cancelEditBedrooms;
        window.saveBedrooms = saveBedrooms;
        window.editBathrooms = editBathrooms;
        window.cancelEditBathrooms = cancelEditBathrooms;
        window.saveBathrooms = saveBathrooms;
        window.editKitchen = editKitchen;
        window.cancelEditKitchen = cancelEditKitchen;
        window.saveKitchen = saveKitchen;
        window.editLivingAreas = editLivingAreas;
        window.cancelEditLivingAreas = cancelEditLivingAreas;
        window.saveLivingAreas = saveLivingAreas;
        window.editGarage = editGarage;
        window.cancelEditGarage = cancelEditGarage;
        window.saveGarage = saveGarage;
        window.editExterior = editExterior;
        window.cancelEditExterior = cancelEditExterior;
        window.saveExterior = saveExterior;
        window.editAppliances = editAppliances;
        window.cancelEditAppliances = cancelEditAppliances;
        window.saveAppliances = saveAppliances;
        window.editFavorites = editFavorites;
        window.cancelEditFavorites = cancelEditFavorites;
        window.saveFavorites = saveFavorites;
        window.editPhotos = editPhotos;
        window.cancelEditPhotos = cancelEditPhotos;
        window.savePhotos = savePhotos;
        window.uploadPhotos = uploadPhotos;
        window.addPhotoFromUrl = addPhotoFromUrl;
        window.clearPhotos = clearPhotos;
        window.editFloorplan = editFloorplan;
        window.cancelEditFloorplan = cancelEditFloorplan;
        window.saveFloorplan = saveFloorplan;
        window.uploadFloorplan = uploadFloorplan;
        window.addFloorplanFromUrl = addFloorplanFromUrl;
        window.editEmergency = editEmergency;
        window.cancelEditEmergency = cancelEditEmergency;
        window.saveEmergency = saveEmergency;
        window.openHomeDetails = openHomeDetails;
        window.exportData = exportData;
        window.openChatbot = openChatbot;
        window.signOut = signOut;
        window.editBasicInfo = editBasicInfo;
        window.cancelEditBasicInfo = cancelEditBasicInfo;
        window.saveBasicInfo = saveBasicInfo;
        window.editStructure = editStructure;
        window.cancelEditStructure = cancelEditStructure;
        window.saveStructure = saveStructure;
        window.editSystems = editSystems;
        window.cancelEditSystems = cancelEditSystems;
        window.saveSystems = saveSystems;

        // Bedrooms CRUD Functions
        function editBedrooms() {
            document.getElementById('bedroomsDisplay').style.display = 'none';
            const form = document.getElementById('bedroomsForm');
            form.style.display = 'grid';
            form.classList.add('active');
        }

        function cancelEditBedrooms() {
            document.getElementById('bedroomsDisplay').style.display = 'block';
            const form = document.getElementById('bedroomsForm');
            form.style.display = 'none';
            form.classList.remove('active');
        }

        async function saveBedrooms() {
            const bedroomData = {
                masterBedroom: document.getElementById('masterBedroom').value,
                bedroom2: document.getElementById('bedroom2').value,
                bedroom3: document.getElementById('bedroom3').value,
                bedroom4: document.getElementById('bedroom4').value,
                closetSpace: document.getElementById('closetSpace').value,
                bedroomFlooring: document.getElementById('bedroomFlooring').value
            };

            try {
                // Save to DynamoDB
                const userId = nestMateAuth.currentUser.userId;
                console.log('Saving bedrooms data for userId:', userId);
                console.log('Bedrooms data:', bedroomData);
                
                const params = {
                    TableName: 'nestmate-users',
                    Key: { userId: userId },
                    UpdateExpression: 'SET bedroomsInfo = :bedrooms, lastUpdated = :timestamp',
                    ExpressionAttributeValues: {
                        ':bedrooms': bedroomData,
                        ':timestamp': new Date().toISOString()
                    },
                    ReturnValues: 'UPDATED_NEW'
                };
                
                const result = await dynamodb.update(params).promise();
                console.log('Bedrooms data saved to DynamoDB:', result);

                // Update display
                document.getElementById('displayMasterBedroom').textContent = bedroomData.masterBedroom || 'Not set';
                document.getElementById('displayBedroom2').textContent = bedroomData.bedroom2 || 'Not set';
                document.getElementById('displayBedroom3').textContent = bedroomData.bedroom3 || 'Not set';
                document.getElementById('displayBedroom4').textContent = bedroomData.bedroom4 || 'Not set';
                document.getElementById('displayClosetSpace').textContent = bedroomData.closetSpace || 'Not set';
                document.getElementById('displayBedroomFlooring').textContent = bedroomData.bedroomFlooring || 'Not set';
                
                // Hide form
                document.getElementById('bedroomsDisplay').style.display = 'block';
                const form = document.getElementById('bedroomsForm');
            form.style.display = 'none';
            form.classList.remove('active');
                
                showAlert('Bedroom information saved successfully!', 'success');
            } catch (error) {
                console.error('Error saving bedrooms data:', error);
                showAlert('Error saving bedroom information. Please try again.', 'error');
            }
        }

        // Bathrooms CRUD Functions
        function editBathrooms() {
            document.getElementById('bathroomsDisplay').style.display = 'none';
            const form = document.getElementById('bathroomsForm');
            form.style.display = 'grid';
            form.classList.add('active');
        }

        function cancelEditBathrooms() {
            document.getElementById('bathroomsDisplay').style.display = 'block';
            const form = document.getElementById('bathroomsForm');
            form.style.display = 'none';
            form.classList.remove('active');
        }

        async function saveBathrooms() {
            const bathroomData = {
                masterBath: document.getElementById('masterBath').value,
                guestBath: document.getElementById('guestBath').value,
                powderRoom: document.getElementById('powderRoom').value,
                bathroomFixtures: document.getElementById('bathroomFixtures').value,
                bathroomFlooring: document.getElementById('bathroomFlooring').value,
                bathroomRenovation: document.getElementById('bathroomRenovation').value
            };

            try {
                // Save to DynamoDB
                const userId = nestMateAuth.currentUser.userId;
                console.log('Saving bathrooms data for userId:', userId);
                console.log('Bathrooms data:', bathroomData);
                
                const params = {
                    TableName: 'nestmate-users',
                    Key: { userId: userId },
                    UpdateExpression: 'SET bathroomsInfo = :bathrooms, lastUpdated = :timestamp',
                    ExpressionAttributeValues: {
                        ':bathrooms': bathroomData,
                        ':timestamp': new Date().toISOString()
                    },
                    ReturnValues: 'UPDATED_NEW'
                };
                
                const result = await dynamodb.update(params).promise();
                console.log('Bathrooms data saved to DynamoDB:', result);

                // Update display (old static bathroom display - now using dynamic bathroomsList)
                // document.getElementById('displayMasterBath').textContent = bathroomData.masterBath || 'Not set';
                // document.getElementById('displayGuestBath').textContent = bathroomData.guestBath || 'Not set';
                // document.getElementById('displayPowderRoom').textContent = bathroomData.powderRoom || 'Not set';
                // document.getElementById('displayBathroomFixtures').textContent = bathroomData.bathroomFixtures || 'Not set';
                // document.getElementById('displayBathroomFlooring').textContent = bathroomData.bathroomFlooring || 'Not set';
                // document.getElementById('displayBathroomRenovation').textContent = bathroomData.bathroomRenovation || 'Not set';
                
                // Hide form
                document.getElementById('bathroomsDisplay').style.display = 'block';
                const form = document.getElementById('bathroomsForm');
            form.style.display = 'none';
            form.classList.remove('active');
                
                showAlert('Bathroom information saved successfully!', 'success');
            } catch (error) {
                console.error('Error saving bathrooms data:', error);
                showAlert('Error saving bathroom information. Please try again.', 'error');
            }
        }

        // Kitchen CRUD Functions
        function editKitchen() {
            document.getElementById('kitchenDisplay').style.display = 'none';
            const form = document.getElementById('kitchenForm');
            form.style.display = 'grid';
            form.classList.add('active');
        }

        function cancelEditKitchen() {
            document.getElementById('kitchenDisplay').style.display = 'block';
            const form = document.getElementById('kitchenForm');
            form.style.display = 'none';
            form.classList.remove('active');
        }

        async function saveKitchen() {
            const kitchenData = {
                kitchenSize: document.getElementById('kitchenSize').value,
                kitchenAppliances: document.getElementById('kitchenAppliances').value,
                kitchenCountertops: document.getElementById('kitchenCountertops').value,
                kitchenCabinets: document.getElementById('kitchenCabinets').value,
                kitchenFlooring: document.getElementById('kitchenFlooring').value,
                kitchenRenovation: document.getElementById('kitchenRenovation').value
            };

            try {
                // Save to DynamoDB
                const userId = nestMateAuth.currentUser.userId;
                console.log('Saving kitchen data for userId:', userId);
                console.log('Kitchen data:', kitchenData);
                
                const params = {
                    TableName: 'nestmate-users',
                    Key: { userId: userId },
                    UpdateExpression: 'SET kitchenInfo = :kitchen, lastUpdated = :timestamp',
                    ExpressionAttributeValues: {
                        ':kitchen': kitchenData,
                        ':timestamp': new Date().toISOString()
                    },
                    ReturnValues: 'UPDATED_NEW'
                };
                
                const result = await dynamodb.update(params).promise();
                console.log('Kitchen data saved to DynamoDB:', result);

                // Update display (old static kitchen display - now using dynamic kitchensList)
                // document.getElementById('displayKitchenSize').textContent = kitchenData.kitchenSize || 'Not set';
                // document.getElementById('displayKitchenAppliances').textContent = kitchenData.kitchenAppliances || 'Not set';
                // document.getElementById('displayKitchenCountertops').textContent = kitchenData.kitchenCountertops || 'Not set';
                // document.getElementById('displayKitchenCabinets').textContent = kitchenData.kitchenCabinets || 'Not set';
                // document.getElementById('displayKitchenFlooring').textContent = kitchenData.kitchenFlooring || 'Not set';
                // document.getElementById('displayKitchenRenovation').textContent = kitchenData.kitchenRenovation || 'Not set';
                
                // Hide form
                document.getElementById('kitchenDisplay').style.display = 'block';
                const form = document.getElementById('kitchenForm');
            form.style.display = 'none';
            form.classList.remove('active');
                
                showAlert('Kitchen information saved successfully!', 'success');
            } catch (error) {
                console.error('Error saving kitchen data:', error);
                showAlert('Error saving kitchen information. Please try again.', 'error');
            }
        }

        window.editBedrooms = editBedrooms;
        window.cancelEditBedrooms = cancelEditBedrooms;
        window.saveBedrooms = saveBedrooms;
        window.editBathrooms = editBathrooms;
        window.cancelEditBathrooms = cancelEditBathrooms;
        window.saveBathrooms = saveBathrooms;
        window.editKitchen = editKitchen;
        window.cancelEditKitchen = cancelEditKitchen;
        window.saveKitchen = saveKitchen;

        // Living Areas CRUD Functions
        function editLivingAreas() {
            document.getElementById('livingDisplay').style.display = 'none';
            const form = document.getElementById('livingForm');
            form.style.display = 'grid';
            form.classList.add('active');
        }

        function cancelEditLivingAreas() {
            document.getElementById('livingDisplay').style.display = 'block';
            const form = document.getElementById('livingForm');
            form.style.display = 'none';
            form.classList.remove('active');
        }

        async function saveLivingAreas() {
            const livingData = {
                livingRoom: document.getElementById('livingRoom').value,
                diningRoom: document.getElementById('diningRoom').value,
                familyRoom: document.getElementById('familyRoom').value,
                livingFlooring: document.getElementById('livingFlooring').value,
                ceilingHeight: document.getElementById('ceilingHeight').value,
                fireplace: document.getElementById('fireplace').value
            };

            try {
                // Save to DynamoDB
                const userId = nestMateAuth.currentUser.userId;
                console.log('Saving living areas data for userId:', userId);
                console.log('Living areas data:', livingData);
                
                const params = {
                    TableName: 'nestmate-users',
                    Key: { userId: userId },
                    UpdateExpression: 'SET livingInfo = :living, lastUpdated = :timestamp',
                    ExpressionAttributeValues: {
                        ':living': livingData,
                        ':timestamp': new Date().toISOString()
                    },
                    ReturnValues: 'UPDATED_NEW'
                };
                
                const result = await dynamodb.update(params).promise();
                console.log('Living areas data saved to DynamoDB:', result);

                // Update display
                document.getElementById('displayLivingRoom').textContent = livingData.livingRoom || 'Not set';
                document.getElementById('displayDiningRoom').textContent = livingData.diningRoom || 'Not set';
                document.getElementById('displayFamilyRoom').textContent = livingData.familyRoom || 'Not set';
                document.getElementById('displayLivingFlooring').textContent = livingData.livingFlooring || 'Not set';
                document.getElementById('displayCeilingHeight').textContent = livingData.ceilingHeight || 'Not set';
                document.getElementById('displayFireplace').textContent = livingData.fireplace || 'Not set';
                
                // Hide form
                document.getElementById('livingDisplay').style.display = 'block';
                const form = document.getElementById('livingForm');
            form.style.display = 'none';
            form.classList.remove('active');
                
                showAlert('Living areas information saved successfully!', 'success');
            } catch (error) {
                console.error('Error saving living areas data:', error);
                showAlert('Error saving living areas information. Please try again.', 'error');
            }
        }

        // Garage CRUD Functions
        function editGarage() {
            document.getElementById('garageDisplay').style.display = 'none';
            const form = document.getElementById('garageForm');
            form.style.display = 'grid';
            form.classList.add('active');
        }

        function cancelEditGarage() {
            document.getElementById('garageDisplay').style.display = 'block';
            const form = document.getElementById('garageForm');
            form.style.display = 'none';
            form.classList.remove('active');
        }

        async function saveGarage() {
            const garageData = {
                garageType: document.getElementById('garageType').value,
                garageSize: document.getElementById('garageSize').value,
                garageDoor: document.getElementById('garageDoor').value,
                garageFlooring: document.getElementById('garageFlooring').value,
                garageStorage: document.getElementById('garageStorage').value,
                garageElectrical: document.getElementById('garageElectrical').value
            };

            try {
                // Save to DynamoDB
                const userId = nestMateAuth.currentUser.userId;
                console.log('Saving garage data for userId:', userId);
                console.log('Garage data:', garageData);
                
                const params = {
                    TableName: 'nestmate-users',
                    Key: { userId: userId },
                    UpdateExpression: 'SET garageInfo = :garage, lastUpdated = :timestamp',
                    ExpressionAttributeValues: {
                        ':garage': garageData,
                        ':timestamp': new Date().toISOString()
                    },
                    ReturnValues: 'UPDATED_NEW'
                };
                
                const result = await dynamodb.update(params).promise();
                console.log('Garage data saved to DynamoDB:', result);

                // Update display
                document.getElementById('displayGarageType').textContent = garageData.garageType || 'Not set';
                document.getElementById('displayGarageSize').textContent = garageData.garageSize || 'Not set';
                document.getElementById('displayGarageDoor').textContent = garageData.garageDoor || 'Not set';
                document.getElementById('displayGarageFlooring').textContent = garageData.garageFlooring || 'Not set';
                document.getElementById('displayGarageStorage').textContent = garageData.garageStorage || 'Not set';
                document.getElementById('displayGarageElectrical').textContent = garageData.garageElectrical || 'Not set';
                
                // Hide form
                document.getElementById('garageDisplay').style.display = 'block';
                const form = document.getElementById('garageForm');
            form.style.display = 'none';
            form.classList.remove('active');
                
                showAlert('Garage information saved successfully!', 'success');
            } catch (error) {
                console.error('Error saving garage data:', error);
                showAlert('Error saving garage information. Please try again.', 'error');
            }
        }

        window.editLivingAreas = editLivingAreas;
        window.cancelEditLivingAreas = cancelEditLivingAreas;
        window.saveLivingAreas = saveLivingAreas;
        window.editGarage = editGarage;
        window.cancelEditGarage = cancelEditGarage;
        window.saveGarage = saveGarage;

        // Exterior CRUD Functions
        function editExterior() {
            document.getElementById('exteriorDisplay').style.display = 'none';
            const form = document.getElementById('exteriorForm');
            form.style.display = 'grid';
            form.classList.add('active');
        }

        function cancelEditExterior() {
            document.getElementById('exteriorDisplay').style.display = 'block';
            const form = document.getElementById('exteriorForm');
            form.style.display = 'none';
            form.classList.remove('active');
        }

        async function saveExterior() {
            const exteriorData = {
                lotSize: document.getElementById('lotSize').value,
                landscaping: document.getElementById('landscaping').value,
                driveway: document.getElementById('driveway').value,
                patio: document.getElementById('patio').value,
                fencing: document.getElementById('fencing').value,
                pool: document.getElementById('pool').value
            };

            try {
                // Save to DynamoDB
                const userId = nestMateAuth.currentUser.userId;
                console.log('Saving exterior data for userId:', userId);
                console.log('Exterior data:', exteriorData);
                
                const params = {
                    TableName: 'nestmate-users',
                    Key: { userId: userId },
                    UpdateExpression: 'SET exteriorInfo = :exterior, lastUpdated = :timestamp',
                    ExpressionAttributeValues: {
                        ':exterior': exteriorData,
                        ':timestamp': new Date().toISOString()
                    },
                    ReturnValues: 'UPDATED_NEW'
                };
                
                const result = await dynamodb.update(params).promise();
                console.log('Exterior data saved to DynamoDB:', result);

                // Update display
                document.getElementById('displayLotSize').textContent = exteriorData.lotSize || 'Not set';
                document.getElementById('displayLandscaping').textContent = exteriorData.landscaping || 'Not set';
                document.getElementById('displayDriveway').textContent = exteriorData.driveway || 'Not set';
                document.getElementById('displayPatio').textContent = exteriorData.patio || 'Not set';
                document.getElementById('displayFencing').textContent = exteriorData.fencing || 'Not set';
                document.getElementById('displayPool').textContent = exteriorData.pool || 'Not set';
                
                // Hide form
                document.getElementById('exteriorDisplay').style.display = 'block';
                const form = document.getElementById('exteriorForm');
            form.style.display = 'none';
            form.classList.remove('active');
                
                showAlert('Exterior information saved successfully!', 'success');
            } catch (error) {
                console.error('Error saving exterior data:', error);
                showAlert('Error saving exterior information. Please try again.', 'error');
            }
        }

        // Appliances CRUD Functions
        function editAppliances() {
            document.getElementById('appliancesDisplay').style.display = 'none';
            const form = document.getElementById('appliancesForm');
            form.style.display = 'grid';
            form.classList.add('active');
        }

        function cancelEditAppliances() {
            document.getElementById('appliancesDisplay').style.display = 'block';
            const form = document.getElementById('appliancesForm');
            form.style.display = 'none';
            form.classList.remove('active');
        }

        async function saveAppliances() {
            const appliancesData = {
                refrigerator: document.getElementById('refrigerator').value,
                dishwasher: document.getElementById('dishwasher').value,
                washerDryer: document.getElementById('washerDryer').value,
                stove: document.getElementById('stove').value,
                microwave: document.getElementById('microwave').value,
                applianceService: document.getElementById('applianceService').value
            };

            try {
                // Save to DynamoDB
                const userId = nestMateAuth.currentUser.userId;
                console.log('Saving appliances data for userId:', userId);
                console.log('Appliances data:', appliancesData);
                
                const params = {
                    TableName: 'nestmate-users',
                    Key: { userId: userId },
                    UpdateExpression: 'SET appliancesInfo = :appliances, lastUpdated = :timestamp',
                    ExpressionAttributeValues: {
                        ':appliances': appliancesData,
                        ':timestamp': new Date().toISOString()
                    },
                    ReturnValues: 'UPDATED_NEW'
                };
                
                const result = await dynamodb.update(params).promise();
                console.log('Appliances data saved to DynamoDB:', result);

                // Update display
                document.getElementById('displayRefrigerator').textContent = appliancesData.refrigerator || 'Not set';
                document.getElementById('displayDishwasher').textContent = appliancesData.dishwasher || 'Not set';
                document.getElementById('displayWasherDryer').textContent = appliancesData.washerDryer || 'Not set';
                document.getElementById('displayStove').textContent = appliancesData.stove || 'Not set';
                document.getElementById('displayMicrowave').textContent = appliancesData.microwave || 'Not set';
                document.getElementById('displayApplianceService').textContent = appliancesData.applianceService || 'Not set';
                
                // Hide form
                document.getElementById('appliancesDisplay').style.display = 'block';
                const form = document.getElementById('appliancesForm');
            form.style.display = 'none';
            form.classList.remove('active');
                
                showAlert('Appliances information saved successfully!', 'success');
            } catch (error) {
                console.error('Error saving appliances data:', error);
                showAlert('Error saving appliances information. Please try again.', 'error');
            }
        }

        window.editExterior = editExterior;
        window.cancelEditExterior = cancelEditExterior;
        window.saveExterior = saveExterior;
        window.editAppliances = editAppliances;
        window.cancelEditAppliances = cancelEditAppliances;
        window.saveAppliances = saveAppliances;

        // Favorites CRUD Functions
        function editFavorites() {
            document.getElementById('favoritesDisplay').style.display = 'none';
            const form = document.getElementById('favoritesForm');
            form.style.display = 'grid';
            form.classList.add('active');
        }

        function cancelEditFavorites() {
            document.getElementById('favoritesDisplay').style.display = 'block';
            const form = document.getElementById('favoritesForm');
            form.style.display = 'none';
            form.classList.remove('active');
        }

        function addFavorite() {
            const input = document.getElementById('favoriteItem');
            const value = (input.value || '').trim();
            if (!value) return;
            const list = document.getElementById('favoritesList');
            const li = document.createElement('li');
            li.textContent = value;
            list.appendChild(li);
            input.value = '';
            document.getElementById('favoritesEmpty').style.display = 'none';
        }

        function clearFavorites() {
            const list = document.getElementById('favoritesList');
            list.innerHTML = '';
            document.getElementById('favoritesEmpty').style.display = '';
        }

        function saveFavorites() {
            // Nothing persisted yet; just close form
            document.getElementById('favoritesDisplay').style.display = 'block';
            const form = document.getElementById('favoritesForm');
            form.style.display = 'none';
            form.classList.remove('active');
            showAlert('Favorites saved!', 'success');
        }

        // Photos CRUD Functions
        function editPhotos() {
            document.getElementById('photosDisplay').style.display = 'none';
            const form = document.getElementById('photosForm');
            form.style.display = 'grid';
            form.classList.add('active');
        }

        function cancelEditPhotos() {
            document.getElementById('photosDisplay').style.display = 'block';
            const form = document.getElementById('photosForm');
            form.style.display = 'none';
            form.classList.remove('active');
        }

        // Photos CRUD Functions with S3 Upload
        let photosData = [];
        let favoritesData = [];
        let floorPlanData = null;

        async function addPhotoFromUrl() {
            const input = document.getElementById('photoUrl');
            const url = (input.value || '').trim();
            if (!url) return;
            
            photosData.push({ url, type: 'url' });
            await displayPhotos();
            input.value = '';
            document.getElementById('photosEmpty').style.display = 'none';
        }

        async function uploadPhotos() {
            console.log('uploadPhotos function called!');
            
            const fileInput = document.getElementById('photoFile');
            const files = fileInput.files;
            
            console.log('uploadPhotos called with files:', files.length);
            
            if (files.length === 0) {
                showAlert('Please select files to upload', 'error');
                return;
            }

            showAlert('Uploading photos...', 'info');
            
            try {
                const userId = nestMateAuth.currentUser.userId;
                console.log('User ID for upload:', userId);
                
                const uploadPromises = Array.from(files).map(async (file, index) => {
                    const key = `users/${userId}/photos/${Date.now()}-${index}-${file.name}`;
                    console.log('Uploading file:', file.name, 'with key:', key);
                    const url = await uploadToS3(file, key);
                    console.log('Upload successful, URL:', url);
                    return { url, key, type: 's3', filename: file.name };
                });

                const uploadedPhotos = await Promise.all(uploadPromises);
                console.log('All uploads completed:', uploadedPhotos);
                console.log('Before push - photosData:', photosData);
                photosData.push(...uploadedPhotos);
                console.log('After push - photosData:', photosData);
                console.log('Number of photos added:', uploadedPhotos.length);
                await displayPhotos();
                fileInput.value = '';
                document.getElementById('photosEmpty').style.display = 'none';
                showAlert(`${uploadedPhotos.length} photos uploaded successfully!`, 'success');
            } catch (error) {
                console.error('Upload error:', error);
                showAlert('Upload failed. Please try again.', 'error');
            }
        }

        async function displayPhotos() {
            console.log('displayPhotos called with photosData:', photosData);
            const grid = document.getElementById('photosGrid');
            if (!grid) {
                console.error('photosGrid element not found!');
                return;
            }
            grid.innerHTML = '';
            
            if (!photosData || photosData.length === 0) {
                console.log('No photos to display');
                return;
            }
            
            for (let index = 0; index < photosData.length; index++) {
                const photo = photosData[index];
                console.log('Displaying photo:', photo);
                const container = document.createElement('div');
                container.className = 'photo-container';
                container.style.position = 'relative';
                
                const img = document.createElement('img');
                
                // Generate presigned URL for viewing if it's an S3 photo
                if (photo.type === 's3' && (photo.key || photo.url)) {
                    try {
                        // Use the key directly if available, otherwise extract from URL
                        let key = photo.key;
                        if (!key && photo.url) {
                            // Extract the key from the URL - handle different URL formats
                            if (photo.url.includes('s3.amazonaws.com')) {
                                // Format: https://bucket.s3.amazonaws.com/path/to/file
                                const urlParts = photo.url.split('/');
                                key = urlParts.slice(3).join('/');
                            } else if (photo.url.includes('amazonaws.com')) {
                                // Format: https://s3.amazonaws.com/bucket/path/to/file
                                const urlParts = photo.url.split('/');
                                key = urlParts.slice(4).join('/');
                            } else if (photo.url.includes('nestmate-files')) {
                                // Format: https://nestmate-files-xxx.s3.region.amazonaws.com/path/to/file
                                const match = photo.url.match(/nestmate-files-[^/]+\/(.+)/);
                                if (match) {
                                    key = decodeURIComponent(match[1]);
                                }
                            } else {
                                // Assume it's already a key or extract differently
                                key = photo.url.replace('https://nestmate-files-483954734051.s3.amazonaws.com/', '');
                            }
                        }
                        console.log('Photo object:', photo);
                        console.log('Using key:', key);
                        
                        if (!key) {
                            console.error('No key found for photo:', photo);
                            img.src = photo.url;
                        } else {
                            const presignedResponse = await fetch('/.netlify/functions/s3-get-presigned-url', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    bucket: 'nestmate-files-483954734051',
                                    key: key
                                })
                            });
                        
                            console.log('Presigned response status:', presignedResponse.status);
                            
                            if (presignedResponse.ok) {
                                const responseData = await presignedResponse.json();
                                console.log('Presigned response data:', responseData);
                                img.src = responseData.presignedUrl;
                                console.log('Using presigned URL for image:', responseData.presignedUrl.substring(0, 100) + '...');
                            } else {
                                const errorText = await presignedResponse.text();
                                console.error('Failed to get presigned URL:', presignedResponse.status, errorText);
                                console.log('Falling back to original URL:', photo.url);
                                img.src = photo.url;
                            }
                        }
                    } catch (error) {
                        console.error('Error generating presigned URL:', error);
                        img.src = photo.url;
                    }
                } else {
                    img.src = photo.url;
                }
                
                // Add error handling for image loading with better fallback
                img.onerror = function() {
                    console.error('Failed to load image:', img.src);
                    // Try to show a placeholder or error message
                    if (img.parentNode) {
                        img.style.display = 'none';
                        const errorDiv = document.createElement('div');
                        errorDiv.style.width = '100%';
                        errorDiv.style.height = '120px';
                        errorDiv.style.display = 'flex';
                        errorDiv.style.alignItems = 'center';
                        errorDiv.style.justifyContent = 'center';
                        errorDiv.style.backgroundColor = '#1e293b';
                        errorDiv.style.borderRadius = '0.375rem';
                        errorDiv.style.color = '#94a3b8';
                        errorDiv.style.border = '1px solid #334155';
                        errorDiv.innerHTML = '<i class="fas fa-image" style="margin-right: 8px;"></i> Image not available';
                        img.parentNode.insertBefore(errorDiv, img);
                    }
                };
                
                img.alt = photo.filename || 'Home Photo';
                img.style.width = '100%';
                img.style.height = '120px';
                img.style.objectFit = 'cover';
                img.style.borderRadius = '0.375rem';
                img.style.cursor = 'pointer';
                
                // Add click handler to open photo in new page
                img.onclick = function() {
                    openPhotoInNewPage(photo);
                };
                
                const deleteBtn = document.createElement('button');
                deleteBtn.innerHTML = '<i class="fas fa-times"></i>';
                deleteBtn.style.position = 'absolute';
                deleteBtn.style.top = '0.25rem';
                deleteBtn.style.right = '0.25rem';
                deleteBtn.style.background = 'rgba(239, 68, 68, 0.8)';
                deleteBtn.style.border = 'none';
                deleteBtn.style.borderRadius = '50%';
                deleteBtn.style.width = '1.5rem';
                deleteBtn.style.height = '1.5rem';
                deleteBtn.style.color = 'white';
                deleteBtn.style.cursor = 'pointer';
                deleteBtn.onclick = () => removePhoto(index);
                
                container.appendChild(img);
                container.appendChild(deleteBtn);
                grid.appendChild(container);
            }
        }

        async function removePhoto(index) {
            photosData.splice(index, 1);
            await displayPhotos();
            if (photosData.length === 0) {
                document.getElementById('photosEmpty').style.display = '';
            }
        }

        async function clearPhotos() {
            photosData = [];
            await displayPhotos();
            document.getElementById('photosEmpty').style.display = '';
        }

        // Open photo in new page with controls
        async function openPhotoInNewPage(photo) {
            try {
                if (!photo || !photo.key) {
                    showAlert('Photo data is incomplete. Cannot open viewer.', 'error');
                    return;
                }

                const filename = photo.filename || 'Photo';
                const photoViewerUrl = `photo-viewer.html?key=${encodeURIComponent(photo.key)}&filename=${encodeURIComponent(filename)}`;
                
                window.open(photoViewerUrl, '_blank', 'width=1200,height=800,scrollbars=yes,resizable=yes');

            } catch (error) {
                console.error('Error opening photo in new page:', error);
                showAlert('Error opening photo. Please try again.', 'error');
            }
        }

        function downloadPhoto(photo) {
            try {
                const link = document.createElement('a');
                link.href = photo.url;
                link.download = photo.filename || 'photo.jpg';
                link.target = '_blank';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                showAlert('Photo download started!', 'success');
            } catch (error) {
                console.error('Download error:', error);
                showAlert('Download failed. Please try again.', 'error');
            }
        }

        async function generatePhotoPDF(photo) {
            try {
                showAlert('Generating PDF...', 'info');
                
                const response = await fetch('/.netlify/functions/generate-photo-pdf', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        photo: photo,
                        userInfo: {
                            name: 'Cherie & Frank Gaidosh',
                            email: 'cfgaidosh@gmail.com'
                        }
                    })
                });
                
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = `${photo.filename || 'photo'}_report.pdf`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    window.URL.revokeObjectURL(url);
                    showAlert('PDF generated successfully!', 'success');
                } else {
                    throw new Error('PDF generation failed');
                }
            } catch (error) {
                console.error('PDF generation error:', error);
                showAlert('PDF generation failed. Please try again.', 'error');
            }
        }

        async function savePhotos() {
            try {
                console.log('Saving photos:', photosData);
                console.log('User ID:', nestMateAuth.currentUser.userId);
                
                const response = await fetch('/.netlify/functions/save-user-photos', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        userId: nestMateAuth.currentUser.userId,
                        photos: photosData
                    })
                });
                
                console.log('Save response status:', response.status);
                const responseText = await response.text();
                console.log('Save response body:', responseText);
                
                if (response.ok) {
                    console.log('Photos saved successfully to database');
                    document.getElementById('photosDisplay').style.display = 'block';
                    const form = document.getElementById('photosForm');
            form.style.display = 'none';
            form.classList.remove('active');
                    showAlert('Photos saved to database!', 'success');
                } else {
                    console.error('Save failed with status:', response.status, 'Response:', responseText);
                    throw new Error(`Failed to save photos: ${response.status} - ${responseText}`);
                }
            } catch (error) {
                console.error('Save photos error:', error);
                showAlert('Failed to save photos. Please try again.', 'error');
            }
        }

        // Floorplan CRUD Functions
        function editFloorplan() {
            document.getElementById('floorplanDisplay').style.display = 'none';
            const form = document.getElementById('floorplanForm');
            form.style.display = 'grid';
            form.classList.add('active');
        }

        function cancelEditFloorplan() {
            document.getElementById('floorplanDisplay').style.display = 'block';
            const form = document.getElementById('floorplanForm');
            form.style.display = 'none';
            form.classList.remove('active');
        }

        // Floor Plan CRUD Functions with S3 Upload
        let floorplanData = null;

        function addFloorplanFromUrl() {
            const input = document.getElementById('floorplanUrl');
            const url = (input.value || '').trim();
            if (!url) return;
            
            floorplanData = { url, type: 'url' };
            displayFloorplan();
            input.value = '';
        }

        async function uploadFloorplan() {
            const fileInput = document.getElementById('floorplanFile');
            const file = fileInput.files[0];
            
            if (!file) {
                showAlert('Please select a file to upload', 'error');
                return;
            }

            showAlert('Uploading floor plan...', 'info');
            
            try {
                const userId = nestMateAuth.currentUser.userId;
                const key = `users/${userId}/floorplan/${Date.now()}-${file.name}`;
                const url = await uploadToS3(file, key);
                
                floorplanData = { url, type: 's3', filename: file.name };
                displayFloorplan();
                fileInput.value = '';
                showAlert('Floor plan uploaded successfully!', 'success');
            } catch (error) {
                console.error('Upload error:', error);
                showAlert('Upload failed. Please try again.', 'error');
            }
        }

        function displayFloorplan() {
            const preview = document.getElementById('floorplanPreview');
            
            if (floorplanData && floorplanData.url) {
                if (floorplanData.url.match(/\.(png|jpg|jpeg|gif|webp)$/i)) {
                    preview.innerHTML = '';
                    const img = document.createElement('img');
                    img.src = floorplanData.url;
                    img.alt = 'Floor Plan';
                    img.style.maxWidth = '100%';
                    img.style.maxHeight = '100%';
                    img.style.objectFit = 'contain';
                    preview.appendChild(img);
                } else {
                    preview.innerHTML = `<a href="${floorplanData.url}" target="_blank" style="color:#93c5fd;">Open Floor Plan</a>`;
                }
            } else {
                preview.textContent = 'Floor plan not available';
            }
        }

        async function saveFloorplan() {
            try {
                const userId = nestMateAuth.currentUser.userId;
                const params = {
                    TableName: 'nestmate-users',
                    Key: { userId: userId },
                    UpdateExpression: 'SET floorplan = :floorplan, lastUpdated = :timestamp',
                    ExpressionAttributeValues: {
                        ':floorplan': floorplanData,
                        ':timestamp': new Date().toISOString()
                    }
                };
                
                await dynamodb.update(params).promise();
                
                document.getElementById('floorplanDisplay').style.display = 'block';
                const form = document.getElementById('floorplanForm');
            form.style.display = 'none';
            form.classList.remove('active');
                showAlert('Floor plan saved to database!', 'success');
            } catch (error) {
                console.error('Save floorplan error:', error);
                showAlert('Failed to save floor plan. Please try again.', 'error');
            }
        }

        // Enhanced Floor Plan System
        let floorPlanDataArray = [];
        let currentFloorPlan = null;
        let floorPlanCanvas = null;
        let floorPlanCtx = null;
        let currentTool = 'select';
        let isDrawing = false;
        let startX = 0;
        let startY = 0;
        let zoom = 1;
        let panX = 0;
        let panY = 0;
        let showGrid = true;
        let snapToGrid = true;
        let gridSize = 20;

        // Floor Plan Modal Functions
        function openFloorPlanUpload() {
            document.getElementById('floorPlanUploadModal').style.display = 'flex';
        }

        function closeFloorPlanUpload() {
            document.getElementById('floorPlanUploadModal').style.display = 'none';
        }

        function openFloorPlanCreator() {
            document.getElementById('floorPlanCreatorModal').style.display = 'flex';
            initializeFloorPlanCanvas();
        }

        function closeFloorPlanCreator() {
            document.getElementById('floorPlanCreatorModal').style.display = 'none';
        }

        function openFloorPlanViewer() {
            document.getElementById('floorPlanViewerModal').style.display = 'flex';
            loadFloorPlanGallery();
        }

        function closeFloorPlanViewer() {
            document.getElementById('floorPlanViewerModal').style.display = 'none';
        }

        // Professional Floor Plan Canvas System
        let floorPlanObjects = [];
        let selectedObject = null;
        let isDragging = false;
        let dragOffset = { x: 0, y: 0 };
        let snapDistance = 10;
        let wallThickness = 6;
        let doorWidth = 36;
        let windowWidth = 48;

        function initializeFloorPlanCanvas() {
            floorPlanCanvas = document.getElementById('floorPlanCanvas');
            floorPlanCtx = floorPlanCanvas.getContext('2d');
            
            // Set canvas size
            const container = document.getElementById('canvasArea');
            floorPlanCanvas.width = container.offsetWidth;
            floorPlanCanvas.height = container.offsetHeight;
            
            // Add event listeners
            floorPlanCanvas.addEventListener('mousedown', handleMouseDown);
            floorPlanCanvas.addEventListener('mousemove', handleMouseMove);
            floorPlanCanvas.addEventListener('mouseup', handleMouseUp);
            floorPlanCanvas.addEventListener('wheel', handleWheel);
            floorPlanCanvas.addEventListener('dblclick', handleDoubleClick);
            
            // Initialize canvas with professional settings
            floorPlanCtx.lineCap = 'round';
            floorPlanCtx.lineJoin = 'round';
            
            // Initialize furniture tools
            initializeFurnitureTools();
            
            // Initialize advanced features
            initializeAdvancedFeatures();
            
            // Initialize canvas
            redrawCanvas();
        }

        // Snapping helpers
        let AXIS_SNAP_PX = 8; // dynamic via UI
        function readSnapSettings() {
            // snap to grid
            const snapSel = document.getElementById('snapToGridSelect');
            snapToGrid = !snapSel || snapSel.value === 'on';
            // axis lock
            const axisSel = document.getElementById('axisLockSelect');
            window.__axisLockOn = !axisSel || axisSel.value === 'on';
            // angle snap degrees
            const angSel = document.getElementById('angleSnapSelect');
            window.__angleSnapDeg = angSel ? parseInt(angSel.value) : 45;
            // strength
            const strength = document.getElementById('snapStrengthRange');
            AXIS_SNAP_PX = strength ? parseInt(strength.value) : 8;
        }

        function snapToGridPoint(x, y) {
            if (!snapToGrid) return { x, y };
            const size = parseInt(document.getElementById('gridSize').value);
            return {
                x: Math.round(x / size) * size,
                y: Math.round(y / size) * size,
            };
        }

        function snapToAxesAndWalls(x, y, startX, startY) {
            readSnapSettings();
            // Axis lock when close to horizontal/vertical from start point
            const dx = Math.abs(x - startX);
            const dy = Math.abs(y - startY);
            let sx = x, sy = y;
            if (window.__axisLockOn && dx < AXIS_SNAP_PX && dy >= AXIS_SNAP_PX) {
                sx = startX; // vertical line
            } else if (window.__axisLockOn && dy < AXIS_SNAP_PX && dx >= AXIS_SNAP_PX) {
                sy = startY; // horizontal line
            }

            // Angle snapping (e.g., 15/30/45 degrees)
            const deg = window.__angleSnapDeg || 0;
            if (deg && (dx > AXIS_SNAP_PX || dy > AXIS_SNAP_PX)) {
                const angle = Math.atan2(y - startY, x - startX); // radians
                const snapRad = (Math.PI / 180) * deg;
                const snappedAngle = Math.round(angle / snapRad) * snapRad;
                const length = Math.hypot(x - startX, y - startY);
                sx = startX + Math.cos(snappedAngle) * length;
                sy = startY + Math.sin(snappedAngle) * length;
            }

            // Snap to nearby existing perfectly horizontal/vertical walls
            const alignSnap = Math.max(4, Math.min(AXIS_SNAP_PX, 16));
            for (const obj of floorPlanObjects) {
                if (obj.type !== 'wall') continue;
                const isVertical = Math.abs(obj.x1 - obj.x2) < 1e-3;
                const isHorizontal = Math.abs(obj.y1 - obj.y2) < 1e-3;
                if (isVertical && Math.abs(sx - obj.x1) <= alignSnap) sx = obj.x1;
                if (isHorizontal && Math.abs(sy - obj.y1) <= alignSnap) sy = obj.y1;
            }

            // Finally apply grid snap
            const g = snapToGridPoint(sx, sy);
            return g;
        }

        function handleMouseDown(e) {
            const rect = floorPlanCanvas.getBoundingClientRect();
            const x = (e.clientX - rect.left) / zoom - panX;
            const y = (e.clientY - rect.top) / zoom - panY;
            
            const g = snapToGridPoint(x, y);
            startX = g.x;
            startY = g.y;
            isDrawing = true;
            
            if (currentTool === 'select') {
                // Handle selection
                selectObject(x, y);
                if (selectedObject) {
                    isDragging = true;
                    dragOffset.x = x - selectedObject.x1;
                    dragOffset.y = y - selectedObject.y1;
                }
            } else if (currentTool === 'pan') {
                // Handle panning
                floorPlanCanvas.style.cursor = 'grabbing';
                isDragging = true;
            } else if (currentTool === 'wall') {
                // Start wall drawing
                startWallDrawing(x, y);
            } else if (currentTool === 'door') {
                // Start door placement
                startDoorPlacement(x, y);
            } else if (currentTool === 'window') {
                // Start window placement
                startWindowPlacement(x, y);
            } else if (['polyline', 'arc', 'spline', 'circle', 'ellipse', 'polygon'].includes(currentTool)) {
                // Start advanced drawing
                startAdvancedDrawing(x, y);
            }
        }

        function handleMouseMove(e) {
            const rect = floorPlanCanvas.getBoundingClientRect();
            const x = (e.clientX - rect.left) / zoom - panX;
            const y = (e.clientY - rect.top) / zoom - panY;
            
            // Update cursor position in status bar
            document.getElementById('cursorPosition').textContent = `X: ${Math.round(x)}, Y: ${Math.round(y)}`;
            
            if (isDrawing) {
                if (currentTool === 'pan') {
                    // Handle panning
                    panX += (e.movementX || 0) / zoom;
                    panY += (e.movementY || 0) / zoom;
                    redrawCanvas();
                } else if (currentTool === 'select' && selectedObject && isDragging) {
                    // Handle object dragging
                    const snapped = snapToGridPoint(x - dragOffset.x, y - dragOffset.y);
                    selectedObject.x1 = snapped.x;
                    selectedObject.y1 = snapped.y;
                    selectedObject.x2 = selectedObject.x1 + (selectedObject.x2 - selectedObject.x1);
                    selectedObject.y2 = selectedObject.y1 + (selectedObject.y2 - selectedObject.y1);
                    redrawCanvas();
                } else if (currentTool === 'wall') {
                    // Update wall end point
                    const lastWall = floorPlanObjects[floorPlanObjects.length - 1];
                    if (lastWall && lastWall.type === 'wall') {
                        const snapped = snapToAxesAndWalls(x, y, startX, startY);
                        lastWall.x2 = snapped.x;
                        lastWall.y2 = snapped.y;
                        redrawCanvas();
                    }
                }
            }
        }

        function handleMouseUp(e) {
            if (!isDrawing) return;
            
            const rect = floorPlanCanvas.getBoundingClientRect();
            const x = (e.clientX - rect.left) / zoom - panX;
            const y = (e.clientY - rect.top) / zoom - panY;
            
            if (currentTool === 'wall') {
                // Finalize wall
                const lastWall = floorPlanObjects[floorPlanObjects.length - 1];
                if (lastWall && lastWall.type === 'wall') {
                    const snapped = snapToAxesAndWalls(x, y, startX, startY);
                    lastWall.x2 = snapped.x;
                    lastWall.y2 = snapped.y;
                }
            } else if (currentTool === 'room') {
                // Create room
                const end = snapToGridPoint(x, y);
                const room = {
                    type: 'room',
                    x1: Math.min(startX, end.x),
                    y1: Math.min(startY, end.y),
                    x2: Math.max(startX, end.x),
                    y2: Math.max(startY, end.y),
                    color: document.getElementById('lineColor').value,
                    id: Date.now()
                };
                floorPlanObjects.push(room);
            }
            
            isDrawing = false;
            isDragging = false;
            floorPlanCanvas.style.cursor = 'crosshair';
            redrawCanvas();
        }

        function handleDoubleClick(e) {
            const rect = floorPlanCanvas.getBoundingClientRect();
            const x = (e.clientX - rect.left) / zoom - panX;
            const y = (e.clientY - rect.top) / zoom - panY;
            
            if (currentTool === 'text') {
                const text = prompt('Enter text:');
                if (text) {
                    const textObj = {
                        type: 'text',
                        x1: x,
                        y1: y,
                        text: text,
                        color: document.getElementById('lineColor').value,
                        id: Date.now()
                    };
                    floorPlanObjects.push(textObj);
                    redrawCanvas();
                }
            }
        }

        function selectObject(x, y) {
            selectedObject = null;
            
            // Check objects in reverse order (top to bottom)
            for (let i = floorPlanObjects.length - 1; i >= 0; i--) {
                const obj = floorPlanObjects[i];
                if (isPointInObject(x, y, obj)) {
                    selectedObject = obj;
                    break;
                }
            }
            
            redrawCanvas();
        }

        function isPointInObject(x, y, obj) {
            switch (obj.type) {
                case 'wall':
                    return distanceToLine(x, y, obj.x1, obj.y1, obj.x2, obj.y2) < (obj.thickness || wallThickness) / 2;
                case 'room':
                    return x >= obj.x1 && x <= obj.x2 && y >= obj.y1 && y <= obj.y2;
                case 'door':
                case 'window':
                    return distanceToLine(x, y, obj.x1, obj.y1, obj.x2, obj.y2) < 10;
                case 'furniture':
                    return x >= obj.x1 && x <= obj.x2 && y >= obj.y1 && y <= obj.y2;
                default:
                    return false;
            }
        }

        function handleWheel(e) {
            e.preventDefault();
            const delta = e.deltaY > 0 ? 0.9 : 1.1;
            zoom *= delta;
            zoom = Math.max(0.1, Math.min(5, zoom));
            
            document.getElementById('zoomLevel').textContent = `Zoom: ${Math.round(zoom * 100)}%`;
            redrawCanvas();
        }

        // Tool Selection
        function selectTool(tool) {
            currentTool = tool;
            document.getElementById('currentTool').textContent = `Tool: ${tool.charAt(0).toUpperCase() + tool.slice(1)}`;
            
            // Update active button
            document.querySelectorAll('.tool-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`[data-tool="${tool}"]`).classList.add('active');
            
            // Update cursor
            if (tool === 'pan') {
                floorPlanCanvas.style.cursor = 'grab';
            } else if (tool === 'select') {
                floorPlanCanvas.style.cursor = 'default';
            } else if (tool === 'door' || tool === 'window') {
                floorPlanCanvas.style.cursor = 'crosshair';
            } else {
                floorPlanCanvas.style.cursor = 'crosshair';
            }
        }

        // Furniture Placement Functions
        function placeFurniture(type, x, y) {
            const furniture = {
                type: 'furniture',
                furnitureType: type,
                x1: x - 20,
                y1: y - 20,
                x2: x + 20,
                y2: y + 20,
                color: '#8B4513',
                id: Date.now()
            };
            floorPlanObjects.push(furniture);
            redrawCanvas();
        }

        // Add furniture tool handlers
        function addFurnitureTool(tool, furnitureType) {
            const button = document.querySelector(`[data-tool="${tool}"]`);
            if (button) {
                button.onclick = () => {
                    selectTool(tool);
                    // Set up furniture placement
                    floorPlanCanvas.addEventListener('click', function placeFurnitureHandler(e) {
                        const rect = floorPlanCanvas.getBoundingClientRect();
                        const x = (e.clientX - rect.left) / zoom - panX;
                        const y = (e.clientY - rect.top) / zoom - panY;
                        placeFurniture(furnitureType, x, y);
                        floorPlanCanvas.removeEventListener('click', placeFurnitureHandler);
                    });
                };
            }
        }

        // Initialize furniture tools
        function initializeFurnitureTools() {
            addFurnitureTool('bed', 'Bed');
            addFurnitureTool('sofa', 'Sofa');
            addFurnitureTool('table', 'Table');
            addFurnitureTool('chair', 'Chair');
            addFurnitureTool('appliance', 'Appliance');
            addFurnitureTool('sink', 'Sink');
            addFurnitureTool('toilet', 'Toilet');
            addFurnitureTool('bathtub', 'Bathtub');
            addFurnitureTool('shower', 'Shower');
            addFurnitureTool('stove', 'Stove');
            addFurnitureTool('refrigerator', 'Refrigerator');
        }

        // Canvas Drawing Functions
        function redrawCanvas() {
            if (!floorPlanCtx) return;
            
            floorPlanCtx.clearRect(0, 0, floorPlanCanvas.width, floorPlanCanvas.height);
            
            // Apply zoom and pan
            floorPlanCtx.save();
            floorPlanCtx.scale(zoom, zoom);
            floorPlanCtx.translate(panX, panY);
            
            // Draw grid
            if (showGrid) {
                drawGrid();
            }
            
            // Draw existing objects
            drawObjects();
            
            floorPlanCtx.restore();
        }

        function drawGrid() {
            const gridSize = parseInt(document.getElementById('gridSize').value);
            const width = floorPlanCanvas.width / zoom;
            const height = floorPlanCanvas.height / zoom;

            // Light minor grid
            floorPlanCtx.beginPath();
            floorPlanCtx.strokeStyle = 'rgba(148, 163, 184, 0.35)'; // slate-400 @ 35%
            floorPlanCtx.lineWidth = 1;
            for (let x = 0; x <= width; x += gridSize) {
                floorPlanCtx.moveTo(x, 0);
                floorPlanCtx.lineTo(x, height);
            }
            for (let y = 0; y <= height; y += gridSize) {
                floorPlanCtx.moveTo(0, y);
                floorPlanCtx.lineTo(width, y);
            }
            floorPlanCtx.stroke();

            // Darker major grid every 5 squares
            const major = gridSize * 5;
            floorPlanCtx.beginPath();
            floorPlanCtx.strokeStyle = 'rgba(100, 116, 139, 0.7)'; // slate-500 @ 70%
            floorPlanCtx.lineWidth = 1.5;
            for (let x = 0; x <= width; x += major) {
                floorPlanCtx.moveTo(x, 0);
                floorPlanCtx.lineTo(x, height);
            }
            for (let y = 0; y <= height; y += major) {
                floorPlanCtx.moveTo(0, y);
                floorPlanCtx.lineTo(width, y);
            }
            floorPlanCtx.stroke();
        }

        // Professional Drawing System
        let currentDoorType = 'single';
        let currentWindowType = 'single';
        let currentSidingType = 'brick';
        let currentMaterial = 'standard';

        // Professional Door System
        function selectDoorType(type) {
            currentDoorType = type;
            currentTool = 'door';
            selectTool('door');
            
            // Update door width based on type
            const doorWidthSelect = document.getElementById('doorWidth');
            switch (type) {
                case 'single':
                    doorWidth = 30;
                    break;
                case 'double':
                    doorWidth = 60;
                    break;
                case 'slider':
                    doorWidth = 72;
                    break;
                case 'french':
                    doorWidth = 60;
                    break;
                case 'exterior':
                    doorWidth = 36;
                    break;
                case 'patio':
                    doorWidth = 72;
                    break;
            }
        }

        // Professional Window System
        function selectWindowType(type) {
            currentWindowType = type;
            currentTool = 'window';
            selectTool('window');
            
            // Update window width based on type
            const windowWidthSelect = document.getElementById('windowWidth');
            switch (type) {
                case 'single':
                    windowWidth = 36;
                    break;
                case 'double':
                    windowWidth = 60;
                    break;
                case 'bay':
                    windowWidth = 84;
                    break;
                case 'casement':
                    windowWidth = 36;
                    break;
                case 'slider':
                    windowWidth = 72;
                    break;
                case 'picture':
                    windowWidth = 96;
                    break;
            }
        }

        // Siding Materials System
        function selectSidingType(type) {
            currentSidingType = type;
            currentTool = 'siding';
            selectTool('siding');
        }

        // Professional Wall Drawing
        function startWallDrawing(x, y) {
            const thickness = parseInt(document.getElementById('wallThickness').value);
            const wall = {
                type: 'wall',
                x1: x,
                y1: y,
                x2: x,
                y2: y,
                thickness: thickness,
                color: document.getElementById('lineColor').value,
                material: currentMaterial,
                id: Date.now()
            };
            floorPlanObjects.push(wall);
        }

        function startDoorPlacement(x, y) {
            // Find nearest wall for door placement
            const nearestWall = findNearestWall(x, y);
            if (nearestWall) {
                const doorWidth = parseInt(document.getElementById('doorWidth').value);
                const door = {
                    type: 'door',
                    doorType: currentDoorType,
                    x1: x,
                    y1: y,
                    x2: x + doorWidth,
                    y2: y,
                    width: doorWidth,
                    wallId: nearestWall.id,
                    swing: 'left', // default swing direction
                    color: getDoorColor(currentDoorType),
                    id: Date.now()
                };
                floorPlanObjects.push(door);
            }
        }

        function getDoorColor(doorType) {
            switch (doorType) {
                case 'exterior':
                    return '#8B4513'; // Brown
                case 'interior':
                    return '#DEB887'; // Light brown
                case 'slider':
                    return '#4682B4'; // Steel blue
                case 'french':
                    return '#8B4513'; // Brown
                case 'patio':
                    return '#2F4F4F'; // Dark slate gray
                default:
                    return '#8B4513';
            }
        }

        function startWindowPlacement(x, y) {
            // Find nearest wall for window placement
            const nearestWall = findNearestWall(x, y);
            if (nearestWall) {
                const windowWidth = parseInt(document.getElementById('windowWidth').value);
                const window = {
                    type: 'window',
                    windowType: currentWindowType,
                    x1: x,
                    y1: y,
                    x2: x + windowWidth,
                    y2: y,
                    width: windowWidth,
                    wallId: nearestWall.id,
                    color: getWindowColor(currentWindowType),
                    id: Date.now()
                };
                floorPlanObjects.push(window);
            }
        }

        function getWindowColor(windowType) {
            switch (windowType) {
                case 'single':
                    return '#87CEEB'; // Sky blue
                case 'double':
                    return '#4682B4'; // Steel blue
                case 'bay':
                    return '#5F9EA0'; // Cadet blue
                case 'casement':
                    return '#87CEEB'; // Sky blue
                case 'slider':
                    return '#4682B4'; // Steel blue
                case 'picture':
                    return '#87CEEB'; // Sky blue
                default:
                    return '#87CEEB';
            }
        }

        // Advanced Drawing Tools
        function startAdvancedDrawing(x, y) {
            switch (currentTool) {
                case 'polyline':
                    startPolyline(x, y);
                    break;
                case 'arc':
                    startArc(x, y);
                    break;
                case 'spline':
                    startSpline(x, y);
                    break;
                case 'circle':
                    startCircle(x, y);
                    break;
                case 'ellipse':
                    startEllipse(x, y);
                    break;
                case 'polygon':
                    startPolygon(x, y);
                    break;
            }
        }

        function startPolyline(x, y) {
            const polyline = {
                type: 'polyline',
                points: [{x: x, y: y}],
                color: document.getElementById('lineColor').value,
                lineWidth: document.getElementById('lineWidth').value,
                id: Date.now()
            };
            floorPlanObjects.push(polyline);
        }

        function startArc(x, y) {
            const arc = {
                type: 'arc',
                centerX: x,
                centerY: y,
                radius: 0,
                startAngle: 0,
                endAngle: 0,
                color: document.getElementById('lineColor').value,
                lineWidth: document.getElementById('lineWidth').value,
                id: Date.now()
            };
            floorPlanObjects.push(arc);
        }

        function startSpline(x, y) {
            const spline = {
                type: 'spline',
                points: [{x: x, y: y}],
                color: document.getElementById('lineColor').value,
                lineWidth: document.getElementById('lineWidth').value,
                id: Date.now()
            };
            floorPlanObjects.push(spline);
        }

        function startCircle(x, y) {
            const circle = {
                type: 'circle',
                centerX: x,
                centerY: y,
                radius: 0,
                color: document.getElementById('lineColor').value,
                fillColor: document.getElementById('fillColor').value,
                lineWidth: document.getElementById('lineWidth').value,
                id: Date.now()
            };
            floorPlanObjects.push(circle);
        }

        function startEllipse(x, y) {
            const ellipse = {
                type: 'ellipse',
                centerX: x,
                centerY: y,
                radiusX: 0,
                radiusY: 0,
                color: document.getElementById('lineColor').value,
                fillColor: document.getElementById('fillColor').value,
                lineWidth: document.getElementById('lineWidth').value,
                id: Date.now()
            };
            floorPlanObjects.push(ellipse);
        }

        function startPolygon(x, y) {
            const polygon = {
                type: 'polygon',
                points: [{x: x, y: y}],
                color: document.getElementById('lineColor').value,
                fillColor: document.getElementById('fillColor').value,
                lineWidth: document.getElementById('lineWidth').value,
                id: Date.now()
            };
            floorPlanObjects.push(polygon);
        }

        function findNearestWall(x, y) {
            let nearestWall = null;
            let minDistance = Infinity;
            
            floorPlanObjects.forEach(obj => {
                if (obj.type === 'wall') {
                    const distance = distanceToLine(x, y, obj.x1, obj.y1, obj.x2, obj.y2);
                    if (distance < minDistance && distance < snapDistance) {
                        minDistance = distance;
                        nearestWall = obj;
                    }
                }
            });
            
            return nearestWall;
        }

        function distanceToLine(px, py, x1, y1, x2, y2) {
            const A = px - x1;
            const B = py - y1;
            const C = x2 - x1;
            const D = y2 - y1;
            
            const dot = A * C + B * D;
            const lenSq = C * C + D * D;
            let param = -1;
            
            if (lenSq !== 0) {
                param = dot / lenSq;
            }
            
            let xx, yy;
            
            if (param < 0) {
                xx = x1;
                yy = y1;
            } else if (param > 1) {
                xx = x2;
                yy = y2;
            } else {
                xx = x1 + param * C;
                yy = y1 + param * D;
            }
            
            const dx = px - xx;
            const dy = py - yy;
            return Math.sqrt(dx * dx + dy * dy);
        }

        function drawObjects() {
            floorPlanObjects.forEach(obj => {
                drawObject(obj);
            });
        }

        function drawObject(obj) {
            floorPlanCtx.save();
            
            switch (obj.type) {
                case 'wall':
                    drawWall(obj);
                    break;
                case 'door':
                    drawDoor(obj);
                    break;
                case 'window':
                    drawWindow(obj);
                    break;
                case 'room':
                    drawRoom(obj);
                    break;
                case 'furniture':
                    drawFurniture(obj);
                    break;
                case 'polyline':
                    drawPolyline(obj);
                    break;
                case 'arc':
                    drawArc(obj);
                    break;
                case 'circle':
                    drawCircle(obj);
                    break;
                case 'ellipse':
                    drawEllipse(obj);
                    break;
                case 'polygon':
                    drawPolygon(obj);
                    break;
                case 'dimension':
                case 'wall-measurement':
                    drawDimension(obj);
                    break;
                case 'text':
                    drawText(obj);
                    break;
            }
            
            floorPlanCtx.restore();
        }

        function drawText(obj) {
            floorPlanCtx.fillStyle = obj.color;
            floorPlanCtx.font = '14px Arial';
            floorPlanCtx.textAlign = 'left';
            floorPlanCtx.fillText(obj.text, obj.x1, obj.y1);
        }

        function drawWall(obj) {
            floorPlanCtx.strokeStyle = obj.color || '#000000';
            floorPlanCtx.lineWidth = obj.thickness || wallThickness;
            floorPlanCtx.beginPath();
            floorPlanCtx.moveTo(obj.x1, obj.y1);
            floorPlanCtx.lineTo(obj.x2, obj.y2);
            floorPlanCtx.stroke();
            
            // Draw selection highlight
            if (obj === selectedObject) {
                floorPlanCtx.strokeStyle = '#FF6B6B';
                floorPlanCtx.lineWidth = (obj.thickness || wallThickness) + 2;
                floorPlanCtx.setLineDash([5, 5]);
                floorPlanCtx.beginPath();
                floorPlanCtx.moveTo(obj.x1, obj.y1);
                floorPlanCtx.lineTo(obj.x2, obj.y2);
                floorPlanCtx.stroke();
                floorPlanCtx.setLineDash([]);
            }
        }

        function drawDoor(obj) {
            const centerX = (obj.x1 + obj.x2) / 2;
            const centerY = (obj.y1 + obj.y2) / 2;
            const length = Math.sqrt((obj.x2 - obj.x1) ** 2 + (obj.y2 - obj.y1) ** 2);
            const angle = Math.atan2(obj.y2 - obj.y1, obj.x2 - obj.x1);
            
            // Draw door frame
            floorPlanCtx.strokeStyle = '#8B4513';
            floorPlanCtx.lineWidth = 2;
            floorPlanCtx.beginPath();
            floorPlanCtx.moveTo(obj.x1, obj.y1);
            floorPlanCtx.lineTo(obj.x2, obj.y2);
            floorPlanCtx.stroke();
            
            // Draw door swing arc
            floorPlanCtx.strokeStyle = '#8B4513';
            floorPlanCtx.lineWidth = 1;
            floorPlanCtx.beginPath();
            floorPlanCtx.arc(centerX, centerY, length / 2, angle - Math.PI/2, angle + Math.PI/2);
            floorPlanCtx.stroke();
            
            // Draw door panel
            floorPlanCtx.fillStyle = '#DEB887';
            floorPlanCtx.fillRect(centerX - 2, centerY - 2, 4, 4);
        }

        function drawWindow(obj) {
            const centerX = (obj.x1 + obj.x2) / 2;
            const centerY = (obj.y1 + obj.y2) / 2;
            const length = Math.sqrt((obj.x2 - obj.x1) ** 2 + (obj.y2 - obj.y1) ** 2);
            
            // Draw window frame
            floorPlanCtx.strokeStyle = '#87CEEB';
            floorPlanCtx.lineWidth = 3;
            floorPlanCtx.beginPath();
            floorPlanCtx.moveTo(obj.x1, obj.y1);
            floorPlanCtx.lineTo(obj.x2, obj.y2);
            floorPlanCtx.stroke();
            
            // Draw window panes
            floorPlanCtx.strokeStyle = '#4682B4';
            floorPlanCtx.lineWidth = 1;
            floorPlanCtx.beginPath();
            floorPlanCtx.moveTo(centerX, obj.y1);
            floorPlanCtx.lineTo(centerX, obj.y2);
            floorPlanCtx.stroke();
        }

        function drawRoom(obj) {
            // Draw room outline
            floorPlanCtx.strokeStyle = obj.color || '#000000';
            floorPlanCtx.lineWidth = 2;
            floorPlanCtx.beginPath();
            floorPlanCtx.rect(obj.x1, obj.y1, obj.x2 - obj.x1, obj.y2 - obj.y1);
            floorPlanCtx.stroke();
            
            // Fill room if selected
            if (obj === selectedObject) {
                floorPlanCtx.fillStyle = 'rgba(255, 107, 107, 0.1)';
                floorPlanCtx.fillRect(obj.x1, obj.y1, obj.x2 - obj.x1, obj.y2 - obj.y1);
            }
        }

        function drawFurniture(obj) {
            floorPlanCtx.fillStyle = obj.color || '#8B4513';
            floorPlanCtx.fillRect(obj.x1, obj.y1, obj.x2 - obj.x1, obj.y2 - obj.y1);
            
            // Draw furniture icon
            floorPlanCtx.fillStyle = '#FFFFFF';
            floorPlanCtx.font = '12px Arial';
            floorPlanCtx.textAlign = 'center';
            floorPlanCtx.fillText(obj.furnitureType || 'F', 
                (obj.x1 + obj.x2) / 2, 
                (obj.y1 + obj.y2) / 2 + 4);
        }

        function drawPreview(x, y) {
            if (!floorPlanCtx) return;
            
            floorPlanCtx.save();
            floorPlanCtx.strokeStyle = document.getElementById('lineColor').value;
            floorPlanCtx.lineWidth = document.getElementById('lineWidth').value;
            floorPlanCtx.setLineDash([5, 5]);
            
            switch (currentTool) {
                case 'wall':
                    floorPlanCtx.beginPath();
                    floorPlanCtx.moveTo(startX, startY);
                    floorPlanCtx.lineTo(x, y);
                    floorPlanCtx.stroke();
                    break;
                case 'room':
                    floorPlanCtx.beginPath();
                    floorPlanCtx.rect(startX, startY, x - startX, y - startY);
                    floorPlanCtx.stroke();
                    break;
                // Add more tools as needed
            }
            
            floorPlanCtx.restore();
        }

        function createObject(x1, y1, x2, y2) {
            const object = {
                type: currentTool,
                x1: Math.min(x1, x2),
                y1: Math.min(y1, y2),
                x2: Math.max(x1, x2),
                y2: Math.max(y1, y2),
                color: document.getElementById('lineColor').value,
                lineWidth: document.getElementById('lineWidth').value,
                fillColor: document.getElementById('fillColor').value
            };
            
            if (!currentFloorPlan) {
                currentFloorPlan = {
                    id: Date.now(),
                    name: 'New Floor Plan',
                    objects: []
                };
            }
            
            currentFloorPlan.objects.push(object);
        }

        function selectObject(x, y) {
            // Find and select object at coordinates
            // Implementation for object selection
        }

        // Canvas Controls
        function zoomIn() {
            zoom *= 1.2;
            zoom = Math.min(5, zoom);
            document.getElementById('zoomLevel').textContent = `Zoom: ${Math.round(zoom * 100)}%`;
            redrawCanvas();
        }

        function zoomOut() {
            zoom *= 0.8;
            zoom = Math.max(0.1, zoom);
            document.getElementById('zoomLevel').textContent = `Zoom: ${Math.round(zoom * 100)}%`;
            redrawCanvas();
        }

        function resetZoom() {
            zoom = 1;
            panX = 0;
            panY = 0;
            document.getElementById('zoomLevel').textContent = `Zoom: 100%`;
            redrawCanvas();
        }

        function toggleGrid() {
            showGrid = !showGrid;
            redrawCanvas();
        }

        function toggleSnap() {
            snapToGrid = !snapToGrid;
        }

        // Floor Plan Upload Functions
        async function uploadFloorPlan() {
            const fileInput = document.getElementById('floorPlanFile');
            const urlInput = document.getElementById('floorPlanUrl');
            const nameInput = document.getElementById('floorPlanName');
            const descInput = document.getElementById('floorPlanDescription');
            
            let files = [];
            
            if (fileInput.files.length > 0) {
                for (let file of fileInput.files) {
                    try {
                        const userId = nestMateAuth.currentUser.userId;
                        const key = `users/${userId}/floorplans/${Date.now()}-${file.name}`;
                        const url = await uploadToS3(file, key);
                        
                        files.push({
                            name: file.name,
                            url: url,
                            key: key,
                            type: 's3'
                        });
                    } catch (error) {
                        console.error('Upload error:', error);
                        showAlert(`Failed to upload ${file.name}`, 'error');
                    }
                }
            } else if (urlInput.value.trim()) {
                files.push({
                    name: nameInput.value || 'Floor Plan',
                    url: urlInput.value.trim(),
                    type: 'url'
                });
            }
            
            if (files.length > 0) {
                const floorPlan = {
                    id: Date.now(),
                    name: nameInput.value || 'Floor Plan',
                    description: descInput.value || '',
                    files: files,
                    createdAt: new Date().toISOString()
                };
                
                floorPlanDataArray.push(floorPlan);
                await saveFloorPlanToDB(floorPlan);
                
                showAlert('Floor plan uploaded successfully!', 'success');
                closeFloorPlanUpload();
                
                // Clear form
                fileInput.value = '';
                urlInput.value = '';
                nameInput.value = '';
                descInput.value = '';
            } else {
                showAlert('Please select files or enter a URL', 'error');
            }
        }

        async function saveFloorPlanToDB(floorPlan) {
            try {
                const userId = nestMateAuth.currentUser.userId;
                const params = {
                    TableName: 'nestmate-users',
                    Key: { userId: userId },
                    UpdateExpression: 'SET floorPlanData = :floorPlanData, lastUpdated = :timestamp',
                    ExpressionAttributeValues: {
                        ':floorPlanData': floorPlanDataArray,
                        ':timestamp': new Date().toISOString()
                    }
                };
                
                await dynamodb.update(params).promise();
            } catch (error) {
                console.error('Save floor plan error:', error);
                throw error;
            }
        }

        function loadFloorPlanGallery() {
            const gallery = document.getElementById('floorPlanGallery');
            
            if (floorPlanDataArray.length === 0) {
                gallery.innerHTML = '<p style="text-align: center; color: #94a3b8; grid-column: 1 / -1;">No floor plans found</p>';
                return;
            }
            
            gallery.innerHTML = floorPlanDataArray.map(plan => `
                <div class="floor-plan-card" onclick="viewFloorPlan('${plan.id}')">
                    <img src="${plan.files[0]?.url || '#'}" alt="${plan.name}" onerror="this.style.display='none'">
                    <h4>${plan.name}</h4>
                    <p>${plan.description || 'No description'}</p>
                    <p style="font-size: 0.75rem; color: #64748b;">
                        ${new Date(plan.createdAt).toLocaleDateString()}
                    </p>
                </div>
            `).join('');
        }

        function viewFloorPlan(planId) {
            const plan = floorPlanDataArray.find(p => p.id == planId);
            if (plan) {
                // Open floor plan in viewer
                window.open(plan.files[0]?.url, '_blank');
            }
        }

        // Save and Export Functions
        async function saveFloorPlan() {
            if (!currentFloorPlan) {
                showAlert('No floor plan to save', 'error');
                return;
            }
            
            try {
                await saveFloorPlanToDB(currentFloorPlan);
                showAlert('Floor plan saved successfully!', 'success');
            } catch (error) {
                console.error('Save error:', error);
                showAlert('Failed to save floor plan', 'error');
            }
        }

        function exportFloorPlan() {
            if (floorPlanObjects.length === 0) {
                showAlert('No floor plan to export', 'error');
                return;
            }
            
            // Export as image
            const dataURL = floorPlanCanvas.toDataURL('image/png');
            const link = document.createElement('a');
            link.download = `floor-plan-${Date.now()}.png`;
            link.href = dataURL;
            link.click();
        }

        // Advanced Features
        function addKeyboardShortcuts() {
            document.addEventListener('keydown', (e) => {
                if (e.ctrlKey || e.metaKey) {
                    switch (e.key) {
                        case 's':
                            e.preventDefault();
                            saveFloorPlan();
                            break;
                        case 'z':
                            e.preventDefault();
                            undoLastAction();
                            break;
                        case 'y':
                            e.preventDefault();
                            redoLastAction();
                            break;
                        case 'a':
                            e.preventDefault();
                            selectAllObjects();
                            break;
                        case 'd':
                            e.preventDefault();
                            deleteSelectedObject();
                            break;
                    }
                } else {
                    switch (e.key) {
                        case 'Delete':
                        case 'Backspace':
                            deleteSelectedObject();
                            break;
                        case 'Escape':
                            selectedObject = null;
                            redrawCanvas();
                            break;
                    }
                }
            });
        }

        function undoLastAction() {
            if (floorPlanObjects.length > 0) {
                floorPlanObjects.pop();
                redrawCanvas();
                showAlert('Undo completed', 'success');
            }
        }

        function redoLastAction() {
            // Implementation would require action history
            showAlert('Redo not implemented yet', 'info');
        }

        function selectAllObjects() {
            // Select all objects for bulk operations
            showAlert('Select all not implemented yet', 'info');
        }

        function deleteSelectedObject() {
            if (selectedObject) {
                const index = floorPlanObjects.indexOf(selectedObject);
                if (index > -1) {
                    floorPlanObjects.splice(index, 1);
                    selectedObject = null;
                    redrawCanvas();
                    showAlert('Object deleted', 'success');
                }
            }
        }

        // Professional Measurement & Dimensioning System
        function addMeasurementTool() {
            if (currentTool === 'measure') {
                // Add measurement line
                const measurement = {
                    type: 'measurement',
                    x1: startX,
                    y1: startY,
                    x2: startX,
                    y2: startY,
                    color: '#FF0000',
                    id: Date.now()
                };
                floorPlanObjects.push(measurement);
            }
        }

        // Professional Dimensioning
        function addDimension(x1, y1, x2, y2) {
            const distance = Math.sqrt((x2 - x1) ** 2 + (y2 - y1) ** 2);
            const dimension = {
                type: 'dimension',
                x1: x1,
                y1: y1,
                x2: x2,
                y2: y2,
                distance: distance,
                text: `${Math.round(distance)}"`,
                color: '#FF0000',
                id: Date.now()
            };
            floorPlanObjects.push(dimension);
            redrawCanvas();
        }

        // Auto-measurement for walls
        function addWallMeasurement(wall) {
            const distance = Math.sqrt((wall.x2 - wall.x1) ** 2 + (wall.y2 - wall.y1) ** 2);
            const measurement = {
                type: 'wall-measurement',
                wallId: wall.id,
                x1: (wall.x1 + wall.x2) / 2,
                y1: (wall.y1 + wall.y2) / 2 - 20,
                x2: (wall.x1 + wall.x2) / 2,
                y2: (wall.y1 + wall.y2) / 2 + 20,
                distance: distance,
                text: `${Math.round(distance)}"`,
                color: '#FF0000',
                id: Date.now()
            };
            floorPlanObjects.push(measurement);
        }

        // Professional Drawing Functions for Advanced Tools
        function drawPolyline(obj) {
            if (obj.points.length < 2) return;
            
            floorPlanCtx.strokeStyle = obj.color;
            floorPlanCtx.lineWidth = obj.lineWidth;
            floorPlanCtx.beginPath();
            floorPlanCtx.moveTo(obj.points[0].x, obj.points[0].y);
            
            for (let i = 1; i < obj.points.length; i++) {
                floorPlanCtx.lineTo(obj.points[i].x, obj.points[i].y);
            }
            floorPlanCtx.stroke();
        }

        function drawArc(obj) {
            floorPlanCtx.strokeStyle = obj.color;
            floorPlanCtx.lineWidth = obj.lineWidth;
            floorPlanCtx.beginPath();
            floorPlanCtx.arc(obj.centerX, obj.centerY, obj.radius, obj.startAngle, obj.endAngle);
            floorPlanCtx.stroke();
        }

        function drawCircle(obj) {
            floorPlanCtx.strokeStyle = obj.color;
            floorPlanCtx.lineWidth = obj.lineWidth;
            floorPlanCtx.beginPath();
            floorPlanCtx.arc(obj.centerX, obj.centerY, obj.radius, 0, 2 * Math.PI);
            floorPlanCtx.stroke();
            
            if (obj.fillColor) {
                floorPlanCtx.fillStyle = obj.fillColor;
                floorPlanCtx.fill();
            }
        }

        function drawEllipse(obj) {
            floorPlanCtx.strokeStyle = obj.color;
            floorPlanCtx.lineWidth = obj.lineWidth;
            floorPlanCtx.beginPath();
            floorPlanCtx.ellipse(obj.centerX, obj.centerY, obj.radiusX, obj.radiusY, 0, 0, 2 * Math.PI);
            floorPlanCtx.stroke();
            
            if (obj.fillColor) {
                floorPlanCtx.fillStyle = obj.fillColor;
                floorPlanCtx.fill();
            }
        }

        function drawPolygon(obj) {
            if (obj.points.length < 3) return;
            
            floorPlanCtx.strokeStyle = obj.color;
            floorPlanCtx.lineWidth = obj.lineWidth;
            floorPlanCtx.beginPath();
            floorPlanCtx.moveTo(obj.points[0].x, obj.points[0].y);
            
            for (let i = 1; i < obj.points.length; i++) {
                floorPlanCtx.lineTo(obj.points[i].x, obj.points[i].y);
            }
            floorPlanCtx.closePath();
            floorPlanCtx.stroke();
            
            if (obj.fillColor) {
                floorPlanCtx.fillStyle = obj.fillColor;
                floorPlanCtx.fill();
            }
        }

        function drawDimension(obj) {
            // Draw dimension line
            floorPlanCtx.strokeStyle = obj.color;
            floorPlanCtx.lineWidth = 1;
            floorPlanCtx.beginPath();
            floorPlanCtx.moveTo(obj.x1, obj.y1);
            floorPlanCtx.lineTo(obj.x2, obj.y2);
            floorPlanCtx.stroke();
            
            // Draw dimension text
            floorPlanCtx.fillStyle = obj.color;
            floorPlanCtx.font = '12px Arial';
            floorPlanCtx.textAlign = 'center';
            floorPlanCtx.fillText(obj.text, (obj.x1 + obj.x2) / 2, (obj.y1 + obj.y2) / 2 - 5);
        }

        // Initialize advanced features
        function initializeAdvancedFeatures() {
            addKeyboardShortcuts();
            
            // Add measurement tool to canvas
            document.getElementById('measurementTool')?.addEventListener('click', () => {
                selectTool('measure');
            });
        }

        // Emergency CRUD Functions
        function editEmergency() {
            document.getElementById('emergencyDisplay').style.display = 'none';
            const form = document.getElementById('emergencyForm');
            form.style.display = 'grid';
            form.classList.add('active');
        }

        function cancelEditEmergency() {
            document.getElementById('emergencyDisplay').style.display = 'block';
            const form = document.getElementById('emergencyForm');
            form.style.display = 'none';
            form.classList.remove('active');
        }

        function saveEmergency() {
            document.getElementById('displayPolice').textContent = document.getElementById('police').value || '911';
            document.getElementById('displayFire').textContent = document.getElementById('fire').value || '911';
            document.getElementById('displayElectrician').textContent = document.getElementById('electrician').value || '(555) 123-4567';
            document.getElementById('displayPlumber').textContent = document.getElementById('plumber').value || '(555) 987-6543';
            document.getElementById('displayEmergencyNotes').textContent = document.getElementById('emergencyNotes').value || 'None';
            document.getElementById('emergencyDisplay').style.display = 'block';
            const form = document.getElementById('emergencyForm');
            form.style.display = 'none';
            form.classList.remove('active');
            showAlert('Emergency contacts saved!', 'success');
        }

        // Update user display
        function updateUserDisplay() {
            try {
                console.log('updateUserDisplay called');
                console.log('nestMateAuth:', nestMateAuth);
                console.log('nestMateAuth.currentUser:', nestMateAuth?.currentUser);
                
                if (nestMateAuth && nestMateAuth.currentUser) {
                    const userName = nestMateAuth.currentUser.name || nestMateAuth.currentUser.email?.split('@')[0] || 'User';
                    const userEmail = nestMateAuth.currentUser.email || 'Loading...';
                    
                    document.getElementById('userName').textContent = userName;
                    document.getElementById('userEmail').textContent = userEmail;
                    
                    // Update avatar with first letter of name
                    const firstLetter = userName.charAt(0).toUpperCase();
                    document.getElementById('userAvatar').textContent = firstLetter;
                    
                    console.log('User display updated:', userName, userEmail);
                } else {
                    console.log('No current user found, setting default values');
                    document.getElementById('userName').textContent = 'User';
                    document.getElementById('userEmail').textContent = 'Loading...';
                    document.getElementById('userAvatar').textContent = 'U';
                }
            } catch (error) {
                console.error('Error updating user display:', error);
                // Set fallback values
                document.getElementById('userName').textContent = 'User';
                document.getElementById('userEmail').textContent = 'Error';
                document.getElementById('userAvatar').textContent = 'U';
            }
        }

        // Tasks & Calendar Data Management
        let tasksData = [];
        let currentMonth = new Date().getMonth();
        let currentYear = new Date().getFullYear();
        let currentFilter = 'all';

        // Tasks & Calendar Functions
        function switchTasksView(view) {
            const tasksView = document.getElementById('tasksView');
            const calendarView = document.getElementById('calendarView');
            const tasksViewBtn = document.getElementById('tasksViewBtn');
            const calendarViewBtn = document.getElementById('calendarViewBtn');
            
            if (!tasksView || !calendarView || !tasksViewBtn || !calendarViewBtn) {
                console.error('Tasks/Calendar elements not found');
                return;
            }
            
            if (view === 'tasks') {
                tasksView.style.display = 'block';
                calendarView.style.display = 'none';
                tasksViewBtn.classList.remove('btn-secondary');
                tasksViewBtn.classList.add('btn');
                calendarViewBtn.classList.remove('btn');
                calendarViewBtn.classList.add('btn-secondary');
            } else {
                tasksView.style.display = 'none';
                calendarView.style.display = 'block';
                calendarViewBtn.classList.remove('btn-secondary');
                calendarViewBtn.classList.add('btn');
                tasksViewBtn.classList.remove('btn');
                tasksViewBtn.classList.add('btn-secondary');
                // Render calendar when switching to calendar view
                setTimeout(() => {
                    renderCalendar();
                }, 50);
            }
        }

        function openAddTaskModal() {
            document.getElementById('taskModalTitle').textContent = 'Add Task';
            document.getElementById('taskForm').reset();
            document.getElementById('taskForm').dataset.taskId = '';
            const modal = document.getElementById('taskModal');
            modal.style.display = 'block';
            modal.classList.add('show');
            let overlay = document.querySelector('.modal-overlay');
            if (!overlay) {
                overlay = document.createElement('div');
                overlay.className = 'modal-overlay';
                overlay.onclick = function(e) {
                    if (e.target === overlay) {
                        closeTaskModal();
                    }
                };
                document.body.appendChild(overlay);
            }
            overlay.classList.add('active');
            overlay.appendChild(modal);
        }

        function openEditTaskModal(taskId) {
            const task = tasksData.find(t => t.id === taskId);
            if (!task) return;
            
            document.getElementById('taskModalTitle').textContent = 'Edit Task';
            document.getElementById('taskTitle').value = task.title || '';
            document.getElementById('taskDescription').value = task.description || '';
            document.getElementById('taskDueDate').value = task.dueDate || '';
            document.getElementById('taskPriority').value = task.priority || 'medium';
            document.getElementById('taskCategory').value = task.category || '';
            document.getElementById('taskForm').dataset.taskId = taskId;
            
            const modal = document.getElementById('taskModal');
            modal.style.display = 'block';
            modal.classList.add('show');
            let overlay = document.querySelector('.modal-overlay');
            if (!overlay) {
                overlay = document.createElement('div');
                overlay.className = 'modal-overlay';
                overlay.onclick = function(e) {
                    if (e.target === overlay) {
                        closeTaskModal();
                    }
                };
                document.body.appendChild(overlay);
            }
            overlay.classList.add('active');
            overlay.appendChild(modal);
        }

        function closeTaskModal() {
            const modal = document.getElementById('taskModal');
            modal.style.display = 'none';
            modal.classList.remove('show');
            const overlay = document.querySelector('.modal-overlay');
            if (overlay) {
                overlay.classList.remove('active');
                if (overlay.contains(modal)) {
                    document.body.appendChild(modal);
                }
            }
        }

        // Task form submission
        document.addEventListener('DOMContentLoaded', function() {
            const taskForm = document.getElementById('taskForm');
            if (taskForm) {
                taskForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    await saveTask();
                });
            }
        });

        async function saveTask() {
            try {
                const form = document.getElementById('taskForm');
                const taskId = form.dataset.taskId;
                const taskData = {
                    title: document.getElementById('taskTitle').value,
                    description: document.getElementById('taskDescription').value,
                    dueDate: document.getElementById('taskDueDate').value,
                    priority: document.getElementById('taskPriority').value,
                    category: document.getElementById('taskCategory').value,
                    status: taskId ? tasksData.find(t => t.id === taskId)?.status || 'pending' : 'pending',
                    createdAt: taskId ? tasksData.find(t => t.id === taskId)?.createdAt : new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                };

                if (taskId) {
                    // Update existing task
                    const index = tasksData.findIndex(t => t.id === taskId);
                    if (index !== -1) {
                        tasksData[index] = { ...tasksData[index], ...taskData };
                    }
                } else {
                    // Add new task
                    taskData.id = Date.now().toString();
                    tasksData.push(taskData);
                }

                await saveTasksToDB();
                renderTasks();
                closeTaskModal();
                showAlert('Task saved successfully!', 'success');
            } catch (error) {
                console.error('Error saving task:', error);
                showAlert('Failed to save task', 'error');
            }
        }

        function deleteTask(taskId) {
            if (confirm('Are you sure you want to delete this task?')) {
                tasksData = tasksData.filter(t => t.id !== taskId);
                saveTasksToDB();
                renderTasks();
                renderCalendar();
                showAlert('Task deleted', 'success');
            }
        }

        async function toggleTaskComplete(taskId) {
            const task = tasksData.find(t => t.id === taskId);
            if (task) {
                task.status = task.status === 'completed' ? 'pending' : 'completed';
                task.updatedAt = new Date().toISOString();
                await saveTasksToDB();
                renderTasks();
                renderCalendar();
            }
        }

        function filterTasks(filter) {
            currentFilter = filter;
            document.querySelectorAll('[id^="filter"]').forEach(btn => {
                btn.classList.remove('btn');
                btn.classList.add('btn-secondary');
            });
            document.getElementById('filter' + filter.charAt(0).toUpperCase() + filter.slice(1)).classList.remove('btn-secondary');
            document.getElementById('filter' + filter.charAt(0).toUpperCase() + filter.slice(1)).classList.add('btn');
            renderTasks();
        }

        function renderTasks() {
            const tasksList = document.getElementById('tasksList');
            if (!tasksList) return;

            let filteredTasks = [...tasksData];
            const today = new Date().toISOString().split('T')[0];

            if (currentFilter === 'pending') {
                filteredTasks = filteredTasks.filter(t => t.status !== 'completed');
            } else if (currentFilter === 'completed') {
                filteredTasks = filteredTasks.filter(t => t.status === 'completed');
            } else if (currentFilter === 'overdue') {
                filteredTasks = filteredTasks.filter(t => t.status !== 'completed' && t.dueDate < today);
            }

            if (filteredTasks.length === 0) {
                tasksList.innerHTML = '<p style="color: #94a3b8; text-align: center; padding: 2rem;">No tasks found.</p>';
                return;
            }

            // Sort tasks: overdue first, then by due date
            filteredTasks.sort((a, b) => {
                const aOverdue = a.status !== 'completed' && a.dueDate < today;
                const bOverdue = b.status !== 'completed' && b.dueDate < today;
                if (aOverdue && !bOverdue) return -1;
                if (!aOverdue && bOverdue) return 1;
                return new Date(a.dueDate) - new Date(b.dueDate);
            });

            tasksList.innerHTML = filteredTasks.map(task => {
                const isOverdue = task.status !== 'completed' && task.dueDate < today;
                const dueDate = new Date(task.dueDate);
                return `
                    <div class="task-item ${task.status === 'completed' ? 'completed' : ''} ${isOverdue ? 'overdue' : ''}">
                        <input type="checkbox" class="task-checkbox" ${task.status === 'completed' ? 'checked' : ''} 
                               onchange="toggleTaskComplete('${task.id}')">
                        <div class="task-content">
                            <div class="task-title">${task.title}</div>
                            ${task.description ? `<div class="task-description">${task.description}</div>` : ''}
                            <div class="task-meta">
                                <div class="task-date">
                                    <i class="fas fa-calendar"></i> ${dueDate.toLocaleDateString()}
                                </div>
                                <span class="task-priority ${task.priority}">${task.priority.toUpperCase()}</span>
                                ${task.category ? `<span><i class="fas fa-tag"></i> ${task.category}</span>` : ''}
                            </div>
                        </div>
                        <div class="task-actions">
                            <button class="btn btn-sm" onclick="openEditTaskModal('${task.id}')">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-secondary" onclick="deleteTask('${task.id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function changeMonth(direction) {
            currentMonth += direction;
            if (currentMonth < 0) {
                currentMonth = 11;
                currentYear--;
            } else if (currentMonth > 11) {
                currentMonth = 0;
                currentYear++;
            }
            renderCalendar();
        }

        function renderCalendar() {
            const calendarGrid = document.getElementById('calendarGrid');
            const monthYear = document.getElementById('calendarMonthYear');
            if (!calendarGrid || !monthYear) {
                console.error('Calendar elements not found');
                return;
            }
            
            console.log('Rendering calendar for', currentMonth, currentYear);

            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 
                              'July', 'August', 'September', 'October', 'November', 'December'];
            monthYear.textContent = `${monthNames[currentMonth]} ${currentYear}`;

            const firstDay = new Date(currentYear, currentMonth, 1);
            const lastDay = new Date(currentYear, currentMonth + 1, 0);
            const daysInMonth = lastDay.getDate();
            const startingDayOfWeek = firstDay.getDay();

            const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            let html = dayNames.map(day => `<div class="calendar-day-header">${day}</div>`).join('');

            // Previous month days
            const prevMonthLastDay = new Date(currentYear, currentMonth, 0).getDate();
            for (let i = startingDayOfWeek - 1; i >= 0; i--) {
                const day = prevMonthLastDay - i;
                html += `<div class="calendar-day other-month"><div class="calendar-day-number">${day}</div></div>`;
            }

            // Current month days
            const today = new Date();
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(currentYear, currentMonth, day);
                const dateStr = date.toISOString().split('T')[0];
                const isToday = date.toDateString() === today.toDateString();
                const dayTasks = tasksData.filter(t => t.dueDate === dateStr);
                
                html += `<div class="calendar-day ${isToday ? 'today' : ''}" onclick="openDayTasks('${dateStr}')">
                    <div class="calendar-day-number">${day}</div>
                    <div class="calendar-day-tasks">
                        ${dayTasks.slice(0, 3).map(task => `
                            <div class="calendar-task-dot ${task.priority}" title="${task.title}">
                                ${task.title}
                            </div>
                        `).join('')}
                        ${dayTasks.length > 3 ? `<div style="font-size: 0.75rem; color: #94a3b8;">+${dayTasks.length - 3} more</div>` : ''}
                    </div>
                </div>`;
            }

            // Next month days
            const totalCells = startingDayOfWeek + daysInMonth;
            const remainingCells = 42 - totalCells; // 6 weeks * 7 days
            for (let day = 1; day <= remainingCells && day <= 14; day++) {
                html += `<div class="calendar-day other-month"><div class="calendar-day-number">${day}</div></div>`;
            }

            calendarGrid.innerHTML = html;
        }

        function openDayTasks(dateStr) {
            const dayTasks = tasksData.filter(t => t.dueDate === dateStr);
            if (dayTasks.length === 0) {
                // Open add task modal with date pre-filled
                document.getElementById('taskDueDate').value = dateStr;
                openAddTaskModal();
            } else {
                // Show tasks for that day
                switchTasksView('tasks');
                filterTasks('all');
                // Scroll to first task of that day
                setTimeout(() => {
                    const firstTask = document.querySelector(`[data-task-date="${dateStr}"]`);
                    if (firstTask) {
                        firstTask.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                }, 100);
            }
        }

        async function saveTasksToDB() {
            try {
                // Get DynamoDB instance
                const dynamodb = getDynamoDB();
                if (!dynamodb) {
                    throw new Error('DynamoDB not initialized');
                }
                
                if (!nestMateAuth || !nestMateAuth.currentUser || !nestMateAuth.currentUser.userId) {
                    throw new Error('User not authenticated');
                }
                
                const userId = nestMateAuth.currentUser.userId;
                console.log('Saving tasks to DB for userId:', userId);
                console.log('Tasks data:', tasksData);
                
                const params = {
                    TableName: 'nestmate-users',
                    Key: { userId },
                    UpdateExpression: 'SET tasks = :tasks, lastUpdated = :timestamp',
                    ExpressionAttributeValues: {
                        ':tasks': tasksData,
                        ':timestamp': new Date().toISOString()
                    },
                    ReturnValues: 'UPDATED_NEW'
                };

                const result = await dynamodb.update(params).promise();
                console.log('Tasks saved to DynamoDB successfully:', result);
            } catch (error) {
                console.error('Error saving tasks to DB:', error);
                throw error;
            }
        }

        async function loadTasksData() {
            try {
                if (!nestMateAuth || !nestMateAuth.currentUser || !nestMateAuth.currentUser.userId) {
                    console.warn('No user available for loading tasks');
                    tasksData = [];
                    renderTasks();
                    return;
                }
                
                // Get DynamoDB instance
                const dynamodb = getDynamoDB();
                if (!dynamodb) {
                    console.warn('DynamoDB not initialized, tasks will not load');
                    tasksData = [];
                    renderTasks();
                    return;
                }
                
                const userId = nestMateAuth.currentUser.userId;
                console.log('Loading tasks for userId:', userId);
                
                const params = {
                    TableName: 'nestmate-users',
                    Key: { userId }
                };

                const result = await dynamodb.get(params).promise();
                const userData = result.Item || {};
                tasksData = userData.tasks || [];
                console.log('Tasks loaded from DB:', tasksData.length, tasksData);
                renderTasks();
                // Only render calendar if calendar view is visible
                if (document.getElementById('calendarView') && document.getElementById('calendarView').style.display !== 'none') {
                    renderCalendar();
                }
            } catch (error) {
                console.error('Error loading tasks:', error);
                tasksData = [];
                renderTasks();
            }
        }

        // Renovation Data Management
        let renovationsData = [];

        // Renovation Modal Functions
        function openAddRenovationModal() {
            document.getElementById('renovationModalTitle').textContent = 'Add Renovation Project';
            document.getElementById('renovationForm').reset();
            clearFileLists();
            const modal = document.getElementById('renovationModal');
            modal.style.display = 'block';
            modal.classList.add('show');
            // Create overlay if it doesn't exist
            let overlay = document.querySelector('.modal-overlay');
            if (!overlay) {
                overlay = document.createElement('div');
                overlay.className = 'modal-overlay';
                overlay.onclick = function(e) {
                    if (e.target === overlay) {
                        closeRenovationModal();
                    }
                };
                document.body.appendChild(overlay);
            }
            overlay.classList.add('active');
            overlay.appendChild(modal);
            setupRenovationFileUploads();
        }

        function openEditRenovationModal(renovationId) {
            const renovation = renovationsData.find(r => r.id === renovationId);
            if (!renovation) return;

            document.getElementById('renovationModalTitle').textContent = 'Edit Renovation Project';
            
            // Populate form fields
            document.getElementById('projectName').value = renovation.projectName || '';
            document.getElementById('projectType').value = renovation.projectType || '';
            document.getElementById('startDate').value = renovation.startDate || '';
            document.getElementById('endDate').value = renovation.endDate || '';
            document.getElementById('contractor').value = renovation.contractor || '';
            document.getElementById('contractorPhone').value = renovation.contractorPhone || '';
            document.getElementById('projectDescription').value = renovation.projectDescription || '';
            document.getElementById('totalCost').value = renovation.totalCost || '';
            document.getElementById('status').value = renovation.status || 'planned';
            document.getElementById('warrantyInfo').value = renovation.warrantyInfo || '';
            document.getElementById('notes').value = renovation.notes || '';

            // Store current renovation ID for editing
            document.getElementById('renovationForm').dataset.editingId = renovationId;
            
            clearFileLists();
            displayExistingFiles(renovation);
            const modal = document.getElementById('renovationModal');
            modal.style.display = 'block';
            modal.classList.add('show');
            let overlay = document.querySelector('.modal-overlay');
            if (!overlay) {
                overlay = document.createElement('div');
                overlay.className = 'modal-overlay';
                overlay.onclick = function(e) {
                    if (e.target === overlay) {
                        closeRenovationModal();
                    }
                };
                document.body.appendChild(overlay);
            }
            overlay.classList.add('active');
            overlay.appendChild(modal);
            setupRenovationFileUploads();
        }

        function closeRenovationModal() {
            const modal = document.getElementById('renovationModal');
            modal.style.display = 'none';
            modal.classList.remove('show');
            const overlay = document.querySelector('.modal-overlay');
            if (overlay) {
                overlay.classList.remove('active');
                // Move modal back to body if it was in overlay
                if (overlay.contains(modal)) {
                    document.body.appendChild(modal);
                }
            }
            document.getElementById('renovationForm').reset();
            document.getElementById('renovationForm').dataset.editingId = '';
            clearFileLists();
        }

        function clearFileLists() {
            document.getElementById('receiptList').innerHTML = '';
            document.getElementById('projectPhotosList').innerHTML = '';
            document.getElementById('permitList').innerHTML = '';
        }

        function displayExistingFiles(renovation) {
            // Display existing receipts
            if (renovation.receipts && renovation.receipts.length > 0) {
                renovation.receipts.forEach(receipt => {
                    addFileToList(document.getElementById('receiptList'), receipt.filename, receipt.key, 'renovation');
                });
            }

            // Display existing photos
            if (renovation.photos && renovation.photos.length > 0) {
                renovation.photos.forEach(photo => {
                    addFileToList(document.getElementById('projectPhotosList'), photo.filename, photo.key, 'renovation');
                });
            }

            // Display existing permits
            if (renovation.permits && renovation.permits.length > 0) {
                renovation.permits.forEach(permit => {
                    addFileToList(document.getElementById('permitList'), permit.filename, permit.key, 'renovation');
                });
            }
        }

        function setupRenovationFileUploads() {
            // Setup receipt uploads
            document.getElementById('receiptFiles').onchange = function() {
                handleRenovationFileUpload(this.files, 'receipts', 'receiptList');
            };

            // Setup photo uploads
            document.getElementById('projectPhotos').onchange = function() {
                handleRenovationFileUpload(this.files, 'photos', 'projectPhotosList');
            };

            // Setup permit uploads
            document.getElementById('permitFiles').onchange = function() {
                handleRenovationFileUpload(this.files, 'permits', 'permitList');
            };
        }

        async function handleRenovationFileUpload(files, type, listId) {
            for (let file of files) {
                try {
                    const userId = nestMateAuth.currentUser.userId;
                    const key = `users/${userId}/renovations/${type}/${Date.now()}-${file.name}`;
                    const url = await uploadToS3(file, key);
                    
                    addFileToList(document.getElementById(listId), file.name, key, 'renovation');
                } catch (error) {
                    console.error(`Error uploading ${type} file:`, error);
                    showAlert(`Failed to upload ${file.name}`, 'error');
                }
            }
        }


        async function saveRenovation() {
            try {
                const form = document.getElementById('renovationForm');
                const editingId = form.dataset.editingId;
                
                const renovationData = {
                    projectName: document.getElementById('projectName').value,
                    projectType: document.getElementById('projectType').value,
                    startDate: document.getElementById('startDate').value,
                    endDate: document.getElementById('endDate').value,
                    contractor: document.getElementById('contractor').value,
                    contractorPhone: document.getElementById('contractorPhone').value,
                    projectDescription: document.getElementById('projectDescription').value,
                    totalCost: parseFloat(document.getElementById('totalCost').value) || 0,
                    status: document.getElementById('status').value,
                    warrantyInfo: document.getElementById('warrantyInfo').value,
                    notes: document.getElementById('notes').value,
                    receipts: getFileData('receiptList'),
                    photos: getFileData('projectPhotosList'),
                    permits: getFileData('permitList'),
                    createdAt: editingId ? renovationsData.find(r => r.id === editingId).createdAt : new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                };

                if (editingId) {
                    // Update existing renovation
                    const index = renovationsData.findIndex(r => r.id === editingId);
                    if (index !== -1) {
                        renovationsData[index] = { ...renovationsData[index], ...renovationData };
                    }
                } else {
                    // Add new renovation
                    renovationData.id = Date.now().toString();
                    renovationsData.push(renovationData);
                }

                // Save to DynamoDB
                await saveRenovationsToDB();
                
                // Refresh display
                renderRenovationsList();
                closeRenovationModal();
                showAlert('Renovation project saved successfully!', 'success');

            } catch (error) {
                console.error('Error saving renovation:', error);
                showAlert('Failed to save renovation project', 'error');
            }
        }

        function getFileData(listId) {
            const files = [];
            const list = document.getElementById(listId);
            list.querySelectorAll('.file-item').forEach(item => {
                const name = item.querySelector('.file-name').textContent;
                const viewBtn = item.querySelector('button[onclick*="viewFile"]');
                const removeBtn = item.querySelector('button[onclick*="removeFile"]');
                
                if (viewBtn && removeBtn) {
                    const url = viewBtn.onclick.toString().match(/'([^']+)'/)[1];
                    const key = removeBtn.onclick.toString().match(/'([^']+)'/)[1];
                    files.push({ filename: name, url: url, key: key });
                }
            });
            return files;
        }

        async function saveRenovationsToDB() {
            try {
                const userId = nestMateAuth.currentUser.userId;
                const params = {
                    TableName: 'nestmate-users',
                    Key: { userId },
                    UpdateExpression: 'SET renovations = :renovations, lastUpdated = :timestamp',
                    ExpressionAttributeValues: {
                        ':renovations': renovationsData,
                        ':timestamp': new Date().toISOString()
                    },
                    ReturnValues: 'UPDATED_NEW'
                };

                await dynamodb.update(params).promise();
                console.log('Renovations saved to DynamoDB');
            } catch (error) {
                console.error('Error saving renovations to DB:', error);
                throw error;
            }
        }

        function renderRenovationsList() {
            const list = document.getElementById('renovationsList');
            
            if (renovationsData.length === 0) {
                list.innerHTML = '<p>No renovation projects yet. Click "Add Project" to get started.</p>';
                return;
            }

            list.innerHTML = renovationsData.map(renovation => `
                <div class="renovation-item" style="background: #374151; border: 1px solid #4b5563; border-radius: 0.5rem; padding: 1rem; margin-bottom: 1rem;">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.5rem;">
                        <h4 style="margin: 0; color: #e2e8f0;">${renovation.projectName}</h4>
                        <div style="display: flex; gap: 0.5rem;">
                            <button class="btn btn-sm" onclick="openEditRenovationModal('${renovation.id}')">Edit</button>
                            <button class="btn btn-sm" onclick="exportRenovationPDF('${renovation.id}')">PDF</button>
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 0.5rem; font-size: 0.9rem; color: #9ca3af;">
                        <div><strong>Type:</strong> ${renovation.projectType}</div>
                        <div><strong>Status:</strong> ${renovation.status}</div>
                        <div><strong>Start:</strong> ${renovation.startDate}</div>
                        <div><strong>End:</strong> ${renovation.endDate || 'Ongoing'}</div>
                        <div><strong>Cost:</strong> $${renovation.totalCost || '0'}</div>
                        <div><strong>Contractor:</strong> ${renovation.contractor || 'N/A'}</div>
                    </div>
                    <p style="margin: 0.5rem 0 0 0; color: #d1d5db;">${renovation.projectDescription}</p>
                </div>
            `).join('');
        }

        async function exportRenovationPDF(renovationId) {
            try {
                const renovation = renovationsData.find(r => r.id === renovationId);
                if (!renovation) {
                    showAlert('Renovation project not found', 'error');
                    return;
                }

                showAlert('Generating PDF report...', 'info');

                const response = await fetch('/.netlify/functions/generate-renovation-pdf', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        renovation: renovation,
                        userInfo: {
                            name: nestMateAuth.currentUser.name,
                            email: nestMateAuth.currentUser.email
                        }
                    })
                });

                if (response.ok) {
                    // Check if response is HTML (for browser-based PDF generation)
                    const contentType = response.headers.get('content-type');
                    if (contentType && contentType.includes('text/html')) {
                        // Open HTML in new tab for printing
                        const htmlContent = await response.text();
                        const newWindow = window.open('', '_blank');
                        newWindow.document.write(htmlContent);
                        newWindow.document.close();
                        showAlert('PDF report opened in new tab. Use Ctrl+P to print/save as PDF.', 'success');
                    } else {
                        // Handle as blob for direct download
                        const blob = await response.blob();
                        const url = window.URL.createObjectURL(blob);
                        const link = document.createElement('a');
                        link.href = url;
                        link.download = `${renovation.projectName.replace(/[^a-zA-Z0-9]/g, '_')}_report.pdf`;
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        window.URL.revokeObjectURL(url);
                        showAlert('PDF report generated successfully!', 'success');
                    }
                } else {
                    const errorText = await response.text();
                    console.error('PDF generation failed:', response.status, errorText);
                    throw new Error('PDF generation failed');
                }
            } catch (error) {
                console.error('Error generating PDF:', error);
                showAlert('Failed to generate PDF report', 'error');
            }
        }

        // Initialize dashboard
        // Global error handler for AWS failures and browser extension errors
        window.addEventListener('error', function(e) {
            // Suppress browser extension connection errors (common and harmless)
            if (e.message && (
                e.message.includes('Could not establish connection') ||
                e.message.includes('Receiving end does not exist') ||
                e.message.includes('Extension context invalidated')
            )) {
                // Silently ignore browser extension errors - they're harmless
                e.preventDefault();
                return;
            }
            
            // Handle AWS-related errors
            if (e.message && (e.message.includes('AWS') || e.message.includes('Cognito') || e.message.includes('DynamoDB') || e.message.includes('S3'))) {
                console.warn('AWS service error detected, continuing with fallback:', e.message);
                e.preventDefault();
            }
        });

        // Handle unhandled promise rejections from AWS and browser extensions
        window.addEventListener('unhandledrejection', function(e) {
            // Suppress browser extension connection errors (common and harmless)
            if (e.reason && e.reason.message && (
                e.reason.message.includes('Could not establish connection') ||
                e.reason.message.includes('Receiving end does not exist') ||
                e.reason.message.includes('Extension context invalidated')
            )) {
                // Silently ignore browser extension errors - they're harmless
                e.preventDefault();
                return;
            }
            
            // Handle AWS-related errors
            if (e.reason && (e.reason.message && (e.reason.message.includes('AWS') || e.reason.message.includes('Cognito') || e.reason.message.includes('DynamoDB') || e.reason.message.includes('S3')))) {
                console.warn('AWS promise rejection handled:', e.reason.message);
                e.preventDefault();
            }
        });

        document.addEventListener('DOMContentLoaded', async function() {
            console.log(' Command Center Dashboard Starting...');
            console.log('nestMateAuth object:', nestMateAuth);
            console.log('typeof nestMateAuth:', typeof nestMateAuth);
            
            // Wait a bit for auth to initialize
            await new Promise(resolve => setTimeout(resolve, 500));
            
            // Check authentication and get user
            console.log('Checking authentication...');
            const isAuthenticated = await nestMateAuth.isAuthenticated();
            console.log('Authentication result:', isAuthenticated);
            
            if (!isAuthenticated) {
                console.log('Not authenticated, redirecting to login');
                window.location.href = 'login-aws.html';
                return;
            }

            // Get user info from AWS authentication - try multiple sources
            let user = nestMateAuth.currentUser;
            console.log('Current user from auth after isAuthenticated:', user);
            
            // If no user from auth, try localStorage first (faster)
            if (!user) {
                const storedUser = localStorage.getItem('currentUser');
                if (storedUser) {
                    try {
                        user = JSON.parse(storedUser);
                        console.log('Using stored user from localStorage:', user);
                        // Update nestMateAuth.currentUser for consistency
                        nestMateAuth.currentUser = user;
                    } catch (e) {
                        console.error('Error parsing stored user:', e);
                    }
                }
            }
            
            // If still no user, explicitly call getCurrentUser
            if (!user) {
                try {
                    console.log('No user found, calling getCurrentUser()...');
                    user = await nestMateAuth.getCurrentUser();
                    console.log('Got user from getCurrentUser:', user);
                } catch (e) {
                    console.warn('Failed to get user from getCurrentUser:', e);
                }
            }
            
            // Final check - if still no user, try localStorage again
            if (!user) {
                const storedUser = localStorage.getItem('currentUser');
                if (storedUser) {
                    try {
                        user = JSON.parse(storedUser);
                        console.log('Final attempt - using stored user:', user);
                        nestMateAuth.currentUser = user;
                    } catch (e) {
                        console.error('Error parsing stored user on final attempt:', e);
                    }
                }
            }
            
            if (!user) {
                console.log('No user found after all attempts, redirecting to login');
                window.location.href = 'login-aws.html';
                return;
            }

            const finalUser = user;
            console.log('Final user object:', finalUser);
            
            let displayName = (finalUser && (finalUser.name || (finalUser.email ? finalUser.email.split('@')[0] : ''))) || 'User';
            let displayEmail = (finalUser && finalUser.email) || '';

            // Try to get full user record from DynamoDB
            try {
                if (finalUser && finalUser.userId && nestMateAuth.getUserRecord) {
                    console.log('Loading user record for userId:', finalUser.userId);
                    const rec = await nestMateAuth.getUserRecord(finalUser.userId);
                    console.log('User record result:', rec);
                    if (rec && rec.success && rec.user) {
                        displayName = rec.user.name || displayName;
                        displayEmail = rec.user.email || displayEmail;
                        console.log('Updated display info:', { displayName, displayEmail });
                    }
                }
            } catch (e) {
                console.warn('Failed to load user record, using auth claims:', e);
            }

            console.log('Final display info:', { displayName, displayEmail });
            
            // Force update user display immediately - use any available data
            const finalDisplayName = displayName || (finalUser && finalUser.email ? finalUser.email.split('@')[0] : 'User');
            const finalDisplayEmail = displayEmail || (finalUser && finalUser.email ? finalUser.email : '');
            
            // Always try to update user display immediately
            updateUserDisplayElements(finalDisplayName, finalDisplayEmail, finalUser);
            
            // Load dashboard data
            await loadUserData();
            loadDashboardData();
            
            // Load renovations data
            await loadRenovationsData();
            
            // Load tasks data
            await loadTasksData();
            
            // Update user display after a short delay to ensure auth is loaded
            setTimeout(() => {
                updateUserDisplay();
            }, 100);
            
            // Force update user display multiple times to ensure it works
            setTimeout(() => {
                console.log('Force updating user display (1st attempt)...');
                console.log('Current user:', nestMateAuth.currentUser);
                const storedUser = localStorage.getItem('currentUser');
                console.log('Stored user:', storedUser);
                
                if (nestMateAuth.currentUser && nestMateAuth.currentUser.email) {
                    document.getElementById('userName').textContent = nestMateAuth.currentUser.name || nestMateAuth.currentUser.email.split('@')[0];
                    document.getElementById('userEmail').textContent = nestMateAuth.currentUser.email;
                    document.getElementById('userAvatar').textContent = (nestMateAuth.currentUser.name || nestMateAuth.currentUser.email.split('@')[0]).charAt(0).toUpperCase();
                    console.log('Updated from nestMateAuth.currentUser');
                } else if (storedUser) {
                    try {
                        const parsedUser = JSON.parse(storedUser);
                        if (parsedUser.email) {
                            document.getElementById('userName').textContent = parsedUser.name || parsedUser.email.split('@')[0];
                            document.getElementById('userEmail').textContent = parsedUser.email;
                            document.getElementById('userAvatar').textContent = (parsedUser.name || parsedUser.email.split('@')[0]).charAt(0).toUpperCase();
                            console.log('Updated from localStorage:', parsedUser.email);
                        }
                    } catch (e) {
                        console.error('Error parsing stored user:', e);
                    }
                }
            }, 1000);
            
            // Second attempt after 2 seconds
            setTimeout(() => {
                console.log('Force updating user display (2nd attempt)...');
                const storedUser = localStorage.getItem('currentUser');
                if (storedUser) {
                    try {
                        const parsedUser = JSON.parse(storedUser);
                        if (parsedUser.email) {
                            document.getElementById('userName').textContent = parsedUser.name || parsedUser.email.split('@')[0];
                            document.getElementById('userEmail').textContent = parsedUser.email;
                            document.getElementById('userAvatar').textContent = (parsedUser.name || parsedUser.email.split('@')[0]).charAt(0).toUpperCase();
                            console.log('Final update from localStorage:', parsedUser.email);
                        }
                    } catch (e) {
                        console.error('Error parsing stored user on 2nd attempt:', e);
                    }
                }
            }, 2000);
            
            console.log(' Command Center Dashboard initialized successfully');
        });

        // Load user data from DynamoDB
        async function loadUserData() {
            try {
                console.log('loadUserData called');
                console.log('nestMateAuth.currentUser:', nestMateAuth.currentUser);
                
                // Try to get user from localStorage if not in auth
                let currentUser = nestMateAuth.currentUser;
                if (!currentUser) {
                    const storedUser = localStorage.getItem('currentUser');
                    if (storedUser) {
                        try {
                            currentUser = JSON.parse(storedUser);
                            console.log('Using stored user:', currentUser);
                        } catch (e) {
                            console.error('Error parsing stored user:', e);
                        }
                    }
                }
                
                if (!currentUser) {
                    console.error('No current user found');
                    return;
                }
                
                const userId = currentUser.userId;
                console.log('Loading data for userId:', userId);
                
                const params = {
                    TableName: 'nestmate-users',
                    Key: { userId: userId }
                };
                
                console.log('DynamoDB params:', params);
                const dynamodb = getDynamoDB();
                if (!dynamodb) {
                    throw new Error('DynamoDB not initialized');
                }
                const result = await dynamodb.get(params).promise();
                console.log('DynamoDB result:', result);
                const userData = result.Item || {};
                
                // Load basic info
                const basicInfo = userData.basicInfo || {};
                document.getElementById('displayAddress').textContent = basicInfo.address || 'Not set';
                document.getElementById('displayYearBuilt').textContent = basicInfo.yearBuilt || 'Not set';
                document.getElementById('displaySquareFootage').textContent = basicInfo.squareFootage ? `${basicInfo.squareFootage} sq ft` : 'Not set';
                document.getElementById('displayBedrooms').textContent = basicInfo.bedrooms || 'Not set';
                document.getElementById('displayBathrooms').textContent = basicInfo.bathrooms || 'Not set';
                document.getElementById('displayHomeType').textContent = basicInfo.homeType || 'Not set';
            
                // Load structure info
                const structureInfo = userData.structureInfo || {};
                document.getElementById('displayFoundation').textContent = structureInfo.foundation || 'Not set';
                document.getElementById('displayRoofType').textContent = structureInfo.roofType || 'Not set';
                document.getElementById('displayExterior').textContent = structureInfo.exterior || 'Not set';
                document.getElementById('displayWindows').textContent = structureInfo.windows || 'Not set';
                document.getElementById('displayInsulation').textContent = structureInfo.insulation || 'Not set';
                document.getElementById('displayLastInspection').textContent = structureInfo.lastInspection || 'Not set';
            
            // Load systems info from database
            const systemsInfo = userData.systemsInfo || {};
            document.getElementById('displayHVAC').textContent = systemsInfo.hvac || 'Not set';
            document.getElementById('displayElectrical').textContent = systemsInfo.electrical || 'Not set';
            document.getElementById('displayPlumbing').textContent = systemsInfo.plumbing || 'Not set';
            document.getElementById('displayWaterHeater').textContent = systemsInfo.waterHeater || 'Not set';
            document.getElementById('displaySecurity').textContent = systemsInfo.security || 'Not set';
            document.getElementById('displayLastService').textContent = systemsInfo.lastService || 'Not set';
            
            // Load dynamic bedrooms list
            ensureDashboardState();
            window.dashboardState.bedroomsList = userData.bedroomsList || [];
            if (document.getElementById('bedroomsList')) {
                renderBedroomsList();
            }
            // Load dynamic bathrooms list
            window.dashboardState.bathroomsList = userData.bathroomsList || [];
            if (document.getElementById('bathroomsList')) {
                renderBathroomsList();
            }
            // Load dynamic kitchens list
            window.dashboardState.kitchensList = userData.kitchensList || [];
            if (document.getElementById('kitchensList')) {
                renderKitchensList();
            }
            
            // Load photos data
            console.log('Loading photos data:', userData.photos);
            if (userData.photos && userData.photos.length > 0) {
                photosData = userData.photos;
                console.log('Photos loaded, calling displayPhotos with:', photosData);
                await displayPhotos();
                document.getElementById('photosEmpty').style.display = 'none';
            } else {
                photosData = [];
                console.log('No photos found, showing empty state');
                document.getElementById('photosEmpty').style.display = 'block';
            }
            
            // Load favorites data
            if (userData.favorites && userData.favorites.length > 0) {
                window.favoritesData = userData.favorites;
                displayFavorites();
                document.getElementById('favoritesEmpty').style.display = 'none';
            } else {
                window.favoritesData = [];
                document.getElementById('favoritesEmpty').style.display = 'block';
            }
            
            // Load floor plan data
            if (userData.floorPlan) {
                window.floorPlanData = userData.floorPlan;
                displayFloorPlan();
            } else {
                window.floorPlanData = null;
            }
            
            // Load emergency contacts data
            const emergencyInfo = userData.emergencyInfo || {};
            document.getElementById('displayPolice').textContent = emergencyInfo.police || '911';
            document.getElementById('displayFire').textContent = emergencyInfo.fire || '911';
            document.getElementById('displayElectrician').textContent = emergencyInfo.electrician || '(555) 123-4567';
            document.getElementById('displayPlumber').textContent = emergencyInfo.plumber || '(555) 987-6543';
            document.getElementById('displayEmergencyNotes').textContent = emergencyInfo.notes || 'None';
            
            // Load bathroom info from database (now handled by dynamic bathrooms list)
            // const bathroomsInfo = userData.bathroomsInfo || {};
            // Old static bathroom display elements removed - now using dynamic bathroomsList
            
            // Load kitchen info from database (now handled by dynamic kitchens list)
            // const kitchenInfo = userData.kitchenInfo || {};
            // Old static kitchen display elements removed - now using dynamic kitchensList
            
            // Load living areas info
            const livingInfo = userData.livingInfo || {};
            document.getElementById('displayLivingRoom').textContent = livingInfo.livingRoom || 'Not set';
            document.getElementById('displayDiningRoom').textContent = livingInfo.diningRoom || 'Not set';
            document.getElementById('displayFamilyRoom').textContent = livingInfo.familyRoom || 'Not set';
            document.getElementById('displayLivingFlooring').textContent = livingInfo.livingFlooring || livingInfo.flooring || 'Not set';
            document.getElementById('displayCeilingHeight').textContent = livingInfo.ceilingHeight || 'Not set';
            document.getElementById('displayFireplace').textContent = livingInfo.fireplace || 'Not set';
            
            // Load garage info
            const garageInfo = userData.garageInfo || {};
            document.getElementById('displayGarageType').textContent = garageInfo.garageType || garageInfo.type || 'Not set';
            document.getElementById('displayGarageSize').textContent = garageInfo.garageSize || garageInfo.size || 'Not set';
            document.getElementById('displayGarageDoor').textContent = garageInfo.garageDoor || 'Not set';
            document.getElementById('displayGarageFlooring').textContent = garageInfo.garageFlooring || garageInfo.flooring || 'Not set';
            document.getElementById('displayGarageStorage').textContent = garageInfo.garageStorage || garageInfo.storage || 'Not set';
            document.getElementById('displayGarageElectrical').textContent = garageInfo.garageElectrical || 'Not set';
            
            // Load exterior info
            const exteriorInfo = userData.exteriorInfo || {};
            document.getElementById('displayLotSize').textContent = exteriorInfo.lotSize || 'Not set';
            document.getElementById('displayLandscaping').textContent = exteriorInfo.landscaping || 'Not set';
            document.getElementById('displayDriveway').textContent = exteriorInfo.driveway || 'Not set';
            document.getElementById('displayPatio').textContent = exteriorInfo.patio || 'Not set';
            document.getElementById('displayFencing').textContent = exteriorInfo.fencing || 'Not set';
            document.getElementById('displayPool').textContent = exteriorInfo.pool || 'Not set';
            
            // Load appliances info
            const appliancesInfo = userData.appliancesInfo || {};
            document.getElementById('displayRefrigerator').textContent = appliancesInfo.refrigerator || 'Not set';
            document.getElementById('displayDishwasher').textContent = appliancesInfo.dishwasher || 'Not set';
            document.getElementById('displayWasherDryer').textContent = appliancesInfo.washerDryer || 'Not set';
            document.getElementById('displayStove').textContent = appliancesInfo.stove || 'Not set';
            document.getElementById('displayMicrowave').textContent = appliancesInfo.microwave || 'Not set';
            document.getElementById('displayApplianceService').textContent = appliancesInfo.applianceService || 'Not set';
            
            // Load photos
            if (userData.photos && userData.photos.length > 0) {
                photosData = userData.photos;
                await displayPhotos();
                document.getElementById('photosEmpty').style.display = 'none';
            }
            
            // Load floor plan
            if (userData.floorplan) {
                floorplanData = userData.floorplan;
                displayFloorplan();
            }
            
            } catch (error) {
                console.error('Error loading user data:', error);
                console.error('Error details:', error.message);
                console.error('Error stack:', error.stack);
                showAlert('Failed to load user data: ' + error.message, 'error');
            }
        }

        async function loadRenovationsData() {
            try {
                const userId = nestMateAuth.currentUser.userId;
                const params = {
                    TableName: 'nestmate-users',
                    Key: { userId: userId }
                };
                
                const dynamodb = getDynamoDB();
                if (!dynamodb) {
                    throw new Error('DynamoDB not initialized');
                }
                const result = await dynamodb.get(params).promise();
                
                if (result.Item && result.Item.renovations) {
                    renovationsData = result.Item.renovations;
                    renderRenovationsList();
                    console.log('Renovations data loaded:', renovationsData.length, 'projects');
                } else {
                    renovationsData = [];
                    renderRenovationsList();
                    console.log('No renovations data found');
                }
                
            } catch (error) {
                console.error('Error loading renovations data:', error);
                renovationsData = [];
                renderRenovationsList();
            }
        }

        // Load dashboard data (simplified for testing)
        function loadDashboardData() {
            
            // Set default activity
            const activitySection = document.querySelector('.bottom-section:first-of-type .loading');
            if (activitySection) {
                activitySection.innerHTML = '<p style="color: #94a3b8; text-align: center;">No recent activity</p>';
            }
            
            // Set default energy data
            const energySection = document.querySelector('.bottom-section:last-of-type .loading');
            if (energySection) {
                energySection.innerHTML = `
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div style="text-align: center; padding: 1rem; background: #4a5568; border-radius: 0.5rem;">
                            <div style="color: #00d4aa; font-size: 1.5rem; font-weight: 700;">$450</div>
                            <div style="color: #94a3b8; font-size: 0.875rem;">Saved This Year</div>
                        </div>
                        <div style="text-align: center; padding: 1rem; background: #4a5568; border-radius: 0.5rem;">
                            <div style="color: #00d4aa; font-size: 1.5rem; font-weight: 700;">3</div>
                            <div style="color: #94a3b8; font-size: 0.875rem;">Services This Year</div>
                        </div>
                    </div>
                `;
            }
        }

        // Basic Info CRUD Functions
        function editBasicInfo() {
            document.getElementById('basicInfoDisplay').style.display = 'none';
            const form = document.getElementById('basicInfoForm');
            form.style.display = 'grid';
            form.classList.add('active');
        }

        function cancelEditBasicInfo() {
            document.getElementById('basicInfoDisplay').style.display = 'block';
            const form = document.getElementById('basicInfoForm');
            form.style.display = 'none';
            form.classList.remove('active');
        }

        async function saveBasicInfo() {
            const basicInfo = {
                address: document.getElementById('address').value,
                yearBuilt: document.getElementById('yearBuilt').value,
                squareFootage: document.getElementById('squareFootage').value,
                bedrooms: document.getElementById('bedrooms').value,
                bathrooms: document.getElementById('bathrooms').value,
                homeType: document.getElementById('homeType').value
            };

            try {
                // Save to DynamoDB
                const userId = nestMateAuth.currentUser.userId;
                console.log('Saving basic info for userId:', userId);
                console.log('Basic info data:', basicInfo);
                
                const params = {
                    TableName: 'nestmate-users',
                    Key: { userId: userId },
                    UpdateExpression: 'SET basicInfo = :basic, lastUpdated = :timestamp',
                    ExpressionAttributeValues: {
                        ':basic': basicInfo,
                        ':timestamp': new Date().toISOString()
                    },
                    ReturnValues: 'UPDATED_NEW'
                };
                
                const result = await dynamodb.update(params).promise();
                console.log('Basic info saved to DynamoDB:', result);

                // Update display
                document.getElementById('displayAddress').textContent = basicInfo.address || 'Not set';
                document.getElementById('displayYearBuilt').textContent = basicInfo.yearBuilt || 'Not set';
                document.getElementById('displaySquareFootage').textContent = basicInfo.squareFootage ? `${basicInfo.squareFootage} sq ft` : 'Not set';
                document.getElementById('displayBedrooms').textContent = basicInfo.bedrooms || 'Not set';
                document.getElementById('displayBathrooms').textContent = basicInfo.bathrooms || 'Not set';
                document.getElementById('displayHomeType').textContent = basicInfo.homeType || 'Not set';
                
                // Hide form
                document.getElementById('basicInfoDisplay').style.display = 'block';
                const form = document.getElementById('basicInfoForm');
            form.style.display = 'none';
            form.classList.remove('active');
                
                showAlert('Basic info saved successfully!', 'success');
            } catch (error) {
                console.error('Error saving basic info:', error);
                showAlert('Error saving basic information. Please try again.', 'error');
            }
        }

        // Show alert function
        function showAlert(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.textContent = message;
            alertDiv.style.position = 'fixed';
            alertDiv.style.top = '20px';
            alertDiv.style.right = '20px';
            alertDiv.style.zIndex = '10000';
            alertDiv.style.padding = '1rem';
            alertDiv.style.borderRadius = '0.5rem';
            alertDiv.style.color = type === 'success' ? '#065f46' : '#991b1b';
            alertDiv.style.backgroundColor = type === 'success' ? '#d1fae5' : '#fee2e2';
            alertDiv.style.border = type === 'success' ? '1px solid #a7f3d0' : '1px solid #fca5a5';
            
            document.body.appendChild(alertDiv);
            
            setTimeout(() => {
                alertDiv.remove();
            }, 3000);
        }


        // Update progress bar
        function updateProgressBar(label, percentage) {
            const progressItems = document.querySelectorAll('.progress-item');
            progressItems.forEach(item => {
                const labelElement = item.querySelector('.progress-label');
                if (labelElement.textContent === label) {
                    const progressBar = item.querySelector('.progress-bar');
                    const percentageElement = item.querySelector('.progress-percentage');
                    
                    progressBar.style.width = percentage + '%';
                    percentageElement.textContent = percentage + '%';
                }
            });
        }

        // Load recent activity
        function loadRecentActivity(user) {
            const activitySection = document.querySelector('.bottom-section:first-of-type .loading');
            if (!activitySection) return;
            
            let activities = [];
            
            // Add recent tasks
            if (user.tasks && user.tasks.length > 0) {
                const recentTasks = user.tasks
                    .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt))
                    .slice(0, 3);
                
                activities = activities.concat(recentTasks.map(task => ({
                    type: 'task',
                    title: task.title,
                    date: task.createdAt,
                    icon: 'fas fa-tasks',
                    color: task.status === 'completed' ? '#00d4aa' : '#f59e0b'
                })));
            }
            
            // Add recent maintenance
            if (user.maintenance && user.maintenance.length > 0) {
                const recentMaintenance = user.maintenance
                    .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt))
                    .slice(0, 2);
                
                activities = activities.concat(recentMaintenance.map(maintenance => ({
                    type: 'maintenance',
                    title: maintenance.type + ' - ' + maintenance.description,
                    date: maintenance.createdAt,
                    icon: 'fas fa-wrench',
                    color: '#3b82f6'
                })));
            }
            
            // Sort by date and take top 5
            activities = activities
                .sort((a, b) => new Date(b.date) - new Date(a.date))
                .slice(0, 5);
            
            if (activities.length === 0) {
                activitySection.innerHTML = '<p style="color: #94a3b8; text-align: center;">No recent activity</p>';
                return;
            }
            
            activitySection.innerHTML = activities.map(activity => `
                <div style="display: flex; align-items: center; padding: 0.75rem 0; border-bottom: 1px solid #4a5568;">
                    <i class="${activity.icon}" style="color: ${activity.color}; margin-right: 0.75rem; width: 20px;"></i>
                    <div style="flex: 1;">
                        <div style="color: #ffffff; font-weight: 500;">${activity.title}</div>
                        <div style="color: #94a3b8; font-size: 0.875rem;">${new Date(activity.date).toLocaleDateString()}</div>
                    </div>
                </div>
            `).join('');
        }

        // Load energy & savings data
        function loadEnergySavings(user) {
            const energySection = document.querySelector('.bottom-section:last-of-type .loading');
            if (!energySection) return;
            
            // Calculate savings from service records
            let totalSavings = 0;
            let serviceCount = 0;
            
            if (user.serviceRecords && user.serviceRecords.length > 0) {
                const thisYear = new Date().getFullYear();
                const thisYearServices = user.serviceRecords.filter(record => {
                    const recordYear = new Date(record.date).getFullYear();
                    return recordYear === thisYear;
                });
                
                serviceCount = thisYearServices.length;
                // Estimate savings (this would be calculated based on actual energy data)
                totalSavings = serviceCount * 150; // $150 average savings per service
            }
            
            energySection.innerHTML = `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div style="text-align: center; padding: 1rem; background: #4a5568; border-radius: 0.5rem;">
                        <div style="color: #00d4aa; font-size: 1.5rem; font-weight: 700;">$${totalSavings}</div>
                        <div style="color: #94a3b8; font-size: 0.875rem;">Saved This Year</div>
                    </div>
                    <div style="text-align: center; padding: 1rem; background: #4a5568; border-radius: 0.5rem;">
                        <div style="color: #00d4aa; font-size: 1.5rem; font-weight: 700;">${serviceCount}</div>
                        <div style="color: #94a3b8; font-size: 0.875rem;">Services This Year</div>
                    </div>
                </div>
            `;
        }

        // ===== Dynamic Bedrooms Helpers =====
        function renderBedroomsList() {
            const container = document.getElementById('bedroomsList');
            container.innerHTML = '';
            const list = window.dashboardState?.bedroomsList || [];
            if (list.length === 0) {
                const empty = document.createElement('div');
                empty.className = 'empty-state';
                empty.textContent = 'No bedrooms added yet. Click "Add Bedroom" to create one.';
                container.appendChild(empty);
                return;
            }
            list.forEach((b, idx) => {
                const item = document.createElement('div');
                item.className = 'list-item';
                const details = [
                    b.size && `Size: ${b.size}`,
                    b.ceilingHeight && `Ceiling: ${b.ceilingHeight}`,
                    b.floorType && `Floor: ${b.floorType}`,
                    b.wallColor && `Walls: ${b.wallColor}`,
                    b.trimStyle && `Trim: ${b.trimStyle}`,
                    b.windowCount && `Windows: ${b.windowCount}`,
                    b.windowType && `Type: ${b.windowType}`,
                    b.blindType && `Blinds: ${b.blindType}`,
                    b.curtainStyle && `Curtains: ${b.curtainStyle}`,
                    b.outlets && `Outlets: ${b.outlets}`,
                    b.lightingType && `Lights: ${b.lightingType}`,
                    b.ceilingFan && 'Ceiling Fan',
                    b.closetType && `Closet: ${b.closetType}`,
                    b.attachedBath && 'Attached Bath',
                    b.hvac && `HVAC: ${b.hvac}`,
                    b.condition && `Condition: ${b.condition}`
                ].filter(Boolean).join('  ');
                
                item.innerHTML = `
                    <div class="list-item-main">
                        <div class="list-item-title">${b.name || `Bedroom ${idx + 1}`}</div>
                        <div class="list-item-sub">${details || 'No details added'}</div>
                    </div>
                    <div class="list-item-actions">
                        <button class="btn btn-secondary" onclick="openEditBedroomModal(${idx})"><i class="fas fa-edit"></i></button>
                        <button class="btn btn-secondary" onclick="exportBedroomPDF(${idx})"><i class="fas fa-file-pdf"></i></button>
                        <button class="btn btn-secondary" onclick="deleteBedroom(${idx})"><i class="fas fa-trash"></i></button>
                    </div>
                `;
                container.appendChild(item);
            });
        }

        function ensureDashboardState() {
            if (!window.dashboardState) window.dashboardState = {};
            if (!window.dashboardState.bedroomsList) window.dashboardState.bedroomsList = [];
            if (!window.dashboardState.bathroomsList) window.dashboardState.bathroomsList = [];
            if (!window.dashboardState.kitchensList) window.dashboardState.kitchensList = [];
            return window.dashboardState;
        }

        // ===== Dynamic Kitchens Helpers =====
        function renderKitchensList() {
            const container = document.getElementById('kitchensList');
            if (!container) return;
            container.innerHTML = '';
            const list = ensureDashboardState().kitchensList || [];
            if (list.length === 0) {
                const empty = document.createElement('div');
                empty.className = 'empty-state';
                empty.textContent = 'No kitchens added yet. Click "Add Kitchen" to create one.';
                container.appendChild(empty);
                return;
            }
            list.forEach((k, idx) => {
                const item = document.createElement('div');
                item.className = 'list-item';
                const details = [
                    k.size && `Size: ${k.size}`,
                    k.appliances && `Appliances: ${k.appliances}`,
                    k.countertops && `Countertops: ${k.countertops}`,
                    k.cabinets && `Cabinets: ${k.cabinets}`,
                    k.cabinetTrim && `Cabinet Trim: ${k.cabinetTrim}`,
                    k.flooring && `Flooring: ${k.flooring}`,
                    k.floorTrim && `Floor Trim: ${k.floorTrim}`,
                    k.ceilingTrim && `Ceiling Trim: ${k.ceilingTrim}`,
                    k.condition && `Condition: ${k.condition}`
                ].filter(Boolean).join('  ');
                item.innerHTML = `
                    <div class="list-item-main">
                        <div class="list-item-title">${k.name || `Kitchen ${idx + 1}`}</div>
                        <div class="list-item-sub">${details || 'No details added'}</div>
                    </div>
                    <div class="list-item-actions">
                        <button class="btn btn-secondary" onclick="openKitchenModal(${idx})"><i class="fas fa-edit"></i></button>
                        <button class="btn btn-secondary" onclick="deleteKitchen(${idx})"><i class="fas fa-trash"></i></button>
                    </div>
                `;
                container.appendChild(item);
            });
        }

        function openAddKitchenModal() { openKitchenModal(null); }

        function openKitchenModal(index) {
            const existing = (index !== null && index !== undefined) ? ensureDashboardState().kitchensList[index] : null;
            const overlay = document.createElement('div');
            overlay.className = 'modal-overlay';
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.innerHTML = `
                <h3>${existing ? 'Edit Kitchen' : 'Add Kitchen'}</h3>
                <div class="form-grid">
                    <div class="form-group"><label>Name</label><input id="kName" type="text" placeholder="e.g., Main Kitchen" value="${existing?.name || ''}"></div>
                    <div class="form-group"><label>Size</label><input id="kSize" type="text" placeholder="e.g., 12' x 10'" value="${existing?.size || ''}"></div>
                    <div class="form-group"><label>Appliance Finish</label>
                        <select id="kAppliances">
                            <option value="">Select</option>
                            <option value="stainless-steel" ${existing?.appliances==='stainless-steel'?'selected':''}>Stainless Steel</option>
                            <option value="black-stainless" ${existing?.appliances==='black-stainless'?'selected':''}>Black Stainless</option>
                            <option value="white" ${existing?.appliances==='white'?'selected':''}>White</option>
                            <option value="black" ${existing?.appliances==='black'?'selected':''}>Black</option>
                            <option value="custom" ${existing?.appliances==='custom'?'selected':''}>Custom Color</option>
                        </select>
                    </div>
                    <div class="form-group"><label>Countertop Material</label>
                        <select id="kCountertops">
                            <option value="">Select</option>
                            <option value="granite" ${existing?.countertops==='granite'?'selected':''}>Granite</option>
                            <option value="quartz" ${existing?.countertops==='quartz'?'selected':''}>Quartz</option>
                            <option value="marble" ${existing?.countertops==='marble'?'selected':''}>Marble</option>
                            <option value="butcher-block" ${existing?.countertops==='butcher-block'?'selected':''}>Butcher Block</option>
                            <option value="laminate" ${existing?.countertops==='laminate'?'selected':''}>Laminate</option>
                            <option value="concrete" ${existing?.countertops==='concrete'?'selected':''}>Concrete</option>
                        </select>
                    </div>
                    <div class="form-group"><label>Cabinet Material</label>
                        <select id="kCabinets">
                            <option value="">Select</option>
                            <option value="oak" ${existing?.cabinets==='oak'?'selected':''}>Oak</option>
                            <option value="maple" ${existing?.cabinets==='maple'?'selected':''}>Maple</option>
                            <option value="cherry" ${existing?.cabinets==='cherry'?'selected':''}>Cherry</option>
                            <option value="pine" ${existing?.cabinets==='pine'?'selected':''}>Pine</option>
                            <option value="birch" ${existing?.cabinets==='birch'?'selected':''}>Birch</option>
                            <option value="walnut" ${existing?.cabinets==='walnut'?'selected':''}>Walnut</option>
                            <option value="mdf" ${existing?.cabinets==='mdf'?'selected':''}>MDF</option>
                        </select>
                    </div>
                    <div class="form-group"><label>Cabinet Color</label><input id="kCabinetColor" type="text" placeholder="e.g., White, Natural Oak" value="${existing?.cabinetColor || ''}"></div>
                    <div class="form-group"><label>Cabinet Trim Style</label>
                        <select id="kCabinetTrim">
                            <option value="">Select</option>
                            <option value="shaker" ${existing?.cabinetTrim==='shaker'?'selected':''}>Shaker</option>
                            <option value="raised-panel" ${existing?.cabinetTrim==='raised-panel'?'selected':''}>Raised Panel</option>
                            <option value="flat-panel" ${existing?.cabinetTrim==='flat-panel'?'selected':''}>Flat Panel</option>
                            <option value="beadboard" ${existing?.cabinetTrim==='beadboard'?'selected':''}>Beadboard</option>
                            <option value="crown-molding" ${existing?.cabinetTrim==='crown-molding'?'selected':''}>Crown Molding</option>
                            <option value="none" ${existing?.cabinetTrim==='none'?'selected':''}>None</option>
                        </select>
                    </div>
                    <div class="form-group"><label>Cabinet Hardware</label><input id="kCabinetHardware" type="text" placeholder="e.g., Brushed nickel, Oil-rubbed bronze" value="${existing?.cabinetHardware || ''}"></div>
                    <div class="form-group"><label>Flooring Type</label>
                        <select id="kFlooring">
                            <option value="">Select</option>
                            <option value="hardwood" ${existing?.flooring==='hardwood'?'selected':''}>Hardwood</option>
                            <option value="tile" ${existing?.flooring==='tile'?'selected':''}>Tile</option>
                            <option value="vinyl" ${existing?.flooring==='vinyl'?'selected':''}>Vinyl</option>
                            <option value="laminate" ${existing?.flooring==='laminate'?'selected':''}>Laminate</option>
                            <option value="concrete" ${existing?.flooring==='concrete'?'selected':''}>Concrete</option>
                            <option value="cork" ${existing?.flooring==='cork'?'selected':''}>Cork</option>
                        </select>
                    </div>
                    <div class="form-group"><label>Floor Trim Style</label>
                        <select id="kFloorTrim">
                            <option value="">Select</option>
                            <option value="quarter-round" ${existing?.floorTrim==='quarter-round'?'selected':''}>Quarter Round</option>
                            <option value="shoe-molding" ${existing?.floorTrim==='shoe-molding'?'selected':''}>Shoe Molding</option>
                            <option value="baseboard" ${existing?.floorTrim==='baseboard'?'selected':''}>Baseboard</option>
                            <option value="cove-molding" ${existing?.floorTrim==='cove-molding'?'selected':''}>Cove Molding</option>
                            <option value="none" ${existing?.floorTrim==='none'?'selected':''}>None</option>
                        </select>
                    </div>
                    <div class="form-group"><label>Floor Trim Material</label><input id="kFloorTrimMaterial" type="text" placeholder="e.g., Oak, Pine, MDF" value="${existing?.floorTrimMaterial || ''}"></div>
                    <div class="form-group"><label>Ceiling Trim Style</label>
                        <select id="kCeilingTrim">
                            <option value="">Select</option>
                            <option value="crown-molding" ${existing?.ceilingTrim==='crown-molding'?'selected':''}>Crown Molding</option>
                            <option value="chair-rail" ${existing?.ceilingTrim==='chair-rail'?'selected':''}>Chair Rail</option>
                            <option value="picture-rail" ${existing?.ceilingTrim==='picture-rail'?'selected':''}>Picture Rail</option>
                            <option value="wainscoting" ${existing?.ceilingTrim==='wainscoting'?'selected':''}>Wainscoting</option>
                            <option value="none" ${existing?.ceilingTrim==='none'?'selected':''}>None</option>
                        </select>
                    </div>
                    <div class="form-group"><label>Ceiling Trim Material</label><input id="kCeilingTrimMaterial" type="text" placeholder="e.g., Wood, Polyurethane, Plaster" value="${existing?.ceilingTrimMaterial || ''}"></div>
                    <div class="form-group"><label>Backsplash</label><input id="kBacksplash" type="text" placeholder="e.g., Subway tile, Stone" value="${existing?.backsplash || ''}"></div>
                    <div class="form-group"><label>Lighting</label><input id="kLighting" type="text" placeholder="e.g., Pendant lights, Under-cabinet" value="${existing?.lighting || ''}"></div>
                    <div class="form-group"><label>Island</label>
                        <select id="kIsland">
                            <option value="">Select</option>
                            <option value="yes" ${existing?.island==='yes'?'selected':''}>Yes</option>
                            <option value="no" ${existing?.island==='no'?'selected':''}>No</option>
                        </select>
                    </div>
                    <div class="form-group"><label>Island Details</label><input id="kIslandDetails" type="text" placeholder="e.g., Granite top, Seating for 4" value="${existing?.islandDetails || ''}"></div>
                    <div class="form-group"><label>Last Renovation</label><input id="kLastRenovation" type="date" value="${existing?.lastRenovation || ''}"></div>
                    <div class="form-group"><label>Condition</label>
                        <select id="kCondition">
                            <option value="">Select</option>
                            <option value="excellent" ${existing?.condition==='excellent'?'selected':''}>Excellent</option>
                            <option value="good" ${existing?.condition==='good'?'selected':''}>Good</option>
                            <option value="fair" ${existing?.condition==='fair'?'selected':''}>Fair</option>
                            <option value="poor" ${existing?.condition==='poor'?'selected':''}>Poor</option>
                        </select>
                    </div>
                    <div class="form-group" style="grid-column: 1 / -1;"><label>Notes</label><textarea id="kNotes" rows="3" placeholder="Any details or future plans...">${existing?.notes || ''}</textarea></div>

                    <!-- Uploads -->
                    <div class="form-group" style="grid-column: 1 / -1;">
                        <label>Photos</label>
                        <div class="upload-section">
                            <input type="file" id="kPhotosInput" multiple>
                            <div id="kPhotosList" class="file-list"></div>
                        </div>
                    </div>
                    <div class="form-group" style="grid-column: 1 / -1;">
                        <label>Documents (invoices, permits)</label>
                        <div class="upload-section">
                            <input type="file" id="kDocsInput" multiple>
                            <div id="kDocsList" class="file-list"></div>
                        </div>
                    </div>
                </div>
                <div style="display:flex; gap: .75rem; justify-content:flex-end; margin-top: 1rem;">
                    <button class="btn" id="kSaveBtn"><i class="fas fa-save"></i> Save</button>
                    <button class="btn btn-secondary" id="kCancelBtn"><i class="fas fa-times"></i> Cancel</button>
                </div>
            `;
            overlay.appendChild(modal);
            document.body.appendChild(overlay);

            // Prefill file lists
            const photos = existing?.photos || [];
            const docs = existing?.documents || [];
            const photosList = modal.querySelector('#kPhotosList');
            const docsList = modal.querySelector('#kDocsList');
            photos.forEach(f => addFileToList(photosList, f.name, f.key, 'photo'));
            docs.forEach(f => addFileToList(docsList, f.name, f.key, 'doc'));

            setupFileUpload('kPhotosInput', 'kPhotosList', 'photo');
            setupFileUpload('kDocsInput', 'kDocsList', 'doc');

            const cancelBtn = modal.querySelector('#kCancelBtn');
            const saveBtn = modal.querySelector('#kSaveBtn');
            
            console.log('Kitchen modal buttons found:', { cancelBtn: !!cancelBtn, saveBtn: !!saveBtn });
            
            if (cancelBtn) {
                cancelBtn.onclick = () => {
                    console.log('Cancel button clicked');
                    overlay.remove();
                };
            }
            
            if (saveBtn) {
                saveBtn.onclick = async () => {
                    console.log('Save button clicked');
                    try {
                        const payload = {
                            name: document.getElementById('kName').value.trim(),
                            size: document.getElementById('kSize').value.trim(),
                            appliances: document.getElementById('kAppliances').value,
                            countertops: document.getElementById('kCountertops').value,
                            cabinets: document.getElementById('kCabinets').value,
                            cabinetColor: document.getElementById('kCabinetColor').value.trim(),
                            cabinetTrim: document.getElementById('kCabinetTrim').value,
                            cabinetHardware: document.getElementById('kCabinetHardware').value.trim(),
                            flooring: document.getElementById('kFlooring').value,
                            floorTrim: document.getElementById('kFloorTrim').value,
                            floorTrimMaterial: document.getElementById('kFloorTrimMaterial').value.trim(),
                            ceilingTrim: document.getElementById('kCeilingTrim').value,
                            ceilingTrimMaterial: document.getElementById('kCeilingTrimMaterial').value.trim(),
                            backsplash: document.getElementById('kBacksplash').value.trim(),
                            lighting: document.getElementById('kLighting').value.trim(),
                            island: document.getElementById('kIsland').value,
                            islandDetails: document.getElementById('kIslandDetails').value.trim(),
                            lastRenovation: document.getElementById('kLastRenovation').value,
                            condition: document.getElementById('kCondition').value,
                            notes: document.getElementById('kNotes').value.trim(),
                            photos: getFileData('kPhotosList'),
                            documents: getFileData('kDocsList')
                        };
                        console.log('Kitchen payload:', payload);
                        await upsertKitchen(index, payload);
                        overlay.remove();
                    } catch (error) {
                        console.error('Error saving kitchen:', error);
                        showAlert('Error saving kitchen: ' + error.message, 'error');
                    }
                };
            }
        }

        async function upsertKitchen(index, data) {
            const state = ensureDashboardState();
            if (index === null || index === undefined) state.kitchensList.push(data); else state.kitchensList[index] = data;
            await saveKitchensList();
            renderKitchensList();
            showAlert('Kitchen saved successfully!', 'success');
        }

        async function deleteKitchen(index) {
            const state = ensureDashboardState();
            state.kitchensList.splice(index, 1);
            await saveKitchensList();
            renderKitchensList();
            showAlert('Kitchen removed', 'success');
        }

        async function saveKitchensList() {
            try {
                const userId = nestMateAuth.currentUser.userId;
                const params = {
                    TableName: 'nestmate-users',
                    Key: { userId },
                    UpdateExpression: 'SET kitchensList = :list, lastUpdated = :ts',
                    ExpressionAttributeValues: {
                        ':list': ensureDashboardState().kitchensList,
                        ':ts': new Date().toISOString()
                    },
                    ReturnValues: 'UPDATED_NEW'
                };
                await dynamodb.update(params).promise();
                console.log('kitchensList saved');
            } catch (e) {
                console.error('Save kitchensList error', e);
                showAlert('Failed to save kitchen. Try again.', 'error');
            }
        }

        function openAddBedroomModal() {
            openBedroomModal();
        }

        // ===== Dynamic Bathrooms Helpers =====
        function renderBathroomsList() {
            const container = document.getElementById('bathroomsList');
            if (!container) return;
            container.innerHTML = '';
            const list = ensureDashboardState().bathroomsList || [];
            if (list.length === 0) {
                const empty = document.createElement('div');
                empty.className = 'empty-state';
                empty.textContent = 'No bathrooms added yet. Click "Add Bathroom" to create one.';
                container.appendChild(empty);
                return;
            }
            list.forEach((b, idx) => {
                const item = document.createElement('div');
                item.className = 'list-item';
                const details = [
                    b.type && `Type: ${b.type}`,
                    b.fixtures && `Fixtures: ${b.fixtures}`,
                    b.flooring && `Floor: ${b.flooring}`,
                    b.trimStyle && `Trim: ${b.trimStyle}`,
                    b.ventilation && `Ventilation: ${b.ventilation}`,
                    b.condition && `Condition: ${b.condition}`
                ].filter(Boolean).join('  ');
                item.innerHTML = `
                    <div class="list-item-main">
                        <div class="list-item-title">${b.name || `Bathroom ${idx + 1}`}</div>
                        <div class="list-item-sub">${details || 'No details added'}</div>
                    </div>
                    <div class="list-item-actions">
                        <button class="btn btn-secondary" onclick="openBathroomModal(${idx})"><i class=\"fas fa-edit\"></i></button>
                        <button class="btn btn-secondary" onclick="deleteBathroom(${idx})"><i class=\"fas fa-trash\"></i></button>
                    </div>
                `;
                container.appendChild(item);
            });
        }

        function openAddBathroomModal() { openBathroomModal(null); }

        function openBathroomModal(index) {
            const existing = (index !== null && index !== undefined) ? ensureDashboardState().bathroomsList[index] : null;
            const overlay = document.createElement('div');
            overlay.className = 'modal-overlay';
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.innerHTML = `
                <h3>${existing ? 'Edit Bathroom' : 'Add Bathroom'}</h3>
                <div class="form-grid">
                    <div class="form-group"><label>Name</label><input id="baName" type="text" placeholder="e.g., Master Bath" value="${existing?.name || ''}"></div>
                    <div class="form-group"><label>Type</label>
                        <select id="baType">
                            <option value="">Select</option>
                            <option value="full" ${existing?.type==='full'?'selected':''}>Full</option>
                            <option value="three-quarter" ${existing?.type==='three-quarter'?'selected':''}>3/4 Bath</option>
                            <option value="half" ${existing?.type==='half'?'selected':''}>Half</option>
                            <option value="powder" ${existing?.type==='powder'?'selected':''}>Powder</option>
                        </select>
                    </div>
                    <div class="form-group"><label>Fixtures</label><input id="baFixtures" type="text" placeholder="e.g., Double vanity, Walk-in shower" value="${existing?.fixtures || ''}"></div>
                    <div class="form-group"><label>Flooring</label><input id="baFlooring" type="text" placeholder="e.g., Porcelain tile" value="${existing?.flooring || ''}"></div>
                    <div class="form-group"><label>Wall Color</label><input id="baWallColor" type="text" value="${existing?.wallColor || ''}"></div>
                    <div class="form-group"><label>Trim Style</label><input id="baTrimStyle" type="text" value="${existing?.trimStyle || ''}"></div>
                    <div class="form-group"><label>Trim Color</label><input id="baTrimColor" type="text" value="${existing?.trimColor || ''}"></div>
                    <div class="form-group"><label>Ventilation</label><input id="baVentilation" type="text" placeholder="e.g., Exhaust fan, Window" value="${existing?.ventilation || ''}"></div>
                    <div class="form-group"><label>Last Renovation</label><input id="baLastRenovation" type="date" value="${existing?.lastRenovation || ''}"></div>
                    <div class="form-group"><label>Condition</label>
                        <select id="baCondition">
                            <option value="">Select</option>
                            <option value="excellent" ${existing?.condition==='excellent'?'selected':''}>Excellent</option>
                            <option value="good" ${existing?.condition==='good'?'selected':''}>Good</option>
                            <option value="fair" ${existing?.condition==='fair'?'selected':''}>Fair</option>
                            <option value="poor" ${existing?.condition==='poor'?'selected':''}>Poor</option>
                        </select>
                    </div>
                    <div class="form-group" style="grid-column: 1 / -1;"><label>Notes</label><textarea id="baNotes" rows="3" placeholder="Any details or future plans...">${existing?.notes || ''}</textarea></div>

                    <!-- Uploads -->
                    <div class="form-group" style="grid-column: 1 / -1;">
                        <label>Photos</label>
                        <div class="upload-section">
                            <input type="file" id="baPhotosInput" multiple>
                            <div id="baPhotosList" class="file-list"></div>
                        </div>
                    </div>
                    <div class="form-group" style="grid-column: 1 / -1;">
                        <label>Documents (invoices, permits)</label>
                        <div class="upload-section">
                            <input type="file" id="baDocsInput" multiple>
                            <div id="baDocsList" class="file-list"></div>
                        </div>
                    </div>
                </div>
                <div style="display:flex; gap: .75rem; justify-content:flex-end; margin-top: 1rem;">
                    <button class="btn" id="baSaveBtn"><i class="fas fa-save"></i> Save</button>
                    <button class="btn btn-secondary" id="baCancelBtn"><i class="fas fa-times"></i> Cancel</button>
                </div>
            `;
            overlay.appendChild(modal);
            document.body.appendChild(overlay);

            // Prefill file lists
            const photos = existing?.photos || [];
            const docs = existing?.documents || [];
            const photosList = modal.querySelector('#baPhotosList');
            const docsList = modal.querySelector('#baDocsList');
            photos.forEach(f => addFileToList(photosList, f.name, f.key, 'photo'));
            docs.forEach(f => addFileToList(docsList, f.name, f.key, 'doc'));

            setupFileUpload('baPhotosInput', 'baPhotosList', 'photo');
            setupFileUpload('baDocsInput', 'baDocsList', 'doc');

            modal.querySelector('#baCancelBtn').onclick = () => overlay.remove();
            modal.querySelector('#baSaveBtn').onclick = async () => {
                const payload = {
                    name: document.getElementById('baName').value.trim(),
                    type: document.getElementById('baType').value,
                    fixtures: document.getElementById('baFixtures').value.trim(),
                    flooring: document.getElementById('baFlooring').value.trim(),
                    wallColor: document.getElementById('baWallColor').value.trim(),
                    trimStyle: document.getElementById('baTrimStyle').value.trim(),
                    trimColor: document.getElementById('baTrimColor').value.trim(),
                    ventilation: document.getElementById('baVentilation').value.trim(),
                    lastRenovation: document.getElementById('baLastRenovation').value,
                    condition: document.getElementById('baCondition').value,
                    notes: document.getElementById('baNotes').value.trim(),
                    photos: getFileData('baPhotosList'),
                    documents: getFileData('baDocsList')
                };
                await upsertBathroom(index, payload);
                overlay.remove();
            };
        }

        async function upsertBathroom(index, data) {
            const state = ensureDashboardState();
            if (index === null || index === undefined) state.bathroomsList.push(data); else state.bathroomsList[index] = data;
            await saveBathroomsList();
            renderBathroomsList();
            showAlert('Bathroom saved successfully!', 'success');
        }

        async function deleteBathroom(index) {
            const state = ensureDashboardState();
            state.bathroomsList.splice(index, 1);
            await saveBathroomsList();
            renderBathroomsList();
            showAlert('Bathroom removed', 'success');
        }

        async function saveBathroomsList() {
            try {
                const userId = nestMateAuth.currentUser.userId;
                const params = {
                    TableName: 'nestmate-users',
                    Key: { userId },
                    UpdateExpression: 'SET bathroomsList = :list, lastUpdated = :ts',
                    ExpressionAttributeValues: {
                        ':list': ensureDashboardState().bathroomsList,
                        ':ts': new Date().toISOString()
                    },
                    ReturnValues: 'UPDATED_NEW'
                };
                await dynamodb.update(params).promise();
                console.log('bathroomsList saved');
            } catch (e) {
                console.error('Save bathroomsList error', e);
                showAlert('Failed to save bathroom. Try again.', 'error');
            }
        }

        function openEditBedroomModal(index) {
            const state = ensureDashboardState();
            const data = state.bedroomsList[index];
            openBedroomModal(data, index);
        }

        function openBedroomModal(existing = null, index = null) {
            // build comprehensive modal
            const overlay = document.createElement('div');
            overlay.className = 'modal-overlay';
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.innerHTML = `
                <h3>${existing ? 'Edit Bedroom' : 'Add Bedroom'}</h3>
                <div class="form-grid">
                    <div class="form-group"><label>Name</label><input id="bName" type="text" placeholder="e.g., Primary Bedroom" value="${existing?.name || ''}"></div>
                    <div class="form-group"><label>Size</label><input id="bSize" type="text" placeholder="e.g., 15' x 12'" value="${existing?.size || ''}"></div>
                    <div class="form-group"><label>Ceiling Height</label><input id="bCeilingHeight" type="text" placeholder="e.g., 9 feet" value="${existing?.ceilingHeight || ''}"></div>
                    <div class="form-group"><label>Floor Type</label>
                        <select id="bFloor">
                            <option value="">Select</option>
                            <option value="carpet" ${existing?.floorType === 'carpet' ? 'selected' : ''}>Carpet</option>
                            <option value="hardwood" ${existing?.floorType === 'hardwood' ? 'selected' : ''}>Hardwood</option>
                            <option value="laminate" ${existing?.floorType === 'laminate' ? 'selected' : ''}>Laminate</option>
                            <option value="tile" ${existing?.floorType === 'tile' ? 'selected' : ''}>Tile</option>
                            <option value="vinyl" ${existing?.floorType === 'vinyl' ? 'selected' : ''}>Vinyl</option>
                            <option value="bamboo" ${existing?.floorType === 'bamboo' ? 'selected' : ''}>Bamboo</option>
                            <option value="cork" ${existing?.floorType === 'cork' ? 'selected' : ''}>Cork</option>
                        </select>
                    </div>
                    <div class="form-group"><label>Floor Color/Material</label><input id="bFloorDetails" type="text" placeholder="e.g., Oak, Gray Berber" value="${existing?.floorDetails || ''}"></div>
                    <div class="form-group"><label>Wall Color</label><input id="bWallColor" type="text" placeholder="e.g., Light Blue, White" value="${existing?.wallColor || ''}"></div>
                    <div class="form-group"><label>Trim Style</label>
                        <select id="bTrimStyle">
                            <option value="">Select</option>
                            <option value="colonial" ${existing?.trimStyle === 'colonial' ? 'selected' : ''}>Colonial</option>
                            <option value="craftsman" ${existing?.trimStyle === 'craftsman' ? 'selected' : ''}>Craftsman</option>
                            <option value="modern" ${existing?.trimStyle === 'modern' ? 'selected' : ''}>Modern</option>
                            <option value="traditional" ${existing?.trimStyle === 'traditional' ? 'selected' : ''}>Traditional</option>
                            <option value="minimal" ${existing?.trimStyle === 'minimal' ? 'selected' : ''}>Minimal</option>
                        </select>
                    </div>
                    <div class="form-group"><label>Trim Color</label><input id="bTrimColor" type="text" placeholder="e.g., White, Cream" value="${existing?.trimColor || ''}"></div>
                    <div class="form-group"><label>Window Count</label><input id="bWindowCount" type="number" min="0" placeholder="e.g., 2" value="${existing?.windowCount ?? ''}"></div>
                    <div class="form-group"><label>Window Sizes</label><input id="bWindows" type="text" placeholder="e.g., 36x48, 24x36" value="${existing?.windowSizes || ''}"></div>
                    <div class="form-group"><label>Window Type</label>
                        <select id="bWindowType">
                            <option value="">Select</option>
                            <option value="single-hung" ${existing?.windowType === 'single-hung' ? 'selected' : ''}>Single Hung</option>
                            <option value="double-hung" ${existing?.windowType === 'double-hung' ? 'selected' : ''}>Double Hung</option>
                            <option value="casement" ${existing?.windowType === 'casement' ? 'selected' : ''}>Casement</option>
                            <option value="sliding" ${existing?.windowType === 'sliding' ? 'selected' : ''}>Sliding</option>
                            <option value="bay" ${existing?.windowType === 'bay' ? 'selected' : ''}>Bay</option>
                            <option value="picture" ${existing?.windowType === 'picture' ? 'selected' : ''}>Picture</option>
                        </select>
                    </div>
                    <div class="form-group"><label>Blind Sizes</label><input id="bBlinds" type="text" placeholder="e.g., 36x48, 24x36" value="${existing?.blindSizes || ''}"></div>
                    <div class="form-group"><label>Blind Type</label>
                        <select id="bBlindType">
                            <option value="">Select</option>
                            <option value="venetian" ${existing?.blindType === 'venetian' ? 'selected' : ''}>Venetian</option>
                            <option value="vertical" ${existing?.blindType === 'vertical' ? 'selected' : ''}>Vertical</option>
                            <option value="roller" ${existing?.blindType === 'roller' ? 'selected' : ''}>Roller</option>
                            <option value="cellular" ${existing?.blindType === 'cellular' ? 'selected' : ''}>Cellular</option>
                            <option value="roman" ${existing?.blindType === 'roman' ? 'selected' : ''}>Roman</option>
                            <option value="none" ${existing?.blindType === 'none' ? 'selected' : ''}>None</option>
                        </select>
                    </div>
                    <div class="form-group"><label>Curtain Sizes</label><input id="bCurtains" type="text" placeholder="e.g., 84\" panels" value="${existing?.curtainSizes || ''}"></div>
                    <div class="form-group"><label>Curtain Style</label>
                        <select id="bCurtainStyle">
                            <option value="">Select</option>
                            <option value="grommet" ${existing?.curtainStyle === 'grommet' ? 'selected' : ''}>Grommet</option>
                            <option value="rod-pocket" ${existing?.curtainStyle === 'rod-pocket' ? 'selected' : ''}>Rod Pocket</option>
                            <option value="tab-top" ${existing?.curtainStyle === 'tab-top' ? 'selected' : ''}>Tab Top</option>
                            <option value="pinch-pleat" ${existing?.curtainStyle === 'pinch-pleat' ? 'selected' : ''}>Pinch Pleat</option>
                            <option value="none" ${existing?.curtainStyle === 'none' ? 'selected' : ''}>None</option>
                        </select>
                    </div>
                    <div class="form-group"><label>Electrical Outlets</label><input id="bOutlets" type="number" min="0" placeholder="e.g., 6" value="${existing?.outlets ?? ''}"></div>
                    <div class="form-group"><label>Outlet Type</label>
                        <select id="bOutletType">
                            <option value="">Select</option>
                            <option value="standard" ${existing?.outletType === 'standard' ? 'selected' : ''}>Standard</option>
                            <option value="gfci" ${existing?.outletType === 'gfci' ? 'selected' : ''}>GFCI</option>
                            <option value="usb" ${existing?.outletType === 'usb' ? 'selected' : ''}>USB Outlets</option>
                            <option value="smart" ${existing?.outletType === 'smart' ? 'selected' : ''}>Smart Outlets</option>
                        </select>
                    </div>
                    <div class="form-group"><label>Light Fixtures</label><input id="bLights" type="number" min="0" placeholder="e.g., 2" value="${existing?.lights ?? ''}"></div>
                    <div class="form-group"><label>Lighting Type</label>
                        <select id="bLightingType">
                            <option value="">Select</option>
                            <option value="ceiling-fan" ${existing?.lightingType === 'ceiling-fan' ? 'selected' : ''}>Ceiling Fan</option>
                            <option value="recessed" ${existing?.lightingType === 'recessed' ? 'selected' : ''}>Recessed</option>
                            <option value="chandelier" ${existing?.lightingType === 'chandelier' ? 'selected' : ''}>Chandelier</option>
                            <option value="pendant" ${existing?.lightingType === 'pendant' ? 'selected' : ''}>Pendant</option>
                            <option value="table-lamp" ${existing?.lightingType === 'table-lamp' ? 'selected' : ''}>Table Lamp</option>
                            <option value="floor-lamp" ${existing?.lightingType === 'floor-lamp' ? 'selected' : ''}>Floor Lamp</option>
                            <option value="wall-sconce" ${existing?.lightingType === 'wall-sconce' ? 'selected' : ''}>Wall Sconce</option>
                        </select>
                    </div>
                    <div class="form-group"><label>Ceiling Fan</label>
                        <select id="bCeilingFan">
                            <option value="no" ${existing?.ceilingFan ? '' : 'selected'}>No</option>
                            <option value="yes" ${existing?.ceilingFan ? 'selected' : ''}>Yes</option>
                        </select>
                    </div>
                    <div class="form-group"><label>Fan Brand/Model</label><input id="bFanDetails" type="text" placeholder="e.g., Hunter, 52\"" value="${existing?.fanDetails || ''}"></div>
                    <div class="form-group"><label>Closet Type</label>
                        <select id="bClosetType">
                            <option value="">Select</option>
                            <option value="walk-in" ${existing?.closetType === 'walk-in' ? 'selected' : ''}>Walk-in</option>
                            <option value="reach-in" ${existing?.closetType === 'reach-in' ? 'selected' : ''}>Reach-in</option>
                            <option value="built-in" ${existing?.closetType === 'built-in' ? 'selected' : ''}>Built-in</option>
                            <option value="wardrobe" ${existing?.closetType === 'wardrobe' ? 'selected' : ''}>Wardrobe</option>
                            <option value="none" ${existing?.closetType === 'none' ? 'selected' : ''}>None</option>
                        </select>
                    </div>
                    <div class="form-group"><label>Closet Size</label><input id="bClosetSize" type="text" placeholder="e.g., 6' x 4'" value="${existing?.closetSize || ''}"></div>
                    <div class="form-group"><label>Closet Organization</label>
                        <select id="bClosetOrg">
                            <option value="">Select</option>
                            <option value="hanging-rods" ${existing?.closetOrg === 'hanging-rods' ? 'selected' : ''}>Hanging Rods</option>
                            <option value="shelving" ${existing?.closetOrg === 'shelving' ? 'selected' : ''}>Shelving</option>
                            <option value="drawers" ${existing?.closetOrg === 'drawers' ? 'selected' : ''}>Drawers</option>
                            <option value="custom-system" ${existing?.closetOrg === 'custom-system' ? 'selected' : ''}>Custom System</option>
                            <option value="basic" ${existing?.closetOrg === 'basic' ? 'selected' : ''}>Basic</option>
                        </select>
                    </div>
                    <div class="form-group"><label>Attached Bathroom</label>
                        <select id="bBath">
                            <option value="no" ${existing?.attachedBath ? '' : 'selected'}>No</option>
                            <option value="yes" ${existing?.attachedBath ? 'selected' : ''}>Yes</option>
                        </select>
                    </div>
                    <div class="form-group"><label>Bathroom Access</label>
                        <select id="bBathAccess">
                            <option value="">Select</option>
                            <option value="private" ${existing?.bathAccess === 'private' ? 'selected' : ''}>Private</option>
                            <option value="shared" ${existing?.bathAccess === 'shared' ? 'selected' : ''}>Shared</option>
                            <option value="jack-jill" ${existing?.bathAccess === 'jack-jill' ? 'selected' : ''}>Jack & Jill</option>
                            <option value="none" ${existing?.bathAccess === 'none' ? 'selected' : ''}>None</option>
                        </select>
                    </div>
                    <div class="form-group"><label>Heating/Cooling</label>
                        <select id="bHVAC">
                            <option value="">Select</option>
                            <option value="central" ${existing?.hvac === 'central' ? 'selected' : ''}>Central</option>
                            <option value="window-unit" ${existing?.hvac === 'window-unit' ? 'selected' : ''}>Window Unit</option>
                            <option value="baseboard" ${existing?.hvac === 'baseboard' ? 'selected' : ''}>Baseboard</option>
                            <option value="radiator" ${existing?.hvac === 'radiator' ? 'selected' : ''}>Radiator</option>
                            <option value="none" ${existing?.hvac === 'none' ? 'selected' : ''}>None</option>
                        </select>
                    </div>
                    <div class="form-group"><label>Security Features</label>
                        <select id="bSecurity">
                            <option value="">Select</option>
                            <option value="motion-sensor" ${existing?.security === 'motion-sensor' ? 'selected' : ''}>Motion Sensor</option>
                            <option value="window-sensor" ${existing?.security === 'window-sensor' ? 'selected' : ''}>Window Sensor</option>
                            <option value="door-sensor" ${existing?.security === 'door-sensor' ? 'selected' : ''}>Door Sensor</option>
                            <option value="camera" ${existing?.security === 'camera' ? 'selected' : ''}>Camera</option>
                            <option value="none" ${existing?.security === 'none' ? 'selected' : ''}>None</option>
                        </select>
                    </div>
                    <div class="form-group"><label>Last Renovation</label><input id="bLastRenovation" type="text" placeholder="e.g., 2020" value="${existing?.lastRenovation || ''}"></div>
                    <div class="form-group"><label>Condition</label>
                        <select id="bCondition">
                            <option value="">Select</option>
                            <option value="excellent" ${existing?.condition === 'excellent' ? 'selected' : ''}>Excellent</option>
                            <option value="good" ${existing?.condition === 'good' ? 'selected' : ''}>Good</option>
                            <option value="fair" ${existing?.condition === 'fair' ? 'selected' : ''}>Fair</option>
                            <option value="poor" ${existing?.condition === 'poor' ? 'selected' : ''}>Poor</option>
                            <option value="needs-renovation" ${existing?.condition === 'needs-renovation' ? 'selected' : ''}>Needs Renovation</option>
                        </select>
                    </div>
                    <div class="form-group" style="grid-column: 1 / -1"><label>Notes</label><textarea id="bNotes" rows="3" placeholder="Any additional notes...">${existing?.notes || ''}</textarea></div>
                </div>
                
                <!-- Photo Upload Section -->
                <div class="upload-section">
                    <h4><i class="fas fa-camera"></i> Photos</h4>
                    <div class="upload-grid">
                        <div class="upload-item">
                            <label>Bedroom Photos</label>
                            <input type="file" id="bBedroomPhotos" multiple accept="image/*" style="display: none;">
                            <button type="button" class="btn btn-secondary" onclick="document.getElementById('bBedroomPhotos').click()">
                                <i class="fas fa-plus"></i> Add Photos
                            </button>
                            <div id="bBedroomPhotosList" class="file-list"></div>
                        </div>
                        <div class="upload-item">
                            <label>Renovation Photos</label>
                            <input type="file" id="bRenovationPhotos" multiple accept="image/*" style="display: none;">
                            <button type="button" class="btn btn-secondary" onclick="document.getElementById('bRenovationPhotos').click()">
                                <i class="fas fa-plus"></i> Add Photos
                            </button>
                            <div id="bRenovationPhotosList" class="file-list"></div>
                        </div>
                    </div>
                </div>

                <!-- Document Upload Section -->
                <div class="upload-section">
                    <h4><i class="fas fa-file-alt"></i> Documents</h4>
                    <div class="upload-grid">
                        <div class="upload-item">
                            <label>Invoices & Receipts</label>
                            <input type="file" id="bInvoices" multiple accept=".pdf,.jpg,.jpeg,.png,.doc,.docx" style="display: none;">
                            <button type="button" class="btn btn-secondary" onclick="document.getElementById('bInvoices').click()">
                                <i class="fas fa-plus"></i> Add Documents
                            </button>
                            <div id="bInvoicesList" class="file-list"></div>
                        </div>
                        <div class="upload-item">
                            <label>Work Proof & Permits</label>
                            <input type="file" id="bWorkProof" multiple accept=".pdf,.jpg,.jpeg,.png,.doc,.docx" style="display: none;">
                            <button type="button" class="btn btn-secondary" onclick="document.getElementById('bWorkProof').click()">
                                <i class="fas fa-plus"></i> Add Documents
                            </button>
                            <div id="bWorkProofList" class="file-list"></div>
                        </div>
                    </div>
                </div>

                <div class="form-actions">
                    <button class="btn" id="saveBedroomBtn"><i class="fas fa-save"></i> Save</button>
                    <button class="btn btn-secondary" id="cancelBedroomBtn"><i class="fas fa-times"></i> Cancel</button>
                </div>
            `;
            overlay.appendChild(modal);
            document.body.appendChild(overlay);

            // Setup file upload handlers
            setupFileUpload('bBedroomPhotos', 'bBedroomPhotosList', 'bedroomPhotos');
            setupFileUpload('bRenovationPhotos', 'bRenovationPhotosList', 'renovationPhotos');
            setupFileUpload('bInvoices', 'bInvoicesList', 'invoices');
            setupFileUpload('bWorkProof', 'bWorkProofList', 'workProof');

            function close() { document.body.removeChild(overlay); }
            modal.querySelector('#cancelBedroomBtn').onclick = close;
            modal.querySelector('#saveBedroomBtn').onclick = async () => {
                const payload = {
                    name: document.getElementById('bName').value.trim(),
                    size: document.getElementById('bSize').value.trim(),
                    ceilingHeight: document.getElementById('bCeilingHeight').value.trim(),
                    floorType: document.getElementById('bFloor').value,
                    floorDetails: document.getElementById('bFloorDetails').value.trim(),
                    wallColor: document.getElementById('bWallColor').value.trim(),
                    trimStyle: document.getElementById('bTrimStyle').value,
                    trimColor: document.getElementById('bTrimColor').value.trim(),
                    windowCount: Number(document.getElementById('bWindowCount').value || 0),
                    windowSizes: document.getElementById('bWindows').value.trim(),
                    windowType: document.getElementById('bWindowType').value,
                    blindSizes: document.getElementById('bBlinds').value.trim(),
                    blindType: document.getElementById('bBlindType').value,
                    curtainSizes: document.getElementById('bCurtains').value.trim(),
                    curtainStyle: document.getElementById('bCurtainStyle').value,
                    outlets: Number(document.getElementById('bOutlets').value || 0),
                    outletType: document.getElementById('bOutletType').value,
                    lights: Number(document.getElementById('bLights').value || 0),
                    lightingType: document.getElementById('bLightingType').value,
                    ceilingFan: document.getElementById('bCeilingFan').value === 'yes',
                    fanDetails: document.getElementById('bFanDetails').value.trim(),
                    closetType: document.getElementById('bClosetType').value,
                    closetSize: document.getElementById('bClosetSize').value.trim(),
                    closetOrg: document.getElementById('bClosetOrg').value,
                    attachedBath: document.getElementById('bBath').value === 'yes',
                    bathAccess: document.getElementById('bBathAccess').value,
                    hvac: document.getElementById('bHVAC').value,
                    security: document.getElementById('bSecurity').value,
                    lastRenovation: document.getElementById('bLastRenovation').value.trim(),
                    condition: document.getElementById('bCondition').value,
                    notes: document.getElementById('bNotes').value.trim(),
                    // File data
                    bedroomPhotos: getFileData('bBedroomPhotosList'),
                    renovationPhotos: getFileData('bRenovationPhotosList'),
                    invoices: getFileData('bInvoicesList'),
                    workProof: getFileData('bWorkProofList')
                };
                await upsertBedroom(index, payload);
                close();
            };
        }

        async function upsertBedroom(index, data) {
            const state = ensureDashboardState();
            if (index === null || index === undefined) state.bedroomsList.push(data); else state.bedroomsList[index] = data;
            await saveBedroomsList();
            renderBedroomsList();
            showAlert('Bedroom saved successfully!', 'success');
        }

        async function deleteBedroom(index) {
            const state = ensureDashboardState();
            state.bedroomsList.splice(index, 1);
            await saveBedroomsList();
            renderBedroomsList();
            showAlert('Bedroom removed', 'success');
        }

        async function saveBedroomsList() {
            try {
                const userId = nestMateAuth.currentUser.userId;
                const params = {
                    TableName: 'nestmate-users',
                    Key: { userId },
                    UpdateExpression: 'SET bedroomsList = :list, lastUpdated = :ts',
                    ExpressionAttributeValues: {
                        ':list': window.dashboardState.bedroomsList,
                        ':ts': new Date().toISOString()
                    },
                    ReturnValues: 'UPDATED_NEW'
                };
                await dynamodb.update(params).promise();
                console.log('bedroomsList saved');
            } catch (e) {
                console.error('Save bedroomsList error', e);
                showAlert('Failed to save bedroom. Try again.', 'error');
            }
        }

        // File upload helpers
        function setupFileUpload(inputId, listId, type) {
            const input = document.getElementById(inputId);
            const list = document.getElementById(listId);
            
            input.addEventListener('change', async (e) => {
                const files = Array.from(e.target.files);
                for (const file of files) {
                    await uploadFile(file, list, type);
                }
                input.value = ''; // Clear input
            });
        }

        async function uploadFile(file, listContainer, type) {
            try {
                // Get presigned URL for upload
                const response = await fetch('/.netlify/functions/s3-presign', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        fileName: file.name,
                        fileType: file.type,
                        folder: `bedrooms/${type}`
                    })
                });
                
                const { uploadUrl, fileKey } = await response.json();
                
                // Upload file to S3
                await fetch(uploadUrl, {
                    method: 'PUT',
                    body: file,
                    headers: { 'Content-Type': file.type }
                });
                
                // Add to UI
                addFileToList(listContainer, file.name, fileKey, type);
                
            } catch (error) {
                console.error('Upload error:', error);
                showAlert('Failed to upload file', 'error');
            }
        }

        function addFileToList(container, fileName, fileKey, type) {
            const fileItem = document.createElement('div');
            fileItem.className = 'file-item';
            fileItem.innerHTML = `
                <span class="file-name">${fileName}</span>
                <div class="file-actions">
                    <button class="btn btn-secondary" onclick="viewFile('${fileKey}')">
                        <i class="fas fa-eye"></i>
                    </button>
                    <button class="btn btn-secondary" onclick="removeFile(this, '${fileKey}')">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `;
            container.appendChild(fileItem);
        }

        function getFileData(listId) {
            const list = document.getElementById(listId);
            const files = [];
            list.querySelectorAll('.file-item').forEach(item => {
                const name = item.querySelector('.file-name').textContent;
                const viewBtn = item.querySelector('button[onclick*="viewFile"]');
                let fileKey = null;
                
                if (viewBtn && viewBtn.onclick) {
                    try {
                        const onclickStr = viewBtn.onclick.toString();
                        const match = onclickStr.match(/'([^']+)'/);
                        if (match && match[1]) {
                            fileKey = match[1];
                        }
                    } catch (error) {
                        console.error('Error extracting file key:', error);
                    }
                }
                
                if (fileKey && fileKey !== 'undefined') {
                    files.push({ name, key: fileKey });
                } else {
                    console.warn('Could not extract file key for:', name);
                }
            });
            return files;
        }

        function viewFile(fileKey) {
            // Extract filename from key for display
            const filename = fileKey.split('/').pop() || 'Photo';
            // Open in photo viewer with presigned URL
            window.open(`photo-viewer.html?key=${encodeURIComponent(fileKey)}&filename=${encodeURIComponent(filename)}`, '_blank');
        }

        function removeFile(button, fileKey) {
            button.closest('.file-item').remove();
            // TODO: Also delete from S3
        }

        // PDF Export functionality
        async function exportBedroomPDF(bedroomIndex) {
            console.log('exportBedroomPDF called with index:', bedroomIndex);
            try {
                const bedroom = window.dashboardState.bedroomsList[bedroomIndex];
                console.log('Bedroom found:', bedroom);
                if (!bedroom) {
                    showAlert('Bedroom not found', 'error');
                    return;
                }

                // Debug logging
                console.log('Exporting bedroom:', bedroom);
                console.log('Bedroom photos:', bedroom.bedroomPhotos);
                console.log('Renovation photos:', bedroom.renovationPhotos);
                console.log('Invoices:', bedroom.invoices);
                console.log('Work proof:', bedroom.workProof);
                
                // Check if bedroom has any data at all
                if (!bedroom.name && !bedroom.size && !bedroom.ceilingHeight) {
                    console.warn('Bedroom appears to be empty or has no data');
                }
                
                // Check if we have any files at all
                const hasFiles = (bedroom.bedroomPhotos && bedroom.bedroomPhotos.length > 0) ||
                               (bedroom.renovationPhotos && bedroom.renovationPhotos.length > 0) ||
                               (bedroom.invoices && bedroom.invoices.length > 0) ||
                               (bedroom.workProof && bedroom.workProof.length > 0);
                console.log('Has files:', hasFiles);
                
                if (!hasFiles) {
                    console.warn('No files attached to this bedroom');
                    console.log('Bedroom object keys:', Object.keys(bedroom));
                }
                
                // Test with sample data if no files
                if (!hasFiles) {
                    console.log('Adding sample file data for testing...');
                    bedroom.bedroomPhotos = [{ name: "test.jpg", key: "uploads/1759665351262_test.txt" }];
                    bedroom.renovationPhotos = [{ name: "test2.jpg", key: "uploads/1759665439242_test.txt" }];
                }

                showAlert('Generating PDF report...', 'info');
                
                const response = await fetch('/.netlify/functions/generate-bedroom-pdf-simple', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        bedroom: bedroom,
                        userInfo: {
                            name: nestMateAuth.currentUser.name,
                            email: nestMateAuth.currentUser.email
                        }
                    })
                });

                if (response.ok) {
                    // Open the HTML report in a new tab for printing/saving as PDF
                    const htmlContent = await response.text();
                    console.log('Report HTML received:', htmlContent.substring(0, 500) + '...');
                    const newWindow = window.open('', '_blank');
                    newWindow.document.write(htmlContent);
                    newWindow.document.close();
                    showAlert('Report opened in new tab. Use Ctrl+P to print/save as PDF!', 'success');
                } else {
                    const errorText = await response.text();
                    console.error('Report generation failed:', response.status, errorText);
                    throw new Error(`Report generation failed: ${response.status} - ${errorText}`);
                }
            } catch (error) {
                console.error('PDF export error:', error);
                showAlert('Failed to generate PDF report', 'error');
            }
        }

        // Account Management Modal
        function openAccountModal() {
            const modal = document.createElement('div');
            modal.className = 'account-modal';
            modal.innerHTML = `
                <div class="account-modal-content">
                    <div class="account-modal-header">
                        <h2><i class="fas fa-user-cog"></i> Account Management</h2>
                        <button class="account-modal-close" onclick="closeAccountModal()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="account-modal-body">
                        <!-- Profile Information -->
                        <div class="account-section">
                            <h3><i class="fas fa-user"></i> Profile Information</h3>
                            <div class="account-info-grid">
                                <div class="account-info-item">
                                    <div class="account-info-label">Full Name</div>
                                    <div class="account-info-value" id="accountName">${nestMateAuth.currentUser.name || 'Not set'}</div>
                                </div>
                                <div class="account-info-item">
                                    <div class="account-info-label">Email Address</div>
                                    <div class="account-info-value" id="accountEmail">${nestMateAuth.currentUser.email || 'Not set'}</div>
                                </div>
                                <div class="account-info-item">
                                    <div class="account-info-label">Phone Number</div>
                                    <div class="account-info-value" id="accountPhone">${nestMateAuth.currentUser.phone || 'Not set'}</div>
                                </div>
                                <div class="account-info-item">
                                    <div class="account-info-label">Account Created</div>
                                    <div class="account-info-value" id="accountCreated">${new Date().toLocaleDateString()}</div>
                                </div>
                            </div>
                            <div class="account-actions">
                                <button class="btn btn-secondary" onclick="editProfile()">
                                    <i class="fas fa-edit"></i> Edit Profile
                                </button>
                            </div>
                        </div>

                        <!-- Subscription Information -->
                        <div class="account-section">
                            <h3><i class="fas fa-credit-card"></i> Subscription</h3>
                            <div class="subscription-plan">
                                <div class="plan-name" id="planName">Basic Plan</div>
                                <div class="plan-status ${getSubscriptionStatus()}" id="planStatus">
                                    ${getSubscriptionStatus() === 'active' ? 'Active' : 'Inactive'}
                                </div>
                                <div class="account-info-grid">
                                    <div class="account-info-item">
                                        <div class="account-info-label">Plan Type</div>
                                        <div class="account-info-value" id="planType">Basic Monthly</div>
                                    </div>
                                    <div class="account-info-item">
                                        <div class="account-info-label">Next Billing</div>
                                        <div class="account-info-value" id="nextBilling">Not set</div>
                                    </div>
                                </div>
                            </div>
                            <div class="account-actions">
                                <button class="btn btn-primary" onclick="manageSubscription()">
                                    <i class="fas fa-credit-card"></i> Manage Subscription
                                </button>
                                <button class="btn btn-secondary" onclick="upgradePlan()">
                                    <i class="fas fa-arrow-up"></i> Upgrade Plan
                                </button>
                            </div>
                        </div>

                        <!-- Security -->
                        <div class="account-section">
                            <h3><i class="fas fa-shield-alt"></i> Security</h3>
                            <div class="account-info-grid">
                                <div class="account-info-item">
                                    <div class="account-info-label">Email Verified</div>
                                    <div class="account-info-value" id="emailVerified">
                                        ${nestMateAuth.currentUser.emailVerified ? 'Yes' : 'No'}
                                    </div>
                                </div>
                                <div class="account-info-item">
                                    <div class="account-info-label">Last Login</div>
                                    <div class="account-info-value" id="lastLogin">${new Date().toLocaleString()}</div>
                                </div>
                            </div>
                            <div class="account-actions">
                                <button class="btn btn-secondary" onclick="changePassword()">
                                    <i class="fas fa-key"></i> Change Password
                                </button>
                                <button class="btn btn-secondary" onclick="resendVerification()">
                                    <i class="fas fa-envelope"></i> Resend Verification
                                </button>
                            </div>
                        </div>

                        <!-- Data Management -->
                        <div class="account-section">
                            <h3><i class="fas fa-database"></i> Data Management</h3>
                            <div class="account-actions">
                                <button class="btn btn-secondary" onclick="exportData()">
                                    <i class="fas fa-download"></i> Export Data
                                </button>
                                <button class="btn btn-danger" onclick="deleteAccount()">
                                    <i class="fas fa-trash"></i> Delete Account
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Close modal when clicking outside
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closeAccountModal();
                }
            });
        }

        function closeAccountModal() {
            const modal = document.querySelector('.account-modal');
            if (modal) {
                document.body.removeChild(modal);
            }
        }

        function getSubscriptionStatus() {
            // This would check the actual subscription status from DynamoDB
            return 'active'; // Placeholder
        }

        function editProfile() {
            openProfileEditModal();
        }

        async function manageSubscription() {
            try {
                showAlert('Opening subscription management...', 'info');
                
                const response = await fetch('/.netlify/functions/create-customer-portal', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userId: nestMateAuth.currentUser.userId })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    window.open(data.url, '_blank');
                } else {
                    throw new Error(data.error || 'Failed to open customer portal');
                }
            } catch (error) {
                console.error('Subscription management error:', error);
                showAlert('Failed to open subscription management', 'error');
            }
        }

        function upgradePlan() {
            // Use your actual Stripe payment links
            const upgradeUrl = 'https://buy.stripe.com/your-upgrade-link';
            window.open(upgradeUrl, '_blank');
        }

        function changePassword() {
            openPasswordChangeModal();
        }

        async function resendVerification() {
            try {
                showAlert('Sending verification email...', 'info');
                
                const response = await fetch('/.netlify/functions/resend-verification', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email: nestMateAuth.currentUser.email })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    showAlert('Verification email sent!', 'success');
                } else {
                    throw new Error(data.error || 'Failed to send verification email');
                }
            } catch (error) {
                console.error('Resend verification error:', error);
                showAlert(error.message || 'Failed to send verification email', 'error');
            }
        }

        async function exportData() {
            try {
                showAlert('Preparing data export...', 'info');
                
                const response = await fetch('/.netlify/functions/export-user-data', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userId: nestMateAuth.currentUser.userId })
                });
                
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `nestmate-export-${new Date().toISOString().split('T')[0]}.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                    showAlert('Data exported successfully!', 'success');
                } else {
                    const data = await response.json();
                    throw new Error(data.error || 'Failed to export data');
                }
            } catch (error) {
                console.error('Data export error:', error);
                showAlert(error.message || 'Failed to export data', 'error');
            }
        }

        function deleteAccount() {
            if (confirm('Are you sure you want to delete your account? This action cannot be undone.')) {
                showAlert('Account deletion coming soon!', 'warning');
            }
        }

        // Profile Edit Modal
        function openProfileEditModal() {
            const modal = document.createElement('div');
            modal.className = 'account-modal';
            modal.innerHTML = `
                <div class="account-modal-content">
                    <div class="account-modal-header">
                        <h2><i class="fas fa-edit"></i> Edit Profile</h2>
                        <button class="account-modal-close" onclick="closeAccountModal()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="account-modal-body">
                        <div class="form-group">
                            <label for="editName">Full Name</label>
                            <input type="text" id="editName" value="${nestMateAuth.currentUser.name || ''}" placeholder="Enter your full name">
                        </div>
                        <div class="form-group">
                            <label for="editPhone">Phone Number</label>
                            <input type="tel" id="editPhone" value="${nestMateAuth.currentUser.phone || ''}" placeholder="Enter your phone number">
                        </div>
                        <div class="form-actions">
                            <button class="btn btn-primary" onclick="saveProfileChanges()">
                                <i class="fas fa-save"></i> Save Changes
                            </button>
                            <button class="btn btn-secondary" onclick="closeAccountModal()">
                                <i class="fas fa-times"></i> Cancel
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        // Password Change Modal
        function openPasswordChangeModal() {
            const modal = document.createElement('div');
            modal.className = 'account-modal';
            modal.innerHTML = `
                <div class="account-modal-content">
                    <div class="account-modal-header">
                        <h2><i class="fas fa-key"></i> Change Password</h2>
                        <button class="account-modal-close" onclick="closeAccountModal()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="account-modal-body">
                        <div class="form-group">
                            <label for="newPassword">New Password</label>
                            <input type="password" id="newPassword" placeholder="Enter new password">
                        </div>
                        <div class="form-group">
                            <label for="confirmPassword">Confirm New Password</label>
                            <input type="password" id="confirmPassword" placeholder="Confirm new password">
                        </div>
                        <div class="form-actions">
                            <button class="btn btn-primary" onclick="savePasswordChange()">
                                <i class="fas fa-save"></i> Change Password
                            </button>
                            <button class="btn btn-secondary" onclick="closeAccountModal()">
                                <i class="fas fa-times"></i> Cancel
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        async function saveProfileChanges() {
            try {
                const name = document.getElementById('editName').value.trim();
                const phone = document.getElementById('editPhone').value.trim();
                
                if (!name) {
                    showAlert('Name is required', 'error');
                    return;
                }
                
                showAlert('Updating profile...', 'info');
                
                const response = await fetch('/.netlify/functions/update-profile', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        userId: nestMateAuth.currentUser.userId,
                        name: name,
                        phone: phone
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    // Update local user data
                    nestMateAuth.currentUser.name = name;
                    nestMateAuth.currentUser.phone = phone;
                    
                    // Update display
                    document.getElementById('userName').textContent = name;
                    document.getElementById('userEmail').textContent = nestMateAuth.currentUser.email;
                    
                    closeAccountModal();
                    showAlert('Profile updated successfully!', 'success');
                } else {
                    throw new Error(data.error || 'Failed to update profile');
                }
            } catch (error) {
                console.error('Profile update error:', error);
                showAlert(error.message || 'Failed to update profile', 'error');
            }
        }

        async function savePasswordChange() {
            try {
                const newPassword = document.getElementById('newPassword').value;
                const confirmPassword = document.getElementById('confirmPassword').value;
                
                if (!newPassword || !confirmPassword) {
                    showAlert('All fields are required', 'error');
                    return;
                }
                
                if (newPassword !== confirmPassword) {
                    showAlert('New passwords do not match', 'error');
                    return;
                }
                
                if (newPassword.length < 8) {
                    showAlert('New password must be at least 8 characters', 'error');
                    return;
                }
                
                showAlert('Changing password...', 'info');
                
                const response = await fetch('/.netlify/functions/change-password', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        userId: nestMateAuth.currentUser.userId,
                        newPassword: newPassword
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    closeAccountModal();
                    showAlert('Password changed successfully!', 'success');
                } else {
                    throw new Error(data.error || 'Failed to change password');
                }
            } catch (error) {
                console.error('Password change error:', error);
                showAlert(error.message || 'Failed to change password', 'error');
            }
        }

        // Extend loadUserData to pull bedroomsList
        // ... existing code ...

    </script>
</body>
</html>