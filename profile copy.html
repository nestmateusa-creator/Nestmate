<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Edit Profile | NestMate</title>
  <link rel="stylesheet" href="styles/main.css">
  <script type="module" defer src="./profile-firebase-delete.js"></script>
  
  <!-- Firebase CDN -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      background: linear-gradient(120deg, #e0e7ff 0%, #f8fafc 100%);
      color: #1e293b;
      margin: 0;
      min-height: 100vh;
    }
    .profile-container {
      max-width: 420px;
      margin: 48px auto;
      background: #fff;
      border-radius: 18px;
      box-shadow: 0 4px 32px rgba(37,99,235,0.10);
      padding: 36px 28px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .profile-photo {
      width: 110px;
      height: 110px;
      border-radius: 50%;
      object-fit: cover;
      box-shadow: 0 2px 12px #2563eb22;
      margin-bottom: 18px;
      background: #f1f5f9;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }
    .profile-photo input {
      display: none;
    }
    .edit-photo-btn {
      background: #2563eb;
      color: #fff;
      border: none;
      border-radius: 10px;
      padding: 8px 18px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      margin-bottom: 18px;
      box-shadow: 0 2px 8px #2563eb22;
      transition: background 0.18s;
    }
    .edit-photo-btn:hover {
      background: #1d4ed8;
    }
    .profile-form {
      width: 100%;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    .profile-form label {
      font-weight: 600;
      color: #2563eb;
      margin-bottom: 4px;
    }
    .profile-form input {
      padding: 10px 12px;
      border-radius: 8px;
      border: 1.5px solid #e5e7eb;
      font-size: 1.08rem;
      outline: none;
    }
  </style>
  </script>

  <body>
    <div style="display:flex;gap:18px;margin:32px auto 0 auto;justify-content:center;flex-wrap:nowrap;width:100%;max-width:900px;align-items:center;">
      <a href="dashboard.html" style="background:#2563eb;color:#fff;border:none;border-radius:12px;padding:12px 32px;font-size:1.1rem;font-weight:700;text-decoration:none;box-shadow:0 2px 12px #2563eb22;display:inline-flex;align-items:center;gap:8px;transition:background 0.18s;">üè° My Home</a>
      <a href="shop-for-my-home.html" style="background:linear-gradient(90deg,#2563eb 60%,#facc15 100%);color:#fff;border:none;border-radius:12px;padding:12px 32px;font-size:1.1rem;font-weight:700;text-decoration:none;box-shadow:0 2px 12px #2563eb22;display:inline-flex;align-items:center;gap:8px;transition:background 0.18s;">üõí Shop for my home</a>
  <a href="compare-contractor-bids.html" style="background:#2563eb;color:#fff;border:none;border-radius:12px;padding:12px 32px;font-size:1.1rem;font-weight:700;text-decoration:none;box-shadow:0 2px 12px #2563eb22;display:inline-flex;align-items:center;gap:8px;transition:background 0.18s;">Compare Contractor Bids</a>
  <a href="pricing.html" style="background:linear-gradient(90deg,#facc15 60%,#2563eb 100%);color:#fff;border:none;border-radius:12px;padding:12px 28px;font-size:1.08rem;font-weight:700;text-decoration:none;box-shadow:0 2px 12px #facc1522;display:inline-flex;align-items:center;gap:8px;transition:background 0.18s;">‚¨ÜÔ∏è Upgrade Account</a>
    </div>
    <div class="profile-container">
      <h2>Edit Profile</h2>
      <div class="profile-photo">
        <img id="profilePhoto" src="https://ui-avatars.com/api/?name=User" alt="Profile Photo" style="width:100%;height:100%;object-fit:cover;" />
      </div>
      <label class="edit-photo-btn" for="profilePhotoInput">Change Photo</label>
      <input type="file" id="profilePhotoInput" accept="image/*" style="display:none;" />
      <form id="profileForm" class="profile-form">
        <label for="profileName">Name</label>
        <input type="text" id="profileName" required />
        <label for="profileEmail">Email</label>
        <input type="email" id="profileEmail" required />
        <label for="profilePhone">Phone</label>
        <input type="tel" id="profilePhone" />
        <label for="profileAddress">Address</label>
        <input type="text" id="profileAddress" />
        <button type="submit">Save Profile</button>
        <div id="profileSuccess" style="color:green;"></div>
        <div id="profileError" style="color:red;"></div>
      </form>
      <button id="logoutBtn" style="margin-top:18px;background:#f87171;color:#fff;border:none;padding:10px 20px;border-radius:8px;cursor:pointer;">Logout</button>
      <hr style="margin:32px 0;width:100%;border:0;border-top:1.5px solid #e5e7eb;" />
      
      <!-- Subscription Management -->
      <h3>Subscription Management</h3>
      <div id="subscriptionInfo" style="background:#f8fafc;padding:16px;border-radius:8px;margin-bottom:16px;">
        <p><strong>Current Plan:</strong> <span id="currentPlan">Loading...</span></p>
        <p><strong>Status:</strong> <span id="subscriptionStatus">Loading...</span></p>
      </div>
      <button id="cancelSubscriptionBtn" style="background:#ef4444;color:#fff;border:none;padding:10px 20px;border-radius:8px;cursor:pointer;margin-bottom:16px;">Cancel Subscription</button>
      <div id="subscriptionMessage" style="color:green;margin-bottom:16px;"></div>
      <div id="subscriptionError" style="color:red;margin-bottom:16px;"></div>
      
      <hr style="margin:32px 0;width:100%;border:0;border-top:1.5px solid #e5e7eb;" />
      <h3>Delete Account</h3>
      <form id="deleteAccountForm" style="display:flex;flex-direction:column;gap:10px;">
        <input type="password" id="deletePassword" placeholder="Enter password to confirm" required />
        <button type="submit" style="background:#ef4444;color:#fff;border:none;padding:10px 20px;border-radius:8px;cursor:pointer;">Delete Account</button>
        <div id="deleteAccountError" style="color:red;"></div>
        <div id="deleteAccountSuccess" style="color:green;"></div>
      </form>
    </div>
  </body>
  <script type="module" src="./profile-firebase-delete.js" onerror="document.getElementById('deleteAccountError').textContent = 'Failed to load account deletion module.';"></script>
  <script>
    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyC7vRXVWl64DyBHywDOcRHAwm5Oij5G7yI",
      authDomain: "data-41fa8.firebaseapp.com",
      projectId: "data-41fa8",
      storageBucket: "data-41fa8.firebasestorage.app",
      messagingSenderId: "865171535257",
      appId: "1:865171535257:web:9944a48a952e99f55f0f08",
      measurementId: "G-1DYR2RGY4G"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    let currentUser = null;
    let userData = null;

    // Load subscription information
    async function loadSubscriptionInfo() {
      try {
        const user = auth.currentUser;
        if (!user) {
          document.getElementById('currentPlan').textContent = 'Not logged in';
          document.getElementById('subscriptionStatus').textContent = 'Not logged in';
          return;
        }

        const userDoc = await db.collection('userProfiles').doc(user.uid).get();
        if (userDoc.exists) {
          userData = userDoc.data();
          const accountType = userData.accountType || 'trial';
          const subscriptionStatus = userData.subscriptionStatus || 'active';
          
          document.getElementById('currentPlan').textContent = accountType.charAt(0).toUpperCase() + accountType.slice(1) + ' Plan';
          document.getElementById('subscriptionStatus').textContent = subscriptionStatus.charAt(0).toUpperCase() + subscriptionStatus.slice(1);
          
          // Show/hide cancel button based on plan
          const cancelBtn = document.getElementById('cancelSubscriptionBtn');
          if (accountType === 'trial') {
            cancelBtn.style.display = 'none';
          } else {
            cancelBtn.style.display = 'block';
          }
        } else {
          document.getElementById('currentPlan').textContent = 'Trial Plan';
          document.getElementById('subscriptionStatus').textContent = 'Active';
          document.getElementById('cancelSubscriptionBtn').style.display = 'none';
        }
      } catch (error) {
        console.error('Error loading subscription info:', error);
        document.getElementById('subscriptionError').textContent = 'Error loading subscription information';
      }
    }

    // Cancel subscription function
    async function cancelSubscription() {
      if (confirm('Are you sure you want to cancel your subscription? This will downgrade your account to Trial.')) {
        try {
          const user = auth.currentUser;
          if (!user) {
            document.getElementById('subscriptionError').textContent = 'Not logged in';
            return;
          }

          // Call Netlify function to cancel Stripe subscription
          const response = await fetch('/.netlify/functions/cancel-subscription', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              userId: user.uid,
              email: user.email
            })
          });

          if (response.ok) {
            // Update user account type to trial
            await db.collection('userProfiles').doc(user.uid).update({
              accountType: 'trial',
              plan: 'trial',
              subscriptionStatus: 'cancelled',
              cancelledAt: new Date().toISOString(),
              updatedAt: new Date().toISOString()
            });

            userData.accountType = 'trial';
            document.getElementById('subscriptionMessage').textContent = 'Subscription cancelled successfully. Your account has been downgraded to Trial.';
            document.getElementById('subscriptionError').textContent = '';
            
            // Reload subscription info
            await loadSubscriptionInfo();
          } else {
            throw new Error('Failed to cancel subscription');
          }
        } catch (error) {
          console.error('Error cancelling subscription:', error);
          document.getElementById('subscriptionError').textContent = 'Error cancelling subscription. Please contact support.';
        }
      }
    }

    // Initialize page
    document.addEventListener('DOMContentLoaded', function() {
      auth.onAuthStateChanged(async (user) => {
        if (user) {
          currentUser = user;
          await loadSubscriptionInfo();
        } else {
          window.location.href = 'signin.html';
        }
      });
    });

    // Add event listener for cancel button
    document.addEventListener('DOMContentLoaded', function() {
      const cancelBtn = document.getElementById('cancelSubscriptionBtn');
      if (cancelBtn) {
        cancelBtn.addEventListener('click', cancelSubscription);
      }
    });
  </script>
  <script>
    // Top nav Logout button logic
    const navLogoutBtn = document.getElementById('navLogoutBtn');
    if (navLogoutBtn) {
      navLogoutBtn.addEventListener('click', function() {
        window.location.href = 'index.html';
      });
    }
    // Logout button logic
    document.getElementById('logoutBtn').addEventListener('click', function() {
      window.location.href = 'index.html';
    });
    // Profile photo preview
    document.getElementById('profilePhotoInput').addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function(ev) {
          document.getElementById('profilePhoto').src = ev.target.result;
        };
        reader.readAsDataURL(file);
      }
    });
    // Profile form logic (localStorage demo)
    const profileForm = document.getElementById('profileForm');
    const profileSuccess = document.getElementById('profileSuccess');
    const profileError = document.getElementById('profileError');
    // Load profile from localStorage
    window.addEventListener('DOMContentLoaded', () => {
      const profile = JSON.parse(localStorage.getItem('userProfile') || '{}');
      if (profile.name) document.getElementById('profileName').value = profile.name;
      if (profile.email) document.getElementById('profileEmail').value = profile.email;
      if (profile.phone) document.getElementById('profilePhone').value = profile.phone;
      if (profile.address) document.getElementById('profileAddress').value = profile.address;
      if (profile.photo) document.getElementById('profilePhoto').src = profile.photo;
    });
    profileForm.addEventListener('submit', function(e) {
      e.preventDefault();
      const name = document.getElementById('profileName').value.trim();
      const email = document.getElementById('profileEmail').value.trim();
      const phone = document.getElementById('profilePhone').value.trim();
      const address = document.getElementById('profileAddress').value.trim();
      const photo = document.getElementById('profilePhoto').src;
      if (!name || !email) {
        profileError.textContent = 'Name and email are required.';
        profileSuccess.textContent = '';
        return;
      }
      const profile = { name, email, phone, address, photo };
      localStorage.setItem('userProfile', JSON.stringify(profile));
      profileSuccess.textContent = 'Profile updated!';
      profileError.textContent = '';
    });
  </script>
</html>
